# å‰ç«¯æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–å…¨é¢åˆ†ææŠ¥å‘Š

## ğŸ“Š åˆ†ææ¦‚è§ˆ

- **åˆ†æç›®æ ‡**: `/mnt/d/Documents/yunkebaiban/baibanfront`
- **æŠ€æœ¯æ ˆ**: React + TypeScript + YJS + BlockSuite + Socket.IO
- **æ¶æ„æ¨¡å¼**: åŒå±‚å­˜å‚¨æ¶æ„ (æœ¬åœ°å­˜å‚¨ + äº‘ç«¯åŒæ­¥)
- **åˆ†ææ—¶é—´**: åŸºäºæœ€æ–°ä»£ç åˆ†æ
- **åˆ†æé‡ç‚¹**: ç¦»çº¿/è”ç½‘ä¿å­˜æœºåˆ¶ã€æ•°æ®æŒä¹…åŒ–æµç¨‹ã€åç«¯APIé›†æˆ

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜åˆ†æ

### â“ ç”¨æˆ·æ ¸å¿ƒç–‘é—®
1. **å‰ç«¯æ˜¯å¦åŒºåˆ†ç¦»çº¿å’Œè”ç½‘ä¿å­˜ï¼Ÿ** âœ… æ˜¯çš„ï¼Œæœ‰å®Œæ•´çš„ç¦»çº¿/åœ¨çº¿æ¨¡å¼åˆ‡æ¢
2. **è”ç½‘ä¿å­˜æ˜¯å¦èµ°åç«¯æ¥å£ï¼Ÿ** âœ… æ˜¯çš„ï¼Œé€šè¿‡Socket.IOå’ŒREST APIåŒé‡ä¿å­˜
3. **æ•°æ®ä¸èƒ½æŒä¹…åŒ–çš„åŸå› ï¼Ÿ** âš ï¸ å‘ç°å¤šä¸ªé…ç½®å’Œè¿æ¥é—®é¢˜

---

## ğŸ“‹ æ•°æ®å­˜å‚¨æ¶æ„è¯¦ç»†åˆ†æ

### ğŸ—ï¸ æ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "å‰ç«¯åº”ç”¨å±‚"
        A[ç¼–è¾‘å™¨UI] --> B[BlockSuiteç¼–è¾‘å¼•æ“]
    end
    
    subgraph "æ•°æ®ç®¡ç†å±‚"
        B --> C[YJSæ–‡æ¡£å¼•æ“]
        C --> D[WorkspaceEngine]
        D --> E[å­˜å‚¨ç­–ç•¥é€‰æ‹©å™¨]
    end
    
    subgraph "å­˜å‚¨å±‚"
        E --> F[æœ¬åœ°å­˜å‚¨ LocalStorage]
        E --> G[äº‘ç«¯å­˜å‚¨ CloudStorage]
        F --> F1[IndexedDB]
        F --> F2[SQLite/Capacitor]
        G --> G1[Socket.IOå®æ—¶åŒæ­¥]
        G --> G2[REST APIæ‰¹é‡ä¿å­˜]
    end
    
    subgraph "åç«¯æœåŠ¡"
        G1 --> H[Javaåç«¯SocketæœåŠ¡]
        G2 --> I[Javaåç«¯REST API]
        H --> J[æ•°æ®åº“MySQL]
        I --> J
    end
```

### ğŸ”§ å­˜å‚¨å¼•æ“é…ç½®

#### 1. åŒå¼•æ“æ¶æ„

**æœ¬åœ°å­˜å‚¨å¼•æ“** (`local.ts:76-122`):
```typescript
class LocalWorkspaceFlavourProvider {
  // å¹³å°é€‚é…å­˜å‚¨é€‰æ‹©
  DocStorageType = BUILD_CONFIG.isElectron ? SqliteDocStorage : IndexedDBDocStorage;
  BlobStorageType = BUILD_CONFIG.isElectron ? SqliteBlobStorage : IndexedDBBlobStorage;
  
  // Androidç‰¹æ®Šå¤„ç†
  DocStorageType = BUILD_CONFIG.isAndroid && window.Capacitor 
    ? IndexedDBDocStorage 
    : SqliteDocStorage;
}
```

**äº‘ç«¯å­˜å‚¨å¼•æ“** (`cloud.ts:186-260`):
```typescript
class CloudWorkspaceFlavourProvider {
  // åŠ¨æ€å­˜å‚¨ç±»å‹é€‰æ‹©
  DocStorageType = () => {
    if (BUILD_CONFIG.isAndroid && window.Capacitor) {
      return IndexedDBDocStorage; // å¼ºåˆ¶ä½¿ç”¨IndexedDB
    }
    return BUILD_CONFIG.isElectron ? SqliteDocStorage : IndexedDBDocStorage;
  }
}
```

#### 2. å­˜å‚¨å±‚çº§æ˜ å°„

| å¹³å°ç¯å¢ƒ | æ–‡æ¡£å­˜å‚¨ | äºŒè¿›åˆ¶å­˜å‚¨ | åŒæ­¥å­˜å‚¨ | å¤‡æ³¨ |
|----------|----------|------------|----------|------|
| **Webæµè§ˆå™¨** | IndexedDBDocStorage | IndexedDBBlobStorage | IndexedDBDocSyncStorage | æ ‡å‡†Webç¯å¢ƒ |
| **Electronæ¡Œé¢** | SqliteDocStorage | SqliteBlobStorage | SqliteDocSyncStorage | åŸç”Ÿæ•°æ®åº“ |
| **Android App** | IndexedDBDocStorage | IndexedDBBlobStorage | IndexedDBDocSyncStorage | å¼ºåˆ¶IndexedDB |
| **iOS App** | SqliteDocStorage | SqliteBlobStorage | SqliteDocSyncStorage | åŸç”ŸSQLite |

---

## ğŸ”„ ç¦»çº¿/åœ¨çº¿æ¨¡å¼å®ç°åˆ†æ

### âœ… **é—®é¢˜ç­”æ¡ˆï¼šå‰ç«¯ç¡®å®åŒºåˆ†ç¦»çº¿å’Œè”ç½‘ä¿å­˜**

#### 1. æ¨¡å¼æ£€æµ‹æœºåˆ¶

**ç½‘ç»œçŠ¶æ€ç›‘å¬** (`cloud-storage-manager.tsx:242-264`):
```typescript
// ç½‘ç»œçŠ¶æ€å®æ—¶ç›‘æ§
useEffect(() => {
  const handleOnline = () => {
    setIsOnline(true);
    if (!isConnected && currentWorkspaceId) {
      reconnectAttempts.current = 0;
      connectToSocket(); // ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨é‡è¿
    }
  };

  const handleOffline = () => {
    setIsOnline(false);
    setStorageMode('local'); // åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
  };

  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
}, [isConnected, currentWorkspaceId]);
```

#### 2. å­˜å‚¨æ¨¡å¼åˆ‡æ¢

**å››ç§å­˜å‚¨çŠ¶æ€** (`cloud-storage-manager.tsx:49`):
```typescript
storageMode: 'detecting' | 'local' | 'cloud' | 'error'
```

- **`detecting`**: æ£€æµ‹ç½‘ç»œå’ŒæœåŠ¡å™¨è¿æ¥çŠ¶æ€
- **`local`**: çº¯ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®åªä¿å­˜åˆ°æœ¬åœ°
- **`cloud`**: è”ç½‘æ¨¡å¼ï¼Œæ•°æ®åŒæ­¥åˆ°äº‘ç«¯
- **`error`**: è¿æ¥é”™è¯¯ï¼Œé™çº§åˆ°æœ¬åœ°æ¨¡å¼

#### 3. æ™ºèƒ½é™çº§ç­–ç•¥

**è¿æ¥å¤±è´¥å¤„ç†** (`cloud-storage-manager.tsx:556-576`):
```typescript
// Socketè¿æ¥å¤±è´¥æ—¶çš„é™çº§å¤„ç†
newSocket.on('connect_error', (error) => {
  console.warn('è¿æ¥å¤±è´¥:', error.message);
  setIsConnected(false);
  newSocket.disconnect();
  
  // æŒ‡æ•°é€€é¿é‡è¿
  scheduleReconnect();
});

// è¶…è¿‡æœ€å¤§é‡è¿æ¬¡æ•°åï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
if (reconnectAttempts.current >= maxReconnectAttempts) {
  setStorageMode('local');
  return;
}
```

---

## ğŸŒ è”ç½‘ä¿å­˜æœºåˆ¶è¯¦ç»†åˆ†æ

### âœ… **é—®é¢˜ç­”æ¡ˆï¼šè”ç½‘ä¿å­˜ç¡®å®èµ°åç«¯æ¥å£**

#### 1. åŒé‡ä¿å­˜æœºåˆ¶

**Socket.IOå®æ—¶åŒæ­¥** + **REST APIæ‰¹é‡åŒæ­¥**

**å®æ—¶åŒæ­¥æµç¨‹** (`cloud-storage-manager.tsx:442`):
```typescript
const result = await socket.emitWithAck('space:push-doc-update', {
  spaceType: 'workspace',
  spaceId: currentWorkspaceId,      // å·¥ä½œç©ºé—´ID
  docId: docId,                     // æ–‡æ¡£ID
  update: updateBase64              // YJSæ›´æ–°æ•°æ®(Base64ç¼–ç )
});
```

**æ‰¹é‡APIåŒæ­¥** (`cloud.ts:266-281`):
```typescript
// ä½¿ç”¨REST APIåˆ é™¤å·¥ä½œç©ºé—´
const response = await this.fetchWithAuth(`/api/workspaces/${id}`, {
  method: 'DELETE',
  headers: { 'Content-Type': 'application/json' },
});

// ä½¿ç”¨REST APIåˆ›å»ºå·¥ä½œç©ºé—´  
const response = await this.fetchWithAuth('/api/workspaces', {
  method: 'POST',
  body: JSON.stringify({
    name: workspaceName,
    isPublic: false,
    enableAi: true
  }),
});
```

#### 2. è®¤è¯æœºåˆ¶

**JWT Tokenè®¤è¯** (`cloud.ts:154-183`):
```typescript
private async fetchWithAuth(url: string, options: RequestInit = {}): Promise<Response> {
  const headers = { ...options.headers } as Record<string, string>;
  
  // ä»localStorageè·å–JWT token
  const token = localStorage.getItem('affine-admin-token');
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  
  // è‡ªåŠ¨æ·»åŠ APIåŸºç¡€URL
  const apiBaseUrl = import.meta.env?.VITE_API_BASE_URL || 'http://localhost:8080';
  const fullUrl = url.startsWith('http') ? url : `${apiBaseUrl}${url}`;
  
  return await fetch(fullUrl, {
    ...options,
    headers,
    credentials: 'include',
  });
}
```

#### 3. åç«¯æ¥å£æ˜ å°„

| å‰ç«¯æ“ä½œ | åç«¯æ¥å£ | è¯·æ±‚æ–¹æ³• | æ•°æ®æ ¼å¼ |
|----------|----------|----------|----------|
| **å®æ—¶æ–‡æ¡£æ›´æ–°** | `space:push-doc-update` | Socket.IO | YJS Binary â†’ Base64 |
| **åˆ›å»ºå·¥ä½œç©ºé—´** | `/api/workspaces` | POST | JSONè¯·æ±‚ä½“ |
| **è·å–å·¥ä½œç©ºé—´åˆ—è¡¨** | `/api/workspaces` | GET | JWTè®¤è¯å¤´ |
| **åˆ é™¤å·¥ä½œç©ºé—´** | `/api/workspaces/{id}` | DELETE | è·¯å¾„å‚æ•° |
| **è·å–å·¥ä½œç©ºé—´ä¿¡æ¯** | `/api/workspaces/{id}` | GET | JWTè®¤è¯å¤´ |
| **æ–‡æ¡£å·¥ä½œç©ºé—´æ˜ å°„** | `/api/docs/{docId}/workspace` | GET | è·¯å¾„å‚æ•° |

---

## âŒ æ•°æ®æŒä¹…åŒ–é—®é¢˜æ ¹å› åˆ†æ

### ğŸ” **ä¸»è¦é—®é¢˜ï¼šå¤šå±‚é…ç½®é”™è¯¯å¯¼è‡´æ•°æ®æ— æ³•æ­£ç¡®ä¿å­˜**

#### 1. ç½‘ç»œè¿æ¥é…ç½®é—®é¢˜

**WSLç¯å¢ƒç½‘ç»œé…ç½®é”™è¯¯** (`cloud-storage-manager.tsx:10-31`):
```typescript
function getSocketIOUrl(): string {
  // âŒ é—®é¢˜ï¼šWSLç¯å¢ƒä¸‹ä½¿ç”¨é”™è¯¯çš„IPåœ°å€
  if (buildConfig?.isAndroid || buildConfig?.platform === 'android') {
    return 'http://localhost:9092';  // âŒ åº”è¯¥æ˜¯172.24.48.1
  }
  
  // âŒ é—®é¢˜ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®é”™è¯¯
  if (window.location.hostname !== 'localhost') {
    return 'https://your-domain.com:9092'; // âŒ ç¡¬ç¼–ç çš„å ä½ç¬¦
  }
  
  return 'http://localhost:9092'; // âŒ WSLç¯å¢ƒä¸‹ä¸å¯è®¿é—®
}
```

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
function getSocketIOUrl(): string {
  // âœ… WSLç¯å¢ƒæ£€æµ‹å’Œæ­£ç¡®é…ç½®
  if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
    // æ£€æµ‹æ˜¯å¦åœ¨WSLç¯å¢ƒä¸­è¿è¡Œ
    return 'http://172.24.48.1:8080'; // ä½¿ç”¨æ­£ç¡®çš„WSLç½‘å…³IP
  }
  
  return import.meta.env?.VITE_SOCKETIO_URL || 'http://localhost:8080';
}
```

#### 2. Socket.IOè¿æ¥ç«¯å£é”™è¯¯

**å½“å‰é…ç½®** vs **åç«¯å®é™…ç«¯å£**:
- å‰ç«¯è¿æ¥: `localhost:9092` (Socket.IO)
- åç«¯ç›‘å¬: `localhost:8080` (Spring Bootå†…åµŒSocket.IO)

**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ç«¯å£é…ç½®
```typescript
// âœ… ä¿®æ­£åçš„é…ç½®
const SOCKET_URL = 'http://172.24.48.1:8080';
const API_BASE_URL = 'http://172.24.48.1:8080';
```

#### 3. YJSæ•°æ®ç¼–ç é—®é¢˜

**Base64ç¼–ç ä¸ä¸€è‡´** (`yjs-utils.ts:12-27`):
```typescript
// âŒ å½“å‰å®ç°ï¼šä½¿ç”¨FileReaderå¼‚æ­¥ç¼–ç 
export function uint8ArrayToBase64(array: Uint8Array): Promise<string> {
  return new Promise<string>(resolve => {
    const blob = new Blob([array]);
    const reader = new FileReader();
    reader.onload = function () {
      const dataUrl = reader.result as string;
      const base64 = dataUrl.split(',')[1]; // å»æ‰data:å‰ç¼€
      resolve(base64);
    };
    reader.readAsDataURL(blob);
  });
}
```

**å¯èƒ½çš„å…¼å®¹æ€§é—®é¢˜**:
- FileReaderåœ¨æŸäº›ç¯å¢ƒä¸‹è¡Œä¸ºä¸ä¸€è‡´
- Base64ç¼–ç ç»“æœå¯èƒ½åŒ…å«æ¢è¡Œç¬¦æˆ–å¡«å……

#### 4. å·¥ä½œç©ºé—´IDæ˜ å°„æ··ä¹±

**IDæ ¼å¼ä¸ä¸€è‡´** (`cloud-storage-manager.tsx:206-224`):
```typescript
// âŒ é—®é¢˜ï¼šçŸ­IDå’Œé•¿IDæ··ç”¨
if (workspaceId.length === 36 && workspaceId.includes('-')) {
  // UUIDæ ¼å¼ï¼šd33eccd3-3d08-4bcd-8c16-a775e2ea1f28
  return workspaceId;
} else if (workspaceId.length === 21 && !workspaceId.includes('-')) {
  // çŸ­IDæ ¼å¼ï¼šLpaTmZqNPqWRY7M2R63MM
  // è¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿä½†æœ‰fallbackå¤„ç†
}
```

---

## ğŸ”„ ç¦»çº¿æ•°æ®åŒæ­¥æœºåˆ¶

### ğŸ“¦ ç¦»çº¿æ“ä½œç¼“å­˜

**ç¦»çº¿æ“ä½œå­˜å‚¨æ ¼å¼** (`cloud-storage-manager.tsx:38-45`):
```typescript
interface OfflineOperation {
  id: string;
  docId: string;
  update: string;        // Base64ç¼–ç çš„YJSæ›´æ–°
  timestamp: number;
  spaceId: string;       // å·¥ä½œç©ºé—´ID
  spaceType: 'workspace' | 'userspace';
}
```

**ç¦»çº¿æ“ä½œä¿å­˜** (`cloud-storage-manager.tsx:98-123`):
```typescript
const saveOfflineOperation = async (docId: string, update: Uint8Array) => {
  const updateBase64 = await uint8ArrayToBase64(update);
  
  const operation: OfflineOperation = {
    id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    docId,
    update: updateBase64,
    timestamp: Date.now(),
    spaceId: currentWorkspaceId,
    spaceType: 'workspace'
  };

  // ä¿å­˜åˆ°localStorage
  const existing = localStorage.getItem(OFFLINE_OPERATIONS_KEY);
  const operations: OfflineOperation[] = existing ? JSON.parse(existing) : [];
  operations.push(operation);
  localStorage.setItem(OFFLINE_OPERATIONS_KEY, JSON.stringify(operations));
};
```

### â¬†ï¸ ç½‘ç»œæ¢å¤æ—¶åŒæ­¥

**æ‰¹é‡åŒæ­¥ç¦»çº¿æ“ä½œ** (`cloud-storage-manager.tsx:136-187`):
```typescript
const syncOfflineOperations = async (): Promise<void> => {
  const operations = getOfflineOperations()
    .filter(op => op.spaceId === currentWorkspaceId)
    .sort((a, b) => a.timestamp - b.timestamp); // æŒ‰æ—¶é—´é¡ºåº

  for (const operation of operations) {
    try {
      // ä½¿ç”¨Socket.IOå‘é€ç¦»çº¿æ“ä½œ
      const result = await socket.emitWithAck('space:push-doc-update', {
        spaceType: operation.spaceType,
        spaceId: operation.spaceId,
        docId: operation.docId,
        update: operation.update  // ç›´æ¥ä½¿ç”¨Base64å­—ç¬¦ä¸²
      });

      if ('error' in result) {
        throw new Error(result.error.message);
      }

      successCount++;
    } catch (error) {
      failureCount++;
      console.error(`ç¦»çº¿æ“ä½œåŒæ­¥å¤±è´¥: ${operation.id}`, error);
    }
  }
};
```

---

## ğŸ› ï¸ BlockSuiteåä½œæœºåˆ¶

### ğŸ“ æ–‡æ¡£ç¼–è¾‘å¼•æ“

**YJSåä½œç¼–è¾‘æ ¸å¿ƒ**:
- BlockSuiteä½¿ç”¨YJSä½œä¸ºåº•å±‚CRDTå¼•æ“
- æ”¯æŒå®æ—¶å¤šäººåä½œç¼–è¾‘
- è‡ªåŠ¨å†²çªè§£å†³å’ŒçŠ¶æ€åŒæ­¥

**æ–‡æ¡£æ›´æ–°æµç¨‹**:
1. ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥
2. BlockSuiteç”ŸæˆYJSæ“ä½œ
3. YJSæ›´æ–°è¢«åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ ¼å¼
4. å‰ç«¯å°†æ›´æ–°ç¼–ç ä¸ºBase64
5. é€šè¿‡Socket.IOå‘é€åˆ°åç«¯
6. åç«¯ä¿å­˜åˆ°æ•°æ®åº“å¹¶å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·

### ğŸ”„ å®æ—¶åŒæ­¥æœºåˆ¶

**WebSocketè¿æ¥ç®¡ç†** (`cloud-storage-manager.tsx:521-554`):
```typescript
// Socket.IOè¿æ¥å»ºç«‹
const newSocket = io(serverUrl, {
  transports: ['websocket', 'polling'],
  timeout: 5000,
  reconnection: false, // æ‰‹åŠ¨å¤„ç†é‡è¿
  auth: {
    token: 'dev-token-' + Date.now()  // å¼€å‘ç¯å¢ƒä¸´æ—¶token
  }
});

// åŠ å…¥å·¥ä½œç©ºé—´æˆ¿é—´
newSocket.emit('space:join', {
  spaceType: 'workspace',
  spaceId: currentWorkspaceId,
  clientVersion: '1.0.0'
}, (response) => {
  if (response && !response.error) {
    setStorageMode('cloud');
    setLastSync(new Date());
  }
});
```

---

## âš ï¸ å‘ç°çš„å…³é”®é—®é¢˜

### ğŸš¨ **æ•°æ®æ— æ³•æŒä¹…åŒ–çš„å…·ä½“åŸå› **

#### 1. **ç½‘ç»œè¿æ¥å¤±è´¥** (ä¸¥é‡)
- å‰ç«¯å°è¯•è¿æ¥ `localhost:9092`
- åç«¯å®é™…è¿è¡Œåœ¨ `172.24.48.1:8080`
- WSLç¯å¢ƒä¸‹localhostä¸å¯è¾¾

#### 2. **Socket.IOç«¯å£ä¸åŒ¹é…** (ä¸¥é‡)  
- å‰ç«¯Socket.IOé…ç½®ç«¯å£: `9092`
- åç«¯Spring Bootç«¯å£: `8080`
- å¯¼è‡´å®æ—¶åŒæ­¥å®Œå…¨å¤±è´¥

#### 3. **JWTè®¤è¯å¯èƒ½å¤±æ•ˆ** (ä¸­ç­‰)
- Tokenå¯èƒ½å·²è¿‡æœŸ
- åç«¯æ¥å£è¿”å›401/403é”™è¯¯
- å‰ç«¯æ²¡æœ‰æ­£ç¡®çš„tokenåˆ·æ–°æœºåˆ¶

#### 4. **YJSæ•°æ®æ ¼å¼å…¼å®¹æ€§** (è½»å¾®)
- Base64ç¼–ç æ–¹å¼å¯èƒ½ä¸åç«¯é¢„æœŸä¸ä¸€è‡´
- éœ€è¦éªŒè¯å‰åç«¯çš„æ•°æ®åºåˆ—åŒ–æ ¼å¼

#### 5. **å·¥ä½œç©ºé—´IDè§£æé”™è¯¯** (ä¸­ç­‰)
- å‰ç«¯å¯èƒ½å‘é€é”™è¯¯çš„å·¥ä½œç©ºé—´ID
- åç«¯æ— æ³•æ‰¾åˆ°å¯¹åº”çš„å·¥ä½œç©ºé—´è®°å½•

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆæ€»ç»“

### âœ… **ç«‹å³ä¿®å¤æ–¹æ¡ˆ**

#### 1. ç½‘ç»œé…ç½®ä¿®å¤
```typescript
// ä¿®æ”¹ cloud-storage-manager.tsx
function getSocketIOUrl(): string {
  return 'http://172.24.48.1:8080';  // ç›´æ¥ä½¿ç”¨æ­£ç¡®çš„IPå’Œç«¯å£
}

// ä¿®æ”¹ cloud.ts
const apiBaseUrl = 'http://172.24.48.1:8080';
```

#### 2. ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env.local
VITE_API_BASE_URL=http://172.24.48.1:8080
VITE_SOCKETIO_URL=http://172.24.48.1:8080
```

#### 3. Socket.IOæœåŠ¡å™¨ç«¯å£ç»Ÿä¸€
ç¡®ä¿åç«¯Socket.IOæœåŠ¡è¿è¡Œåœ¨8080ç«¯å£ï¼Œæˆ–å‰ç«¯é…ç½®è°ƒæ•´åˆ°åç«¯å®é™…ç«¯å£ã€‚

#### 4. JWT Tokenæ£€æŸ¥
```typescript
// æ·»åŠ tokenéªŒè¯å’Œè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
const token = localStorage.getItem('affine-admin-token');
if (!token || isTokenExpired(token)) {
  await refreshToken();
}
```

### ğŸ“Š **æ•°æ®æµè¿½è¸ªå»ºè®®**

1. **å‰ç«¯æ—¥å¿—å¢å¼º**: å¢åŠ è¯¦ç»†çš„æ•°æ®å‘é€å’Œå“åº”æ—¥å¿—
2. **åç«¯æ—¥å¿—æ£€æŸ¥**: éªŒè¯æ˜¯å¦æ”¶åˆ°å‰ç«¯å‘é€çš„æ•°æ®
3. **ç½‘ç»œæŠ“åŒ…åˆ†æ**: ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹å®é™…ç½‘ç»œè¯·æ±‚
4. **æ•°æ®åº“æŸ¥è¯¢éªŒè¯**: ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ç¡®è®¤æ•°æ®æ˜¯å¦ä¿å­˜

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ğŸš€ **çŸ­æœŸä¼˜åŒ–**
1. å®ç°æ™ºèƒ½æ‰¹å¤„ç†ï¼šåˆå¹¶é¢‘ç¹çš„å°æ›´æ–°
2. æ·»åŠ æœ¬åœ°ç¼“å­˜ï¼šå‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
3. ä¼˜åŒ–é‡è¿ç­–ç•¥ï¼šä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•

### ğŸ¯ **é•¿æœŸä¼˜åŒ–**  
1. å®ç°å¢é‡åŒæ­¥ï¼šåªåŒæ­¥å˜æ›´çš„éƒ¨åˆ†
2. æ·»åŠ å‹ç¼©ç®—æ³•ï¼šå‡å°‘æ•°æ®ä¼ è¾“é‡
3. å¤šç«¯çŠ¶æ€ç®¡ç†ï¼šç»Ÿä¸€ä¸åŒå¹³å°çš„å­˜å‚¨ç­–ç•¥

---

## ğŸ“ æ€»ç»“

### âœ… **å›ç­”ç”¨æˆ·æ ¸å¿ƒé—®é¢˜**

1. **å‰ç«¯ç¡®å®åŒºåˆ†ç¦»çº¿å’Œè”ç½‘ä¿å­˜**ï¼š
   - æœ‰å®Œæ•´çš„ç½‘ç»œçŠ¶æ€æ£€æµ‹
   - æ”¯æŒè‡ªåŠ¨æ¨¡å¼åˆ‡æ¢
   - ç¦»çº¿æ“ä½œä¼šè¢«ç¼“å­˜å¹¶åœ¨ç½‘ç»œæ¢å¤æ—¶åŒæ­¥

2. **è”ç½‘ä¿å­˜ç¡®å®èµ°åç«¯æ¥å£**ï¼š
   - Socket.IOç”¨äºå®æ—¶åŒæ­¥
   - REST APIç”¨äºæ‰¹é‡æ“ä½œ
   - ä½¿ç”¨JWTè¿›è¡Œè®¤è¯

3. **æ•°æ®æ— æ³•æŒä¹…åŒ–çš„ä¸»è¦åŸå› **ï¼š
   - ç½‘ç»œé…ç½®é”™è¯¯(WSLç¯å¢ƒIPé—®é¢˜)
   - Socket.IOç«¯å£ä¸åŒ¹é…
   - JWTè®¤è¯å¯èƒ½å­˜åœ¨é—®é¢˜

### ğŸ¯ **æ ¸å¿ƒå»ºè®®**

**ç«‹å³æ‰§è¡Œ**ï¼šä¿®å¤ç½‘ç»œé…ç½®ï¼Œç»Ÿä¸€ç«¯å£å·ï¼ŒéªŒè¯JWT tokenæœ‰æ•ˆæ€§

**éªŒè¯æ–¹æ³•**ï¼šé€šè¿‡æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥ç½‘ç»œè¯·æ±‚å’ŒSocket.IOè¿æ¥çŠ¶æ€

**é•¿æœŸè§„åˆ’**ï¼šå®Œå–„ç¦»çº¿åŒæ­¥æœºåˆ¶ï¼Œå¢åŠ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼Œä¼˜åŒ–æ€§èƒ½

---

*æœ¬åˆ†æåŸºäºå½“å‰ä»£ç ç‰ˆæœ¬ï¼Œå»ºè®®ç»“åˆå®é™…ç½‘ç»œç¯å¢ƒå’Œåç«¯æ—¥å¿—è¿›è¡ŒéªŒè¯ã€‚*