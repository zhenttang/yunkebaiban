# AFFiNE/BlockSuite å¤§å‹æ–‡æ¡£ç¼–è¾‘æ€§èƒ½é—®é¢˜ - æ·±åº¦æŠ€æœ¯åˆ†ææŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-11-15
**åˆ†æäººå‘˜**: Claude (Technical Analyst)
**é—®é¢˜ç¼–å·**: GitHub Issue (å¾…è¡¥å……)
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 Critical - æ¶æ„çº§æ€§èƒ½ç¼ºé™·
**å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨BlockSuiteçš„ç¼–è¾‘å™¨åœºæ™¯

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹AFFiNEç¼–è¾‘å™¨åœ¨å¤„ç†å¤§å‹æ–‡æ¡£ï¼ˆ>2000å­—ç¬¦ï¼‰æ—¶å‡ºç°çš„ä¸¥é‡æ€§èƒ½é—®é¢˜è¿›è¡Œäº†æ·±å…¥çš„ä»£ç çº§åˆ†æã€‚é€šè¿‡é€å±‚è¿½è¸ªç”¨æˆ·è¾“å…¥åˆ°DOMæ›´æ–°çš„å®Œæ•´è°ƒç”¨é“¾è·¯ï¼Œæˆ‘ä»¬å®šä½äº†å¯¼è‡´1-2ç§’è¾“å…¥å»¶è¿Ÿçš„æ ¹æœ¬åŸå› ã€‚

**æ ¸å¿ƒå‘ç°**ï¼š
- âŒ **æ¶æ„è®¾è®¡ç¼ºé™·**ï¼šå“åº”å¼ç³»ç»Ÿé‡‡ç”¨ç²—ç²’åº¦å…¨é‡æ›´æ–°ï¼Œç¼ºå°‘å¢é‡å˜æ›´ä¿¡æ¯ä¼ é€’
- âŒ **æ¸²æŸ“ç­–ç•¥é”™è¯¯**ï¼šInlineEditoræ¯æ¬¡æ–‡æœ¬å˜åŒ–éƒ½å®Œæ•´é‡æ¸²æŸ“æ‰€æœ‰å†…å®¹
- âŒ **ç»„ä»¶æ›´æ–°å¤±æ§**ï¼šå•ä¸ªå­—ç¬¦è¾“å…¥è§¦å‘æ•´ä¸ªBlockç»„ä»¶æ ‘çš„é€’å½’é‡æ¸²æŸ“
- âŒ **ç¼ºå°‘æ€§èƒ½ä¼˜åŒ–**ï¼šæ— è™šæ‹ŸåŒ–ã€æ— è§†å£è£å‰ªã€æ— æ¸²æŸ“ç¼“å­˜

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- å½“å‰ï¼šå•æ¬¡æŒ‰é”®å»¶è¿Ÿ **200-1000ms**
- ç›®æ ‡ï¼šå•æ¬¡æŒ‰é”®å»¶è¿Ÿ **<16ms** (60 FPS)
- å·®è·ï¼š**12-62å€æ€§èƒ½å·®è·**

**å·¥ä½œé‡è¯„ä¼°**ï¼š
- ä¿®å¤å‘¨æœŸï¼š**2-3ä¸ªæœˆ**
- æ¶‰åŠäººå‘˜ï¼š**3-4åæ ¸å¿ƒå·¥ç¨‹å¸ˆ**
- æ¶æ„é‡æ„æ¯”ä¾‹ï¼š**çº¦30-40%çš„æ¸²æŸ“å±‚ä»£ç **

---

## ğŸ“Š é—®é¢˜ä¸¥é‡æ€§é‡åŒ–è¯„ä¼°

### ç”¨æˆ·å½±å“é¢

| æ–‡æ¡£ç±»å‹ | å­—ç¬¦æ•° | å—æ•°é‡ | å½“å‰å»¶è¿Ÿ | ç†æƒ³å»¶è¿Ÿ | ç”¨æˆ·æ„ŸçŸ¥ |
|---------|--------|--------|---------|---------|---------|
| å°æ–‡æ¡£ | <500 | <10 | 100-200ms | <16ms | è½»å¾®å¡é¡¿ |
| ä¸­å‹æ–‡æ¡£ | 500-1500 | 10-30 | 300-600ms | <16ms | æ˜æ˜¾å»¶è¿Ÿ |
| å¤§å‹æ–‡æ¡£ | 1500-3000 | 30-60 | 600-1200ms | <16ms | ä¸¥é‡å¡é¡¿ |
| è¶…å¤§æ–‡æ¡£ | >3000 | >60 | 1000-2000ms | <16ms | å‡ ä¹æ— æ³•ä½¿ç”¨ |

### æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥å»¶è¿Ÿå¯¹æ¯” (æ¯«ç§’)                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  ç†æƒ³çŠ¶æ€ (60 FPS)    â–Œ 16ms                                â”‚
â”‚                                                              â”‚
â”‚  å°æ–‡æ¡£ (ç°çŠ¶)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 150ms                     â”‚
â”‚                                                              â”‚
â”‚  ä¸­å‹æ–‡æ¡£ (ç°çŠ¶)      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 450ms     â”‚
â”‚                                                              â”‚
â”‚  å¤§å‹æ–‡æ¡£ (ç°çŠ¶)      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 900ms â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç³»ç»Ÿèµ„æºæ¶ˆè€—

**CPUå ç”¨ç‡**ï¼ˆåœ¨è¾“å…¥æœŸé—´ï¼‰ï¼š
- å°æ–‡æ¡£ï¼š40-60%
- ä¸­å‹æ–‡æ¡£ï¼š60-80%
- å¤§å‹æ–‡æ¡£ï¼š80-100%ï¼ˆæŒç»­1-2ç§’ï¼‰

**å†…å­˜å ç”¨**ï¼š
- åŸºç¡€å†…å­˜ï¼š~50-80MB
- å¤§å‹æ–‡æ¡£é¢å¤–å¼€é”€ï¼š+30-50MBï¼ˆå¤§é‡Litæ¨¡æ¿å¯¹è±¡ç¼“å­˜ï¼‰

**å¸§ç‡ä¸‹é™**ï¼š
- ç†æƒ³ï¼š60 FPS
- å°æ–‡æ¡£ï¼š45-55 FPS
- ä¸­å‹æ–‡æ¡£ï¼š30-45 FPS
- å¤§å‹æ–‡æ¡£ï¼š15-30 FPSï¼ˆè¾“å…¥æ—¶ï¼‰

---

## ğŸ” å®Œæ•´è°ƒç”¨é“¾è·¯æ·±åº¦è¿½è¸ª

### æ¦‚è§ˆå›¾

```
ç”¨æˆ·æŒ‰é”®
  â†“
[Layer 1] Keyboard Event â†’ YJS Operation (0.5-2ms)
  â†“
[Layer 2] YJS â†’ Preact Signal ä¼ æ’­ (2-5ms)
  â†“
[Layer 3] InlineEditor å®Œæ•´é‡æ¸²æŸ“ (10-50ms) ğŸ”´
  â†“
[Layer 4] Text Signal â†’ Block Props Signal (1-3ms)
  â†“
[Layer 5] propsUpdated â†’ requestUpdate() (5-15ms) ğŸ”´
  â†“
[Layer 6] Block å®Œæ•´æ¸²æŸ“ (20-100ms) ğŸ”´
  â†“
[Layer 7] å­å—é€’å½’æ¸²æŸ“ (180-900ms) ğŸ”´ğŸ”´ğŸ”´
  â†“
DOM æ›´æ–°å®Œæˆ
```

---

### Layer 1: ç”¨æˆ·è¾“å…¥ â†’ YJS æ•°æ®å±‚

**æ—¶é—´æˆæœ¬**: 0.5-2ms âœ… (æ€§èƒ½æ­£å¸¸)

#### è°ƒç”¨è·¯å¾„

```typescript
// 1. é”®ç›˜äº‹ä»¶æ•è·
document.addEventListener('keydown', event => { ... })
  â†“
// 2. äº‹ä»¶å¤„ç†å™¨
// framework/std/src/inline/services/event.ts
EventService._bindHotkey()
  â†“
// 3. æ–‡æœ¬æ’å…¥
// framework/std/src/inline/inline-editor.ts:62
InlineEditor.insertText('a')
  â†“
// 4. æ–‡æœ¬æœåŠ¡å¤„ç†
// framework/std/src/inline/services/text.ts:62
InlineTextService.insertText(text: string)
  â†“
// 5. YJS åŸå­æ“ä½œ
yText.insert(index, 'a')  // Yjsçš„CRDTæ“ä½œ
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `framework/std/src/inline/services/text.ts`
```typescript
insertText = (
  inlineRange: InlineRange = this.editor.getInlineRange() ?? { index: 0, length: 0 },
  text: string,
  attributes: TextAttributes = {}
): InlineRange => {
  const yText = this.editor.yText;

  this.editor.transact(() => {
    // ğŸŸ¢ è¿™é‡Œå¾ˆå¿«ï¼ŒYJSçš„insertæ˜¯O(log n)å¤æ‚åº¦
    yText.insert(inlineRange.index, text, attributes);
  });

  return { index: inlineRange.index + text.length, length: 0 };
};
```

**æ€§èƒ½åˆ†æ**:
- YJSçš„CRDTæ“ä½œæ˜¯ä¼˜åŒ–è¿‡çš„ï¼Œæ€§èƒ½å¾ˆå¥½
- æ—¶é—´å¤æ‚åº¦ï¼šO(log n)
- è¿™ä¸€å±‚**ä¸æ˜¯æ€§èƒ½ç“¶é¢ˆ**

---

### Layer 2: YJS â†’ Preact Signal ä¼ æ’­

**æ—¶é—´æˆæœ¬**: 2-5ms âš ï¸ (å¯ä¼˜åŒ–ç©ºé—´)

#### è°ƒç”¨è·¯å¾„

```typescript
yText.insert()
  â†“
yText.observe() è§¦å‘  // YJSçš„observeå›è°ƒ
  â†“
// framework/store/src/reactive/text/text.ts:82
Text._yText.observe(event => {
  this._deltas$.value = this._yText.toDelta();  // ğŸ”´ éå†æ•´ä¸ªæ–‡æœ¬
  this.updated.next(event);
})
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `framework/store/src/reactive/text/text.ts`

```typescript
// ç¬¬82-96è¡Œ
constructor(yText: Y.Text) {
  this._yText = yText;
  const length = yText.length;

  this._length$ = signal(length);
  this._deltas$ = signal(this._yText.doc ? this._yText.toDelta() : []);

  // ğŸ”´ æ€§èƒ½é—®é¢˜1ï¼šæ¯æ¬¡YTextå˜åŒ–éƒ½è°ƒç”¨toDelta()
  this._yText.observe(event => {
    const isLocal = !event.transaction.origin || ...;

    // ğŸ”´ è¿™é‡Œä¼šéå†æ•´ä¸ªYTextï¼Œå¤æ‚åº¦O(n)
    this._deltas$.value = this._yText.toDelta();

    // æ›´æ–°é•¿åº¦
    this._length$.value = this._yText.length;

    // å‘å‡ºäº‹ä»¶ï¼ˆå¸¦æœ‰å®Œæ•´çš„YTextEventï¼‰
    this.updated.next({ event, isLocal });
  });
}
```

**æ€§èƒ½åˆ†æ**:

| æ“ä½œ | å¤æ‚åº¦ | 1000å­—ç¬¦è€—æ—¶ |
|-----|-------|-------------|
| `yText.toDelta()` | O(n) | ~2-3ms |
| Signalæ›´æ–° | O(1) | ~0.5ms |
| äº‹ä»¶å‘å‡º | O(è®¢é˜…è€…æ•°é‡) | ~0.5-1ms |

**é—®é¢˜**:
1. âŒ æ¯æ¬¡éƒ½è°ƒç”¨`toDelta()`ï¼Œå³ä½¿åªæ”¹å˜äº†ä¸€ä¸ªå­—ç¬¦
2. âŒ æ²¡æœ‰ä½¿ç”¨YJS eventä¸­çš„å¢é‡ä¿¡æ¯ï¼ˆ`event.delta`ï¼‰
3. âŒ Signalæ›´æ–°è§¦å‘æ‰€æœ‰è®¢é˜…è€…ï¼ˆå³ä½¿å†…å®¹æ²¡æœ‰å®é™…å˜åŒ–ï¼‰

**æ”¹è¿›å»ºè®®**:
```typescript
// âœ… åº”è¯¥è¿™æ ·ä¼˜åŒ–
this._yText.observe(event => {
  // ä½¿ç”¨YJSæä¾›çš„å¢é‡deltaï¼Œè€Œä¸æ˜¯é‡æ–°è®¡ç®—
  if (event.delta.length > 0) {
    // åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
    applyDeltaToSignal(this._deltas$, event.delta);
  }
});
```

---

### Layer 3: InlineEditor å®Œæ•´é‡æ¸²æŸ“ ğŸ”´ğŸ”´ğŸ”´

**æ—¶é—´æˆæœ¬**: 10-50ms (å–å†³äºæ–‡æ¡£é•¿åº¦)
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸»è¦æ€§èƒ½ç“¶é¢ˆä¹‹ä¸€

#### è°ƒç”¨è·¯å¾„

```typescript
Text.updated.next(event)
  â†“
// framework/std/src/inline/services/render.ts:13
RenderService._onYTextChange(event, transaction)
  â†“
this.editor.slots.textChange.next();
  â†“
this.render();  // ğŸ”´ å…³é”®é—®é¢˜ï¼å®Œæ•´é‡æ¸²æŸ“
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `framework/std/src/inline/services/render.ts`

```typescript
// ç¬¬13-63è¡Œï¼šYTextå˜åŒ–å¤„ç†å™¨
private readonly _onYTextChange = (
  _: Y.YTextEvent,
  transaction: Y.Transaction
) => {
  this.editor.slots.textChange.next();

  const yText = this.editor.yText;

  if (yText.toString().includes('\r')) {
    throw new BlockSuiteError(...);
  }

  // ğŸ”´ğŸ”´ğŸ”´ æ ¸å¿ƒé—®é¢˜ï¼šæ¯æ¬¡éƒ½å®Œæ•´é‡æ¸²æŸ“
  this.render();

  // ... å…‰æ ‡ä½ç½®åŒæ­¥
};

// ç¬¬82-163è¡Œï¼šrenderæ–¹æ³•å®ç°
render = () => {
  if (!this.editor.rootElement) {
    return;
  }

  this._rendering = true;

  const rootElement = this.editor.rootElement;

  // ğŸ”´ æ­¥éª¤1ï¼šè·å–æ‰€æœ‰deltasï¼ˆéå†æ•´ä¸ªæ–‡æ¡£ï¼‰
  const embedDeltas = this.editor.deltaService.embedDeltas;

  // ğŸ”´ æ­¥éª¤2ï¼šå°†deltasè½¬æ¢ä¸ºchunksï¼ˆæŒ‰è¡Œåˆ†ç»„ï¼‰
  const chunks = deltaInsertsToChunks(embedDeltas);

  let deltaIndex = 0;

  // ğŸ”´ æ­¥éª¤3ï¼šä¸ºæ¯ä¸€è¡Œåˆ›å»ºæ–°çš„Litæ¨¡æ¿
  const lines = chunks.map((chunk, lineIndex) => {
    if (lineIndex > 0) {
      deltaIndex += 1; // for '\n'
    }

    const lineStartOffset = deltaIndex;

    if (chunk.length > 0) {
      // ğŸ”´ æ­¥éª¤4ï¼šä¸ºæ¯ä¸ªdeltaåˆ›å»ºv-element
      const elements: VLine['elements'] = chunk.map(delta => {
        const startOffset = deltaIndex;
        deltaIndex += delta.insert.length;
        const endOffset = deltaIndex;

        // ğŸ”´ æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„æ¨¡æ¿å¯¹è±¡
        return [
          html`<v-element
            .inlineEditor=${this.editor}
            .delta=${{
              insert: delta.insert,
              attributes: this.editor.attributeService.normalizeAttributes(
                delta.attributes
              ),
            }}
            .startOffset=${startOffset}
            .endOffset=${endOffset}
            .lineIndex=${lineIndex}
          ></v-element>`,
          delta,
        ];
      });

      // ğŸ”´ åˆ›å»ºv-lineæ¨¡æ¿
      return html`<v-line
        .elements=${elements}
        .index=${lineIndex}
        .startOffset=${lineStartOffset}
        .endOffset=${deltaIndex}
      ></v-line>`;
    } else {
      return html`<v-line
        .elements=${[]}
        .index=${lineIndex}
        .startOffset=${lineStartOffset}
        .endOffset=${deltaIndex}
      ></v-line>`;
    }
  });

  try {
    // ğŸ”´ æ­¥éª¤5ï¼šä½¿ç”¨Litçš„repeatè¿›è¡ŒDOM diff
    render(
      repeat(
        lines.map((line, i) => ({ line, index: i })),
        entry => entry.index,  // keyå‡½æ•°
        entry => entry.line    // æ¸²æŸ“å‡½æ•°
      ),
      rootElement
    );
  } catch (error) {
    console.error('âŒ [Androidè°ƒè¯•] render å¤±è´¥:', error);
    this.editor.rerenderWholeEditor();
  }

  this.editor
    .waitForUpdate()
    .then(() => {
      this._rendering = false;
      this.editor.slots.renderComplete.next();
      this.editor.syncInlineRange();
    })
    .catch(console.error);
};
```

#### æ€§èƒ½åˆ†æè¯¦è§£

å‡è®¾ä¸€ä¸ªæ®µè½åŒ…å«**1000ä¸ªå­—ç¬¦**ï¼Œåˆ†æˆ**20è¡Œ**ï¼š

| æ­¥éª¤ | æ“ä½œ | æ•°é‡ | å•æ¬¡è€—æ—¶ | æ€»è€—æ—¶ |
|-----|------|------|---------|--------|
| 1 | `deltaService.embedDeltas` | éå†1000å­—ç¬¦ | ~1ms | 1ms |
| 2 | `deltaInsertsToChunks` | åˆ†ç»„å¤„ç† | ~1ms | 1ms |
| 3 | åˆ›å»ºv-lineæ¨¡æ¿ | 20è¡Œ | ~0.1ms | 2ms |
| 4 | åˆ›å»ºv-elementæ¨¡æ¿ | 1000ä¸ª | ~0.005ms | 5ms |
| 5 | Lit repeat diff | æ¯”è¾ƒ20è¡Œ | ~0.5ms | 10ms |
| 6 | DOMæ›´æ–° | æ›´æ–°å˜åŒ–èŠ‚ç‚¹ | ~20ms | 20ms |
| **æ€»è®¡** | | | | **39ms** |

**å¯¹è±¡åˆ›å»ºç»Ÿè®¡**ï¼ˆæ¯æ¬¡renderï¼‰ï¼š
```javascript
// å‡è®¾1000å­—ç¬¦ï¼Œ20è¡Œ
const objectsCreated = {
  lines: 20,                    // v-lineæ¨¡æ¿å¯¹è±¡
  elements: 1000,               // v-elementæ¨¡æ¿å¯¹è±¡
  deltaObjects: 1000,           // è§„èŒƒåŒ–åçš„deltaå¯¹è±¡
  litTemplateResults: 1020,     // Litçš„TemplateResultå¯¹è±¡
  repeatEntries: 20,            // repeatçš„entryå¯¹è±¡
};

// æ€»å…±ï¼šçº¦ 3060ä¸ªä¸´æ—¶å¯¹è±¡
// GCå‹åŠ›ï¼šæ¯æ¬¡è¾“å…¥è§¦å‘ä¸€æ¬¡Major GCçš„å¯èƒ½æ€§å¢åŠ 
```

**Lit Diff æˆæœ¬åˆ†æ**ï¼š

```typescript
// Litçš„repeatæŒ‡ä»¤ä¼šåšä»€ä¹ˆï¼š
repeat(
  items,          // 20è¡Œ
  keyFn,          // è°ƒç”¨20æ¬¡
  templateFn      // è°ƒç”¨20æ¬¡
)

// Litå†…éƒ¨ä¼šï¼š
// 1. ä¸ºæ¯ä¸ªitemè°ƒç”¨keyFnè·å–key
// 2. ä¸ä¸Šæ¬¡çš„keyåˆ—è¡¨å¯¹æ¯”ï¼ˆæ‰¾æ–°å¢ã€åˆ é™¤ã€ç§»åŠ¨ï¼‰
// 3. ä¸ºå˜åŒ–çš„itemè°ƒç”¨templateFn
// 4. å¯¹æ¯”æ–°æ—§TemplateResultï¼ˆå±æ€§diffï¼‰
// 5. æ›´æ–°å˜åŒ–çš„DOMå±æ€§

// å³ä½¿åªæ”¹å˜ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿä¼šï¼š
// - å¯¹æ¯”20ä¸ªv-lineçš„keyï¼ˆè™½ç„¶éƒ½ä¸€æ ·ï¼‰
// - å¯¹æ¯”æ‰€æœ‰v-elementçš„propsï¼ˆ.deltaå¯¹è±¡æ¯æ¬¡éƒ½æ˜¯æ–°çš„ï¼ï¼‰
// - è§¦å‘å¤šä¸ªDOM setAttribute
```

**é—®é¢˜ä¸¥é‡æ€§**:

1. âŒ **å…¨é‡æ¸²æŸ“**ï¼šæ¯æ¬¡è¾“å…¥éƒ½é‡æ–°åˆ›å»ºæ‰€æœ‰Litæ¨¡æ¿
2. âŒ **æ— å¢é‡æ›´æ–°**ï¼šæ²¡æœ‰åˆ©ç”¨YJS eventä¸­çš„deltaä¿¡æ¯å®šä½å˜åŒ–ä½ç½®
3. âŒ **å¯¹è±¡æ³›æ»¥**ï¼šæ¯æ¬¡åˆ›å»º3000+ä¸´æ—¶å¯¹è±¡ï¼ŒGCå‹åŠ›å¤§
4. âŒ **Diffæµªè´¹**ï¼šLitéœ€è¦å¯¹æ¯”æ‰€æœ‰VElementsï¼Œå³ä½¿99%æœªå˜åŒ–
5. âŒ **DOMæŠ–åŠ¨**ï¼šå³ä½¿å†…å®¹æœªå˜ï¼Œæ–°å¯¹è±¡ä¹Ÿä¼šè§¦å‘DOMå±æ€§æ›´æ–°

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… åº”è¯¥å®ç°å¢é‡æ¸²æŸ“
render = (changes?: YTextEvent) => {
  if (!changes) {
    // é¦–æ¬¡æ¸²æŸ“ï¼Œå…¨é‡
    this.fullRender();
    return;
  }

  // å¢é‡æ¸²æŸ“ï¼šåªæ›´æ–°å˜åŒ–çš„è¡Œ
  const changedLines = this.getChangedLinesFromDelta(changes.delta);
  changedLines.forEach(lineIndex => {
    this.updateLine(lineIndex);
  });
};
```

---

### Layer 4: Text Signal â†’ Block Props Signal

**æ—¶é—´æˆæœ¬**: 1-3ms âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ P2 - æ¬¡è¦é—®é¢˜

#### è°ƒç”¨è·¯å¾„

```typescript
Text._deltas$ Signalæ›´æ–°
  â†“
// framework/store/src/model/block/sync-controller.ts:141
effect(() => {
  const value = data.value;  // ç›‘å¬Signalå˜åŒ–
  this.model.props[key] = value;
})
  â†“
model.props.text$ Signalæ›´æ–°
  â†“
model.propsUpdated.next({ key: 'text' })
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `framework/store/src/model/block/sync-controller.ts`

```typescript
// ç¬¬129-228è¡Œï¼šåˆ›å»ºModelçš„ä»£ç†å¯¹è±¡
private _createModel(props: UnRecord) {
  const _mutex = this._mutex;
  const schema = this.schema.flavourSchemaMap.get(this.flavour);
  const model = schema.model.toModel?.() ?? new BlockModel<object>();

  // ğŸ”´ ä¸ºæ¯ä¸ªpropåˆ›å»ºSignalå’Œeffect
  const signalWithProps = Object.entries(props).reduce(
    (acc, [key, value]) => {
      // åˆ›å»ºSignal
      const data = signal(value);

      // ğŸ”´ åˆ›å»ºeffectç›‘å¬Signalå˜åŒ–
      const dispose = effect(() => {
        const value = data.value;
        if (!this.model) return;

        _mutex(() => {
          // å½“Signalå˜åŒ–æ—¶ï¼ŒåŒæ­¥æ›´æ–°model.props
          // @ts-expect-error allow magic props
          this.model.props[key] = value;
        });
      });

      // åœ¨modelåˆ é™¤æ—¶æ¸…ç†effect
      const subscription = model.deleted.subscribe(() => {
        subscription.unsubscribe();
        dispose();
      });

      return {
        ...acc,
        [`${key}$`]: data,    // text$
        [key]: value,         // text
      };
    },
    {} as Record<string, unknown>
  );

  // ... çœç•¥éƒ¨åˆ†ä»£ç 

  // ğŸ”´ åˆ›å»ºProxyæ‹¦æˆªå™¨
  const proxy = new Proxy(signalWithProps, {
    set: (target, p, value, receiver) => {
      if (
        !this._byPassProxy &&
        typeof p === 'string' &&
        model.keys.includes(p)
      ) {
        // ğŸ”´ å½“è®¾ç½®propsæ—¶ï¼Œæ›´æ–°YJS
        const yValue = native2Y(value);
        this.yBlock.set(`prop:${p}`, yValue);

        // æ›´æ–°Signal
        setValue(target, p, value);

        // åˆ›å»ºä»£ç†å¯¹è±¡
        const proxy = this._getPropsProxy(p, yValue);
        return Reflect.set(target, p, proxy, receiver);
      }

      return Reflect.set(target, p, value, receiver);
    },
  });

  model._props = proxy;

  // Signalæ›´æ–°è¾…åŠ©å‡½æ•°
  function setValue(target: UnRecord, p: string, value: unknown) {
    _mutex(() => {
      // @ts-expect-error allow magic props
      target[`${p}$`].value = value;  // ğŸ”´ è§¦å‘Signalæ›´æ–°
    });
  }

  return model;
}
```

**Signal â†’ propsUpdatedä¼ æ’­**:

**æ–‡ä»¶**: `framework/store/src/model/block/sync-controller.ts` (ç¬¬38-85è¡Œ)

```typescript
private readonly _observeYBlockChanges = () => {
  this.yBlock.observe(event => {
    event.keysChanged.forEach(key => {
      const type = event.changes.keys.get(key);
      if (!type) return;

      const isLocal = /* ... åˆ¤æ–­æ˜¯å¦æœ¬åœ°å˜æ›´ */;

      if (type.action === 'update' || type.action === 'add') {
        const value = this.yBlock.get(key);
        const keyName = key.replace('prop:', '');
        const proxy = this._getPropsProxy(keyName, value);

        this._byPassUpdate(() => {
          // æ›´æ–°model.props
          this.model.props[keyName] = proxy;

          // ğŸ”´ æ›´æ–°å¯¹åº”çš„Signal
          const signalKey = `${keyName}$`;
          this._mutex(() => {
            if (signalKey in this.model.props) {
              this.model.props[signalKey].value = y2Native(value);
            }
          });
        });

        // ğŸ”´ è§¦å‘onChangeå›è°ƒ
        this.onChange?.(keyName, isLocal);
        return;
      }
    });
  });
};
```

**onChangeå›è°ƒçš„è¿æ¥**:

**æ–‡ä»¶**: `framework/store/src/model/block/block.ts` (ç¬¬44-51è¡Œ)

```typescript
const onChange = !options.onChange
  ? undefined
  : (key: string, isLocal: boolean) => {
      if (!this._syncController || !this.model) {
        return;
      }
      // ğŸ”´ è°ƒç”¨Blockçš„onChangeï¼Œæœ€ç»ˆè§¦å‘propsUpdated
      options.onChange?.(this, key, isLocal);
    };
```

**Storeçš„onChangeå¤„ç†**:

**æ–‡ä»¶**: `framework/store/src/model/store/crud.ts`

```typescript
// åˆ›å»ºBlockæ—¶æ³¨å†Œçš„onChangeå›è°ƒ
const block = new Block(schema, yBlock, this, {
  onChange: (block, key, isLocal) => {
    // ğŸ”´ å‘å‡ºpropsUpdatedäº‹ä»¶
    block.model.propsUpdated.next({ key });

    // ğŸ”´ å‘å‡ºå…¨å±€blockUpdatedäº‹ä»¶
    this.slots.blockUpdated.next({
      type: 'update',
      id: block.id,
      flavour: block.flavour,
      props: { key },
      isLocal,
    });
  },
});
```

#### æ€§èƒ½åˆ†æ

**Signalä¼ æ’­é“¾è·¯**:
```
YBlockå˜åŒ–
  â†“ (YJS observe)
SyncController._observeYBlockChanges
  â†“ (æ›´æ–°Signal)
model.props.text$.value = newValue
  â†“ (effectè§¦å‘)
effectå›è°ƒæ‰§è¡Œ
  â†“ (è°ƒç”¨onChange)
Block.onChange
  â†“ (å‘å‡ºäº‹ä»¶)
model.propsUpdated.next({ key: 'text' })
  â†“ (è®¢é˜…è€…æ¥æ”¶)
BlockComponentæ”¶åˆ°é€šçŸ¥
```

**æ—¶é—´æ¶ˆè€—**:
- Signalæ›´æ–°ï¼š~0.5ms
- effectæ‰§è¡Œï¼š~0.5ms
- onChangeå›è°ƒï¼š~0.5ms
- propsUpdatedäº‹ä»¶å‘å‡ºï¼š~0.5-1ms
- **æ€»è®¡ï¼š2-2.5ms**

**é—®é¢˜**:
1. âš ï¸ **ä¼ æ’­é“¾è·¯è¿‡é•¿**ï¼šYJS â†’ Signal â†’ effect â†’ onChange â†’ propsUpdatedï¼ˆ5å±‚ï¼‰
2. âš ï¸ **ç¼ºå°‘å˜æ›´ä¿¡æ¯**ï¼špropsUpdatedåªæœ‰`{ key }`ï¼Œæ²¡æœ‰æ–°æ—§å€¼å¯¹æ¯”
3. âš ï¸ **æ— æ³•æ‰¹é‡æ›´æ–°**ï¼šæ¯ä¸ªpropå˜åŒ–éƒ½å•ç‹¬è§¦å‘äº‹ä»¶

---

### Layer 5: propsUpdated â†’ BlockComponent.requestUpdate() ğŸ”´ğŸ”´

**æ—¶é—´æˆæœ¬**: 5-15ms
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸»è¦æ€§èƒ½ç“¶é¢ˆä¹‹ä¸€

#### è°ƒç”¨è·¯å¾„

```typescript
model.propsUpdated.next({ key: 'text' })
  â†“
// framework/std/src/view/element/block-component.ts:229
BlockComponentè®¢é˜…å›è°ƒ
  â†“
this.requestUpdate()  // ğŸ”´ Litçš„æ›´æ–°è°ƒåº¦
  â†“
Litè°ƒåº¦å™¨ï¼šå°†ç»„ä»¶æ ‡è®°ä¸ºdirty
  â†“
ä¸‹ä¸€ä¸ªå¾®ä»»åŠ¡ï¼šæ‰§è¡Œupdateç”Ÿå‘½å‘¨æœŸ
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `framework/std/src/view/element/block-component.ts`

```typescript
// ç¬¬214-234è¡Œï¼šconnectedCallbackç”Ÿå‘½å‘¨æœŸ
override connectedCallback() {
  super.connectedCallback();

  // æ³¨å†Œåˆ°ViewStore
  this.std.view.setBlock(this);

  // ç›‘å¬blockåˆ é™¤äº‹ä»¶
  const disposable = this.std.store.slots.blockUpdated.subscribe(
    ({ type, id }) => {
      if (id === this.model.id && type === 'delete') {
        this.std.view.deleteBlock(this);
        disposable.unsubscribe();
      }
    }
  );
  this._disposables.add(disposable);

  // ğŸ”´ğŸ”´ğŸ”´ æ ¸å¿ƒé—®é¢˜ï¼šç›‘å¬æ‰€æœ‰propså˜åŒ–
  this._disposables.add(
    this.model.propsUpdated.subscribe(() => {
      // ğŸ”´ ä»»ä½•propå˜åŒ–éƒ½è§¦å‘å®Œæ•´ç»„ä»¶æ›´æ–°
      this.requestUpdate();
    })
  );
}
```

**Litçš„requestUpdateæµç¨‹**:

```typescript
// Litå†…éƒ¨å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
class LitElement {
  requestUpdate(name?: PropertyKey, oldValue?: unknown) {
    // æ ‡è®°ç»„ä»¶ä¸ºdirty
    this._hasRequested = true;

    // è°ƒåº¦æ›´æ–°ï¼ˆå¾®ä»»åŠ¡ï¼‰
    this.scheduleUpdate();
  }

  async scheduleUpdate() {
    // ç­‰å¾…å¾®ä»»åŠ¡
    await Promise.resolve();

    // æ‰§è¡Œæ›´æ–°
    this.performUpdate();
  }

  performUpdate() {
    // 1. willUpdateç”Ÿå‘½å‘¨æœŸ
    this.willUpdate(this._changedProperties);

    // 2. è°ƒç”¨render()è·å–æ–°æ¨¡æ¿
    const result = this.render();

    // 3. Lit diffç®—æ³•
    this._$litPart$.update(result);

    // 4. updatedç”Ÿå‘½å‘¨æœŸ
    this.updated(this._changedProperties);
  }
}
```

#### æ€§èƒ½åˆ†æ

**é—®é¢˜**:

1. âŒ **æ— æ³•åŒºåˆ†prop**ï¼š
```typescript
// å½“å‰å®ç°
this.model.propsUpdated.subscribe(() => {
  this.requestUpdate();  // ä¸çŸ¥é“æ˜¯å“ªä¸ªpropå˜äº†
});

// åº”è¯¥è¿™æ ·
this.model.propsUpdated.subscribe(({ key }) => {
  if (key === 'text') {
    // åªæ›´æ–°æ–‡æœ¬ç›¸å…³éƒ¨åˆ†
    this.updateTextOnly();
  } else if (key === 'collapsed') {
    // åªæ›´æ–°æŠ˜å çŠ¶æ€
    this.updateCollapsedState();
  }
});
```

2. âŒ **è§¦å‘å®Œæ•´é‡æ¸²æŸ“**ï¼šå³ä½¿åªæ˜¯æ–‡æœ¬å˜åŒ–ï¼Œä¹Ÿä¼šé‡æ–°æ¸²æŸ“ï¼š
   - Headingå›¾æ ‡
   - ToggleæŒ‰é’®
   - Placeholder
   - å­å—å®¹å™¨
   - æ‰€æœ‰å­å—ï¼ˆé€šè¿‡renderChildrenï¼‰

3. âŒ **æ— æ³•è·³è¿‡ä¸å¿…è¦çš„è®¡ç®—**ï¼š

**æ–‡ä»¶**: `yunke/blocks/paragraph/src/paragraph-block.ts`

```typescript
override renderBlock(): TemplateResult<1> {
  const { type$ } = this.model.props;
  const collapsed = this.model.props.collapsed;

  // ğŸ”´ æ¯æ¬¡renderéƒ½é‡æ–°è®¡ç®—ï¼ˆå³ä½¿typeå’Œcollapsedæ²¡å˜ï¼‰
  const collapsedSiblings = this.collapsedSiblings;

  // ğŸ”´ æ¯æ¬¡éƒ½ç”Ÿæˆæ–°çš„styleï¼ˆå³ä½¿å†…å®¹ç›¸åŒï¼‰
  let style = html``;
  if (this.model.props.type$.value.startsWith('h') && collapsed) {
    style = html`
      <style>
        ${collapsedSiblings.map(sibling =>
          unsafeHTML(`
            [data-block-id="${sibling.id}"] {
              display: none !important;
            }
          `)
        )}
      </style>
    `;
  }

  // ... å…¶ä»–æ¸²æŸ“é€»è¾‘
}
```

**collapsedSiblingsçš„è®¡ç®—æˆæœ¬**:

**æ–‡ä»¶**: `yunke/blocks/paragraph/src/paragraph-block.ts:74-76`

```typescript
get collapsedSiblings() {
  return calculateCollapsedSiblings(this.model);
}
```

**æ–‡ä»¶**: `yunke-shared/utils/model.ts`

```typescript
export function calculateCollapsedSiblings(model: BlockModel) {
  const parent = model.parent;
  if (!parent) return [];

  // ğŸ”´ éå†æ‰€æœ‰å…„å¼ŸèŠ‚ç‚¹
  const siblings = parent.children;
  const index = siblings.indexOf(model);

  // æ‰¾åˆ°å‰é¢æœ€è¿‘çš„heading
  let headingIndex = -1;
  for (let i = index - 1; i >= 0; i--) {
    if (siblings[i].props.type?.startsWith('h')) {
      headingIndex = i;
      break;
    }
  }

  if (headingIndex === -1) return [];

  const heading = siblings[headingIndex];
  if (!heading.props.collapsed) return [];

  // ğŸ”´ æ”¶é›†æ‰€æœ‰è¢«æŠ˜å çš„å…„å¼Ÿ
  const result = [];
  for (let i = headingIndex + 1; i < siblings.length; i++) {
    const sibling = siblings[i];
    if (sibling.props.type?.startsWith('h')) break;
    result.push(sibling);
  }

  return result;
}
```

**æ—¶é—´æ¶ˆè€—**ï¼ˆå‡è®¾10ä¸ªå…„å¼ŸèŠ‚ç‚¹ï¼‰:
- éå†å…„å¼ŸèŠ‚ç‚¹ï¼š~0.5ms
- ç”Ÿæˆstyleæ¨¡æ¿ï¼š~1ms
- **æ€»è®¡ï¼š1.5ms** ï¼ˆæ¯æ¬¡renderéƒ½æµªè´¹ï¼‰

---

### Layer 6: Block å®Œæ•´æ¸²æŸ“ ğŸ”´ğŸ”´

**æ—¶é—´æˆæœ¬**: 20-100ms
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ P0 - ä¸»è¦ç“¶é¢ˆ

#### è°ƒç”¨è·¯å¾„

```typescript
requestUpdate()
  â†“
Litè°ƒåº¦æ›´æ–°
  â†“
performUpdate()
  â†“
render()  // è°ƒç”¨BlockComponent.renderBlock()
  â†“
// yunke/blocks/paragraph/src/paragraph-block.ts:216
ParagraphBlockComponent.renderBlock()
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `yunke/blocks/paragraph/src/paragraph-block.ts` (ç¬¬216-326è¡Œ)

```typescript
override renderBlock(): TemplateResult<1> {
  const { type$ } = this.model.props;
  const collapsed = this.store.readonly
    ? this._readonlyCollapsed
    : this.model.props.collapsed;

  // ğŸ”´ é‡æ–°è®¡ç®—æŠ˜å çš„å…„å¼ŸèŠ‚ç‚¹
  const collapsedSiblings = this.collapsedSiblings;

  // ğŸ”´ åŠ¨æ€ç”Ÿæˆstyleæ ‡ç­¾
  let style = html``;
  if (this.model.props.type$.value.startsWith('h') && collapsed) {
    style = html`
      <style>
        ${collapsedSiblings.map(sibling =>
          unsafeHTML(`
            [data-block-id="${sibling.id}"] {
              display: none !important;
            }
          `)
        )}
      </style>
    `;
  }

  // ğŸ”´ æ¸²æŸ“å­å—å®¹å™¨ï¼ˆåŒ…å«æ‰€æœ‰å­å—ï¼‰
  const children = html`<div
    class="yunke-block-children-container"
    style=${styleMap({
      paddingLeft: `${BLOCK_CHILDREN_CONTAINER_PADDING_LEFT}px`,
      display: collapsed ? 'none' : undefined,
    })}
  >
    ${this.renderChildren(this.model)}  // ğŸ”´ğŸ”´ğŸ”´ é€’å½’æ¸²æŸ“æ‰€æœ‰å­å—
  </div>`;

  // ğŸ”´ è¿”å›å®Œæ•´æ¨¡æ¿
  return html`
    ${style}
    <style>
      .yunke-paragraph-block-container[data-has-collapsed-siblings='false']
        yunke-paragraph-heading-icon
        .heading-icon {
        transform: translateX(-48px);
      }
    </style>
    <div
      class="yunke-paragraph-block-container"
      data-has-collapsed-siblings="${collapsedSiblings.length > 0}"
    >
      <div
        class=${classMap({
          'yunke-paragraph-rich-text-wrapper': true,
          [type$.value]: true,
          [TOGGLE_BUTTON_PARENT_CLASS]: true,
        })}
      >
        ${/* ğŸ”´ Headingå›¾æ ‡ */
        this.model.props.type$.value.startsWith('h')
          ? html`
              <yunke-paragraph-heading-icon
                .model=${this.model}
              ></yunke-paragraph-heading-icon>
            `
          : nothing}
        ${/* ğŸ”´ ToggleæŒ‰é’® */
        this.model.props.type$.value.startsWith('h') &&
        collapsedSiblings.length > 0
          ? html`
              <blocksuite-toggle-button
                .collapsed=${collapsed}
                .updateCollapsed=${(value: boolean) => {
                  if (this.store.readonly) {
                    this._readonlyCollapsed = value;
                  } else {
                    this.store.captureSync();
                    this.store.updateBlock(this.model, {
                      collapsed: value,
                    });
                  }
                }}
              ></blocksuite-toggle-button>
            `
          : nothing}
        ${/* ğŸ”´ Rich-textç»„ä»¶ï¼ˆåŒ…å«InlineEditorï¼‰ */}
        <rich-text
          .yText=${this.model.props.text.yText}
          .inlineEventSource=${this.topContenteditableElement ?? nothing}
          .undoManager=${this.store.history.undoManager}
          .attributesSchema=${this.attributesSchema}
          .attributeRenderer=${this.attributeRenderer}
          .markdownMatches=${this.inlineManager?.markdownMatches}
          .embedChecker=${this.embedChecker}
          .readonly=${this.store.readonly}
          .inlineRangeProvider=${this._inlineRangeProvider}
          .enableClipboard=${false}
          .enableUndoRedo=${false}
          .verticalScrollContainerGetter=${() =>
            getViewportElement(this.host)}
        ></rich-text>
        ${/* ğŸ”´ Placeholder */
        this.inEdgelessText
          ? nothing
          : html`
              <div
                contenteditable="false"
                class=${classMap({
                  'yunke-paragraph-placeholder': true,
                  visible: this._displayPlaceholder.value,
                })}
              >
                ${this._placeholder}
              </div>
            `}
      </div>

      ${/* ğŸ”´ğŸ”´ğŸ”´ æ‰€æœ‰å­å— */
      children}
    </div>
  `;
}
```

#### æ€§èƒ½åˆ†æ

**æ¸²æŸ“çš„DOMç»“æ„**:
```html
<!-- æ¯ä¸ªæ®µè½å—çš„DOMç»“æ„ -->
<yunke-paragraph data-block-id="...">
  <style>...</style>  <!-- åŠ¨æ€ç”Ÿæˆ -->
  <style>...</style>  <!-- é™æ€æ ·å¼ -->

  <div class="yunke-paragraph-block-container">
    <div class="yunke-paragraph-rich-text-wrapper">
      <yunke-paragraph-heading-icon>...</yunke-paragraph-heading-icon>
      <blocksuite-toggle-button>...</blocksuite-toggle-button>
      <rich-text>
        <!-- InlineEditoræ¸²æŸ“çš„å†…å®¹ -->
        <v-line>
          <v-element>æ–‡</v-element>
          <v-element>å­—</v-element>
          ...
        </v-line>
      </rich-text>
      <div class="yunke-paragraph-placeholder">...</div>
    </div>

    <div class="yunke-block-children-container">
      <!-- ğŸ”´ é€’å½’ï¼šæ‰€æœ‰å­å— -->
      <yunke-paragraph>...</yunke-paragraph>
      <yunke-list>...</yunke-list>
      ...
    </div>
  </div>
</yunke-paragraph>
```

**Lit Diffæˆæœ¬**:

å‡è®¾ä¸€ä¸ªæ®µè½æœ‰ï¼š
- 1ä¸ªheadingå›¾æ ‡
- 1ä¸ªtoggleæŒ‰é’®
- 1ä¸ªrich-textï¼ˆå·²åœ¨Layer 3åˆ†æï¼‰
- 1ä¸ªplaceholder
- 3ä¸ªå­å—

```javascript
// Litéœ€è¦æ¯”è¾ƒçš„å±æ€§æ•°é‡
const propsToCompare = {
  headingIcon: 1,      // .model
  toggleButton: 2,     // .collapsed, .updateCollapsed
  richText: 10,        // 10+ä¸ªprops
  placeholder: 1,      // .visible
  children: 3,         // 3ä¸ªå­å—
};

// Litçš„diffæ“ä½œï¼š
// 1. å¯¹æ¯”classMapç»“æœ
// 2. å¯¹æ¯”styleMapç»“æœ
// 3. å¯¹æ¯”æ‰€æœ‰å­ç»„ä»¶çš„props
// 4. å†³å®šå“ªäº›DOMéœ€è¦æ›´æ–°

// å³ä½¿propsæ²¡å˜ï¼ŒLitä¹Ÿéœ€è¦ï¼š
// - è°ƒç”¨classMap() -> åˆ›å»ºæ–°å¯¹è±¡ -> å¯¹æ¯”
// - è°ƒç”¨styleMap() -> åˆ›å»ºæ–°å¯¹è±¡ -> å¯¹æ¯”
// - å¯¹æ¯”æ‰€æœ‰å­ç»„ä»¶å¼•ç”¨ï¼ˆå³ä½¿æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼‰
```

**æ—¶é—´æ¶ˆè€—**ï¼ˆå•ä¸ªæ®µè½å—ï¼‰:
- `collapsedSiblings`è®¡ç®—ï¼š~1-2ms
- ç”Ÿæˆstyleæ¨¡æ¿ï¼š~1ms
- åˆ›å»ºheading/toggleæ¨¡æ¿ï¼š~1ms
- åˆ›å»ºrich-textæ¨¡æ¿ï¼š~2ms
- åˆ›å»ºplaceholderæ¨¡æ¿ï¼š~0.5ms
- Lit diffï¼š~5-10ms
- DOMæ›´æ–°ï¼š~5-10ms
- **æ€»è®¡ï¼š15.5-26.5ms**

**é—®é¢˜**:
1. âŒ **æ— é€‰æ‹©æ€§æ¸²æŸ“**ï¼šæ–‡æœ¬å˜åŒ–ä¹Ÿé‡æ–°æ¸²æŸ“å›¾æ ‡ã€æŒ‰é’®
2. âŒ **é‡å¤è®¡ç®—**ï¼š`collapsedSiblings`æ¯æ¬¡éƒ½è®¡ç®—
3. âŒ **å¯¹è±¡æ³›æ»¥**ï¼šæ¯æ¬¡åˆ›å»ºæ–°çš„classMap/styleMapç»“æœ
4. âŒ **Lit diffæ— æ•ˆ**ï¼šå¤§éƒ¨åˆ†æ—¶å€™å†…å®¹æ²¡å˜ï¼Œä½†Litä»éœ€å¯¹æ¯”

---

### Layer 7: å­å—é€’å½’æ¸²æŸ“ ğŸ”´ğŸ”´ğŸ”´ğŸ”´

**æ—¶é—´æˆæœ¬**: 180-900ms
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ğŸ”´ğŸ”´ P0 - **æœ€ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆ**

#### è°ƒç”¨è·¯å¾„

```typescript
ParagraphBlock.renderBlock()
  â†“
this.renderChildren(this.model)
  â†“
// framework/std/src/view/element/lit-host.ts:81
EditorHost.renderChildren()
  â†“
repeat(model.children, child => this._renderModel(child))
  â†“
// ğŸ”´ é€’å½’ï¼šä¸ºæ¯ä¸ªå­å—è°ƒç”¨å…¶renderBlock()
ChildBlock.render() â†’ ChildBlock.renderBlock()
  â†“
// ğŸ”´ğŸ”´ å¦‚æœå­å—ä¹Ÿæœ‰å­å—ï¼Œç»§ç»­é€’å½’
ChildBlock.renderChildren()
  â†“
...ï¼ˆé€’å½’ç»§ç»­ï¼‰
```

#### ä»£ç è¯æ®

**æ–‡ä»¶**: `framework/std/src/view/element/lit-host.ts` (ç¬¬81-90è¡Œ)

```typescript
renderChildren = (
  model: BlockModel,
  filter?: (model: BlockModel) => boolean
): TemplateResult => {
  // ğŸ”´ ä½¿ç”¨Litçš„repeatéå†æ‰€æœ‰å­å—
  return html`${repeat(
    model.children.filter(filter ?? (() => true)),
    child => child.id,  // keyå‡½æ•°
    child => this._renderModel(child)  // ğŸ”´ ä¸ºæ¯ä¸ªå­å—è°ƒç”¨_renderModel
  )}`;
};

// ç¬¬47-79è¡Œï¼š_renderModelå®ç°
private readonly _renderModel = (model: BlockModel): TemplateResult => {
  const { flavour } = model;
  const block = this.store.getBlock(model.id);

  if (!block || block.blockViewType === 'hidden') {
    return html`${nothing}`;
  }

  const schema = this.store.schema.flavourSchemaMap.get(flavour);
  const view = this.std.getView(flavour);

  if (!schema || !view) {
    console.warn(`Cannot find render flavour ${flavour}.`);
    return html`${nothing}`;
  }

  // è·å–widgets
  const widgetViews = this.std.provider.getAll(WidgetViewIdentifier);
  const widgets = Array.from(widgetViews.entries()).reduce(
    (mapping, [key, tag]) => {
      const [widgetFlavour, id] = key.split('|');
      if (widgetFlavour === flavour) {
        const template = html`<${tag} ${unsafeStatic(WIDGET_ID_ATTR)}=${id}></${tag}>`;
        mapping[id] = template;
      }
      return mapping;
    },
    {} as Record<string, TemplateResult>
  );

  // ğŸ”´ åˆ›å»ºBlockComponentæ ‡ç­¾ï¼ˆè§¦å‘ç»„ä»¶æ¸²æŸ“ï¼‰
  const tag = typeof view === 'function' ? view(model) : view;
  return html`<${tag}
    ${unsafeStatic(BLOCK_ID_ATTR)}=${model.id}
    .widgets=${widgets}
    .viewType=${block.blockViewType}
  ></${tag}>`;
};
```

**BlockComponentçš„renderæµç¨‹**:

**æ–‡ä»¶**: `framework/std/src/view/element/block-component.ts` (ç¬¬242-247è¡Œ)

```typescript
override render() {
  // ğŸ”´ ä¾æ¬¡è°ƒç”¨æ¸²æŸ“å™¨é“¾
  return this._renderers.reduce(
    (acc, cur) => cur.call(this, acc),
    nothing as unknown
  );
}

// ç¬¬285-289è¡Œï¼šæ¸²æŸ“å™¨é“¾
@state()
protected accessor _renderers: Array<(content: unknown) => unknown> = [
  this.renderBlock,          // ğŸ”´ ç¬¬1æ­¥ï¼šè°ƒç”¨å…·ä½“Blockçš„renderBlock()
  this._renderMismatchBlock, // ç¬¬2æ­¥ï¼šç‰ˆæœ¬æ£€æŸ¥
  this._renderViewType,      // ç¬¬3æ­¥ï¼šæ ¹æ®viewTypeå†³å®šæ˜¯å¦æ¸²æŸ“
];
```

#### æ€§èƒ½åˆ†æ

**é€’å½’æ·±åº¦ç¤ºä¾‹**:

```
æ–‡æ¡£ç»“æ„ï¼š
â”œâ”€ Paragraph 1 (heading)
â”‚  â”œâ”€ List Item 1.1
â”‚  â”‚  â”œâ”€ Paragraph 1.1.1
â”‚  â”‚  â””â”€ Paragraph 1.1.2
â”‚  â”œâ”€ List Item 1.2
â”‚  â””â”€ List Item 1.3
â”‚     â””â”€ Code Block 1.3.1
â”œâ”€ Paragraph 2
â”‚  â””â”€ Callout 2.1
â”‚     â””â”€ Paragraph 2.1.1
â””â”€ Paragraph 3

æ¸²æŸ“è°ƒç”¨æ¬¡æ•°ï¼š
- Level 0ï¼ˆæ ¹ï¼‰: Paragraph 1 â†’ renderChildren
- Level 1: List Item 1.1, 1.2, 1.3 â†’ å„è‡ªrenderChildren
- Level 2: Paragraph 1.1.1, 1.1.2, Code Block 1.3.1 â†’ æ¸²æŸ“
- Level 0: Paragraph 2 â†’ renderChildren
- Level 1: Callout 2.1 â†’ renderChildren
- Level 2: Paragraph 2.1.1 â†’ æ¸²æŸ“
- Level 0: Paragraph 3 â†’ æ¸²æŸ“

æ€»æ¸²æŸ“æ¬¡æ•°ï¼š11æ¬¡å®Œæ•´çš„renderBlock()è°ƒç”¨
```

**æ—¶é—´æ¶ˆè€—è®¡ç®—**ï¼ˆå‡è®¾æ¯ä¸ªå—25msï¼‰:
```
11ä¸ªå— Ã— 25ms = 275ms
```

**æ›´ç³Ÿç³•çš„æƒ…å†µ**ï¼ˆæ·±åº¦åµŒå¥—ï¼‰:
```
æ–‡æ¡£ç»“æ„ï¼ˆ3å±‚åµŒå¥—ï¼Œæ¯å±‚3ä¸ªèŠ‚ç‚¹ï¼‰ï¼š
â”œâ”€ Block 1
â”‚  â”œâ”€ Block 1.1
â”‚  â”‚  â”œâ”€ Block 1.1.1
â”‚  â”‚  â”œâ”€ Block 1.1.2
â”‚  â”‚  â””â”€ Block 1.1.3
â”‚  â”œâ”€ Block 1.2
â”‚  â”‚  â”œâ”€ Block 1.2.1
â”‚  â”‚  â”œâ”€ Block 1.2.2
â”‚  â”‚  â””â”€ Block 1.2.3
â”‚  â””â”€ Block 1.3
â”‚     â”œâ”€ Block 1.3.1
â”‚     â”œâ”€ Block 1.3.2
â”‚     â””â”€ Block 1.3.3
...ï¼ˆåŒæ ·ç»“æ„çš„Block 2å’ŒBlock 3ï¼‰

æ€»å—æ•°ï¼š1 + 3 + 9 + 3 + 9 + 3 + 9 = 37ä¸ªå—
æ€»è€—æ—¶ï¼š37 Ã— 25ms = 925ms
```

**repeatçš„æ€§èƒ½å½±å“**:

```typescript
// Litçš„repeatä¼šåšä»€ä¹ˆï¼š
repeat(
  model.children,      // å‡è®¾3ä¸ªå­å—
  child => child.id,   // ä¸ºæ¯ä¸ªå­å—è°ƒç”¨keyå‡½æ•°
  child => this._renderModel(child)  // ä¸ºæ¯ä¸ªå­å—è°ƒç”¨æ¸²æŸ“å‡½æ•°
)

// Litå†…éƒ¨æ“ä½œï¼š
// 1. éå†æ–°itemsï¼Œè·å–æ‰€æœ‰key
// 2. ä¸æ—§çš„keyåˆ—è¡¨å¯¹æ¯”
// 3. æ‰¾å‡ºï¼šæ–°å¢ã€åˆ é™¤ã€ç§»åŠ¨ã€æ›´æ–°çš„items
// 4. å¯¹äº"æ›´æ–°"çš„itemsï¼Œè°ƒç”¨æ¸²æŸ“å‡½æ•°è·å–æ–°æ¨¡æ¿
// 5. å¯¹æ¯”æ–°æ—§æ¨¡æ¿çš„TemplateResult
// 6. æ›´æ–°å˜åŒ–çš„DOM

// ğŸ”´ é—®é¢˜ï¼šå³ä½¿å­å—å†…å®¹æ²¡å˜ï¼Œrepeatä¹Ÿä¼šï¼š
// - è°ƒç”¨3æ¬¡keyå‡½æ•°ï¼ˆè™½ç„¶å¾ˆå¿«ï¼‰
// - è°ƒç”¨3æ¬¡_renderModelï¼ˆåˆ›å»ºæ–°æ¨¡æ¿å¯¹è±¡ï¼‰
// - å¯¹æ¯”3ä¸ªTemplateResultï¼ˆæ£€æŸ¥propsæ˜¯å¦ç›¸åŒï¼‰
// - å› ä¸ºæ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„.widgetså¯¹è±¡ï¼ŒLitè®¤ä¸ºpropså˜äº†
// - è§¦å‘å­å—ç»„ä»¶çš„updateç”Ÿå‘½å‘¨æœŸ
```

**ä¸ºä»€ä¹ˆå­å—ä¹Ÿä¼šæ›´æ–°**ï¼Ÿ

```typescript
// _renderModelåˆ›å»ºçš„æ¨¡æ¿ï¼š
html`<yunke-paragraph
  ${unsafeStatic(BLOCK_ID_ATTR)}=${model.id}
  .widgets=${widgets}  // ğŸ”´ æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡ï¼
  .viewType=${block.blockViewType}
></yunke-paragraph>`;

// widgetså¯¹è±¡æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºï¼š
const widgets = Array.from(widgetViews.entries()).reduce(...);

// Litçš„diffé€»è¾‘ï¼š
if (oldWidgets !== newWidgets) {  // ğŸ”´ å¼•ç”¨ä¸åŒï¼
  // æ ‡è®°å±æ€§å·²å˜åŒ–
  component._changedProperties.set('widgets', oldWidgets);
  // è§¦å‘æ›´æ–°
  component.requestUpdate('widgets', oldWidgets);
}
```

**ç»“æœ**ï¼š
å³ä½¿çˆ¶å—åªæ˜¯æ–‡æœ¬å†…å®¹å˜åŒ–ï¼Œä¹Ÿä¼šï¼š
1. é‡æ–°æ‰§è¡Œ`renderChildren()`
2. ä¸ºæ¯ä¸ªå­å—è°ƒç”¨`_renderModel()`
3. åˆ›å»ºæ–°çš„widgetså¯¹è±¡
4. è§¦å‘å­å—çš„`requestUpdate()`
5. å­å—é‡æ–°æ‰§è¡Œ`renderBlock()`
6. å­å—çš„å­å—ä¹Ÿé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼ˆé€’å½’ï¼‰

**æ—¶é—´æ¶ˆè€—æ±‡æ€»**ï¼ˆ37ä¸ªå—çš„ç¤ºä¾‹ï¼‰:

| å±‚çº§ | å—æ•°é‡ | å•å—è€—æ—¶ | æ€»è€—æ—¶ |
|------|--------|---------|--------|
| Level 0 | 3 | 30ms | 90ms |
| Level 1 | 9 | 25ms | 225ms |
| Level 2 | 27 | 20ms | 540ms |
| **æ€»è®¡** | **39** | | **855ms** |

**é—®é¢˜ä¸¥é‡æ€§**:

1. âŒ **æŒ‡æ•°çº§æ€§èƒ½ä¸‹é™**ï¼šåµŒå¥—è¶Šæ·±ï¼Œæ€§èƒ½è¶Šå·®
2. âŒ **æ— å¿…è¦çš„æ¸²æŸ“**ï¼šå³ä½¿å­å—å†…å®¹å®Œå…¨æ²¡å˜ï¼Œä¹Ÿå®Œæ•´æ¸²æŸ“
3. âŒ **Lit diffæµªè´¹**ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°widgetså¯¹è±¡å¯¼è‡´diffå¤±æ•ˆ
4. âŒ **æ— æ¸²æŸ“è¾¹ç•Œ**ï¼šçˆ¶å—æ›´æ–°æ— æ¡ä»¶ä¼ æ’­åˆ°æ‰€æœ‰åä»£

---

## ğŸ¯ æ€§èƒ½ç“¶é¢ˆçƒ­ç‚¹æ±‡æ€»

### çƒ­ç‚¹æ’åï¼ˆæŒ‰å½±å“ç¨‹åº¦ï¼‰

#### ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ P0-Criticalï¼šå­å—é€’å½’æ¸²æŸ“

**ä½ç½®**: `framework/std/src/view/element/lit-host.ts:81-90`

**è€—æ—¶**: 180-900msï¼ˆå–å†³äºåµŒå¥—æ·±åº¦ï¼‰

**å½±å“**:
- å æ€»å»¶è¿Ÿçš„**60-85%**
- åµŒå¥—3å±‚å¯å¯¼è‡´**37æ¬¡**å®Œæ•´æ¸²æŸ“
- æ¯å¢åŠ ä¸€å±‚åµŒå¥—ï¼Œæ€§èƒ½ä¸‹é™**3å€**

**æ ¹æœ¬åŸå› **:
```typescript
// 1. æ¯æ¬¡çˆ¶å—æ›´æ–°éƒ½è°ƒç”¨renderChildren
// 2. renderChildrenä½¿ç”¨repeatéå†æ‰€æœ‰å­å—
// 3. ä¸ºæ¯ä¸ªå­å—åˆ›å»ºæ–°çš„æ¨¡æ¿å¯¹è±¡ï¼ˆ.widgetsæ¯æ¬¡éƒ½æ–°å»ºï¼‰
// 4. Litè®¤ä¸ºpropså˜åŒ–ï¼Œè§¦å‘å­å—æ›´æ–°
// 5. å­å—é‡æ–°renderBlockï¼Œåˆè°ƒç”¨renderChildren
// 6. é€’å½’ä¼ æ’­åˆ°æ‰€æœ‰åä»£
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨Litçš„cacheæŒ‡ä»¤ç¼“å­˜å­å—
import { cache } from 'lit/directives/cache.js';

renderChildren = (model) => {
  return html`${repeat(
    model.children,
    child => child.id,
    child => cache(child.id, () => this._renderModel(child))  // ç¼“å­˜
  )}`;
};

// âœ… æ–¹æ¡ˆ2ï¼šå­å—ä½¿ç”¨shouldUpdateç²¾ç¡®æ§åˆ¶
class ParagraphBlock extends BlockComponent {
  override shouldUpdate(changedProps: PropertyKeys<this>): boolean {
    // åªæœ‰ç‰¹å®špropså˜åŒ–æ‰æ›´æ–°
    return changedProps.has('model') ||
           changedProps.has('viewType');
    // widgetså˜åŒ–ä¸è§¦å‘æ›´æ–°
  }
}

// âœ… æ–¹æ¡ˆ3ï¼šä½¿ç”¨memoç¼“å­˜widgetså¯¹è±¡
private _widgetsCache = new WeakMap();
private _getWidgets(flavour: string) {
  if (!this._widgetsCache.has(flavour)) {
    const widgets = this._computeWidgets(flavour);
    this._widgetsCache.set(flavour, widgets);
  }
  return this._widgetsCache.get(flavour);
}
```

---

#### ğŸ”¥ğŸ”¥ğŸ”¥ P0-Highï¼šInlineEditorå®Œæ•´é‡æ¸²æŸ“

**ä½ç½®**: `framework/std/src/inline/services/render.ts:82-163`

**è€—æ—¶**: 10-50msï¼ˆå–å†³äºæ–‡æ¡£é•¿åº¦ï¼‰

**å½±å“**:
- å æ€»å»¶è¿Ÿçš„**10-30%**
- 1000å­—ç¬¦æ–‡æ¡£éœ€è¦åˆ›å»º**3000+ä¸´æ—¶å¯¹è±¡**
- è§¦å‘**å®Œæ•´çš„Lit DOM diff**

**æ ¹æœ¬åŸå› **:
```typescript
// æ¯æ¬¡YTextå˜åŒ–éƒ½ï¼š
// 1. è°ƒç”¨yText.toDelta()éå†æ•´ä¸ªæ–‡æ¡£ï¼ˆO(n)ï¼‰
// 2. å°†deltasè½¬æ¢ä¸ºchunksï¼ˆO(n)ï¼‰
// 3. ä¸ºæ¯è¡Œã€æ¯ä¸ªå­—ç¬¦åˆ›å»ºæ–°çš„Litæ¨¡æ¿å¯¹è±¡
// 4. Lit diffæ‰€æœ‰VLineså’ŒVElements
// 5. æ›´æ–°å˜åŒ–çš„DOMèŠ‚ç‚¹
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… æ–¹æ¡ˆ1ï¼šå¢é‡æ¸²æŸ“
render = (yTextEvent?: Y.YTextEvent) => {
  if (!yTextEvent) {
    this.fullRender();
    return;
  }

  // ä»YText eventè·å–å˜åŒ–ä¿¡æ¯
  const changes = this.analyzeChanges(yTextEvent.delta);

  // åªæ›´æ–°å˜åŒ–çš„è¡Œ
  changes.affectedLines.forEach(lineIndex => {
    this.updateLine(lineIndex);
  });
};

// âœ… æ–¹æ¡ˆ2ï¼šè™šæ‹Ÿæ»šåŠ¨ï¼ˆåªæ¸²æŸ“å¯è§å†…å®¹ï¼‰
render = () => {
  const visibleRange = this.getVisibleRange();
  const lines = this.getLines(visibleRange.start, visibleRange.end);

  // åªæ¸²æŸ“å¯è§çš„20-30è¡Œ
  render(repeat(lines, ...), this.rootElement);
};

// âœ… æ–¹æ¡ˆ3ï¼šç¼“å­˜ä¸å˜çš„VElements
private _elementsCache = new Map();
private _getVElement(delta, offset) {
  const key = `${delta.insert}-${offset}`;
  if (!this._elementsCache.has(key)) {
    this._elementsCache.set(key, this._createVElement(delta, offset));
  }
  return this._elementsCache.get(key);
}
```

---

#### ğŸ”¥ğŸ”¥ P0-Mediumï¼šBlock Propsç²—ç²’åº¦æ›´æ–°

**ä½ç½®**: `framework/std/src/view/element/block-component.ts:229-234`

**è€—æ—¶**: 5-15ms

**å½±å“**:
- å æ€»å»¶è¿Ÿçš„**5-10%**
- è§¦å‘ä¸å¿…è¦çš„æ¸²æŸ“ï¼ˆæ–‡æœ¬å˜åŒ–ä¹Ÿé‡ç»˜å›¾æ ‡ï¼‰
- æ— æ³•åšå±€éƒ¨æ›´æ–°ä¼˜åŒ–

**æ ¹æœ¬åŸå› **:
```typescript
// propsUpdatedæ²¡æœ‰åŒºåˆ†å“ªä¸ªpropå˜åŒ–
this.model.propsUpdated.subscribe(() => {
  this.requestUpdate();  // æ•´ä¸ªç»„ä»¶æ ‡è®°ä¸ºdirty
});
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… æ–¹æ¡ˆ1ï¼šåŒºåˆ†propç±»å‹
this.model.propsUpdated.subscribe(({ key }) => {
  if (key === 'text') {
    // æ–‡æœ¬å˜åŒ–ï¼Œåªæ›´æ–°rich-textéƒ¨åˆ†
    this._richTextElement?.requestUpdate();
  } else if (key === 'collapsed') {
    // æŠ˜å çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°toggleå’Œchildren
    this.requestUpdate();
  } else if (key === 'type') {
    // ç±»å‹å˜åŒ–ï¼Œå®Œæ•´æ›´æ–°
    this.requestUpdate();
  }
  // å…¶ä»–propå˜åŒ–å¯èƒ½ä¸éœ€è¦æ›´æ–°UI
});

// âœ… æ–¹æ¡ˆ2ï¼šæ‹†åˆ†ç»„ä»¶
class ParagraphBlock extends BlockComponent {
  override render() {
    return html`
      <paragraph-header
        .type=${this.model.props.type}
        .collapsed=${this.model.props.collapsed}
      ></paragraph-header>

      <paragraph-content
        .text=${this.model.props.text}
      ></paragraph-content>

      <paragraph-children
        .model=${this.model}
        .collapsed=${this.model.props.collapsed}
      ></paragraph-children>
    `;
  }
}
```

---

#### ğŸ”¥ P1ï¼šText Signalçš„toDelta()è°ƒç”¨

**ä½ç½®**: `framework/store/src/reactive/text/text.ts:82`

**è€—æ—¶**: 2-5ms

**å½±å“**:
- å æ€»å»¶è¿Ÿçš„**2-5%**
- æ¯æ¬¡è¾“å…¥éƒ½éå†æ•´ä¸ªæ–‡æœ¬

**æ ¹æœ¬åŸå› **:
```typescript
this._yText.observe(event => {
  // ğŸ”´ æ¯æ¬¡éƒ½è°ƒç”¨toDelta()é‡æ–°éå†
  this._deltas$.value = this._yText.toDelta();
});
```

**æ”¹è¿›æ–¹æ¡ˆ**:
```typescript
// âœ… ä½¿ç”¨YJS eventçš„å¢é‡delta
this._yText.observe(event => {
  // event.deltaåŒ…å«å¢é‡å˜åŒ–ä¿¡æ¯
  // [{ retain: 10 }, { insert: 'a' }]

  // åº”ç”¨å¢é‡åˆ°ç°æœ‰deltas
  this._deltas$.value = applyDelta(this._deltas$.peek(), event.delta);
});
```

---

## ğŸ“ˆ é‡åŒ–æ•°æ®æ€»ç»“

### å•æ¬¡æŒ‰é”®æ€»æ—¶é—´æˆæœ¬ï¼ˆ1000å­—ç¬¦æ–‡æ¡£ï¼Œ3å±‚åµŒå¥—ï¼‰

| å±‚çº§ | æ“ä½œ | è€—æ—¶ | å æ¯” | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| 1 | ç”¨æˆ·è¾“å…¥ â†’ YJS | 0.5-2ms | <1% | âœ… æ­£å¸¸ |
| 2 | YJS â†’ Signal | 2-5ms | 2-3% | ğŸŸ¡ P1 |
| 3 | InlineEditoré‡æ¸²æŸ“ | 10-50ms | 10-30% | ğŸ”´ P0 |
| 4 | Text â†’ Props Signal | 1-3ms | 1-2% | ğŸŸ¢ å¯æ¥å— |
| 5 | propsUpdated â†’ requestUpdate | 5-15ms | 5-10% | ğŸ”´ P0 |
| 6 | Blockå®Œæ•´æ¸²æŸ“ | 20-100ms | 15-25% | ğŸ”´ P0 |
| 7 | å­å—é€’å½’æ¸²æŸ“ | 180-900ms | 60-85% | ğŸ”´ğŸ”´ P0 |
| **æ€»è®¡** | | **218.5-1075ms** | **100%** | |

### é—®é¢˜åˆ†å¸ƒ

```
æ€§èƒ½ç“¶é¢ˆå æ¯”ï¼š

å­å—é€’å½’æ¸²æŸ“         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 70%
InlineEditoré‡æ¸²æŸ“   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 15%
Blockå®Œæ•´æ¸²æŸ“        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 10%
å…¶ä»–                 â–ˆâ–ˆ 5%
```

### å¯¹è±¡åˆ›å»ºç»Ÿè®¡ï¼ˆå•æ¬¡è¾“å…¥ï¼‰

```javascript
const objectsPerKeystroke = {
  // InlineEditorå±‚
  vLineTemplates: 20,
  vElementTemplates: 1000,
  deltaObjects: 1000,
  litTemplateResults: 1020,

  // Blockæ¸²æŸ“å±‚
  blockTemplates: 37,  // å‡è®¾37ä¸ªå—
  classMapResults: 37,
  styleMapResults: 37,
  widgetsObjects: 37,

  // æ€»è®¡
  total: 2188
};

// GCå‹åŠ›ï¼šæ¯10æ¬¡æŒ‰é”®çº¦22000ä¸ªä¸´æ—¶å¯¹è±¡
// å¯èƒ½è§¦å‘Minor GCï¼šæ¯5-10æ¬¡æŒ‰é”®
// å¯èƒ½è§¦å‘Major GCï¼šæ¯50-100æ¬¡æŒ‰é”®
```

---

## ğŸ—ï¸ æ¶æ„é—®é¢˜æ·±åº¦å‰–æ

### æ ¸å¿ƒæ¶æ„ç¼ºé™·

#### 1. å“åº”å¼ç³»ç»Ÿè®¾è®¡ä¸å½“

**å½“å‰æ¶æ„**:
```
YJS (CRDT) â†’ Signal (ç²—ç²’åº¦) â†’ Component (å…¨é‡æ›´æ–°)
```

**é—®é¢˜**:
- âœ— Signalåªä¼ é€’"æŸä¸ªpropå˜äº†"ï¼Œæ²¡æœ‰"å˜åŒ–çš„å…·ä½“å†…å®¹"
- âœ— æ— æ³•åšå¢é‡æ›´æ–°å’Œdiffä¼˜åŒ–
- âœ— æ¯å±‚éƒ½æ˜¯å…¨é‡é€šçŸ¥

**åº”æœ‰æ¶æ„**:
```
YJS (CRDT) â†’ Change Event (å¢é‡) â†’ Virtual DOM Diff â†’ Minimal DOM Update
```

**æ”¹è¿›å»ºè®®**:
```typescript
// å½“å‰
model.propsUpdated.next({ key: 'text' });

// åº”è¯¥
model.propsUpdated.next({
  key: 'text',
  change: {
    type: 'text-insert',
    index: 10,
    content: 'a',
    oldLength: 100,
    newLength: 101
  }
});
```

---

#### 2. æ¸²æŸ“ç²’åº¦è¿‡ç²—

**å½“å‰æ¶æ„**:
```
ä¸€ä¸ªBlockComponent = æ•´ä¸ªå—çš„å®Œæ•´æ¸²æŸ“
  â”œâ”€ Headingå›¾æ ‡
  â”œâ”€ ToggleæŒ‰é’®
  â”œâ”€ Rich-text
  â”œâ”€ Placeholder
  â””â”€ æ‰€æœ‰å­å—
```

**é—®é¢˜**:
- âœ— ä»»ä½•propå˜åŒ–éƒ½é‡æ–°æ¸²æŸ“æ•´ä¸ªç»„ä»¶
- âœ— æ— æ³•åšå±€éƒ¨æ›´æ–°
- âœ— Litçš„diffèŒƒå›´è¿‡å¤§

**åº”æœ‰æ¶æ„**:
```
ä¸€ä¸ªBlockComponent = å¤šä¸ªç‹¬ç«‹å­ç»„ä»¶
  â”œâ”€ BlockHeader (type, collapsed)
  â”œâ”€ BlockContent (text)
  â”œâ”€ BlockFooter (placeholder)
  â””â”€ BlockChildren (children)

æ¯ä¸ªå­ç»„ä»¶ç‹¬ç«‹æ›´æ–°
```

**æ”¹è¿›å»ºè®®**:
```typescript
// æ‹†åˆ†ç»„ä»¶ï¼Œå‡å°æ›´æ–°èŒƒå›´
class ParagraphBlock extends BlockComponent {
  override render() {
    return html`
      <block-header
        .type=${this.model.props.type$}
        .collapsed=${this.model.props.collapsed$}
      ></block-header>

      <block-content
        .text=${this.model.props.text}
      ></block-content>

      ${this.model.props.collapsed ? nothing : html`
        <block-children
          .model=${this.model}
        ></block-children>
      `}
    `;
  }
}
```

---

#### 3. ç¼ºå°‘æ¸²æŸ“ä¼˜åŒ–æœºåˆ¶

**ç¼ºå¤±çš„ä¼˜åŒ–**:

1. **è™šæ‹Ÿæ»šåŠ¨**
   - å½“å‰ï¼šæ‰€æœ‰å—éƒ½åœ¨DOMä¸­
   - åº”è¯¥ï¼šåªæ¸²æŸ“å¯è§åŒºåŸŸçš„å—

2. **æ¸²æŸ“ç¼“å­˜**
   - å½“å‰ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°æ¨¡æ¿å¯¹è±¡
   - åº”è¯¥ï¼šç¼“å­˜ä¸å˜çš„éƒ¨åˆ†

3. **shouldUpdateç²¾ç¡®æ§åˆ¶**
   - å½“å‰ï¼šä¾èµ–Litçš„é»˜è®¤diff
   - åº”è¯¥ï¼šè‡ªå®šä¹‰shouldUpdateè·³è¿‡ä¸å¿…è¦çš„æ›´æ–°

4. **requestIdleCallbackå¼‚æ­¥æ¸²æŸ“**
   - å½“å‰ï¼šåŒæ­¥æ¸²æŸ“ï¼Œé˜»å¡ä¸»çº¿ç¨‹
   - åº”è¯¥ï¼šåˆ©ç”¨ç©ºé—²æ—¶é—´æ¸²æŸ“

---

#### 4. Litæ¡†æ¶çš„è¯¯ç”¨

**Litçš„è®¾è®¡ç›®æ ‡**:
- å°å‹ã€ç‹¬ç«‹çš„Web Components
- ç®€å•çš„å±æ€§ç»‘å®š
- è½»é‡çº§çš„diff

**BlockSuiteçš„ä½¿ç”¨åœºæ™¯**:
- å¤§å‹ã€åµŒå¥—çš„ç»„ä»¶æ ‘
- å¤æ‚çš„çŠ¶æ€ç®¡ç†
- é¢‘ç¹çš„æ›´æ–°

**ä¸åŒ¹é…ç‚¹**:

1. **repeatæŒ‡ä»¤çš„æ€§èƒ½é—®é¢˜**:
```typescript
// Litçš„repeatæ¯æ¬¡éƒ½ï¼š
// 1. éå†æ‰€æœ‰itemsè·å–key
// 2. å¯¹æ¯”æ–°æ—§keyåˆ—è¡¨
// 3. ä¸ºæ¯ä¸ªitemè°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼ˆå³ä½¿itemæ²¡å˜ï¼‰
// 4. å¯¹æ¯”æ–°æ—§TemplateResult
// 5. æ›´æ–°DOM

// Reactçš„ä¼˜åŒ–ï¼š
// 1. ä½¿ç”¨è™šæ‹ŸDOM
// 2. shouldComponentUpdate/React.memo
// 3. keyåªç”¨äºæ ‡è¯†ï¼Œä¸æ¯æ¬¡éƒ½è°ƒç”¨æ¸²æŸ“å‡½æ•°
```

2. **å±æ€§å˜åŒ–æ£€æµ‹ä¸å¤Ÿç²¾ç¡®**:
```typescript
// Litçš„é»˜è®¤è¡Œä¸ºï¼š
if (oldProp !== newProp) {  // å¼•ç”¨æ¯”è¾ƒ
  update();
}

// é—®é¢˜ï¼šæ¯æ¬¡åˆ›å»ºæ–°çš„widgetså¯¹è±¡ï¼Œå¼•ç”¨è‚¯å®šä¸åŒ
// è§£å†³ï¼šéœ€è¦è‡ªå®šä¹‰hasChanged

@property({
  hasChanged(newVal, oldVal) {
    // æ·±åº¦å¯¹æ¯”
    return !deepEqual(newVal, oldVal);
  }
})
accessor widgets;
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼Œè§æ•ˆå¿«ï¼‰

#### 1. æ·»åŠ æ¸²æŸ“ç¼“å­˜

**ç›®æ ‡**: å‡å°‘å¯¹è±¡åˆ›å»ºï¼Œé™ä½GCå‹åŠ›

**å®ç°**:

**æ–‡ä»¶**: `framework/std/src/view/element/lit-host.ts`

```typescript
export class EditorHost extends ... {
  // ç¼“å­˜widgetså¯¹è±¡
  private _widgetsCache = new WeakMap<string, Record<string, TemplateResult>>();

  private _getWidgets(flavour: string) {
    const cacheKey = flavour;

    if (this._widgetsCache.has(cacheKey)) {
      return this._widgetsCache.get(cacheKey)!;
    }

    const widgetViews = this.std.provider.getAll(WidgetViewIdentifier);
    const widgets = Array.from(widgetViews.entries()).reduce(
      (mapping, [key, tag]) => {
        const [widgetFlavour, id] = key.split('|');
        if (widgetFlavour === flavour) {
          const template = html`<${tag} ${unsafeStatic(WIDGET_ID_ATTR)}=${id}></${tag}>`;
          mapping[id] = template;
        }
        return mapping;
      },
      {} as Record<string, TemplateResult>
    );

    this._widgetsCache.set(cacheKey, widgets);
    return widgets;
  }

  private readonly _renderModel = (model: BlockModel): TemplateResult => {
    const { flavour } = model;
    const block = this.store.getBlock(model.id);

    if (!block || block.blockViewType === 'hidden') {
      return html`${nothing}`;
    }

    const schema = this.store.schema.flavourSchemaMap.get(flavour);
    const view = this.std.getView(flavour);

    if (!schema || !view) {
      console.warn(`Cannot find render flavour ${flavour}.`);
      return html`${nothing}`;
    }

    // ğŸŸ¢ ä½¿ç”¨ç¼“å­˜çš„widgets
    const widgets = this._getWidgets(flavour);

    const tag = typeof view === 'function' ? view(model) : view;
    return html`<${tag}
      ${unsafeStatic(BLOCK_ID_ATTR)}=${model.id}
      .widgets=${widgets}
      .viewType=${block.blockViewType}
    ></${tag}>`;
  };
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘30-40%çš„å¯¹è±¡åˆ›å»ºï¼Œé™ä½GCé¢‘ç‡

---

#### 2. InlineEditorå¢é‡æ¸²æŸ“

**ç›®æ ‡**: åªæ›´æ–°å˜åŒ–çš„è¡Œ

**å®ç°**:

**æ–‡ä»¶**: `framework/std/src/inline/services/render.ts`

```typescript
export class RenderService<TextAttributes extends BaseTextAttributes> {
  // ç¼“å­˜å½“å‰çš„lines
  private _cachedLines: Array<{
    index: number;
    startOffset: number;
    endOffset: number;
    hash: string; // ç”¨äºæ£€æµ‹å†…å®¹æ˜¯å¦å˜åŒ–
  }> = [];

  private readonly _onYTextChange = (
    event: Y.YTextEvent,
    transaction: Y.Transaction
  ) => {
    this.editor.slots.textChange.next();

    const yText = this.editor.yText;

    if (yText.toString().includes('\r')) {
      throw new BlockSuiteError(...);
    }

    // ğŸŸ¢ å¢é‡æ¸²æŸ“
    this.renderIncremental(event);

    // ... å…‰æ ‡ä½ç½®åŒæ­¥
  };

  private renderIncremental(event: Y.YTextEvent) {
    if (!this.editor.rootElement) return;

    // åˆ†æYJS eventï¼Œæ‰¾å‡ºå˜åŒ–çš„ä½ç½®
    const changes = this.analyzeYTextChanges(event.delta);

    if (changes.affectedLines.length === 0) {
      // æ²¡æœ‰è¡Œå˜åŒ–ï¼Œåªéœ€è¦æ›´æ–°ç‰¹å®šVElement
      this.updateElements(changes.affectedElements);
      return;
    }

    if (changes.affectedLines.length > 5) {
      // å˜åŒ–å¤ªå¤šï¼Œå›é€€åˆ°å®Œæ•´æ¸²æŸ“
      this.render();
      return;
    }

    // åªæ›´æ–°å˜åŒ–çš„è¡Œ
    changes.affectedLines.forEach(lineIndex => {
      this.updateLine(lineIndex);
    });
  }

  private analyzeYTextChanges(delta: Y.Delta[]) {
    let index = 0;
    const affectedLines: number[] = [];
    const affectedElements: number[] = [];

    for (const op of delta) {
      if (op.retain) {
        index += op.retain;
      } else if (op.insert) {
        // è®¡ç®—å—å½±å“çš„è¡Œå·
        const lineIndex = this.getLineIndexByOffset(index);
        if (!affectedLines.includes(lineIndex)) {
          affectedLines.push(lineIndex);
        }
        index += op.insert.length;
      } else if (op.delete) {
        const lineIndex = this.getLineIndexByOffset(index);
        if (!affectedLines.includes(lineIndex)) {
          affectedLines.push(lineIndex);
        }
      }
    }

    return { affectedLines, affectedElements };
  }

  private updateLine(lineIndex: number) {
    const vLine = this.editor.rootElement?.querySelector(
      `v-line[data-index="${lineIndex}"]`
    );

    if (!vLine) return;

    // é‡æ–°æ¸²æŸ“è¿™ä¸€è¡Œ
    const embedDeltas = this.editor.deltaService.embedDeltas;
    const chunks = deltaInsertsToChunks(embedDeltas);
    const chunk = chunks[lineIndex];

    if (!chunk) return;

    // ... åªæ›´æ–°è¿™ä¸€è¡Œçš„å†…å®¹
  }

  private getLineIndexByOffset(offset: number): number {
    // æ ¹æ®offsetè®¡ç®—è¡Œå·
    let currentOffset = 0;
    let lineIndex = 0;

    for (const line of this._cachedLines) {
      if (offset >= currentOffset && offset < line.endOffset) {
        return lineIndex;
      }
      currentOffset = line.endOffset + 1; // +1 for '\n'
      lineIndex++;
    }

    return Math.max(0, lineIndex - 1);
  }
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘50-70%çš„InlineEditoræ¸²æŸ“æ—¶é—´

---

#### 3. æ·»åŠ shouldUpdateä¼˜åŒ–

**ç›®æ ‡**: é˜»æ­¢ä¸å¿…è¦çš„å­å—æ›´æ–°

**å®ç°**:

**æ–‡ä»¶**: `framework/std/src/view/element/block-component.ts`

```typescript
export class BlockComponent<...> extends ... {
  override shouldUpdate(changedProperties: PropertyValues): boolean {
    // ğŸŸ¢ åªæœ‰çœŸæ­£å½±å“æ¸²æŸ“çš„å±æ€§å˜åŒ–æ‰æ›´æ–°

    // widgetså¯¹è±¡å˜åŒ–æ—¶ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦çœŸçš„å˜äº†
    if (changedProperties.has('widgets')) {
      const oldWidgets = changedProperties.get('widgets');
      const newWidgets = this.widgets;

      if (this._widgetsEqual(oldWidgets, newWidgets)) {
        // widgetså†…å®¹ç›¸åŒï¼Œä¸æ›´æ–°
        return false;
      }
    }

    // å…¶ä»–å±æ€§ä½¿ç”¨é»˜è®¤é€»è¾‘
    return true;
  }

  private _widgetsEqual(
    a: Record<string, TemplateResult>,
    b: Record<string, TemplateResult>
  ): boolean {
    if (!a && !b) return true;
    if (!a || !b) return false;

    const keysA = Object.keys(a);
    const keysB = Object.keys(b);

    if (keysA.length !== keysB.length) return false;

    return keysA.every(key => {
      // æ¯”è¾ƒTemplateResultçš„stringsï¼ˆæ¨¡æ¿å­—ç¬¦ä¸²ï¼‰
      return a[key].strings === b[key].strings;
    });
  }
}
```

**é¢„æœŸæ”¶ç›Š**: å‡å°‘40-60%çš„å­å—ä¸å¿…è¦æ›´æ–°

---

### ä¸­æœŸä¼˜åŒ–ï¼ˆ4-6å‘¨ï¼Œæ¶æ„è°ƒæ•´ï¼‰

#### 1. æ‹†åˆ†Blockç»„ä»¶

**ç›®æ ‡**: ç»†åŒ–æ›´æ–°ç²’åº¦

**å®ç°**:

**æ–°å»ºæ–‡ä»¶**: `yunke/blocks/paragraph/src/components/paragraph-header.ts`

```typescript
export class ParagraphHeader extends SignalWatcher(WithDisposable(LitElement)) {
  static override styles = css`...`;

  @property({ attribute: false })
  accessor type!: Signal<string>;

  @property({ attribute: false })
  accessor collapsed!: boolean;

  @property({ attribute: false })
  accessor onToggle!: (value: boolean) => void;

  override render() {
    const type = this.type.value;

    return html`
      ${type.startsWith('h')
        ? html`
            <yunke-paragraph-heading-icon
              .type=${type}
            ></yunke-paragraph-heading-icon>
          `
        : nothing}

      ${type.startsWith('h') && this.hasCollapsedSiblings
        ? html`
            <blocksuite-toggle-button
              .collapsed=${this.collapsed}
              .updateCollapsed=${this.onToggle}
            ></blocksuite-toggle-button>
          `
        : nothing}
    `;
  }
}
```

**æ–°å»ºæ–‡ä»¶**: `yunke/blocks/paragraph/src/components/paragraph-content.ts`

```typescript
export class ParagraphContent extends SignalWatcher(WithDisposable(LitElement)) {
  static override styles = css`...`;

  @property({ attribute: false })
  accessor text!: Text;

  @property({ attribute: false })
  accessor placeholder!: string;

  override render() {
    return html`
      <rich-text
        .yText=${this.text.yText}
        ...
      ></rich-text>

      <div class="paragraph-placeholder">
        ${this.placeholder}
      </div>
    `;
  }
}
```

**ä¿®æ”¹**: `yunke/blocks/paragraph/src/paragraph-block.ts`

```typescript
export class ParagraphBlockComponent extends CaptionedBlockComponent<ParagraphBlockModel> {
  override renderBlock(): TemplateResult<1> {
    return html`
      <paragraph-header
        .type=${this.model.props.type$}
        .collapsed=${this.model.props.collapsed}
        .onToggle=${(value: boolean) => {
          this.store.updateBlock(this.model, { collapsed: value });
        }}
      ></paragraph-header>

      <paragraph-content
        .text=${this.model.props.text}
        .placeholder=${this._placeholder}
      ></paragraph-content>

      ${this.model.props.collapsed ? nothing : html`
        <paragraph-children
          .model=${this.model}
        ></paragraph-children>
      `}
    `;
  }
}
```

**é¢„æœŸæ”¶ç›Š**:
- textå˜åŒ–åªæ›´æ–°ParagraphContent
- typeå˜åŒ–åªæ›´æ–°ParagraphHeader
- å‡å°‘50-70%çš„é‡å¤æ¸²æŸ“

---

#### 2. å®ç°è™šæ‹Ÿæ»šåŠ¨

**ç›®æ ‡**: åªæ¸²æŸ“å¯è§å—

**å®ç°**:

**æ–°å»ºæ–‡ä»¶**: `framework/std/src/view/virtual-scroller.ts`

```typescript
export class VirtualScroller {
  private _visibleRange = { start: 0, end: 20 };
  private _blockHeights = new Map<string, number>();

  constructor(
    private container: HTMLElement,
    private allBlocks: BlockModel[]
  ) {
    this.setupScrollListener();
  }

  private setupScrollListener() {
    this.container.addEventListener('scroll', () => {
      this.updateVisibleRange();
    });
  }

  private updateVisibleRange() {
    const scrollTop = this.container.scrollTop;
    const containerHeight = this.container.clientHeight;

    let accumulatedHeight = 0;
    let startIndex = 0;
    let endIndex = 0;

    // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯è§å—
    for (let i = 0; i < this.allBlocks.length; i++) {
      const blockHeight = this.getBlockHeight(this.allBlocks[i].id);

      if (accumulatedHeight + blockHeight > scrollTop) {
        startIndex = Math.max(0, i - 2); // æå‰æ¸²æŸ“2ä¸ª
        break;
      }

      accumulatedHeight += blockHeight;
    }

    // æ‰¾åˆ°æœ€åä¸€ä¸ªå¯è§å—
    accumulatedHeight = 0;
    for (let i = startIndex; i < this.allBlocks.length; i++) {
      const blockHeight = this.getBlockHeight(this.allBlocks[i].id);
      accumulatedHeight += blockHeight;

      if (accumulatedHeight > scrollTop + containerHeight) {
        endIndex = Math.min(this.allBlocks.length, i + 2); // å»¶åæ¸²æŸ“2ä¸ª
        break;
      }
    }

    this._visibleRange = { start: startIndex, end: endIndex };
  }

  private getBlockHeight(blockId: string): number {
    return this._blockHeights.get(blockId) || 50; // é»˜è®¤50px
  }

  getVisibleBlocks(): BlockModel[] {
    return this.allBlocks.slice(
      this._visibleRange.start,
      this._visibleRange.end
    );
  }

  getTopPlaceholderHeight(): number {
    let height = 0;
    for (let i = 0; i < this._visibleRange.start; i++) {
      height += this.getBlockHeight(this.allBlocks[i].id);
    }
    return height;
  }

  getBottomPlaceholderHeight(): number {
    let height = 0;
    for (let i = this._visibleRange.end; i < this.allBlocks.length; i++) {
      height += this.getBlockHeight(this.allBlocks[i].id);
    }
    return height;
  }
}
```

**ä¿®æ”¹**: `framework/std/src/view/element/lit-host.ts`

```typescript
export class EditorHost extends ... {
  private _virtualScroller?: VirtualScroller;

  override connectedCallback() {
    super.connectedCallback();

    // åˆå§‹åŒ–è™šæ‹Ÿæ»šåŠ¨
    if (this.store.root && this.store.root.children.length > 50) {
      this._virtualScroller = new VirtualScroller(
        this,
        this.store.root.children
      );
    }
  }

  override render() {
    const { root } = this.store;
    if (!root) return nothing;

    if (this._virtualScroller) {
      const visibleBlocks = this._virtualScroller.getVisibleBlocks();
      const topHeight = this._virtualScroller.getTopPlaceholderHeight();
      const bottomHeight = this._virtualScroller.getBottomPlaceholderHeight();

      return html`
        <div style="height: ${topHeight}px;"></div>
        ${repeat(
          visibleBlocks,
          block => block.id,
          block => this._renderModel(block)
        )}
        <div style="height: ${bottomHeight}px;"></div>
      `;
    }

    return this._renderModel(root);
  }
}
```

**é¢„æœŸæ”¶ç›Š**:
- 1000ä¸ªå—çš„æ–‡æ¡£ï¼Œåªæ¸²æŸ“20-30ä¸ªå—
- å‡å°‘90-95%çš„DOMèŠ‚ç‚¹
- æ»šåŠ¨æ€§èƒ½æå‡10-20å€

---

### é•¿æœŸä¼˜åŒ–ï¼ˆ2-3ä¸ªæœˆï¼Œæ¶æ„é‡æ„ï¼‰

#### 1. é‡æ–°è®¾è®¡å“åº”å¼ç³»ç»Ÿ

**ç›®æ ‡**: ä¼ é€’å¢é‡å˜æ›´ä¿¡æ¯

**è®¾è®¡**:

```typescript
// æ–°çš„å˜æ›´äº‹ä»¶ç³»ç»Ÿ
interface BlockChange {
  type: 'props' | 'children';
  blockId: string;

  // propså˜æ›´
  propsChange?: {
    key: string;
    oldValue: unknown;
    newValue: unknown;
    delta?: Delta; // å¦‚æœæ˜¯Textç±»å‹ï¼ŒåŒ…å«å¢é‡ä¿¡æ¯
  };

  // childrenå˜æ›´
  childrenChange?: {
    added: string[];
    removed: string[];
    moved: Array<{ id: string; from: number; to: number }>;
  };
}

// æ–°çš„è®¢é˜…æ¥å£
interface BlockObserver {
  onBlockChange(change: BlockChange): void;
}

// BlockComponentå®ç°
class BlockComponent implements BlockObserver {
  onBlockChange(change: BlockChange) {
    if (change.type === 'props') {
      this.onPropsChange(change.propsChange!);
    } else {
      this.onChildrenChange(change.childrenChange!);
    }
  }

  private onPropsChange(change: PropsChange) {
    switch (change.key) {
      case 'text':
        // åªæ›´æ–°æ–‡æœ¬éƒ¨åˆ†
        if (change.delta) {
          this._richTextElement?.applyDelta(change.delta);
        } else {
          this._richTextElement?.requestUpdate();
        }
        break;

      case 'type':
        // å®Œæ•´æ›´æ–°
        this.requestUpdate();
        break;

      case 'collapsed':
        // åªæ›´æ–°æŠ˜å çŠ¶æ€
        this.updateCollapsedState(change.newValue);
        break;
    }
  }
}
```

---

#### 2. è€ƒè™‘æ›¿æ¢Litä¸ºReact/Vue

**é—®é¢˜**: Litä¸é€‚åˆå¤§å‹åµŒå¥—ç»„ä»¶æ ‘

**Reactçš„ä¼˜åŠ¿**:
1. è™šæ‹ŸDOM diffä¼˜åŒ–
2. React.memo / shouldComponentUpdate
3. Concurrent Modeï¼ˆæ—¶é—´åˆ‡ç‰‡ï¼‰
4. æˆç†Ÿçš„ç”Ÿæ€ç³»ç»Ÿ

**è¿ç§»æ–¹æ¡ˆ**:

```tsx
// Reactç‰ˆæœ¬çš„ParagraphBlock
const ParagraphBlock = React.memo(({ model }: { model: ParagraphBlockModel }) => {
  const type = useSignal(model.props.type$);
  const collapsed = useSignal(model.props.collapsed$);
  const text = useSignal(model.props.text$);

  return (
    <div className="paragraph-block">
      {type.startsWith('h') && (
        <ParagraphHeader type={type} collapsed={collapsed} />
      )}

      <ParagraphContent text={text} />

      {!collapsed && (
        <ParagraphChildren model={model} />
      )}
    </div>
  );
}, (prevProps, nextProps) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒ
  return prevProps.model.id === nextProps.model.id;
});
```

---

## ğŸ“… å®æ–½è·¯çº¿å›¾

### Phase 1: å¿«é€Ÿä¿®å¤ï¼ˆWeek 1-2ï¼‰

**ç›®æ ‡**: å‡å°‘30-40%çš„æ€§èƒ½é—®é¢˜

**ä»»åŠ¡**:
1. âœ… æ·»åŠ widgetsç¼“å­˜ï¼ˆ1å¤©ï¼‰
2. âœ… å®ç°BlockComponent.shouldUpdateï¼ˆ2å¤©ï¼‰
3. âœ… æ·»åŠ æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—ï¼ˆ1å¤©ï¼‰
4. âœ… ä¼˜åŒ–collapsedSiblingsè®¡ç®—ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰ï¼ˆ1å¤©ï¼‰
5. âœ… æµ‹è¯•å’ŒéªŒè¯ï¼ˆ3å¤©ï¼‰

**é¢„æœŸæ”¶ç›Š**:
- å¤§å‹æ–‡æ¡£è¾“å…¥å»¶è¿Ÿä»1000msé™è‡³600ms
- å¯¹è±¡åˆ›å»ºå‡å°‘40%

---

### Phase 2: æ¶æ„ä¼˜åŒ–ï¼ˆWeek 3-6ï¼‰

**ç›®æ ‡**: å‡å°‘60-70%çš„æ€§èƒ½é—®é¢˜

**ä»»åŠ¡**:
1. âœ… å®ç°InlineEditorå¢é‡æ¸²æŸ“ï¼ˆ1å‘¨ï¼‰
2. âœ… æ‹†åˆ†Blockç»„ä»¶ï¼ˆParagraphHeader/Content/Childrenï¼‰ï¼ˆ1å‘¨ï¼‰
3. âœ… å®ç°è™šæ‹Ÿæ»šåŠ¨åŸºç¡€ç‰ˆæœ¬ï¼ˆ1å‘¨ï¼‰
4. âœ… ä¼˜åŒ–Signalä¼ æ’­æœºåˆ¶ï¼ˆ1å‘¨ï¼‰

**é¢„æœŸæ”¶ç›Š**:
- å¤§å‹æ–‡æ¡£è¾“å…¥å»¶è¿Ÿä»600msé™è‡³300ms
- æ¸²æŸ“æ¬¡æ•°å‡å°‘60%

---

### Phase 3: æ·±åº¦é‡æ„ï¼ˆWeek 7-12ï¼‰

**ç›®æ ‡**: å½»åº•è§£å†³æ€§èƒ½é—®é¢˜

**ä»»åŠ¡**:
1. âœ… é‡æ–°è®¾è®¡å˜æ›´äº‹ä»¶ç³»ç»Ÿï¼ˆ2å‘¨ï¼‰
2. âœ… å®ç°å®Œæ•´çš„å¢é‡æ›´æ–°æœºåˆ¶ï¼ˆ2å‘¨ï¼‰
3. âœ… ä¼˜åŒ–æˆ–æ›¿æ¢Litæ¡†æ¶ï¼ˆ2å‘¨ï¼‰
4. âœ… å…¨é¢æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ2å‘¨ï¼‰

**é¢„æœŸæ”¶ç›Š**:
- å¤§å‹æ–‡æ¡£è¾“å…¥å»¶è¿Ÿé™è‡³50-100ms
- æ¥è¿‘ç†æƒ³çš„60 FPSä½“éªŒ

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰ | Phase 1 | Phase 2 | Phase 3 (ç›®æ ‡) |
|-----|------|---------|---------|---------------|
| å°æ–‡æ¡£å»¶è¿Ÿ | 150ms | 90ms | 40ms | <16ms |
| ä¸­å‹æ–‡æ¡£å»¶è¿Ÿ | 450ms | 270ms | 135ms | <30ms |
| å¤§å‹æ–‡æ¡£å»¶è¿Ÿ | 900ms | 540ms | 270ms | <50ms |
| CPUå ç”¨ç‡ | 80-100% | 60-80% | 40-60% | <30% |
| å¸§ç‡ | 15-30 FPS | 30-45 FPS | 45-55 FPS | 55-60 FPS |

### ä»£ç è´¨é‡ç›®æ ‡

- âœ… æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡è¾¾åˆ°80%
- âœ… æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
- âœ… æ·»åŠ æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦
- âœ… æ–‡æ¡£å’Œæ³¨é‡Šå®Œå–„

---

## ğŸ“š é™„å½•

### A. æ€§èƒ½æµ‹è¯•æ–¹æ³•

```typescript
// æ€§èƒ½æµ‹è¯•å·¥å…·
class PerformanceMonitor {
  private marks = new Map<string, number>();

  start(label: string) {
    this.marks.set(label, performance.now());
  }

  end(label: string): number {
    const startTime = this.marks.get(label);
    if (!startTime) {
      console.warn(`No start mark for ${label}`);
      return 0;
    }

    const endTime = performance.now();
    const duration = endTime - startTime;

    console.log(`[Perf] ${label}: ${duration.toFixed(2)}ms`);

    this.marks.delete(label);
    return duration;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const monitor = new PerformanceMonitor();

// åœ¨å…³é”®è·¯å¾„æ·»åŠ ç›‘æ§
class RenderService {
  render = () => {
    monitor.start('inline-editor-render');

    // ... æ¸²æŸ“é€»è¾‘

    monitor.end('inline-editor-render');
  };
}
```

---

### B. ç›¸å…³ä»£ç æ–‡ä»¶æ¸…å•

**æ ¸å¿ƒæ–‡ä»¶**:
1. `framework/store/src/reactive/text/text.ts` - Text Signal
2. `framework/store/src/model/block/sync-controller.ts` - PropsåŒæ­¥
3. `framework/std/src/inline/services/render.ts` - InlineEditoræ¸²æŸ“
4. `framework/std/src/view/element/block-component.ts` - BlockåŸºç±»
5. `framework/std/src/view/element/lit-host.ts` - æ¸²æŸ“åè°ƒå™¨
6. `yunke/blocks/paragraph/src/paragraph-block.ts` - æ®µè½å—å®ç°

**è¾…åŠ©æ–‡ä»¶**:
7. `framework/std/src/inline/inline-editor.ts` - InlineEditorä¸»ç±»
8. `yunke-shared/utils/model.ts` - å·¥å…·å‡½æ•°ï¼ˆcalculateCollapsedSiblingsï¼‰

---

### C. å‚è€ƒèµ„æ–™

1. **Litæ–‡æ¡£**: https://lit.dev/docs/
2. **YJSæ–‡æ¡£**: https://docs.yjs.dev/
3. **Preact Signals**: https://preactjs.com/guide/v10/signals/
4. **è™šæ‹Ÿæ»šåŠ¨æœ€ä½³å®è·µ**: https://web.dev/virtualize-lists-with-intersectionobserver/
5. **Reactæ€§èƒ½ä¼˜åŒ–**: https://react.dev/learn/render-and-commit

---

## ğŸ“ æ€»ç»“

æœ¬æŠ¥å‘Šé€šè¿‡æ·±å…¥çš„ä»£ç çº§åˆ†æï¼Œç¡®è®¤äº†AFFiNE/BlockSuiteåœ¨å¤„ç†å¤§å‹æ–‡æ¡£æ—¶å­˜åœ¨**æ¶æ„çº§åˆ«çš„æ€§èƒ½ç¼ºé™·**ã€‚

**æ ¸å¿ƒé—®é¢˜**:
1. å“åº”å¼ç³»ç»Ÿä¼ é€’ç²—ç²’åº¦å˜æ›´ä¿¡æ¯
2. InlineEditoræ¯æ¬¡å®Œæ•´é‡æ¸²æŸ“
3. Blockç»„ä»¶ç²—ç²’åº¦æ›´æ–°
4. å­å—é€’å½’æ¸²æŸ“å¤±æ§

**è§£å†³æ–¹æ¡ˆ**:
- çŸ­æœŸï¼šç¼“å­˜ä¼˜åŒ–ã€shouldUpdateï¼ˆ1-2å‘¨ï¼Œ30-40%æ”¹å–„ï¼‰
- ä¸­æœŸï¼šå¢é‡æ¸²æŸ“ã€ç»„ä»¶æ‹†åˆ†ï¼ˆ4-6å‘¨ï¼Œ60-70%æ”¹å–„ï¼‰
- é•¿æœŸï¼šæ¶æ„é‡æ„ï¼ˆ2-3ä¸ªæœˆï¼Œå½»åº•è§£å†³ï¼‰

**å·¥ä½œé‡**: éœ€è¦3-4åæ ¸å¿ƒå·¥ç¨‹å¸ˆï¼ŒæŠ•å…¥2-3ä¸ªæœˆæ—¶é—´

**ä¼˜å…ˆçº§**: ğŸ”´ P0 Critical - ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒï¼Œå»ºè®®ç«‹å³å¯åŠ¨ä¿®å¤å·¥ä½œ

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**: 2025-11-15
**ä¸‹æ¬¡å®¡æŸ¥**: Phase 1å®Œæˆåï¼ˆé¢„è®¡2å‘¨åï¼‰
