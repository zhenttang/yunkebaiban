# 主题持久化方案设计文档

**创建日期**: 2025-01-09  
**最后更新**: 2025-01-09  
**状态**: 设计阶段

## 目录

1. [需求概述](#需求概述)
2. [当前实现分析](#当前实现分析)
3. [实现方案](#实现方案)
4. [技术实现要点](#技术实现要点)
5. [实施计划](#实施计划)
6. [风险评估](#风险评估)

---

## 需求概述

### 核心需求

1. **持久化保存**: 将用户自定义主题保存到后端数据库，关联到每个登录用户
2. **多主题管理**: 支持保存多个主题方案，用户可以选择和切换
3. **一键应用**: 可以从已保存的主题列表中选择并一键应用
4. **跨设备同步**: 用户在不同设备登录时自动同步主题设置

### 业务价值

- 提升用户体验：用户可以在不同设备上保持一致的个性化主题
- 增强功能价值：支持多主题方案，满足不同场景需求
- 数据安全：主题数据存储在服务器，避免本地数据丢失

---

## 当前实现分析

### 1. 主题存储现状

**存储位置**: `ThemeEditorService` 使用 `GlobalState` (localStorage)

**数据格式**:
```typescript
type CustomTheme = {
  light: Record<string, string>;
  dark: Record<string, string>;
}
```

**关键代码位置**:
- 服务: `packages/frontend/core/src/modules/theme-editor/services/theme-editor.ts`
- 类型: `packages/frontend/core/src/modules/theme-editor/types.ts`
- 应用: `packages/frontend/core/src/desktop/pages/root/custom-theme/index.tsx`

**当前问题**:
- ❌ 数据仅存储在浏览器本地（localStorage）
- ❌ 更换设备或清除浏览器数据会丢失
- ❌ 无法保存多个主题方案
- ❌ 不支持主题的命名和管理

### 2. 现有的用户设置系统

**服务架构**:
- `UserSettingsService`: 用户设置服务层
- `UserSettingsStore`: 用户设置数据存储层
- API 端点: `/api/users/me/settings` (GET/PUT)

**数据格式**: `Record<string, any>` - 支持存储任意键值对

**代码位置**:
- 服务: `packages/frontend/core/src/modules/cloud/services/user-settings.ts`
- 存储: `packages/frontend/core/src/modules/cloud/stores/user-settings.ts`

**优势**:
- ✅ 已有完善的用户设置系统
- ✅ 支持跨设备同步
- ✅ 与用户账号关联

---

## 实现方案

### 方案一：单主题方案（简单）

#### 架构设计

```typescript
UserSettings {
  customTheme: CustomTheme  // 当前使用的主题
}
```

#### 工作流程

1. **保存**: 每次修改后自动保存到后端
2. **加载**: 登录时从后端加载并应用
3. **同步**: 跨设备自动同步

#### 优点

- ✅ 实现简单，改动最小
- ✅ 自动同步，用户体验好
- ✅ 与现有用户设置系统完美集成

#### 缺点

- ❌ 无法保存多个主题方案
- ❌ 无法查看历史版本
- ❌ 用户无法管理不同的主题配置

---

### 方案二：多主题方案（推荐）

#### 架构设计

```typescript
type ThemePreset = {
  id: string;              // 主题ID (UUID)
  name: string;            // 主题名称
  theme: CustomTheme;      // 主题数据
  createdAt: string;        // 创建时间 (ISO 8601)
  updatedAt: string;        // 更新时间 (ISO 8601)
  description?: string;     // 可选描述
};

UserSettings {
  customThemes: ThemePreset[];  // 保存的主题列表
  activeThemeId?: string;        // 当前激活的主题ID
}
```

#### 功能设计

1. **主题管理**
   - 保存当前主题为命名方案
   - 查看所有保存的主题列表
   - 编辑/重命名主题
   - 删除主题
   - 一键应用主题

2. **UI 增强**
   - 在主题编辑器顶部添加工具栏：
     - 主题名称输入框
     - "保存主题"按钮
     - "主题方案"下拉选择器
     - "应用"按钮
     - "删除"按钮
     - "复制"按钮（复制主题）

#### 优点

- ✅ 支持多主题方案管理
- ✅ 用户可以创建和使用多个主题
- ✅ 提供完整的主题管理功能

#### 缺点

- ⚠️ 实现复杂度较高
- ⚠️ 需要设计主题管理 UI
- ⚠️ 需要考虑主题数量限制

---

### 方案三：混合方案（最佳体验）⭐

#### 架构设计

```typescript
UserSettings {
  customThemes: ThemePreset[];  // 多个保存的主题
  activeThemeId?: string;        // 当前激活的主题
  // 临时编辑状态仍保存在 GlobalState (localStorage)
}
```

#### 工作流程

1. **编辑时**: 仍在 localStorage 中实时编辑（响应快）
2. **保存时**: 将当前主题保存到后端，添加到主题列表
3. **应用时**: 从后端加载并应用到 localStorage
4. **自动保存**: 可添加"自动保存"功能，定期同步到后端

#### 优势

- ✅ 保持实时编辑体验（localStorage）
- ✅ 支持多主题方案管理
- ✅ 跨设备同步
- ✅ 提供主题历史管理
- ✅ 编辑时无需等待网络请求

#### 技术要点

- 编辑状态: 使用 `GlobalState` (localStorage) 实现实时编辑
- 持久化: 使用 `UserSettingsService` 保存到后端
- 同步: 登录时自动加载并应用 `activeThemeId` 对应的主题

---

## 技术实现要点

### 1. 数据同步策略

#### ThemeEditorService 改造

```typescript
class ThemeEditorService {
  // 保持现有的 localStorage 实时编辑
  customTheme$: LiveData<CustomTheme>
  
  // 新增：从后端加载的主题列表
  savedThemes$: LiveData<ThemePreset[]>
  
  // 新增：当前激活的主题ID
  activeThemeId$: LiveData<string | undefined>
  
  // 新增：保存当前主题到后端
  async saveTheme(name: string, description?: string): Promise<string>
  
  // 新增：应用已保存的主题
  async applyTheme(themeId: string): Promise<void>
  
  // 新增：删除主题
  async deleteTheme(themeId: string): Promise<void>
  
  // 新增：更新主题
  async updateTheme(themeId: string, updates: Partial<ThemePreset>): Promise<void>
  
  // 新增：从后端加载主题列表
  async loadSavedThemes(): Promise<void>
  
  // 新增：初始化时自动加载并应用主题
  async initialize(): Promise<void>
}
```

### 2. 后端数据结构

#### 数据库设计

```sql
-- 在用户设置表中存储主题数据
-- 使用 JSON 字段存储 customThemes 数组
ALTER TABLE user_settings 
ADD COLUMN custom_themes JSONB DEFAULT '[]'::jsonb,
ADD COLUMN active_theme_id VARCHAR(36);
```

#### 数据限制

- 每个用户最多保存 10 个主题方案
- 单个主题的变量数量限制: 500 个
- 主题名称长度限制: 50 个字符
- 主题描述长度限制: 200 个字符

### 3. UI 交互设计

#### 主题编辑器顶部工具栏

```
┌─────────────────────────────────────────────────────────────┐
│ 主题编辑器                                                    │
├─────────────────────────────────────────────────────────────┤
│ [主题方案 ▼] [保存为...] [应用] [删除] [复制]  [自动保存 ☑] │
│                                                              │
│ ┌─────────────────────────┐ ┌─────────────────────────────┐ │
│ │  左侧: 树形菜单          │ │  右侧: 变量编辑区           │ │
│ │                        │ │                             │ │
│ │  v1 / v2                │ │  名称 | 明亮模式 | 暗黑模式 │ │
│ │  └─ block               │ │  ─────────────────────────  │ │
│ │     └─ callout           │ │  primary | #141414 | #e6e6e6│ │
│ │  └─ switch              │ │  secondary | #7a7a7a | ... │ │
│ │     └─ fontColor        │ │                             │ │
│ └─────────────────────────┘ └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 主题选择器下拉菜单

```
┌─────────────────────────┐
│ 我的主题方案              │
├─────────────────────────┤
│ ✓ 默认主题                │
│   深色商务                │
│   浅色清新                │
│   自定义主题1             │
├─────────────────────────┤
│ + 创建新主题              │
└─────────────────────────┘
```

### 4. API 接口设计

#### 保存主题

```typescript
PUT /api/users/me/settings
Body: {
  customThemes: [
    {
      id: "uuid",
      name: "深色商务",
      theme: { light: {...}, dark: {...} },
      createdAt: "2025-01-09T10:00:00Z",
      updatedAt: "2025-01-09T10:00:00Z"
    }
  ],
  activeThemeId: "uuid"
}
```

#### 获取主题列表

```typescript
GET /api/users/me/settings
Response: {
  customThemes: ThemePreset[],
  activeThemeId?: string
}
```

---

## 实施计划

### 第一阶段：单主题持久化（预计 2-3 天）

**目标**: 实现基础的主题保存和加载功能

**任务清单**:

- [ ] **Day 1: 后端开发**
  - [ ] 在用户设置 API 中添加 `customTheme` 字段支持
  - [ ] 修改 `UserSettingsStore` 支持主题数据
  - [ ] 添加数据验证逻辑（限制主题大小）

- [ ] **Day 2: 前端服务层**
  - [ ] 修改 `ThemeEditorService` 添加 `saveTheme()` 方法
  - [ ] 添加 `loadTheme()` 方法
  - [ ] 实现登录时自动加载主题
  - [ ] 添加主题保存的自动同步机制

- [ ] **Day 3: UI 集成**
  - [ ] 在主题编辑器添加"保存主题"按钮
  - [ ] 添加保存成功的提示
  - [ ] 测试跨设备同步功能

**验收标准**:
- ✅ 用户可以保存当前主题到后端
- ✅ 登录时自动加载并应用保存的主题
- ✅ 跨设备同步正常工作

---

### 第二阶段：多主题管理（预计 4-5 天）

**目标**: 实现多主题方案的管理功能

**任务清单**:

- [ ] **Day 4-5: 数据结构改造**
  - [ ] 修改后端数据结构支持 `customThemes` 数组
  - [ ] 更新 `ThemeEditorService` 支持主题列表
  - [ ] 实现主题的 CRUD 操作（创建、读取、更新、删除）
  - [ ] 添加主题数量限制逻辑

- [ ] **Day 6: 主题管理 UI**
  - [ ] 设计并实现主题选择器组件
  - [ ] 添加主题列表展示
  - [ ] 实现主题名称输入和保存对话框
  - [ ] 添加主题删除确认对话框

- [ ] **Day 7: 功能完善**
  - [ ] 实现主题应用功能
  - [ ] 实现主题复制功能
  - [ ] 添加主题重命名功能
  - [ ] 优化 UI 交互体验

- [ ] **Day 8: 测试和优化**
  - [ ] 端到端测试
  - [ ] 性能优化（大量主题时的加载速度）
  - [ ] 错误处理完善
  - [ ] 用户体验优化

**验收标准**:
- ✅ 用户可以保存多个主题方案
- ✅ 可以查看、选择、应用已保存的主题
- ✅ 可以删除不需要的主题
- ✅ 主题数据正确同步到后端

---

### 第三阶段：UI 增强和优化（预计 2-3 天）

**目标**: 提升用户体验和功能完善

**任务清单**:

- [ ] **Day 9: 高级功能**
  - [ ] 实现主题预览功能
  - [ ] 添加主题描述字段
  - [ ] 实现主题导入/导出功能（JSON 格式）
  - [ ] 添加主题分享功能（可选）

- [ ] **Day 10: 自动保存**
  - [ ] 实现自动保存功能（定期同步）
  - [ ] 添加保存状态指示器
  - [ ] 实现离线编辑支持（离线时缓存，上线后同步）

- [ ] **Day 11: 优化和文档**
  - [ ] 性能优化（懒加载、防抖等）
  - [ ] 添加错误处理和用户提示
  - [ ] 编写用户使用文档
  - [ ] 代码审查和重构

**验收标准**:
- ✅ 所有功能正常工作
- ✅ 用户体验流畅
- ✅ 性能满足要求
- ✅ 文档完整

---

## 风险评估

### 技术风险

1. **数据迁移风险**
   - 风险: 现有用户的 localStorage 主题数据需要迁移
   - 缓解: 提供数据迁移脚本，首次登录时自动迁移

2. **性能风险**
   - 风险: 主题数据较大时，同步可能较慢
   - 缓解: 使用增量更新，只同步变更部分

3. **兼容性风险**
   - 风险: 新旧版本的主题格式不兼容
   - 缓解: 添加版本字段，提供格式转换逻辑

### 业务风险

1. **存储成本**
   - 风险: 用户保存大量主题会占用数据库空间
   - 缓解: 限制每个用户最多保存 10 个主题

2. **用户体验**
   - 风险: 用户可能不知道如何保存和管理主题
   - 缓解: 添加引导提示和帮助文档

---

## 后续扩展计划

### 短期扩展（1-2 个月）

1. **主题市场**
   - 用户可以浏览和下载社区分享的主题
   - 支持主题评分和评论

2. **主题编辑器增强**
   - 添加主题预览功能
   - 支持主题变量分组管理
   - 添加主题变量搜索功能

3. **智能推荐**
   - 根据用户使用习惯推荐主题
   - 根据时间自动切换主题（白天/夜晚）

### 中期扩展（3-6 个月）

1. **主题版本管理**
   - 保存主题的历史版本
   - 支持版本回退

2. **主题导入导出**
   - 支持从其他主题编辑器导入
   - 支持导出为标准格式（CSS Variables）

3. **团队主题**
   - 支持工作区级别的主题设置
   - 团队成员可以共享主题

### 长期扩展（6 个月以上）

1. **AI 主题生成**
   - 根据用户喜好自动生成主题
   - 智能配色建议

2. **主题分析**
   - 分析用户使用习惯
   - 提供主题使用统计

---

## 相关文件清单

### 前端文件

- `packages/frontend/core/src/modules/theme-editor/services/theme-editor.ts` - 主题编辑器服务
- `packages/frontend/core/src/modules/theme-editor/types.ts` - 类型定义
- `packages/frontend/core/src/desktop/pages/theme-editor/theme-editor.tsx` - 主题编辑器 UI
- `packages/frontend/core/src/modules/cloud/services/user-settings.ts` - 用户设置服务
- `packages/frontend/core/src/modules/cloud/stores/user-settings.ts` - 用户设置存储

### 后端文件（待创建）

- `api/users/me/settings` - 用户设置 API 端点
- 数据库迁移脚本 - 添加主题相关字段

---

## 更新日志

- **2025-01-09**: 创建文档，完成方案设计和实施计划

---

## 备注

- 本方案采用渐进式实施策略，确保每个阶段都可以独立交付价值
- 优先保证核心功能的稳定性和可靠性
- UI 设计需要遵循现有的设计规范
- 所有 API 变更需要保持向后兼容

