# 🧪 快速测试指南

## 功能说明

点击白板底部的流程图按钮，会弹出编辑器对话框，用户可以输入 DSL 代码生成流程图。

## 🚀 快速测试步骤

### 1. 启动项目

```bash
# 进入前端项目目录
cd baibanfront

# 启动开发服务器
npm run dev
# 或
pnpm dev
```

### 2. 打开白板

1. 在浏览器中打开项目
2. 创建或打开一个文档
3. 切换到白板（Edgeless）模式

### 3. 点击流程图按钮

1. 在白板底部工具栏找到流程图按钮（🔀 图标）
2. 点击按钮
3. **预期结果**: 弹出 "Yunke Flow 图表生成器" 对话框

### 4. 测试编辑器功能

#### 测试 1: 默认代码
- **操作**: 打开对话框后观察
- **预期**: 
  - 左侧编辑器有默认的"简单流程"代码
  - 右侧显示预览图
  - 底部显示节点和连线数量

#### 测试 2: 选择模板
- **操作**: 点击"快速开始"下拉菜单，选择"微服务架构"
- **预期**:
  - 编辑器代码更新为微服务架构示例
  - 预览自动更新
  - 统计信息更新

#### 测试 3: 手动编辑
- **操作**: 手动修改代码，例如修改节点标签
- **预期**:
  - 预览实时更新
  - 如果语法错误，显示错误提示

#### 测试 4: 生成图表
- **操作**: 点击右上角"生成到白板"按钮
- **预期**:
  - 对话框关闭
  - 白板视口中心出现流程图元素
  - 控制台输出成功信息

### 5. 测试生成的元素

#### 测试 5: 选中节点
- **操作**: 点击任意一个蓝色节点
- **预期**: 节点被选中，显示选择框和控制点

#### 测试 6: 移动节点
- **操作**: 拖动一个节点到新位置
- **预期**: 
  - 节点移动
  - 连接的线条自动跟随调整

#### 测试 7: 编辑文本
- **操作**: 双击节点，修改文本
- **预期**: 可以正常编辑文本内容

#### 测试 8: 删除元素
- **操作**: 选中一个节点，按 Delete 键
- **预期**: 节点被删除

## 📋 验收清单

- [ ] 点击按钮能打开对话框
- [ ] 对话框包含代码编辑器和预览区域
- [ ] 默认加载简单示例代码
- [ ] 模板选择下拉菜单有 7+ 个选项
- [ ] 选择模板能正确加载代码
- [ ] 编辑代码能实时预览
- [ ] 错误代码能显示错误提示
- [ ] 点击"生成到白板"能创建元素
- [ ] 生成的元素位于视口中心
- [ ] 生成的节点是真实的 ShapeElement
- [ ] 生成的连线是真实的 ConnectorElement
- [ ] 节点可以单独选中
- [ ] 节点可以移动
- [ ] 连线跟随节点移动
- [ ] 节点文本可以编辑
- [ ] 元素可以删除
- [ ] 对话框可以关闭（点击遮罩或取消按钮）

## 🐛 常见问题排查

### 问题 1: 点击按钮没有反应
**可能原因**:
- 编辑器对话框组件未正确加载
- 查看浏览器控制台是否有错误

**解决方案**:
```bash
# 重新编译 TypeScript
cd baibanfront/blocksuite/yunke/blocks/flowchart
npm run build
```

### 问题 2: 对话框打开但是空白
**可能原因**:
- CSS 样式未正确加载
- 检查 flowchart-editor-dialog.ts 中的 styles

**解决方案**:
- 检查浏览器开发者工具的 Elements 面板
- 确认元素已渲染但可能被隐藏

### 问题 3: 预览不显示
**可能原因**:
- svg-renderer.ts 解析或渲染失败
- 查看控制台错误信息

**解决方案**:
- 检查 DSL 代码语法是否正确
- 查看控制台的错误堆栈

### 问题 4: 生成按钮点击没反应
**可能原因**:
- element-generator.ts 导入失败
- Surface API 调用失败

**解决方案**:
- 打开控制台，查看是否有错误
- 确认 edgeless service 和 surface 可用

### 问题 5: 生成的元素看不见
**可能原因**:
- 元素生成在视口外
- 元素颜色与背景相同

**解决方案**:
- 缩小视口查看
- 检查生成位置参数 (centerX, centerY)

## 🔧 调试技巧

### 1. 启用详细日志
在 `flowchart-editor-dialog.ts` 的 `_handleGenerate` 方法中已有日志：

```typescript
console.log('✅ 流程图已生成:', {
  节点数: result.nodeIds.size,
  连线数: result.edgeIds.length,
});
```

### 2. 检查元素 ID
在 `element-generator.ts` 中有详细的日志输出：

```typescript
console.log('创建节点:', { id: node.id, x, y, width, height, label });
console.log('节点已创建，ID:', elementId);
console.log('创建连线:', { from, to, sourceId, targetId, label });
```

### 3. 使用浏览器开发者工具
- **Elements 面板**: 查看 DOM 结构，确认对话框是否渲染
- **Console 面板**: 查看日志和错误信息
- **Network 面板**: 确认模块是否正确加载
- **Sources 面板**: 设置断点调试

### 4. 验证 Surface API
在控制台中运行：

```javascript
// 获取当前的 edgeless service
const service = document.querySelector('affine-edgeless-root')?.service;
console.log('Service:', service);
console.log('Surface:', service?.surface);

// 测试创建一个简单的 shape
service?.surface?.addElement({
  type: 'shape',
  xywh: '[100,100,200,100]',
  shapeType: 'rect',
  filled: true,
  fillColor: '#ff0000',
});
```

## ✅ 成功标志

如果看到以下情况，说明功能正常：

1. ✅ 点击按钮后出现全屏对话框
2. ✅ 对话框有左右两栏（代码 + 预览）
3. ✅ 预览区域显示蓝色节点和灰色连线的 SVG 图
4. ✅ 点击"生成到白板"后，白板上出现可操作的元素
5. ✅ 控制台输出 "✅ 流程图已生成"
6. ✅ 生成的节点可以单独拖动，连线自动跟随

## 📸 预期效果截图

### 对话框界面
```
┌─────────────────────────────────────────────────────────┐
│  🔀 Yunke Flow 图表生成器         [生成到白板] [取消] │
├─────────────────────────────────────────────────────────┤
│  💡 快速开始: [微服务架构 ▼]                           │
├────────────────────────┬────────────────────────────────┤
│ DSL 代码               │ 预览                           │
│                        │                                │
│ diagram "微服务" {     │    ┌─────┐    ┌─────┐        │
│   node frontend        │    │前端 │───→│网关 │        │
│   node gateway         │    └─────┘    └─────┘        │
│   ...                  │         │                      │
│ }                      │         ↓                      │
│                        │    ┌─────────────┐            │
│                        │    │  后端服务   │            │
│                        │    └─────────────┘            │
│                        │                                │
├────────────────────────┴────────────────────────────────┤
│  5 个节点 · 6 条连线                                    │
└─────────────────────────────────────────────────────────┘
```

### 生成的白板元素
- 蓝色圆角矩形节点 (#1e96ed)
- 白色文字居中显示
- 灰色正交连线 (#666666)
- 箭头指向目标节点

---

**祝测试顺利！** 🎉

如有问题，请查看控制台日志或参考 USAGE_GUIDE.md 和 IMPLEMENTATION_SUMMARY.md。

