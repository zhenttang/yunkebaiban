# BlockSuite åˆ—å¸ƒå±€åˆ‡æ¢åŠŸèƒ½æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### åŠŸèƒ½æè¿°
ä¸ºBlockSuiteç¼–è¾‘å™¨æ·»åŠ ç±»ä¼¼Notionçš„åˆ—å¸ƒå±€åˆ‡æ¢åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç‚¹å‡»æŒ‰é’®åœ¨å•åˆ—ã€åŒåˆ—ã€ä¸‰åˆ—ã€å››åˆ—ã€äº”åˆ—å¸ƒå±€é—´è‡ªç”±åˆ‡æ¢ï¼Œå®ç°çµæ´»çš„å†…å®¹å±•ç¤ºæ–¹å¼ã€‚

### è®¾è®¡ç›®æ ‡
- **éä¾µå…¥æ€§**: ä¸ä¿®æ”¹ç°æœ‰é¡µé¢ç»“æ„å’ŒBlockç³»ç»Ÿ
- **ç”¨æˆ·å‹å¥½**: ä¸€é”®åˆ‡æ¢ï¼Œæµç•…çš„è§†è§‰ä½“éªŒ
- **å“åº”å¼**: æ”¯æŒç§»åŠ¨ç«¯é€‚é…
- **æŒä¹…åŒ–**: ä¿å­˜æ¯ä¸ªæ–‡æ¡£çš„å¸ƒå±€åå¥½
- **æ™ºèƒ½åˆ†é…**: è‡ªåŠ¨ä¼˜åŒ–å†…å®¹åœ¨å„åˆ—é—´çš„åˆ†å¸ƒ

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

### 1. å¸ƒå±€æ¨¡å¼æ”¯æŒ
- **å•åˆ—å¸ƒå±€** (é»˜è®¤): ä¼ ç»Ÿçš„å‚ç›´å¸ƒå±€
- **åŒåˆ—å¸ƒå±€**: 2åˆ—å¹¶æ’æ˜¾ç¤º
- **ä¸‰åˆ—å¸ƒå±€**: 3åˆ—å¹¶æ’æ˜¾ç¤º  
- **å››åˆ—å¸ƒå±€**: 4åˆ—å¹¶æ’æ˜¾ç¤º
- **äº”åˆ—å¸ƒå±€**: 5åˆ—å¹¶æ’æ˜¾ç¤º

### 2. äº¤äº’åŠŸèƒ½
- **å·¥å…·æ åˆ‡æ¢**: é¡µé¢é¡¶éƒ¨å¸ƒå±€åˆ‡æ¢æŒ‰é’®
- **æ™ºèƒ½åˆ†é…**: ç°æœ‰å†…å®¹è‡ªåŠ¨åˆ†å¸ƒåˆ°å„åˆ—
- **æ‹–æ‹½è°ƒæ•´**: æ”¯æŒè°ƒæ•´åˆ—å®½åº¦(å¯é€‰)
- **å†…å®¹æ·»åŠ **: æ¯åˆ—åº•éƒ¨å¯æ·»åŠ æ–°å†…å®¹

### 3. å“åº”å¼è®¾è®¡
- **æ¡Œé¢ç«¯**: å®Œæ•´çš„å¤šåˆ—å¸ƒå±€
- **å¹³æ¿ç«¯**: è‡ªåŠ¨è°ƒæ•´åˆ—æ•°
- **ç§»åŠ¨ç«¯**: å¼ºåˆ¶å•åˆ—å¸ƒå±€

### 4. æ•°æ®æŒä¹…åŒ–
- **æœ¬åœ°å­˜å‚¨**: ä¿å­˜å¸ƒå±€é…ç½®åˆ°localStorage
- **æ–‡æ¡£çº§åˆ«**: æ¯ä¸ªæ–‡æ¡£ç‹¬ç«‹çš„å¸ƒå±€è®¾ç½®
- **å®æ—¶åŒæ­¥**: å¸ƒå±€å˜åŒ–å³æ—¶ä¿å­˜

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PageRootBlock                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      LayoutSwitcher (å·¥å…·æ )        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     LayoutRenderer (å¸ƒå±€æ¸²æŸ“å™¨)      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚Column1â”‚ â”‚Column2â”‚ â”‚Column3â”‚     â”‚ â”‚
â”‚  â”‚  â”‚       â”‚ â”‚       â”‚ â”‚       â”‚     â”‚ â”‚
â”‚  â”‚  â”‚Block Aâ”‚ â”‚Block Bâ”‚ â”‚Block Câ”‚     â”‚ â”‚
â”‚  â”‚  â”‚Block Dâ”‚ â”‚Block Eâ”‚ â”‚       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒæœåŠ¡å±‚

#### PageLayoutService (å¸ƒå±€çŠ¶æ€ç®¡ç†)
```typescript
class PageLayoutService {
  // å¸ƒå±€æ¨¡å¼ç®¡ç†
  setLayoutMode(mode: PageLayoutMode, docId: string): void
  getLayoutMode(docId: string): PageLayoutMode
  onLayoutModeChange(): Observable<PageLayoutMode>
  
  // å¸ƒå±€é…ç½®ç®¡ç†
  saveLayoutConfig(config: DocLayoutConfig): void
  loadLayoutConfig(docId: string): DocLayoutConfig
  
  // åˆ—å®½åº¦ç®¡ç†
  setColumnWidths(widths: number[], docId: string): void
  getColumnWidths(docId: string): number[]
}
```

#### ColumnDistributor (å†…å®¹åˆ†é…å™¨)
```typescript
class ColumnDistributor {
  // å†…å®¹åˆ†é…ç­–ç•¥
  distributeBlocks(blocks: Block[], columnCount: number): Block[][]
  balancedDistribute(blocks: Block[], columnCount: number): Block[][]
  
  // å†…å®¹é‡æ’
  redistributeOnModeChange(fromMode: PageLayoutMode, toMode: PageLayoutMode): void
}
```

### 3. UIç»„ä»¶å±‚

#### LayoutSwitcher (å¸ƒå±€åˆ‡æ¢å™¨)
```typescript
@customElement('layout-switcher')
class LayoutSwitcher extends LitElement {
  @property() docId: string
  @property() currentMode: PageLayoutMode
  
  render(): TemplateResult
  private _switchLayout(mode: PageLayoutMode): void
  private _renderModeButton(mode: PageLayoutMode): TemplateResult
}
```

#### LayoutRenderer (å¸ƒå±€æ¸²æŸ“å™¨)
```typescript
class LayoutRenderer {
  renderLayout(mode: PageLayoutMode, blocks: Block[]): TemplateResult
  renderColumn(columnIndex: number, blocks: Block[]): TemplateResult
  renderColumnContent(blocks: Block[]): TemplateResult
}
```

## ğŸ“± ç”¨æˆ·ç•Œé¢è®¾è®¡

### 1. å¸ƒå±€åˆ‡æ¢å·¥å…·æ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“„ æ–‡æ¡£æ ‡é¢˜              [â–Š] [â–Šâ–Š] [â–Šâ–Šâ–Š] [â–Šâ–Šâ–Šâ–Š] [â–Šâ–Šâ–Šâ–Šâ–Š]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½ç½®**: é¡µé¢æ ‡é¢˜å³ä¾§
**æ ·å¼**: ç®€æ´çš„å›¾æ ‡æŒ‰é’®ç»„
**çŠ¶æ€**: å½“å‰æ¨¡å¼é«˜äº®æ˜¾ç¤º

### 2. åˆ—å¸ƒå±€å±•ç¤º

#### å•åˆ—å¸ƒå±€ (é»˜è®¤)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Block A          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Block B          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Block C          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸‰åˆ—å¸ƒå±€ç¤ºä¾‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚Block Aâ”‚ â”‚Block Bâ”‚ â”‚Block Câ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Block Dâ”‚ â”‚Block Eâ”‚ â”‚   +   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”¤ â””â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   +   â”‚ â”‚   +   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å“åº”å¼æ–­ç‚¹è®¾è®¡

| å±å¹•å®½åº¦ | æœ€å¤§åˆ—æ•° | è¯´æ˜ |
|---------|---------|------|
| < 768px | 1åˆ— | ç§»åŠ¨ç«¯å¼ºåˆ¶å•åˆ— |
| 768px - 1024px | 2åˆ— | å¹³æ¿ç«¯æœ€å¤šåŒåˆ— |
| 1024px - 1440px | 4åˆ— | æ¡Œé¢ç«¯æ ‡å‡† |
| > 1440px | 5åˆ— | å¤§å±å¹•å…¨åŠŸèƒ½ |

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. æ•°æ®ç»“æ„å®šä¹‰

#### å¸ƒå±€æ¨¡å¼æšä¸¾
```typescript
export enum PageLayoutMode {
  Normal = 'normal',      // å•åˆ—
  TwoColumn = '2-column', // åŒåˆ—  
  ThreeColumn = '3-column', // ä¸‰åˆ—
  FourColumn = '4-column',  // å››åˆ—
  FiveColumn = '5-column'   // äº”åˆ—
}

export const LayoutModeConfig = {
  [PageLayoutMode.Normal]: { columns: 1, icon: 'â–Š', label: 'å•åˆ—' },
  [PageLayoutMode.TwoColumn]: { columns: 2, icon: 'â–Šâ–Š', label: 'åŒåˆ—' },
  [PageLayoutMode.ThreeColumn]: { columns: 3, icon: 'â–Šâ–Šâ–Š', label: 'ä¸‰åˆ—' },
  [PageLayoutMode.FourColumn]: { columns: 4, icon: 'â–Šâ–Šâ–Šâ–Š', label: 'å››åˆ—' },
  [PageLayoutMode.FiveColumn]: { columns: 5, icon: 'â–Šâ–Šâ–Šâ–Šâ–Š', label: 'äº”åˆ—' }
};
```

#### å¸ƒå±€é…ç½®æ¥å£
```typescript
interface DocLayoutConfig {
  docId: string;
  layoutMode: PageLayoutMode;
  columnWidths?: number[];     // å„åˆ—å®½åº¦æ¯”ä¾‹ [1, 1.5, 1, 2]
  lastModified: number;
  responsive: boolean;         // æ˜¯å¦å¯ç”¨å“åº”å¼
}

interface ColumnBlockData {
  columnIndex: number;
  blocks: string[];           // Block IDæ•°ç»„
  minWidth?: number;          // æœ€å°å®½åº¦é™åˆ¶
}
```

### 2. CSS Gridå¸ƒå±€å®ç°

#### åŸºç¡€æ ·å¼å®šä¹‰
```css
.column-layout-container {
  display: grid;
  gap: var(--column-gap, 24px);
  width: 100%;
  min-height: 100vh;
  transition: grid-template-columns 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* åŠ¨æ€åˆ—æ•°æ ·å¼ */
.column-layout-1 { grid-template-columns: 1fr; }
.column-layout-2 { grid-template-columns: 1fr 1fr; }
.column-layout-3 { grid-template-columns: 1fr 1fr 1fr; }
.column-layout-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
.column-layout-5 { grid-template-columns: 1fr 1fr 1fr 1fr 1fr; }

/* å“åº”å¼è®¾è®¡ */
@container (max-width: 768px) {
  .column-layout-container {
    grid-template-columns: 1fr !important;
  }
}

@container (max-width: 1024px) {
  .column-layout-3,
  .column-layout-4,
  .column-layout-5 {
    grid-template-columns: 1fr 1fr;
  }
}
```

#### åˆ—å†…å®¹æ ·å¼
```css
.column-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-height: 200px;
  padding: 16px;
  border-radius: 8px;
  background: var(--affine-background-secondary-color);
  border: 1px dashed var(--affine-border-color);
  transition: all 0.3s ease;
}

.column-content:hover {
  border-color: var(--affine-primary-color);
  background: var(--affine-hover-color);
}

.column-add-button {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 12px;
  color: var(--affine-text-secondary-color);
  cursor: pointer;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.column-add-button:hover {
  background: var(--affine-hover-color);
  color: var(--affine-text-primary-color);
}
```

### 3. çŠ¶æ€ç®¡ç†å®ç°

#### ä½¿ç”¨Preact Signals
```typescript
import { signal, computed } from '@preact/signals-core';

export class PageLayoutService {
  private _layoutMode$ = signal<PageLayoutMode>(PageLayoutMode.Normal);
  private _columnWidths$ = signal<number[]>([]);
  private _docConfigs$ = signal<Map<string, DocLayoutConfig>>(new Map());
  
  // è®¡ç®—å±æ€§
  readonly currentMode$ = computed(() => this._layoutMode$.value);
  readonly columnCount$ = computed(() => 
    LayoutModeConfig[this._layoutMode$.value].columns
  );
  
  // æ–¹æ³•å®ç°
  setLayoutMode(mode: PageLayoutMode, docId: string) {
    this._layoutMode$.value = mode;
    this._saveConfig(docId);
    this._notifyModeChange(mode);
  }
  
  private _saveConfig(docId: string) {
    const config: DocLayoutConfig = {
      docId,
      layoutMode: this._layoutMode$.value,
      columnWidths: this._columnWidths$.value,
      lastModified: Date.now(),
      responsive: true
    };
    
    localStorage.setItem(`layout-${docId}`, JSON.stringify(config));
    
    const configs = this._docConfigs$.value;
    configs.set(docId, config);
    this._docConfigs$.value = new Map(configs);
  }
}
```

### 4. å†…å®¹åˆ†é…ç®—æ³•

#### æ™ºèƒ½åˆ†é…ç­–ç•¥
```typescript
export class ColumnDistributor {
  distributeBlocks(blocks: Block[], columnCount: number): Block[][] {
    if (columnCount === 1) {
      return [blocks];
    }
    
    const columns: Block[][] = Array.from({length: columnCount}, () => []);
    const columnHeights: number[] = Array(columnCount).fill(0);
    
    // æŒ‰Blockä¼°ç®—é«˜åº¦æ’åºï¼Œä¼˜å…ˆåˆ†é…å¤§å—å†…å®¹
    const sortedBlocks = this._sortBlocksByEstimatedHeight(blocks);
    
    for (const block of sortedBlocks) {
      // æ‰¾åˆ°å½“å‰é«˜åº¦æœ€å°çš„åˆ—
      const minHeightIndex = columnHeights.indexOf(Math.min(...columnHeights));
      
      columns[minHeightIndex].push(block);
      columnHeights[minHeightIndex] += this._estimateBlockHeight(block);
    }
    
    return columns;
  }
  
  private _estimateBlockHeight(block: Block): number {
    // æ ¹æ®Blockç±»å‹ä¼°ç®—æ¸²æŸ“é«˜åº¦
    const baseHeight = 50; // åŸºç¡€é«˜åº¦
    
    switch (block.flavour) {
      case 'affine:paragraph':
        return baseHeight + (block.text?.length || 0) * 0.5;
      case 'affine:image':
        return 200; // å›¾ç‰‡é¢„ä¼°é«˜åº¦
      case 'affine:list':
        return baseHeight * (block.children?.length || 1);
      case 'affine:database':
        return 300; // æ•°æ®åº“è¡¨æ ¼é¢„ä¼°é«˜åº¦
      default:
        return baseHeight;
    }
  }
  
  private _sortBlocksByEstimatedHeight(blocks: Block[]): Block[] {
    return [...blocks].sort((a, b) => 
      this._estimateBlockHeight(b) - this._estimateBlockHeight(a)
    );
  }
}
```

## ğŸ¨ åŠ¨ç”»ä¸äº¤äº’è®¾è®¡

### 1. å¸ƒå±€åˆ‡æ¢åŠ¨ç”»
```css
@keyframes layoutTransition {
  0% {
    opacity: 0;
    transform: scale(0.95);
  }
  50% {
    opacity: 0.5;
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

.layout-switching {
  animation: layoutTransition 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

/* åˆ—å†…å®¹æ·¡å…¥æ•ˆæœ */
.column-content {
  animation: columnFadeIn 0.3s ease-out;
}

@keyframes columnFadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
```

### 2. äº¤äº’åé¦ˆ
```typescript
class LayoutTransitionManager {
  async switchLayout(fromMode: PageLayoutMode, toMode: PageLayoutMode) {
    // 1. æ·»åŠ åˆ‡æ¢åŠ¨ç”»ç±»
    this.container.classList.add('layout-switching');
    
    // 2. ç­‰å¾…å½“å‰å†…å®¹æ·¡å‡º
    await this._fadeOut();
    
    // 3. é‡æ–°åˆ†é…å†…å®¹
    const redistributedBlocks = this.distributor.redistribute(fromMode, toMode);
    
    // 4. æ¸²æŸ“æ–°å¸ƒå±€
    this._renderNewLayout(toMode, redistributedBlocks);
    
    // 5. æ·¡å…¥æ–°å†…å®¹
    await this._fadeIn();
    
    // 6. ç§»é™¤åŠ¨ç”»ç±»
    this.container.classList.remove('layout-switching');
    
    // 7. è§¦å‘å®Œæˆäº‹ä»¶
    this._dispatchLayoutChangeEvent(toMode);
  }
  
  private async _fadeOut(): Promise<void> {
    return new Promise(resolve => {
      this.container.style.opacity = '0';
      setTimeout(resolve, 150);
    });
  }
  
  private async _fadeIn(): Promise<void> {
    return new Promise(resolve => {
      this.container.style.opacity = '1';
      setTimeout(resolve, 300);
    });
  }
}
```

## ğŸ“¦ æ–‡ä»¶ç»“æ„è§„åˆ’

```
front/blocksuite/affine/
â”œâ”€â”€ layout/                          # æ–°å¢å¸ƒå±€åŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.ts                 # ä¸»å…¥å£
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ layout-service.ts    # å¸ƒå±€çŠ¶æ€ç®¡ç†æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ column-distributor.ts # å†…å®¹åˆ†é…å™¨
â”‚   â”‚   â”‚   â””â”€â”€ storage-service.ts   # æŒä¹…åŒ–æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ layout-switcher.ts   # å¸ƒå±€åˆ‡æ¢å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ layout-renderer.ts   # å¸ƒå±€æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â””â”€â”€ column-content.ts    # åˆ—å†…å®¹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.css.ts        # å¸ƒå±€æ ·å¼
â”‚   â”‚   â”‚   â”œâ”€â”€ animations.css.ts    # åŠ¨ç”»æ•ˆæœ
â”‚   â”‚   â”‚   â””â”€â”€ responsive.css.ts    # å“åº”å¼æ ·å¼
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ layout.ts            # ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ layout-calculator.ts # å¸ƒå±€è®¡ç®—å·¥å…·
â”‚   â”‚       â””â”€â”€ responsive-detector.ts # å“åº”å¼æ£€æµ‹
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ blocks/root/src/                 # ä¿®æ”¹æ ¹Block
â”‚   â””â”€â”€ page/
â”‚       â””â”€â”€ page-root-block.ts       # é›†æˆå¸ƒå±€åŠŸèƒ½
â””â”€â”€ widgets/toolbar/src/             # å¯é€‰: å·¥å…·æ é›†æˆ
    â””â”€â”€ components/
        â””â”€â”€ layout-toolbar.ts        # å·¥å…·æ å¸ƒå±€æŒ‰é’®
```

## ğŸ”Œ é›†æˆæ–¹æ¡ˆ

### 1. åœ¨PageRootBlockä¸­é›†æˆ
```typescript
// ä¿®æ”¹ page-root-block.ts
import { LayoutSwitcher } from '@blocksuite/affine-layout';
import { PageLayoutService } from '@blocksuite/affine-layout/services';

export class PageRootBlockComponent extends BlockComponent {
  private layoutService = new PageLayoutService();
  
  @state()
  private accessor _layoutMode = PageLayoutMode.Normal;
  
  override connectedCallback() {
    super.connectedCallback();
    
    // åŠ è½½ä¿å­˜çš„å¸ƒå±€é…ç½®
    const savedConfig = this.layoutService.loadLayoutConfig(this.doc.id);
    if (savedConfig) {
      this._layoutMode = savedConfig.layoutMode;
    }
    
    // ç›‘å¬å¸ƒå±€å˜åŒ–
    this.layoutService.onLayoutModeChange().subscribe(mode => {
      this._layoutMode = mode;
      this.requestUpdate();
    });
  }
  
  override renderBlock() {
    return html`
      <div class="affine-page-root-block-container">
        <!-- å¸ƒå±€åˆ‡æ¢å™¨ -->
        <layout-switcher 
          .docId=${this.doc.id}
          .currentMode=${this._layoutMode}
          .layoutService=${this.layoutService}>
        </layout-switcher>
        
        <!-- å†…å®¹æ¸²æŸ“ -->
        ${this._renderContent()}
      </div>
    `;
  }
  
  private _renderContent() {
    return this.layoutService.renderLayout(
      this._layoutMode, 
      this.model.children
    );
  }
}
```

### 2. åœ¨ä¸»é…ç½®ä¸­æ³¨å†Œ
```typescript
// ä¿®æ”¹ affine/all/src/effects.ts
import { LayoutExtension } from '@blocksuite/affine-layout';

export function effects() {
  // ... ç°æœ‰ä»£ç 
  
  // æ³¨å†Œå¸ƒå±€æ‰©å±•
  LayoutExtension.setup();
}
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. è™šæ‹Ÿæ»šåŠ¨ (å¤§é‡å†…å®¹æ—¶)
```typescript
class VirtualColumnRenderer {
  private visibleRange = { start: 0, end: 10 };
  
  renderColumn(blocks: Block[], columnIndex: number) {
    const visibleBlocks = blocks.slice(
      this.visibleRange.start, 
      this.visibleRange.end
    );
    
    return html`
      <div class="virtual-column" style="height: ${this.totalHeight}px">
        <div class="visible-content" style="transform: translateY(${this.offsetY}px)">
          ${visibleBlocks.map(block => this.renderBlock(block))}
        </div>
      </div>
    `;
  }
}
```

### 2. æ‡’åŠ è½½ (åˆ—å†…å®¹)
```typescript
class LazyColumnLoader {
  private intersectionObserver = new IntersectionObserver(
    this.onColumnVisible.bind(this)
  );
  
  private onColumnVisible(entries: IntersectionObserverEntry[]) {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const columnIndex = parseInt(entry.target.getAttribute('data-column')!);
        this.loadColumnContent(columnIndex);
      }
    });
  }
}
```

### 3. ç¼“å­˜ä¼˜åŒ–
```typescript
class LayoutCache {
  private layoutCache = new Map<string, RenderedLayout>();
  
  getCachedLayout(mode: PageLayoutMode, blocksHash: string): RenderedLayout | null {
    const key = `${mode}-${blocksHash}`;
    return this.layoutCache.get(key) || null;
  }
  
  setCachedLayout(mode: PageLayoutMode, blocksHash: string, layout: RenderedLayout) {
    const key = `${mode}-${blocksHash}`;
    this.layoutCache.set(key, layout);
    
    // é™åˆ¶ç¼“å­˜å¤§å°
    if (this.layoutCache.size > 50) {
      const firstKey = this.layoutCache.keys().next().value;
      this.layoutCache.delete(firstKey);
    }
  }
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
```typescript
describe('PageLayoutService', () => {
  test('should switch layout mode correctly', () => {
    const service = new PageLayoutService();
    service.setLayoutMode(PageLayoutMode.ThreeColumn, 'test-doc');
    expect(service.getLayoutMode('test-doc')).toBe(PageLayoutMode.ThreeColumn);
  });
  
  test('should persist layout config', () => {
    const service = new PageLayoutService();
    service.setLayoutMode(PageLayoutMode.TwoColumn, 'test-doc');
    
    // æ¨¡æ‹Ÿé¡µé¢é‡æ–°åŠ è½½
    const newService = new PageLayoutService();
    expect(newService.getLayoutMode('test-doc')).toBe(PageLayoutMode.TwoColumn);
  });
});

describe('ColumnDistributor', () => {
  test('should distribute blocks evenly', () => {
    const distributor = new ColumnDistributor();
    const blocks = createMockBlocks(6);
    const columns = distributor.distributeBlocks(blocks, 3);
    
    expect(columns).toHaveLength(3);
    expect(columns[0]).toHaveLength(2);
    expect(columns[1]).toHaveLength(2);
    expect(columns[2]).toHaveLength(2);
  });
});
```

### 2. é›†æˆæµ‹è¯•
```typescript
describe('Layout Integration', () => {
  test('should render different layout modes', async () => {
    const container = await setupTestEditor();
    const layoutSwitcher = container.querySelector('layout-switcher');
    
    // æµ‹è¯•åˆ‡æ¢åˆ°ä¸‰åˆ—å¸ƒå±€
    layoutSwitcher.switchTo(PageLayoutMode.ThreeColumn);
    await waitForLayoutChange();
    
    const columns = container.querySelectorAll('.column-content');
    expect(columns).toHaveLength(3);
  });
  
  test('should handle responsive breakpoints', async () => {
    const container = await setupTestEditor();
    
    // æ¨¡æ‹Ÿç§»åŠ¨ç«¯å±å¹•
    Object.defineProperty(window, 'innerWidth', { value: 600 });
    window.dispatchEvent(new Event('resize'));
    
    const columns = container.querySelectorAll('.column-content');
    expect(columns).toHaveLength(1); // åº”è¯¥å¼ºåˆ¶å•åˆ—
  });
});
```

### 3. E2Eæµ‹è¯•
```typescript
describe('Layout E2E Tests', () => {
  test('user can switch between layout modes', async () => {
    await page.goto('/editor');
    
    // ç‚¹å‡»ä¸‰åˆ—å¸ƒå±€æŒ‰é’®
    await page.click('[data-layout-mode="3-column"]');
    
    // éªŒè¯å¸ƒå±€å·²æ”¹å˜
    const columns = await page.$$('.column-content');
    expect(columns).toHaveLength(3);
    
    // éªŒè¯å†…å®¹å·²åˆ†é…åˆ°å„åˆ—
    for (let i = 0; i < 3; i++) {
      const columnContent = await columns[i].$('.affine-block-children-container');
      expect(columnContent).toBeTruthy();
    }
  });
  
  test('layout preference is persisted', async () => {
    await page.goto('/editor');
    
    // åˆ‡æ¢åˆ°åŒåˆ—å¸ƒå±€
    await page.click('[data-layout-mode="2-column"]');
    
    // åˆ·æ–°é¡µé¢
    await page.reload();
    
    // éªŒè¯å¸ƒå±€è®¾ç½®è¢«ä¿æŒ
    const activeButton = await page.$('[data-layout-mode="2-column"].active');
    expect(activeButton).toBeTruthy();
  });
});
```

## ğŸš€ éƒ¨ç½²ä¸å‘å¸ƒ

### 1. æ„å»ºé…ç½®
```json
// package.json
{
  "name": "@blocksuite/affine-layout",
  "version": "1.0.0",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "rollup -c",
    "test": "vitest",
    "test:e2e": "playwright test"
  }
}
```

### 2. å‘å¸ƒæ£€æŸ¥æ¸…å•
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ > 90%
- [ ] E2Eæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•: å¸ƒå±€åˆ‡æ¢ < 200ms
- [ ] å…¼å®¹æ€§æµ‹è¯•: Chromeã€Firefoxã€Safari
- [ ] ç§»åŠ¨ç«¯æµ‹è¯•: iOS Safariã€Android Chrome
- [ ] æ–‡æ¡£å®Œæ•´æ€§æ£€æŸ¥
- [ ] ä»£ç è¦†ç›–ç‡ > 85%

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-07-27  
**æœ€åæ›´æ–°**: 2025-07-27  
**ä½œè€…**: Claude & å¼€å‘å›¢é˜Ÿ  