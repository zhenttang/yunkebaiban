# ç‚¹å‡»"ç²¾é€‰"å’Œ"æ ‡ç­¾"æ ‡ç­¾é¡µçš„å®Œæ•´ä»£ç è·¯å¾„åˆ†æ

## æ¦‚è¿°

å½“ç”¨æˆ·ç‚¹å‡»é¡¶éƒ¨æ ‡ç­¾æ ä¸­çš„"ç²¾é€‰"ï¼ˆCollectionsï¼‰æˆ–"æ ‡ç­¾"ï¼ˆTagsï¼‰æ ‡ç­¾æ—¶ï¼Œä»£ç ä¼šç»è¿‡ä»¥ä¸‹è·¯å¾„ï¼š

---

## ç‚¹å‡»"ç²¾é€‰"æ ‡ç­¾çš„å®Œæ•´ä»£ç è·¯å¾„

### 1. ç”¨æˆ·äº¤äº’å±‚

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/components/explorer/header/navigation.tsx`

**ä»£ç ä½ç½®ï¼š** ç¬¬ 7-26 è¡Œå®šä¹‰äº†å¯¼èˆªé¡¹
```typescript
const items = [
  { value: 'docs', label: 'com.yunke.docs.header', to: '/all' },
  { value: 'collections', label: 'com.yunke.collections.header', to: '/collection' },
  { value: 'tags', label: 'Tags', to: '/tag' },
]
```

**æ¸²æŸ“é€»è¾‘ï¼š** ç¬¬ 30-53 è¡Œ
- `ExplorerNavigation` ç»„ä»¶æ¸²æŸ“ä¸‰ä¸ªæ ‡ç­¾
- ä½¿ç”¨ `WorkbenchLink` ç»„ä»¶åŒ…è£¹æ¯ä¸ªæ ‡ç­¾

### 2. å¯¼èˆªé“¾æ¥ç»„ä»¶

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/modules/workbench/view/workbench-link.tsx`

**ç‚¹å‡»å¤„ç†ï¼š** ç¬¬ 62-74 è¡Œ `handleClick` å‡½æ•°
```typescript
const handleClick = useAsyncCallback(
  async (event: React.MouseEvent<HTMLAnchorElement>) => {
    onClick?.(event);  // è§¦å‘åŸ‹ç‚¹è·Ÿè¸ª
    if (event.defaultPrevented) return;
    const at = inferOpenAt(event);
    workbench.open(to, { at, replaceHistory, show: false });
    event.preventDefault();
    event.stopPropagation();
  },
  [onClick, replaceHistory, to, workbench]
);
```

**å…³é”®è°ƒç”¨ï¼š**
- `workbench.open('/collection', { at, replaceHistory, show: false })`

### 3. Workbench å®ä½“ - open æ–¹æ³•

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/modules/workbench/entities/workbench.ts`

**open æ–¹æ³•ï¼š** ç¬¬ 138-162 è¡Œ
```typescript
open(to: To, option: WorkbenchOpenOptions = {}) {
  if (option.at === 'new-tab') {
    this.newTab(to, { show: option.show });
  } else {
    const { at = 'active', replaceHistory = false } = option;
    let view = this.viewAt(at);
    
    if (!view) {
      const newIndex = this.createView(at, to, option.show);
      view = this.viewAt(newIndex);
    } else {
      if (replaceHistory) {
        view.history.replace(to);
      } else {
        view.history.push(to);  // ğŸ‘ˆ å…³é”®ï¼šæ¨å…¥æ–°çš„è·¯ç”±åˆ° view çš„å†å²æ ˆ
      }
    }
  }
}
```

**å…³é”®æ“ä½œï¼š**
- è·å–å½“å‰æ´»è·ƒçš„ View
- è°ƒç”¨ `view.history.push('/collection')` æ›´æ–°è·¯ç”±

### 4. View å®ä½“ - history.push

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/modules/workbench/entities/view.ts`

**push æ–¹æ³•ï¼š** ç¬¬ 145-158 è¡Œ
```typescript
push(path: To) {
  this.history.push(path);  // è°ƒç”¨å†…éƒ¨ history çš„ push æ–¹æ³•
}
```

**location$ ç›‘å¬ï¼š** ç¬¬ 67-82 è¡Œ
- `location$` æ˜¯ä¸€ä¸ª LiveDataï¼Œç›‘å¬ history çš„å˜åŒ–
- å½“ history.push è¢«è°ƒç”¨æ—¶ï¼Œä¼šè§¦å‘ location$ çš„æ›´æ–°

### 5. æµè§ˆå™¨é€‚é…å™¨ - åŒæ­¥ View å’Œæµè§ˆå™¨è·¯ç”±

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/modules/workbench/view/browser-adapter.ts`

**useBindWorkbenchToBrowserRouter Hookï¼š** ç¬¬ 25-96 è¡Œ

**ç›‘å¬ View ä½ç½®å˜åŒ–ï¼š** ç¬¬ 34-54 è¡Œ
```typescript
useEffect(() => {
  return view.history.listen(update => {
    if (update.action === 'POP') return;
    
    const newBrowserLocation = viewLocationToBrowserLocation(
      update.location,
      basename
    );
    
    navigate(newBrowserLocation, {
      state: 'fromView,' + newBrowserLocation.key,
      replace: update.action === 'REPLACE' || newBrowserLocation.state === 'fromBrowser',
    });
  });
}, [basename, browserLocation, navigate, view]);
```

**å…³é”®æ“ä½œï¼š**
- ç›‘å¬ `view.history` çš„å˜åŒ–
- å½“ view çš„è·¯å¾„å˜ä¸º `/collection` æ—¶ï¼Œè°ƒç”¨ `navigate()` æ›´æ–°æµè§ˆå™¨ URL
- æœ€ç»ˆæµè§ˆå™¨ URL å˜ä¸ºï¼š`/workspace/{workspaceId}/collection`

### 6. React Router è·¯ç”±åŒ¹é…

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/desktop/workbench-router.ts`

**è·¯ç”±é…ç½®ï¼š** ç¬¬ 8-11 è¡Œ
```typescript
{
  path: '/collection',
  lazy: () => import('./pages/workspace/all-collection'),
}
```

**è·¯ç”±åŒ¹é…ï¼š**
- React Router åŒ¹é…åˆ° `/collection` è·¯å¾„
- æ‡’åŠ è½½ `all-collection` ç»„ä»¶

### 7. ViewRoot ç»„ä»¶ - æ¸²æŸ“è·¯ç”±

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/modules/workbench/view/view-root.tsx`

**ViewRoot ç»„ä»¶ï¼š** ç¬¬ 13-63 è¡Œ
```typescript
export const ViewRoot = ({ view, routes }: { view: View; routes: RouteObject[] }) => {
  const viewRouter = useMemo(() => createMemoryRouter(routes), [routes]);
  const location = useLiveData(view.location$);

  useLayoutEffect(() => {
    viewRouter.navigate(location).catch(err => {
      console.error('[ViewRoot] å¯¼èˆªé”™è¯¯', err);
    });
  }, [location, view, viewRouter]);

  return (
    <RouterProvider router={viewRouter} />
  );
};
```

**å…³é”®æ“ä½œï¼š**
- ä½¿ç”¨ `createMemoryRouter` åˆ›å»ºå†…å­˜è·¯ç”±
- ç›‘å¬ `view.location$` çš„å˜åŒ–
- å½“ location å˜åŒ–æ—¶ï¼Œè°ƒç”¨ `viewRouter.navigate()` æ›´æ–°è·¯ç”±

### 8. RouteContainer ç»„ä»¶ - æ¸²æŸ“å­è·¯ç”±

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/modules/workbench/view/route-container.tsx`

**RouteContainer ç»„ä»¶ï¼š** ç¬¬ 45-86 è¡Œ
```typescript
export const RouteContainer = () => {
  return (
    <div className={styles.root}>
      <YunkeErrorBoundary>
        <Suspense fallback={<div>åŠ è½½ä¸­...</div>}>
          <Outlet />  {/* ğŸ‘ˆ æ¸²æŸ“åŒ¹é…çš„å­è·¯ç”±ç»„ä»¶ */}
        </Suspense>
      </YunkeErrorBoundary>
    </div>
  );
};
```

**å…³é”®æ“ä½œï¼š**
- `<Outlet />` æ¸²æŸ“åŒ¹é…çš„å­è·¯ç”±ç»„ä»¶
- æ­¤æ—¶ä¼šæ¸²æŸ“ `AllCollection` ç»„ä»¶

### 9. AllCollection é¡µé¢ç»„ä»¶

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/desktop/pages/workspace/all-collection/index.tsx`

**ç»„ä»¶æ¸²æŸ“ï¼š** ç¬¬ 23-97 è¡Œ
```typescript
export const AllCollection = () => {
  const t = useI18n();
  const currentWorkspace = useService(WorkspaceService).workspace;
  const collectionService = useService(CollectionService);
  const collections = useLiveData(collectionService.collections$);
  
  return (
    <>
      <ViewTitle title={t['Collections']()} />
      <ViewIcon icon="collection" />
      <ViewHeader>
        <AllCollectionHeader />
      </ViewHeader>
      <ViewBody>
        <VirtualizedCollectionList />
      </ViewBody>
      <AllDocSidebarTabs />
    </>
  );
};
```

**å…³é”®æ“ä½œï¼š**
- è®¾ç½®é¡µé¢æ ‡é¢˜ä¸º "Collections"
- è®¾ç½®å›¾æ ‡ä¸º "collection"
- æ¸²æŸ“ `AllCollectionHeader`ï¼ˆåŒ…å«å¯¼èˆªæ ‡ç­¾ï¼‰
- æ¸²æŸ“ `VirtualizedCollectionList` æ˜¾ç¤ºç²¾é€‰åˆ—è¡¨

### 10. AllCollectionHeader ç»„ä»¶

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/desktop/pages/workspace/all-collection/header.tsx`

**ç»„ä»¶æ¸²æŸ“ï¼š** ç¬¬ 10-36 è¡Œ
```typescript
export const AllCollectionHeader = ({ ... }) => {
  return (
    <Header
      left={<ExplorerNavigation active={'collections'} />}  // ğŸ‘ˆ é«˜äº®"ç²¾é€‰"æ ‡ç­¾
      right={...}
    />
  );
};
```

**å…³é”®æ“ä½œï¼š**
- æ¸²æŸ“ `ExplorerNavigation` ç»„ä»¶ï¼Œ`active` å±æ€§è®¾ç½®ä¸º `'collections'`
- è¿™ä¼šè®©"ç²¾é€‰"æ ‡ç­¾æ˜¾ç¤ºä¸ºæ¿€æ´»çŠ¶æ€

---

## ç‚¹å‡»"æ ‡ç­¾"æ ‡ç­¾çš„å®Œæ•´ä»£ç è·¯å¾„

### 1-6. ä¸"ç²¾é€‰"ç›¸åŒ

è·¯å¾„ä¸"ç²¾é€‰"ç›¸åŒï¼Œç›´åˆ°è·¯ç”±åŒ¹é…é˜¶æ®µï¼š

### 7. React Router è·¯ç”±åŒ¹é…

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/desktop/workbench-router.ts`

**è·¯ç”±é…ç½®ï¼š** ç¬¬ 17-19 è¡Œ
```typescript
{
  path: '/tag',
  lazy: () => import('./pages/workspace/all-tag'),
}
```

**è·¯ç”±åŒ¹é…ï¼š**
- React Router åŒ¹é…åˆ° `/tag` è·¯å¾„
- æ‡’åŠ è½½ `all-tag` ç»„ä»¶

### 8-9. ä¸"ç²¾é€‰"ç›¸åŒï¼ˆRouteContainer æ¸²æŸ“ï¼‰

### 10. AllTag é¡µé¢ç»„ä»¶

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/desktop/pages/workspace/all-tag/index.tsx`

**ç»„ä»¶æ¸²æŸ“ï¼š** ç¬¬ 41-83 è¡Œ
```typescript
export const AllTag = () => {
  const tagList = useService(TagService).tagList;
  const tags = useLiveData(tagList.tags$);
  const tagMetas: TagMeta[] = useLiveData(tagList.tagMetas$);
  
  return (
    <>
      <ViewTitle title={t['Tags']()} />
      <ViewIcon icon="tag" />
      <ViewHeader>
        <AllTagHeader />
      </ViewHeader>
      <ViewBody>
        <VirtualizedTagList tags={tags} tagMetas={tagMetas} />
      </ViewBody>
      <AllDocSidebarTabs />
    </>
  );
};
```

**å…³é”®æ“ä½œï¼š**
- è®¾ç½®é¡µé¢æ ‡é¢˜ä¸º "Tags"
- è®¾ç½®å›¾æ ‡ä¸º "tag"
- æ¸²æŸ“ `AllTagHeader`ï¼ˆåŒ…å«å¯¼èˆªæ ‡ç­¾ï¼‰
- æ¸²æŸ“ `VirtualizedTagList` æ˜¾ç¤ºæ ‡ç­¾åˆ—è¡¨

### 11. AllTagHeader ç»„ä»¶

**æ–‡ä»¶ï¼š** `packages/frontend/core/src/desktop/pages/workspace/all-tag/header.tsx`

**ç»„ä»¶æ¸²æŸ“ï¼š** ç¬¬ 4-6 è¡Œ
```typescript
export const AllTagHeader = () => {
  return <Header left={<ExplorerNavigation active={'tags'} />} />;
};
```

**å…³é”®æ“ä½œï¼š**
- æ¸²æŸ“ `ExplorerNavigation` ç»„ä»¶ï¼Œ`active` å±æ€§è®¾ç½®ä¸º `'tags'`
- è¿™ä¼šè®©"æ ‡ç­¾"æ ‡ç­¾æ˜¾ç¤ºä¸ºæ¿€æ´»çŠ¶æ€

---

## å®Œæ•´ä»£ç è°ƒç”¨é“¾æ€»ç»“

### ç‚¹å‡»"ç²¾é€‰"æ ‡ç­¾ï¼š

```
1. ExplorerNavigation (navigation.tsx:35-49)
   â””â”€> WorkbenchLink ç»„ä»¶æ¸²æŸ“ï¼Œto="/collection"
   
2. WorkbenchLink.handleClick (workbench-link.tsx:62-74)
   â””â”€> workbench.open('/collection', { at, replaceHistory, show: false })
   
3. Workbench.open (workbench.ts:138-162)
   â””â”€> view.history.push('/collection')
   
4. View.push (view.ts:145-158)
   â””â”€> this.history.push('/collection')
   â””â”€> è§¦å‘ location$ æ›´æ–°
   
5. useBindWorkbenchToBrowserRouter (browser-adapter.ts:34-54)
   â””â”€> view.history.listen() ç›‘å¬åˆ°å˜åŒ–
   â””â”€> navigate(newBrowserLocation) æ›´æ–°æµè§ˆå™¨ URL
   
6. React Router è·¯ç”±åŒ¹é… (workbench-router.ts:8-11)
   â””â”€> åŒ¹é…åˆ° path: '/collection'
   â””â”€> æ‡’åŠ è½½ all-collection ç»„ä»¶
   
7. ViewRoot (view-root.tsx:32-45)
   â””â”€> viewRouter.navigate(location) æ›´æ–°å†…å­˜è·¯ç”±
   
8. RouteContainer (route-container.tsx:78-81)
   â””â”€> <Outlet /> æ¸²æŸ“å­è·¯ç”±
   
9. AllCollection (all-collection/index.tsx:23-93)
   â””â”€> æ¸²æŸ“ç²¾é€‰åˆ—è¡¨é¡µé¢
   â””â”€> æ¸²æŸ“ AllCollectionHeader
   
10. AllCollectionHeader (all-collection/header.tsx:10-36)
    â””â”€> ExplorerNavigation active={'collections'}
    â””â”€> é«˜äº®"ç²¾é€‰"æ ‡ç­¾
```

### ç‚¹å‡»"æ ‡ç­¾"æ ‡ç­¾ï¼š

```
1. ExplorerNavigation (navigation.tsx:35-49)
   â””â”€> WorkbenchLink ç»„ä»¶æ¸²æŸ“ï¼Œto="/tag"
   
2. WorkbenchLink.handleClick (workbench-link.tsx:62-74)
   â””â”€> workbench.open('/tag', { at, replaceHistory, show: false })
   
3. Workbench.open (workbench.ts:138-162)
   â””â”€> view.history.push('/tag')
   
4. View.push (view.ts:145-158)
   â””â”€> this.history.push('/tag')
   â””â”€> è§¦å‘ location$ æ›´æ–°
   
5. useBindWorkbenchToBrowserRouter (browser-adapter.ts:34-54)
   â””â”€> view.history.listen() ç›‘å¬åˆ°å˜åŒ–
   â””â”€> navigate(newBrowserLocation) æ›´æ–°æµè§ˆå™¨ URL
   
6. React Router è·¯ç”±åŒ¹é… (workbench-router.ts:17-19)
   â””â”€> åŒ¹é…åˆ° path: '/tag'
   â””â”€> æ‡’åŠ è½½ all-tag ç»„ä»¶
   
7. ViewRoot (view-root.tsx:32-45)
   â””â”€> viewRouter.navigate(location) æ›´æ–°å†…å­˜è·¯ç”±
   
8. RouteContainer (route-container.tsx:78-81)
   â””â”€> <Outlet /> æ¸²æŸ“å­è·¯ç”±
   
9. AllTag (all-tag/index.tsx:41-83)
   â””â”€> æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨é¡µé¢
   â””â”€> æ¸²æŸ“ AllTagHeader
   
10. AllTagHeader (all-tag/header.tsx:4-6)
    â””â”€> ExplorerNavigation active={'tags'}
    â””â”€> é«˜äº®"æ ‡ç­¾"æ ‡ç­¾
```

---

## å…³é”®æ–‡ä»¶æ¸…å•

### å¯¼èˆªç»„ä»¶
- `packages/frontend/core/src/components/explorer/header/navigation.tsx` - å¯¼èˆªæ ‡ç­¾ç»„ä»¶
- `packages/frontend/core/src/modules/workbench/view/workbench-link.tsx` - å¯¼èˆªé“¾æ¥ç»„ä»¶

### è·¯ç”±æ ¸å¿ƒ
- `packages/frontend/core/src/modules/workbench/entities/workbench.ts` - Workbench å®ä½“ï¼Œopen æ–¹æ³•
- `packages/frontend/core/src/modules/workbench/entities/view.ts` - View å®ä½“ï¼Œhistory ç®¡ç†
- `packages/frontend/core/src/modules/workbench/view/browser-adapter.ts` - æµè§ˆå™¨è·¯ç”±é€‚é…å™¨
- `packages/frontend/core/src/modules/workbench/view/view-root.tsx` - View æ ¹ç»„ä»¶
- `packages/frontend/core/src/modules/workbench/view/route-container.tsx` - è·¯ç”±å®¹å™¨ç»„ä»¶

### è·¯ç”±é…ç½®
- `packages/frontend/core/src/desktop/workbench-router.ts` - å·¥ä½œå°è·¯ç”±é…ç½®
- `packages/frontend/core/src/desktop/router.tsx` - æ¡Œé¢ç«¯æ ¹è·¯ç”±é…ç½®

### é¡µé¢ç»„ä»¶
- `packages/frontend/core/src/desktop/pages/workspace/all-collection/index.tsx` - ç²¾é€‰é¡µé¢
- `packages/frontend/core/src/desktop/pages/workspace/all-collection/header.tsx` - ç²¾é€‰é¡µé¢å¤´éƒ¨
- `packages/frontend/core/src/desktop/pages/workspace/all-tag/index.tsx` - æ ‡ç­¾é¡µé¢
- `packages/frontend/core/src/desktop/pages/workspace/all-tag/header.tsx` - æ ‡ç­¾é¡µé¢å¤´éƒ¨

### æœåŠ¡å±‚
- `packages/frontend/core/src/modules/workbench/services/workbench.ts` - Workbench æœåŠ¡
- `packages/frontend/core/src/modules/collection` - Collection æœåŠ¡ï¼ˆç²¾é€‰ç›¸å…³ï¼‰
- `packages/frontend/core/src/modules/tag` - Tag æœåŠ¡ï¼ˆæ ‡ç­¾ç›¸å…³ï¼‰

---

## æ•°æ®æµè¯´æ˜

### çŠ¶æ€ç®¡ç†
- **Workbench**: ç®¡ç†å¤šä¸ª Viewï¼ˆè§†å›¾ï¼‰
- **View**: æ¯ä¸ª View æœ‰ç‹¬ç«‹çš„ history å’Œ location
- **LiveData**: ä½¿ç”¨å“åº”å¼æ•°æ®æµç®¡ç†çŠ¶æ€å˜åŒ–
- **React Router**: å¤„ç†è·¯ç”±åŒ¹é…å’Œç»„ä»¶æ¸²æŸ“

### åŒå‘åŒæ­¥
1. **View â†’ æµè§ˆå™¨**: å½“ View çš„ history å˜åŒ–æ—¶ï¼Œé€šè¿‡ `browser-adapter` åŒæ­¥åˆ°æµè§ˆå™¨ URL
2. **æµè§ˆå™¨ â†’ View**: å½“æµè§ˆå™¨ URL å˜åŒ–æ—¶ï¼Œé€šè¿‡ `browser-adapter` åŒæ­¥åˆ° View çš„ history

### è·¯ç”±åŒ¹é…
- ä½¿ç”¨ React Router çš„ `createMemoryRouter` åˆ›å»ºå†…å­˜è·¯ç”±
- æ¯ä¸ª View éƒ½æœ‰ç‹¬ç«‹çš„è·¯ç”±å®ä¾‹
- é€šè¿‡ `<Outlet />` æ¸²æŸ“åŒ¹é…çš„å­è·¯ç”±ç»„ä»¶

---

## ç‰¹æ®Šè¯´æ˜

1. **åŸ‹ç‚¹è·Ÿè¸ª**: åœ¨ `navigation.tsx:41-45` ä¸­ï¼Œæ¯æ¬¡ç‚¹å‡»éƒ½ä¼šè§¦å‘åŸ‹ç‚¹ï¼š
   ```typescript
   onClick={() => {
     track.allDocs.header.navigation.navigateAllDocsRouter({
       control: item.value,
     });
   }}
   ```

2. **è·¯ç”±æ‡’åŠ è½½**: ä½¿ç”¨ React Router çš„ `lazy()` è¿›è¡Œä»£ç åˆ†å‰²ï¼ŒæŒ‰éœ€åŠ è½½é¡µé¢ç»„ä»¶

3. **View éš”ç¦»**: æ¯ä¸ª View æœ‰ç‹¬ç«‹çš„ history æ ˆï¼Œæ”¯æŒåˆ†å±è§†å›¾

4. **URL æ„å»º**: æœ€ç»ˆæµè§ˆå™¨ URL æ ¼å¼ä¸º `/workspace/{workspaceId}/collection` æˆ– `/workspace/{workspaceId}/tag`

