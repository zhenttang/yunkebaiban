# äº‘å®¢ç™½æ¿æ¡Œé¢ç«¯ä¿å­˜é€»è¾‘åˆ†æ

> æœ¬æ–‡æ¡£åˆ†ææ¡Œé¢ç«¯ï¼ˆElectronï¼‰çš„åˆå§‹åŒ–æµç¨‹ã€ç¦»çº¿ä¿å­˜ä¸äº‘ä¿å­˜çš„è§¦å‘æ—¶æœºå’Œä»£ç é€»è¾‘ã€‚

---

## ç›®å½•

1. [æ•´ä½“æ¶æ„](#ä¸€æ•´ä½“æ¶æ„)
2. [æ¡Œé¢ç«¯åˆå§‹åŒ–æµç¨‹](#äºŒæ¡Œé¢ç«¯åˆå§‹åŒ–æµç¨‹)
3. [å­˜å‚¨ç±»å‹é€‰æ‹©é€»è¾‘](#ä¸‰å­˜å‚¨ç±»å‹é€‰æ‹©é€»è¾‘)
4. [äº‘åŒæ­¥å¼€å…³ä½¿ç”¨æŒ‡å—](#å››äº‘åŒæ­¥å¼€å…³ä½¿ç”¨æŒ‡å—)
5. [ç¦»çº¿ä¿å­˜è§¦å‘æ—¶æœº](#äº”ç¦»çº¿ä¿å­˜è§¦å‘æ—¶æœº)
6. [äº‘ä¿å­˜è§¦å‘æ—¶æœº](#å…­äº‘ä¿å­˜è§¦å‘æ—¶æœº)
7. [æ ¸å¿ƒä»£ç è·¯å¾„](#ä¸ƒæ ¸å¿ƒä»£ç è·¯å¾„)
8. [å…³é”®æ–‡ä»¶ç´¢å¼•](#å…«å…³é”®æ–‡ä»¶ç´¢å¼•)

---

## ä¸€ã€æ•´ä½“æ¶æ„

### 1.1 ä¸‰è¿›ç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Electron æ¡Œé¢ç«¯æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Main Processâ”‚â—„â”€â”€â–ºâ”‚Helper Processâ”‚â—„â”€â”€â–ºâ”‚    Renderer Process        â”‚ â”‚
â”‚  â”‚  (ä¸»è¿›ç¨‹)    â”‚    â”‚  (ç‹¬ç«‹è¿›ç¨‹)   â”‚    â”‚     (æ¸²æŸ“è¿›ç¨‹/å‰ç«¯)         â”‚ â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚                             â”‚ â”‚
â”‚  â”‚ ãƒ»çª—å£ç®¡ç†   â”‚    â”‚ ãƒ»SQLiteæ“ä½œ â”‚    â”‚ ãƒ»React UI                 â”‚ â”‚
â”‚  â”‚ ãƒ»IPCè·¯ç”±   â”‚    â”‚ ãƒ»æ–‡ä»¶I/O    â”‚    â”‚ ãƒ»Yjs æ–‡æ¡£                  â”‚ â”‚
â”‚  â”‚ ãƒ»ç³»ç»Ÿå¯¹è¯æ¡† â”‚    â”‚ ãƒ»nbstore    â”‚    â”‚ ãƒ»WorkspaceEngine          â”‚ â”‚
â”‚  â”‚ ãƒ»æ›´æ–°æ£€æŸ¥  â”‚    â”‚ ãƒ»workspace  â”‚    â”‚ ãƒ»DocFrontend              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                   â”‚                        â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                    MessagePort / IPC é€šä¿¡                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æµæ¶æ„

```
                    ç”¨æˆ·ç¼–è¾‘æ–‡æ¡£
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WorkspaceImpl (Yjs Doc)                       â”‚
â”‚                    - æœ¬åœ°æ–‡æ¡£çŠ¶æ€ç®¡ç†                            â”‚
â”‚                    - encodeStateAsUpdate() ç”Ÿæˆæ›´æ–°             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                               â”‚
          â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœ¬åœ°å­˜å‚¨ (Local)    â”‚     â”‚    äº‘ç«¯å­˜å‚¨ (Cloud)     â”‚
â”‚                      â”‚     â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ SqliteDoc      â”‚  â”‚     â”‚  â”‚ CloudDocStorage  â”‚  â”‚
â”‚  â”‚ Storage        â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”¤ (Socket.IO)      â”‚  â”‚
â”‚  â”‚ (Electron)     â”‚  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚           â”‚           â”‚
â”‚         æˆ–           â”‚     â”‚           â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ IndexedDBDoc   â”‚  â”‚     â”‚  â”‚ äº‘ç«¯æœåŠ¡å™¨        â”‚  â”‚
â”‚  â”‚ Storage        â”‚  â”‚     â”‚  â”‚ (Java Backend)   â”‚  â”‚
â”‚  â”‚ (Web/Android)  â”‚  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     DocSyncPeer         â”‚
            â”‚  - æœ¬åœ°ä¸äº‘ç«¯åŒæ­¥å¼•æ“    â”‚
            â”‚  - push/pull/save ä½œä¸š  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ¡Œé¢ç«¯åˆå§‹åŒ–æµç¨‹

### 2.1 å¯åŠ¨æµç¨‹æ—¶åºå›¾

```
[åº”ç”¨å¯åŠ¨]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Main Process å¯åŠ¨ (main/index.ts)                         â”‚
â”‚    â”œâ”€ app.enableSandbox()                                   â”‚
â”‚    â”œâ”€ æ£€æŸ¥å•å®ä¾‹é”                                           â”‚
â”‚    â”œâ”€ setupDeepLink()                                       â”‚
â”‚    â””â”€ app.whenReady()                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆå§‹åŒ–é“¾ (Promise chain)                                   â”‚
â”‚    â”œâ”€ registerProtocol()     // æ³¨å†Œè‡ªå®šä¹‰åè®® yunke://       â”‚
â”‚    â”œâ”€ registerHandlers()     // æ³¨å†Œ IPC å¤„ç†å™¨               â”‚
â”‚    â”œâ”€ registerEvents()       // æ³¨å†Œäº‹ä»¶ç›‘å¬                  â”‚
â”‚    â”œâ”€ launch()               // å¯åŠ¨ä¸»çª—å£                    â”‚
â”‚    â”œâ”€ createApplicationMenu()// åˆ›å»ºèœå•                      â”‚
â”‚    â”œâ”€ registerUpdater()      // æ³¨å†Œæ›´æ–°å™¨                    â”‚
â”‚    â””â”€ setupTrayState()       // è®¾ç½®æ‰˜ç›˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»ºä¸»çª—å£ (windows-manager/main-window.ts)               â”‚
â”‚    â”œâ”€ createMainWindow()                                    â”‚
â”‚    â”‚   â”œâ”€ new BrowserWindow({...})                          â”‚
â”‚    â”‚   â””â”€ ensureHelperProcess()  â†â”€â”€â”€ å¯åŠ¨ Helper è¿›ç¨‹       â”‚
â”‚    â””â”€ helper.connectMain(browserWindow)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Helper è¿›ç¨‹å¯åŠ¨ (helper/index.ts)                         â”‚
â”‚    â”œâ”€ utilityProcess.fork('helper.js')                      â”‚
â”‚    â”œâ”€ æ³¨å†Œ handlers:                                         â”‚
â”‚    â”‚   â”œâ”€ nbstoreHandlers (SQLite æ“ä½œ)                     â”‚
â”‚    â”‚   â”œâ”€ workspaceHandlers (å·¥ä½œåŒºç®¡ç†)                    â”‚
â”‚    â”‚   â””â”€ dialogHandlers (æ–‡ä»¶å¯¹è¯æ¡†)                       â”‚
â”‚    â””â”€ setupRendererConnection()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Preload è„šæœ¬æ‰§è¡Œ (preload/bootstrap.ts)                   â”‚
â”‚    â”œâ”€ æš´éœ² API åˆ°æ¸²æŸ“è¿›ç¨‹:                                   â”‚
â”‚    â”‚   â”œâ”€ __appInfo (åº”ç”¨ä¿¡æ¯)                              â”‚
â”‚    â”‚   â”œâ”€ __apis (IPC API)                                  â”‚
â”‚    â”‚   â”œâ”€ __events (äº‹ä»¶è®¢é˜…)                               â”‚
â”‚    â”‚   â””â”€ __sharedStorage (å…±äº«å­˜å‚¨)                        â”‚
â”‚    â””â”€ listenWorkerApis()                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ¸²æŸ“è¿›ç¨‹åŠ è½½ (React åº”ç”¨)                                  â”‚
â”‚    â”œâ”€ åŠ è½½ HTML/JS                                          â”‚
â”‚    â””â”€ åˆå§‹åŒ– Framework                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Main Process å…¥å£ä»£ç 

**æ–‡ä»¶**: `packages/frontend/apps/electron/src/main/index.ts`

```typescript
// åˆå§‹åŒ–é“¾
app
  .whenReady()
  .then(registerProtocol)    // æ³¨å†Œ yunke:// åè®®
  .then(registerHandlers)    // æ³¨å†Œ IPC handlers
  .then(registerEvents)      // æ³¨å†Œäº‹ä»¶
  .then(launch)              // å¯åŠ¨çª—å£
  .then(createApplicationMenu)
  .then(registerUpdater)
  .then(setupRecordingFeature)
  .then(setupTrayState)
  .catch(e => console.error('Failed create window:', e));
```

### 2.3 IPC Handlers æ³¨å†Œ

**æ–‡ä»¶**: `packages/frontend/apps/electron/src/main/handlers.ts`

```typescript
export const allHandlers = {
  debug: debugHandlers,        // è°ƒè¯•åŠŸèƒ½
  ui: uiHandlers,              // UI æ“ä½œï¼ˆæœ€å¤§åŒ–ã€æœ€å°åŒ–ç­‰ï¼‰
  clipboard: clipboardHandlers,// å‰ªè´´æ¿
  updater: updaterHandlers,    // è‡ªåŠ¨æ›´æ–°
  configStorage: configStorageHandlers, // é…ç½®å­˜å‚¨
  findInPage: findInPageHandlers,       // é¡µé¢å†…æœç´¢
  sharedStorage: sharedStorageHandlers, // å…±äº«çŠ¶æ€å­˜å‚¨
  worker: workerHandlers,      // Worker ç®¡ç†
  recording: recordingHandlers,// å½•å±åŠŸèƒ½
  popup: popupHandlers,        // å¼¹å‡ºçª—å£
};

// æ³¨å†Œç»Ÿä¸€çš„ IPC å¤„ç†å™¨
ipcMain.handle(YUNKE_API_CHANNEL_NAME, async (e, ...args) => {
  const channel = args[0];  // æ ¼å¼: "namespace:method"
  const [namespace, key] = channel.split(':');
  const handler = allHandlers[namespace]?.[key];
  return await handler(e, ...args.slice(1));
});
```

### 2.4 Helper è¿›ç¨‹å¯åŠ¨

**æ–‡ä»¶**: `packages/frontend/apps/electron/src/main/helper-process.ts`

```typescript
private constructor() {
  // Fork ç‹¬ç«‹çš„ Helper è¿›ç¨‹
  const helperProcess = utilityProcess.fork(HELPER_PROCESS_PATH, [], {
    execArgv: isDev ? ['--inspect=40894'] : [],
    serviceName: 'yunke-helper',
  });
  
  this.#process = helperProcess;
  
  this.ready = new Promise((resolve, reject) => {
    helperProcess.once('spawn', () => {
      logger.info('[helper] forked', helperProcess.pid);
      resolve();
    });
  });
}

// è¿æ¥ Renderer å’Œ Helper
connectRenderer(renderer: WebContents) {
  const { port1: helperPort, port2: rendererPort } = new MessageChannelMain();
  this.#process.postMessage({ channel: 'renderer-connect' }, [helperPort]);
  renderer.postMessage('helper-connection', null, [rendererPort]);
}
```

### 2.5 Helper è¿›ç¨‹ Handlers

**æ–‡ä»¶**: `packages/frontend/apps/electron/src/helper/exposed.ts`

```typescript
export const handlers = {
  db: dbHandlersV1,        // V1 æ•°æ®åº“å…¼å®¹
  nbstore: nbstoreHandlers,// æ ¸å¿ƒå­˜å‚¨æ“ä½œ (SQLite)
  workspace: workspaceHandlers, // å·¥ä½œåŒºç®¡ç†
  dialog: dialogHandlers,  // æ–‡ä»¶å¯¹è¯æ¡†
  file: fileHandlers,      // æ–‡ä»¶æ“ä½œ
};

export const events = {
  db: dbEventsV1,
  workspace: workspaceEvents,
};
```

### 2.6 nbstore Handlers - SQLite æ“ä½œ

**æ–‡ä»¶**: `packages/frontend/apps/electron/src/helper/nbstore/handlers.ts`

```typescript
const POOL = new DocStoragePool();  // å…¨å±€è¿æ¥æ± 

export const nbstoreHandlers: NativeDBApis = {
  connect: async (universalId: string) => {
    const { peer, type, id } = parseUniversalId(universalId);
    const dbPath = await getSpaceDBPath(peer, type, id);
    await fs.ensureDir(path.dirname(dbPath));
    await POOL.connect(universalId, dbPath);  // è¿æ¥ SQLite
    await POOL.setSpaceId(universalId, id);
  },
  disconnect: async (universalId) => {
    await POOL.disconnect(universalId);
  },
  pushUpdate: POOL.pushUpdate.bind(POOL),      // æ¨é€æ›´æ–°
  getDocSnapshot: POOL.getDocSnapshot.bind(POOL),
  setDocSnapshot: POOL.setDocSnapshot.bind(POOL),
  getDocUpdates: POOL.getDocUpdates.bind(POOL),
  // ... æ›´å¤šæ–¹æ³•
};
```

### 2.7 å·¥ä½œåŒºå¼•æ“åˆå§‹åŒ–

å½“ç”¨æˆ·æ‰“å¼€å·¥ä½œåŒºæ—¶ï¼š

```
[ç”¨æˆ·é€‰æ‹©/åˆ›å»ºå·¥ä½œåŒº]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. WorkspaceEngineService.engine (æ‡’åŠ è½½)                    â”‚
â”‚    â””â”€ åˆ›å»º WorkspaceEngine å®ä½“                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. WorkspaceEngine.start()                                   â”‚
â”‚    â”œâ”€ nbstoreService.openStore(id, options)                 â”‚
â”‚    â”‚   â””â”€ æ ¹æ® engineWorkerInitOptions é…ç½®å­˜å‚¨              â”‚
â”‚    â”œâ”€ this.doc.start() (DocFrontend å¯åŠ¨)                   â”‚
â”‚    â””â”€ blobFrontend.fullDownload('v1') (V1 è¿ç§»)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. DocFrontend.mainLoop()                                    â”‚
â”‚    â”œâ”€ storage.connection.waitForConnected()                 â”‚
â”‚    â”œâ”€ storage.subscribeDocUpdate() (ç›‘å¬æ›´æ–°)               â”‚
â”‚    â””â”€ è¿›å…¥ä¸»å¾ªç¯å¤„ç† load/save/apply ä½œä¸š                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**WorkspaceEngine åˆå§‹åŒ–ä»£ç **:

**æ–‡ä»¶**: `packages/frontend/core/src/modules/workspace/entities/engine.ts`

```typescript
start() {
  if (this.started) {
    throw new Error('å¼•æ“å·²å¯åŠ¨');
  }
  this.started = true;

  // æ‰“å¼€å­˜å‚¨
  const { store, dispose } = this.nbstoreService.openStore(
    `workspace:${this.workspaceService.workspace.flavour}:${this.workspaceService.workspace.id}`,
    this.props.engineWorkerInitOptions  // å…³é”®ï¼šå­˜å‚¨é…ç½®
  );
  this.client = store;

  // è§¦å‘å¯åŠ¨äº‹ä»¶
  this.eventBus.emit(WorkspaceEngineBeforeStart, this);

  // ä¼˜å…ˆåŠ è½½æ ¹æ–‡æ¡£
  const rootDoc = this.workspaceService.workspace.docCollection.doc;
  this.doc.addPriority(rootDoc.guid, 100);
  
  // å¯åŠ¨æ–‡æ¡£å‰ç«¯
  this.doc.start();

  // V1 åˆ° V2 è¿ç§»
  store.blobFrontend.fullDownload('v1').catch(console.warn);
}
```

---

## ä¸‰ã€å­˜å‚¨ç±»å‹é€‰æ‹©é€»è¾‘

### 3.1 ç¦»çº¿/äº‘åŒæ­¥å¼€å…³æœºåˆ¶

**å½“å‰å®ç°ä¸­å·²æœ‰å®Œæ•´çš„ç¦»çº¿/äº‘åŒæ­¥åˆ‡æ¢æœºåˆ¶ï¼š**

#### 3.1.1 å¼€å…³å­˜å‚¨é”®

**æ–‡ä»¶**: `packages/frontend/core/src/modules/cloud-storage/provider.tsx`

```typescript
// ğŸ”§ äº‘åŒæ­¥å¼€å…³å­˜å‚¨é”®
const CLOUD_SYNC_ENABLED_KEY = 'yunke_cloud_sync_enabled';

/**
 * è·å–äº‘åŒæ­¥å¼€å…³çŠ¶æ€
 * é»˜è®¤ä¸º falseï¼ˆç¦»çº¿æ¨¡å¼ï¼‰ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨å¼€å¯äº‘åŒæ­¥
 */
export function isCloudSyncEnabled(): boolean {
  try {
    const value = safeStorage.getItem(CLOUD_SYNC_ENABLED_KEY);
    return value === 'true';
  } catch {
    return false;  // é»˜è®¤ç¦»çº¿æ¨¡å¼
  }
}

/**
 * è®¾ç½®äº‘åŒæ­¥å¼€å…³çŠ¶æ€
 */
export function setCloudSyncEnabled(enabled: boolean): void {
  try {
    safeStorage.setItem(CLOUD_SYNC_ENABLED_KEY, enabled ? 'true' : 'false');
  } catch (error) {
    console.warn('[äº‘åŒæ­¥] ä¿å­˜å¼€å…³çŠ¶æ€å¤±è´¥:', error);
  }
}
```

#### 3.1.2 å¼€å…³çŠ¶æ€åœ¨ Context ä¸­æš´éœ²

```typescript
// CloudStorageStatus æ¥å£
export interface CloudStorageStatus {
  // ... å…¶ä»–å±æ€§
  
  // ğŸ”§ äº‘åŒæ­¥å¼€å…³
  cloudSyncEnabled: boolean;
  setCloudSyncEnabled: (enabled: boolean) => void;
}
```

#### 3.1.3 ä½¿ç”¨æ–¹å¼

åœ¨ React ç»„ä»¶ä¸­ï¼š

```typescript
import { useCloudStorage } from '@yunke/core/modules/cloud-storage';

function CloudSyncToggle() {
  const { cloudSyncEnabled, setCloudSyncEnabled } = useCloudStorage();
  
  return (
    <Switch
      checked={cloudSyncEnabled}
      onChange={(checked) => {
        setCloudSyncEnabled(checked);
        // æ³¨æ„ï¼šåˆ‡æ¢åéœ€è¦é‡æ–°åŠ è½½å·¥ä½œåŒºæ‰èƒ½ç”Ÿæ•ˆ
        window.location.reload();
      }}
    />
  );
}
```

### 3.2 æœ¬åœ°å­˜å‚¨ç±»å‹é€‰æ‹©

**æ–‡ä»¶**: `packages/frontend/core/src/modules/workspace-engine/impls/local.ts`

```typescript
private readonly fileSqliteEnabled =
  BUILD_CONFIG.isElectron ||
  BUILD_CONFIG.isIOS ||
  BUILD_CONFIG.isAndroid ||
  (BUILD_CONFIG.isWeb && isFileSystemAccessSupported() && ...);

DocStorageType =
  (BUILD_CONFIG.isAndroid && (window as any).Capacitor)
    ? IndexedDBDocStorage      // Android Capacitor â†’ IndexedDB
  : this.fileSqliteEnabled
    ? SqliteDocStorage         // Electron/iOS â†’ SQLite
    : IndexedDBDocStorage;     // Web â†’ IndexedDB
```

### 3.3 å¹³å°å­˜å‚¨ç±»å‹å¯¹ç…§è¡¨

| å¹³å° | æ–‡æ¡£å­˜å‚¨ | Blobå­˜å‚¨ | è¯´æ˜ |
|------|----------|----------|------|
| **Electron** | SqliteDocStorage | SqliteBlobStorage | æœ¬åœ° SQLite æ–‡ä»¶ |
| **iOS** | SqliteDocStorage | SqliteBlobStorage | æœ¬åœ° SQLite æ–‡ä»¶ |
| **Android Capacitor** | IndexedDBDocStorage | IndexedDBBlobStorage | æµè§ˆå™¨ IndexedDB |
| **Web** | IndexedDBDocStorage | IndexedDBBlobStorage | æµè§ˆå™¨ IndexedDB |

### 3.4 äº‘å·¥ä½œåŒºæ¨¡å¼é…ç½®ï¼ˆæ ¸å¿ƒåˆ‡æ¢é€»è¾‘ï¼‰

**æ–‡ä»¶**: `packages/frontend/core/src/modules/workspace-engine/impls/cloud.ts`

```typescript
getEngineWorkerInitOptions(workspaceId: string): WorkerInitOptions {
  // ========================================
  // ğŸ”§ æ ¸å¿ƒï¼šæ£€æŸ¥äº‘åŒæ­¥å¼€å…³çŠ¶æ€
  // ========================================
  const isCloudEnabled = (() => {
    try {
      // ä» localStorage æˆ– sharedStorage è¯»å–äº‘åŒæ­¥å¼€å…³çŠ¶æ€
      if (typeof window !== 'undefined') {
        const storage = (window as any).__sharedStorage?.globalState;
        if (storage) {
          return storage.get('yunke_cloud_sync_enabled') === 'true';
        }
        return localStorage.getItem('yunke_cloud_sync_enabled') === 'true';
      }
      return false;  // é»˜è®¤ï¼šç¦»çº¿æ¨¡å¼
    } catch {
      return false;
    }
  })();

  // ========================================
  // æ¨¡å¼ä¸€ï¼šAndroid ç¯å¢ƒ â†’ çº¯äº‘å­˜å‚¨
  // ========================================
  if ((window as any).BUILD_CONFIG?.isAndroid) {
    return {
      local: { awareness: {...} },  // åªæœ‰ awareness
      remotes: {
        [`cloud:${this.flavour}`]: {
          doc: { name: 'CloudDocStorage', ... },
          blob: { name: 'CloudBlobStorage', ... },
        }
      }
    };
  }

  // ========================================
  // æ¨¡å¼äºŒï¼šElectron ç¦»çº¿æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
  // æ¡ä»¶ï¼šisElectron && !isCloudEnabled
  // ========================================
  if (BUILD_CONFIG.isElectron && !isCloudEnabled) {
    console.log('ğŸ’¾ [ç¦»çº¿æ¨¡å¼] ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œä¸è¿æ¥äº‘ç«¯');
    return {
      local: {
        doc: { name: 'SqliteDocStorage', ... },
        blob: { name: 'SqliteBlobStorage', ... },
        awareness: { name: 'BroadcastChannelAwarenessStorage', ... },
      },
      remotes: {},  // âŒ å…³é”®ï¼šremotes ä¸ºç©ºï¼Œä¸è§¦å‘äº‘åŒæ­¥
    };
  }

  // ========================================
  // æ¨¡å¼ä¸‰ï¼šäº‘åŒæ­¥æ¨¡å¼ï¼ˆç”¨æˆ·æ‰‹åŠ¨å¼€å¯ï¼‰
  // æ¡ä»¶ï¼šisCloudEnabled = true
  // ========================================
  console.log('â˜ï¸ [äº‘åŒæ­¥æ¨¡å¼] æœ¬åœ° + äº‘ç«¯åŒæ­¥');
  return {
    local: { awareness: {...} },
    remotes: {
      [`cloud:${this.flavour}`]: {
        doc: { name: 'CloudDocStorage', ... },
        blob: { name: 'CloudBlobStorage', ... },
        awareness: { name: 'CloudAwarenessStorage', ... },
      }
    }
  };
}
```

### 3.5 æ¨¡å¼å†³ç­–æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¨¡å¼å†³ç­–æµç¨‹                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  åº”ç”¨å¯åŠ¨                                                        â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ è¯»å– localStorage   â”‚                                        â”‚
â”‚  â”‚ yunke_cloud_sync_   â”‚                                        â”‚
â”‚  â”‚ enabled             â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚             â”‚                                                   â”‚
â”‚             â–¼                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚     â”‚ isCloudEnabled â”‚                                          â”‚
â”‚     â”‚ === 'true' ?   â”‚                                          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚             â”‚                                                   â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚      â”‚             â”‚                                            â”‚
â”‚      â–¼             â–¼                                            â”‚
â”‚   false          true                                           â”‚
â”‚  (é»˜è®¤)                                                          â”‚
â”‚      â”‚             â”‚                                            â”‚
â”‚      â–¼             â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚ç¦»çº¿æ¨¡å¼  â”‚   â”‚ äº‘åŒæ­¥æ¨¡å¼  â”‚                                  â”‚
â”‚  â”‚         â”‚   â”‚             â”‚                                  â”‚
â”‚  â”‚remotes  â”‚   â”‚remotes =    â”‚                                  â”‚
â”‚  â”‚= {}     â”‚   â”‚{cloud:...}  â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.6 æ¨¡å¼å†³ç­–è¡¨

| åœºæ™¯ | å¼€å…³çŠ¶æ€ | æœ¬åœ°å­˜å‚¨ | äº‘ç«¯åŒæ­¥ | remotes é…ç½® |
|------|---------|---------|---------|--------------|
| **æœ¬åœ°å·¥ä½œåŒº** (flavour='local') | - | âœ… SQLite/IDB | âŒ | `{v1: ...}` |
| **äº‘å·¥ä½œåŒº - Electron ç¦»çº¿** | `false` (é»˜è®¤) | âœ… SQLite | âŒ | `{}` |
| **äº‘å·¥ä½œåŒº - Electron åœ¨çº¿** | `true` | âœ… SQLite | âœ… Socket.IO | `{cloud:...}` |
| **äº‘å·¥ä½œåŒº - Web** | - | âœ… IndexedDB | âœ… Socket.IO | `{cloud:...}` |
| **äº‘å·¥ä½œåŒº - Android** | - | âŒ | âœ… çº¯äº‘å­˜å‚¨ | `{cloud:...}` |

### 3.7 åˆ‡æ¢æ¨¡å¼çš„å½±å“

#### ç¦»çº¿æ¨¡å¼ â†’ äº‘åŒæ­¥æ¨¡å¼

```
1. ç”¨æˆ·è°ƒç”¨ setCloudSyncEnabled(true)
2. localStorage å­˜å‚¨ 'yunke_cloud_sync_enabled' = 'true'
3. é‡æ–°åŠ è½½å·¥ä½œåŒºï¼ˆæˆ–åˆ·æ–°é¡µé¢ï¼‰
4. getEngineWorkerInitOptions è¿”å›å¸¦ remotes çš„é…ç½®
5. DocSyncPeer å¯åŠ¨ï¼Œå¼€å§‹æœ¬åœ°â†’äº‘ç«¯åŒæ­¥
6. æœ¬åœ°æ•°æ®è‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯
```

#### äº‘åŒæ­¥æ¨¡å¼ â†’ ç¦»çº¿æ¨¡å¼

```
1. ç”¨æˆ·è°ƒç”¨ setCloudSyncEnabled(false)
2. localStorage å­˜å‚¨ 'yunke_cloud_sync_enabled' = 'false'
3. é‡æ–°åŠ è½½å·¥ä½œåŒºï¼ˆæˆ–åˆ·æ–°é¡µé¢ï¼‰
4. getEngineWorkerInitOptions è¿”å› remotes = {}
5. DocSyncPeer ä¸å¯åŠ¨ï¼Œæ— äº‘ç«¯è¿æ¥
6. æ‰€æœ‰æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°
```

---

## å››ã€äº‘åŒæ­¥å¼€å…³ä½¿ç”¨æŒ‡å—

### 4.1 å¼€å…³åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‘åŒæ­¥å¼€å…³å·¥ä½œåŸç†                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚   ç”¨æˆ·æ“ä½œ       â”‚                                            â”‚
â”‚  â”‚   å¼€å…³åˆ‡æ¢       â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚           â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ setCloudSyncEnabled(true/false)    â”‚                        â”‚
â”‚  â”‚                                     â”‚                        â”‚
â”‚  â”‚ localStorage.setItem(              â”‚                        â”‚
â”‚  â”‚   'yunke_cloud_sync_enabled',      â”‚                        â”‚
â”‚  â”‚   'true' / 'false'                 â”‚                        â”‚
â”‚  â”‚ )                                  â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â”‚                                                     â”‚
â”‚           â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ é‡æ–°åŠ è½½å·¥ä½œåŒº / åˆ·æ–°é¡µé¢           â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â”‚                                                     â”‚
â”‚           â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ getEngineWorkerInitOptions()       â”‚                        â”‚
â”‚  â”‚                                     â”‚                        â”‚
â”‚  â”‚ è¯»å–å¼€å…³çŠ¶æ€ â†’ å†³å®š remotes é…ç½®   â”‚                        â”‚
â”‚  â”‚                                     â”‚                        â”‚
â”‚  â”‚ isCloudEnabled ?                   â”‚                        â”‚
â”‚  â”‚   remotes = {cloud:...}            â”‚                        â”‚
â”‚  â”‚ : remotes = {}                     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â”‚                                                     â”‚
â”‚           â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ DocSyncPeer æ ¹æ® remotes å†³å®š      â”‚                        â”‚
â”‚  â”‚ æ˜¯å¦å¯åŠ¨äº‘ç«¯åŒæ­¥                    â”‚                        â”‚
â”‚  â”‚                                     â”‚                        â”‚
â”‚  â”‚ remotes éç©º â†’ å¯åŠ¨åŒæ­¥            â”‚                        â”‚
â”‚  â”‚ remotes = {} â†’ çº¯ç¦»çº¿æ¨¡å¼          â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç›¸å…³æ–‡ä»¶å’Œå‡½æ•°

| åŠŸèƒ½ | æ–‡ä»¶è·¯å¾„ | å‡½æ•°/å¸¸é‡ |
|------|---------|----------|
| **å¼€å…³å­˜å‚¨é”®** | `cloud-storage/provider.tsx` | `CLOUD_SYNC_ENABLED_KEY = 'yunke_cloud_sync_enabled'` |
| **è¯»å–å¼€å…³çŠ¶æ€** | `cloud-storage/provider.tsx` | `isCloudSyncEnabled(): boolean` |
| **è®¾ç½®å¼€å…³çŠ¶æ€** | `cloud-storage/provider.tsx` | `setCloudSyncEnabled(enabled: boolean)` |
| **Context æš´éœ²** | `cloud-storage/provider.tsx` | `CloudStorageStatus.cloudSyncEnabled` |
| **æ¨¡å¼å†³ç­–** | `workspace-engine/impls/cloud.ts` | `getEngineWorkerInitOptions()` |
| **userspace åŒæ­¥** | `userspace/entities/user-db-engine.ts` | `shouldUseCloud` å˜é‡ |

### 4.3 åœ¨è®¾ç½®ç•Œé¢æ·»åŠ å¼€å…³

å¦‚æœéœ€è¦åœ¨è®¾ç½®ç•Œé¢æ·»åŠ äº‘åŒæ­¥å¼€å…³ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä»£ç ï¼š

```typescript
import { useCloudStorage } from '@yunke/core/modules/cloud-storage';
import { Switch, SettingRow, SettingWrapper } from '@yunke/component';
import { Cloud, HardDrive } from 'lucide-react';

export const CloudSyncSetting = () => {
  const { cloudSyncEnabled, setCloudSyncEnabled } = useCloudStorage();
  const [pending, setPending] = useState(false);

  const handleToggle = async (checked: boolean) => {
    setPending(true);
    
    // è®¾ç½®å¼€å…³çŠ¶æ€
    setCloudSyncEnabled(checked);
    
    // æç¤ºç”¨æˆ·éœ€è¦é‡æ–°åŠ è½½
    const confirmed = await confirm(
      checked 
        ? 'å¼€å¯äº‘åŒæ­¥åï¼Œæœ¬åœ°æ•°æ®å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ã€‚éœ€è¦é‡æ–°åŠ è½½é¡µé¢ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ'
        : 'å…³é—­äº‘åŒæ­¥åï¼Œæ•°æ®å°†ä»…ä¿å­˜åœ¨æœ¬åœ°ã€‚éœ€è¦é‡æ–°åŠ è½½é¡µé¢ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ'
    );
    
    if (confirmed) {
      window.location.reload();
    } else {
      // ç”¨æˆ·å–æ¶ˆï¼Œæ¢å¤åŸçŠ¶æ€
      setCloudSyncEnabled(!checked);
    }
    
    setPending(false);
  };

  return (
    <SettingWrapper title="æ•°æ®åŒæ­¥">
      <SettingRow
        name="äº‘åŒæ­¥"
        desc={cloudSyncEnabled 
          ? 'å·²å¼€å¯ - æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯ï¼Œæ”¯æŒå¤šè®¾å¤‡è®¿é—®'
          : 'å·²å…³é—­ - æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰'
        }
      >
        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
          {cloudSyncEnabled ? <Cloud size={16} /> : <HardDrive size={16} />}
          <Switch
            checked={cloudSyncEnabled}
            onChange={handleToggle}
            disabled={pending}
          />
        </div>
      </SettingRow>
      
      {!cloudSyncEnabled && (
        <SettingRow
          name=""
          desc="âš ï¸ ç¦»çº¿æ¨¡å¼ä¸‹ï¼Œæ•°æ®ä¸ä¼šåŒæ­¥åˆ°äº‘ç«¯ã€‚å¦‚éœ€å¤šè®¾å¤‡è®¿é—®ï¼Œè¯·å¼€å¯äº‘åŒæ­¥ã€‚"
        />
      )}
    </SettingWrapper>
  );
};
```

### 4.4 ç¼–ç¨‹æ–¹å¼åˆ‡æ¢

```typescript
import { 
  isCloudSyncEnabled, 
  setCloudSyncEnabled 
} from '@yunke/core/modules/cloud-storage';

// æ£€æŸ¥å½“å‰çŠ¶æ€
const isEnabled = isCloudSyncEnabled();
console.log('äº‘åŒæ­¥çŠ¶æ€:', isEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­');

// å¼€å¯äº‘åŒæ­¥
function enableCloudSync() {
  setCloudSyncEnabled(true);
  console.log('äº‘åŒæ­¥å·²å¼€å¯ï¼Œè¯·é‡æ–°åŠ è½½é¡µé¢');
}

// å…³é—­äº‘åŒæ­¥ï¼ˆåˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼ï¼‰
function disableCloudSync() {
  setCloudSyncEnabled(false);
  console.log('äº‘åŒæ­¥å·²å…³é—­ï¼Œæ•°æ®å°†ä»…ä¿å­˜åœ¨æœ¬åœ°');
}
```

### 4.5 æ³¨æ„äº‹é¡¹

1. **åˆ‡æ¢éœ€è¦é‡è½½**ï¼šåˆ‡æ¢å¼€å…³åï¼Œéœ€è¦é‡æ–°åŠ è½½å·¥ä½œåŒºæˆ–åˆ·æ–°é¡µé¢æ‰èƒ½ç”Ÿæ•ˆ
2. **é»˜è®¤ç¦»çº¿**ï¼šé¦–æ¬¡å¯åŠ¨æ—¶ï¼Œ`yunke_cloud_sync_enabled` ä¸ºç©ºï¼Œé»˜è®¤ä¸º `false`ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
3. **æ•°æ®ä¸ä¸¢å¤±**ï¼šä»ç¦»çº¿åˆ‡æ¢åˆ°äº‘åŒæ­¥åï¼Œæœ¬åœ°æ•°æ®ä¼šè‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯
4. **å¹³å°é™åˆ¶**ï¼šAndroid ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨äº‘å­˜å‚¨ï¼Œå¼€å…³æ— æ•ˆ

---

## äº”ã€ç¦»çº¿ä¿å­˜è§¦å‘æ—¶æœº

### 4.1 ä¿å­˜è§¦å‘æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¦»çº¿ä¿å­˜è§¦å‘æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·ç¼–è¾‘ â”€â”€â–º YDoc.on('update') â”€â”€â–º handleDocUpdate()           â”‚
â”‚                                          â”‚                      â”‚
â”‚                                          â–¼                      â”‚
â”‚                                    100ms é˜²æŠ–ç´¯ç§¯                â”‚
â”‚                                          â”‚                      â”‚
â”‚                                          â–¼                      â”‚
â”‚                                  schedule({type:'save'})        â”‚
â”‚                                          â”‚                      â”‚
â”‚                                          â–¼                      â”‚
â”‚                                    jobs.save()                  â”‚
â”‚                                          â”‚                      â”‚
â”‚                                          â–¼                      â”‚
â”‚                               storage.pushDocUpdate()           â”‚
â”‚                                          â”‚                      â”‚
â”‚                                          â–¼                      â”‚
â”‚                              SQLite / IndexedDB å†™å…¥            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è§¦å‘åœºæ™¯ä¸€ï¼šç”¨æˆ·ç¼–è¾‘ï¼ˆæœ€å¸¸è§ï¼‰

**æ–‡ä»¶**: `packages/common/nbstore/src/frontend/doc.ts`

```typescript
private readonly handleDocUpdate = (
  update: Uint8Array,
  origin: any,
  doc: YDoc,
) => {
  // âŒ è·³è¿‡æ¥è‡ª nbstore çš„æ›´æ–°ï¼ˆé¿å…å¾ªç¯ï¼‰
  if (origin === NBSTORE_ORIGIN) {
    return;
  }

  // âœ… ç”¨æˆ·ç¼–è¾‘è§¦å‘çš„ä¿å­˜
  // ç´¯ç§¯ 100ms å†…çš„ update åæ‰¹é‡ä¿å­˜
  const existingUpdates = this.pendingUpdates.get(doc.guid) || [];
  existingUpdates.push(update);
  this.pendingUpdates.set(doc.guid, existingUpdates);

  // 100ms é˜²æŠ–åè§¦å‘ä¿å­˜
  const timer = setTimeout(() => {
    const mergedUpdate = this.mergeUpdates(updates);
    this.schedule({
      type: 'save',
      docId: doc.guid,
      update: mergedUpdate,
    });
  }, 100); // SAVE_DEBOUNCE_MS = 100
};
```

**è§¦å‘æ¡ä»¶**ï¼š

| æ¡ä»¶ | è§¦å‘ | è¯´æ˜ |
|------|------|------|
| ç”¨æˆ·è¾“å…¥æ–‡å­— | âœ… | æ¯æ¬¡æŒ‰é”®è§¦å‘ |
| ç²˜è´´å†…å®¹ | âœ… | æ‰¹é‡æ›´æ–° |
| æ‹–æ‹½å…ƒç´  | âœ… | ä½ç½®å˜åŒ– |
| å¯¼å…¥æ¨¡æ¿ | âœ… | æ‰¹é‡æ–‡æ¡£æ›´æ–° |
| è¿œç¨‹åŒæ­¥æ›´æ–° | âŒ | origin = NBSTORE_ORIGINï¼Œè·³è¿‡ |

### 4.3 è§¦å‘åœºæ™¯äºŒï¼šæ–‡æ¡£è¿æ¥æ—¶ï¼ˆåŠ è½½å·²æœ‰æ•°æ®ï¼‰

```typescript
// frontend/doc.ts - jobs.load
load: async (job, signal) => {
  const doc = this.status.docs.get(job.docId);
  const existingData = encodeStateAsUpdate(doc);

  // âœ… å¦‚æœæ–‡æ¡£å·²æœ‰æ•°æ®ï¼Œå…ˆä¿å­˜åˆ°å­˜å‚¨
  if (!isEmptyUpdate(existingData)) {
    this.schedule({
      type: 'save',
      docId: doc.guid,
      update: existingData,
    });
  }

  // ä»å­˜å‚¨åŠ è½½æ•°æ®
  const docRecord = await this.storage.getDoc(job.docId);
  if (docRecord && !isEmptyUpdate(docRecord.bin)) {
    this.applyUpdate(job.docId, docRecord.bin);
  }
};
```

### 4.4 è§¦å‘åœºæ™¯ä¸‰ï¼šæ–‡æ¡£æ–­å¼€è¿æ¥æ—¶ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰

```typescript
// frontend/doc.ts - disconnectDoc
disconnectDoc(doc: YDoc) {
  // âœ… ç«‹å³ä¿å­˜ pending çš„ updates
  const pendingUpdates = this.pendingUpdates.get(doc.guid);
  if (pendingUpdates && pendingUpdates.length > 0) {
    const mergedUpdate = this.mergeUpdates(pendingUpdates);
    this.schedule({
      type: 'save',
      docId: doc.guid,
      update: mergedUpdate,
    });
  }
  // æ¸…ç†çŠ¶æ€...
};
```

### 4.5 è§¦å‘åœºæ™¯å››ï¼šåˆ›å»ºå·¥ä½œåŒºæ—¶

**æ–‡ä»¶**: `packages/frontend/core/src/modules/workspace-engine/impls/local.ts`

```typescript
// ä¿å­˜æ‰€æœ‰æ–‡æ¡£åˆ°æœ¬åœ°å­˜å‚¨
for (const subdocs of docList) {
  await docStorage.pushDocUpdate({
    docId: subdocs.guid,
    bin: encodeStateAsUpdate(subdocs),
  });
}
```

---

## å…­ã€äº‘ä¿å­˜è§¦å‘æ—¶æœº

### 5.1 äº‘ä¿å­˜è§¦å‘æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‘ä¿å­˜è§¦å‘æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  æœ¬åœ°å­˜å‚¨ä¿å­˜ â”€â”€â–º subscribeDocUpdate â”€â”€â–º localUpdated           â”‚
â”‚                                              â”‚                  â”‚
â”‚                                              â–¼                  â”‚
â”‚                                      schedule(push)             â”‚
â”‚                                              â”‚                  â”‚
â”‚                                              â–¼                  â”‚
â”‚                                        jobs.push()              â”‚
â”‚                                              â”‚                  â”‚
â”‚                                              â–¼                  â”‚
â”‚                                 remote.pushDocUpdate()          â”‚
â”‚                                              â”‚                  â”‚
â”‚                                              â–¼                  â”‚
â”‚                                    Socket.IO å‘é€               â”‚
â”‚                                              â”‚                  â”‚
â”‚                                              â–¼                  â”‚
â”‚                                       äº‘ç«¯æœåŠ¡å™¨                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è§¦å‘åœºæ™¯ä¸€ï¼šæœ¬åœ°æ›´æ–°åŒæ­¥åˆ°äº‘ç«¯

**æ–‡ä»¶**: `packages/common/nbstore/src/sync/doc/peer.ts`

```typescript
localUpdated: ({ docId, update, clock }) => {
  // æ·»åŠ æ–‡æ¡£åˆ°åŒæ­¥åˆ—è¡¨
  this.actions.addDoc(docId);

  // âŒ è¿‡æ»¤ç©ºæ›´æ–°
  if (isEmptyUpdate(update)) {
    return;
  }

  // âœ… è°ƒåº¦ push ä½œä¸š â†’ äº‘ä¿å­˜
  this.schedule({
    type: 'push',
    docId,
    clock,
    update,
  });
};
```

**è§¦å‘é“¾è·¯**ï¼š

```
æœ¬åœ°å­˜å‚¨ä¿å­˜ â†’ subscribeDocUpdate â†’ localUpdated â†’ schedule(push) â†’ jobs.push â†’ remote.pushDocUpdate
```

### 5.3 è§¦å‘åœºæ™¯äºŒï¼špush ä½œä¸šæ‰§è¡Œ

```typescript
// sync/doc/peer.ts - jobs.push
push: async (docId, jobs, signal) => {
  // âœ… æ¡ä»¶ï¼šæ–‡æ¡£å·²è¿æ¥ && è¿œç¨‹éåªè¯»
  if (this.status.connectedDocs.has(docId) && !this.remote.isReadonly) {
    // åˆå¹¶æ‰€æœ‰æ›´æ–°
    const merged = await this.mergeUpdates(jobs.map(j => j.update));

    if (!isEmptyUpdate(merged)) {
      // âœ… æ¨é€åˆ°äº‘ç«¯ï¼ˆ30ç§’è¶…æ—¶ï¼‰
      const { timestamp } = await Promise.race([
        this.remote.pushDocUpdate({ docId, bin: merged }, this.uniqueId),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Push timeout')), 30000))
      ]);

      // è°ƒåº¦ save ä½œä¸šæ›´æ–°æœ¬åœ°æ—¶é—´æˆ³
      this.schedule({ type: 'save', docId, remoteClock: timestamp });
    }

    // æ›´æ–°å·²æ¨é€æ—¶é—´æˆ³
    await this.syncMetadata.setPeerPushedClock(this.peerId, { docId, timestamp: maxClock });
  }
};
```

### 5.4 è§¦å‘åœºæ™¯ä¸‰ï¼šåˆ›å»ºäº‘å·¥ä½œåŒºæ—¶ç«‹å³åŒæ­¥

**æ–‡ä»¶**: `packages/frontend/core/src/modules/workspace-engine/impls/cloud.ts`

```typescript
// æœ¬åœ°ä¿å­˜å®Œæˆåç«‹å³åŒæ­¥åˆ°äº‘ç«¯
await this.syncInitialDataToCloud(workspaceId, docList, blobStorage, docStorage);

// syncInitialDataToCloud æ–¹æ³•
private async syncInitialDataToCloud(workspaceId, docList, ...) {
  const cloudDocStorage = new CloudDocStorage({...});
  await cloudDocStorage.connection.connect();

  // âœ… å¹¶å‘åŒæ­¥æ¯ä¸ªæ–‡æ¡£
  for (const doc of docList) {
    await cloudDocStorage.pushDocUpdate({
      docId: doc.guid,
      bin: encodeStateAsUpdate(doc),
    });
  }
}
```

### 5.5 CloudDocStorage - Socket.IO é€šä¿¡

**æ–‡ä»¶**: `packages/common/nbstore/src/impls/cloud/doc.ts`

```typescript
export class CloudDocStorage extends DocStorageBase<CloudDocStorageOptions> {
  static readonly identifier = 'CloudDocStorage';

  // æ¨é€æ–‡æ¡£æ›´æ–°åˆ°äº‘ç«¯
  override async pushDocUpdate(update: DocUpdate) {
    const requestData = {
      spaceType: this.options.type,
      spaceId: this.spaceId,
      docId: docId,
      update: updateBase64,  // Base64 ç¼–ç 
      sessionId,
      clientId,
    };

    // é€šè¿‡ Socket.IO å‘é€
    const result = await this.connection.inner.socket.emitWithAck(
      'space:push-doc-update', 
      requestData
    );

    return { docId: update.docId, timestamp };
  }

  // ç›‘å¬æœåŠ¡å™¨å¹¿æ’­çš„æ–‡æ¡£æ›´æ–°
  onServerUpdate = (message) => {
    // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ›´æ–°ï¼Œé¿å…å¾ªç¯
    if (isOwnUpdate) return;
    
    // è§¦å‘æ›´æ–°äº‹ä»¶
    this.emit('update', {
      docId: this.idConverter.oldIdToNewId(message.docId),
      bin: base64ToUint8Array(message.update),
      timestamp: new Date(message.timestamp),
    });
  };
}
```

### 5.6 Socket.IO äº‹ä»¶è¡¨

| äº‹ä»¶å | æ–¹å‘ | è¯´æ˜ |
|--------|------|------|
| `space:join` | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | åŠ å…¥å·¥ä½œåŒºæˆ¿é—´ |
| `space:leave` | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | ç¦»å¼€å·¥ä½œåŒºæˆ¿é—´ |
| `space:push-doc-update` | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | æ¨é€æ–‡æ¡£æ›´æ–° |
| `space:load-doc` | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | åŠ è½½æ–‡æ¡£å¿«ç…§ |
| `space:load-doc-timestamps` | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | è·å–æ–‡æ¡£æ—¶é—´æˆ³ |
| `space:broadcast-doc-update` | æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ | å¹¿æ’­å•ä¸ªæ–‡æ¡£æ›´æ–° |
| `space:broadcast-doc-updates` | æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ | å¹¿æ’­æ‰¹é‡æ–‡æ¡£æ›´æ–° |

---

## ä¸ƒã€æ ¸å¿ƒä»£ç è·¯å¾„

### 6.1 ç¦»çº¿ä¿å­˜è·¯å¾„

```
ç”¨æˆ·ç¼–è¾‘ 
    â†’ YDoc.update 
    â†’ handleDocUpdate 
    â†’ 100ms é˜²æŠ– 
    â†’ schedule(save) 
    â†’ jobs.save 
    â†’ storage.pushDocUpdate 
    â†’ SQLite/IndexedDB
```

### 6.2 äº‘ä¿å­˜è·¯å¾„

```
storage.pushDocUpdate 
    â†’ subscribeDocUpdate 
    â†’ localUpdated 
    â†’ schedule(push) 
    â†’ jobs.push 
    â†’ remote.pushDocUpdate 
    â†’ Socket.IO 
    â†’ äº‘ç«¯æœåŠ¡å™¨
```

### 6.3 æ¨¡å¼åˆ‡æ¢

```
- remotes = {} â†’ çº¯ç¦»çº¿æ¨¡å¼ï¼Œä¸è§¦å‘äº‘ä¿å­˜
- remotes = {cloud:xxx} â†’ äº‘åŒæ­¥æ¨¡å¼ï¼Œæ¯æ¬¡æœ¬åœ°ä¿å­˜åè‡ªåŠ¨è§¦å‘äº‘ä¿å­˜
```

### 6.4 è§¦å‘æ—¶æœºå¯¹ç…§è¡¨

| è§¦å‘åœºæ™¯ | ç¦»çº¿ä¿å­˜ | äº‘ä¿å­˜ | å»¶è¿Ÿ |
|----------|---------|--------|------|
| **ç”¨æˆ·è¾“å…¥** | âœ… 100ms é˜²æŠ– | âœ… ç«‹å³æ¨é€ | 100ms + ç½‘ç»œ |
| **ç²˜è´´/æ‹–æ‹½** | âœ… 100ms é˜²æŠ– | âœ… ç«‹å³æ¨é€ | 100ms + ç½‘ç»œ |
| **åˆ›å»ºå·¥ä½œåŒº** | âœ… æ‰¹é‡å†™å…¥ | âœ… syncInitialDataToCloud | æ‰¹é‡å®Œæˆå |
| **æ–‡æ¡£åŠ è½½** | âœ… å¦‚æœ‰æœ¬åœ°æ•°æ® | âœ… pullAndPush åŒæ­¥ | è¿æ¥åç«‹å³ |
| **æ–‡æ¡£å…³é—­** | âœ… ç«‹å³ä¿å­˜ pending | âŒ | ç«‹å³ |
| **è¿œç¨‹æ›´æ–°åˆ°è¾¾** | âœ… save ä½œä¸š | âŒ (å·²æ˜¯äº‘ç«¯æ•°æ®) | ç«‹å³ |
| **å®šæ—¶åŒæ­¥** | âŒ | âœ… 5ç§’é‡è¯•å¾ªç¯ | æŒç»­ |

---

## å…«ã€å…³é”®æ–‡ä»¶ç´¢å¼•

### 7.1 Electron è¿›ç¨‹ç›¸å…³

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|---------|------|
| **Main å…¥å£** | `apps/electron/src/main/index.ts` | åº”ç”¨å¯åŠ¨ã€åˆå§‹åŒ–é“¾ |
| **IPC Handlers** | `apps/electron/src/main/handlers.ts` | ä¸»è¿›ç¨‹ API |
| **çª—å£ç®¡ç†** | `apps/electron/src/main/windows-manager/main-window.ts` | åˆ›å»º/ç®¡ç†çª—å£ |
| **Helper å¯åŠ¨** | `apps/electron/src/main/helper-process.ts` | Fork Helper è¿›ç¨‹ |
| **Helper å…¥å£** | `apps/electron/src/helper/index.ts` | Helper è¿›ç¨‹å…¥å£ |
| **Helper APIs** | `apps/electron/src/helper/exposed.ts` | æš´éœ²çš„ handlers |
| **SQLite æ“ä½œ** | `apps/electron/src/helper/nbstore/handlers.ts` | æ•°æ®åº“æ“ä½œ |
| **å·¥ä½œåŒºç®¡ç†** | `apps/electron/src/helper/workspace/handlers.ts` | å·¥ä½œåŒº CRUD |
| **Preload** | `apps/electron/src/preload/bootstrap.ts` | æš´éœ² API åˆ°æ¸²æŸ“è¿›ç¨‹ |
| **Electron API** | `apps/electron/src/preload/electron-api.ts` | API å°è£… |

### 7.2 å‰ç«¯æ¨¡å—ç›¸å…³

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|---------|------|
| **WorkspaceEngine** | `core/modules/workspace/entities/engine.ts` | å·¥ä½œåŒºå¼•æ“ |
| **æœ¬åœ°å­˜å‚¨** | `core/modules/workspace-engine/impls/local.ts` | æœ¬åœ°å·¥ä½œåŒºæä¾›è€… |
| **äº‘å­˜å‚¨** | `core/modules/workspace-engine/impls/cloud.ts` | äº‘å·¥ä½œåŒºæä¾›è€… |

### 7.3 nbstore å­˜å‚¨å±‚

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|------|---------|------|
| **DocStorage åŸºç±»** | `nbstore/src/storage/doc.ts` | æ–‡æ¡£å­˜å‚¨æ¥å£ |
| **DocFrontend** | `nbstore/src/frontend/doc.ts` | å‰ç«¯æ–‡æ¡£ç®¡ç† |
| **DocSyncPeer** | `nbstore/src/sync/doc/peer.ts` | æœ¬åœ°äº‘ç«¯åŒæ­¥ |
| **CloudDocStorage** | `nbstore/src/impls/cloud/doc.ts` | äº‘ç«¯å­˜å‚¨å®ç° |
| **SqliteDocStorage** | `nbstore/src/impls/sqlite/doc.ts` | SQLite å­˜å‚¨å®ç° |
| **IndexedDBDocStorage** | `nbstore/src/impls/idb/doc.ts` | IndexedDB å­˜å‚¨å®ç° |

---

## é™„å½•ï¼šåˆå§‹åŒ–é˜¶æ®µæ€»ç»“

| é˜¶æ®µ | è¿›ç¨‹ | å…³é”®æ“ä½œ |
|------|------|---------|
| **1. å¯åŠ¨** | Main | `app.whenReady()` â†’ æ³¨å†Œåè®®/handlers/events |
| **2. çª—å£** | Main | åˆ›å»º BrowserWindow â†’ Fork Helper è¿›ç¨‹ |
| **3. Helper** | Helper | æ³¨å†Œ nbstore/workspace handlers |
| **4. é€šä¿¡** | All | MessagePort å»ºç«‹ Renderer â†” Helper è¿æ¥ |
| **5. Preload** | Preload | æš´éœ² `__apis`, `__events` åˆ°æ¸²æŸ“è¿›ç¨‹ |
| **6. å‰ç«¯** | Renderer | åŠ è½½ React åº”ç”¨ â†’ åˆå§‹åŒ– Framework |
| **7. å·¥ä½œåŒº** | Renderer | åˆ›å»º WorkspaceEngine â†’ è¿æ¥ SQLite |
| **8. æ–‡æ¡£** | Renderer | DocFrontend å¯åŠ¨ â†’ åŠ è½½/åŒæ­¥æ–‡æ¡£ |

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š2026-01-29*
