# åˆ—å¸ƒå±€é”®ç›˜å¯¼èˆªè®¾è®¡æ–‡æ¡£

## ğŸ¯ è®¾è®¡ç›®æ ‡

åŸºäºBlockSuiteç°æœ‰çš„é”®ç›˜å¯¼èˆªæ¨¡å¼ï¼Œä¸ºåˆ—å¸ƒå±€ç³»ç»Ÿè®¾è®¡å®Œæ•´çš„é”®ç›˜æ“ä½œæ”¯æŒï¼Œç¡®ä¿ç”¨æˆ·å¯ä»¥å®Œå…¨é€šè¿‡é”®ç›˜æ“ä½œåˆ—å¸ƒå±€åŠŸèƒ½ã€‚

## âŒ¨ï¸ é”®ç›˜å¿«æ·é”®è§„åˆ’

### 1. å¸ƒå±€åˆ‡æ¢å¿«æ·é”®
```typescript
// æ•°å­—é”®å¿«é€Ÿåˆ‡æ¢å¸ƒå±€æ¨¡å¼
interface LayoutKeyboardShortcuts {
  '1': PageLayoutMode.Normal,      // å•åˆ—å¸ƒå±€
  '2': PageLayoutMode.TwoColumn,   // åŒåˆ—å¸ƒå±€
  '3': PageLayoutMode.ThreeColumn, // ä¸‰åˆ—å¸ƒå±€
  '4': PageLayoutMode.FourColumn,  // å››åˆ—å¸ƒå±€
  '5': PageLayoutMode.FiveColumn   // äº”åˆ—å¸ƒå±€
}

// ç»„åˆé”®æ”¯æŒ (Ctrl/Cmd + Shift + æ•°å­—)
const LAYOUT_SHORTCUT_MODIFIER = {
  ctrlKey: true,
  shiftKey: true,
  key: '1-5'
};
```

### 2. å¯¼èˆªå¿«æ·é”®
```typescript
interface NavigationKeys {
  // åœ¨å¸ƒå±€åˆ‡æ¢å™¨ä¸­å¯¼èˆª
  'ArrowLeft': 'previousLayoutMode',
  'ArrowRight': 'nextLayoutMode',
  
  // åœ¨åˆ—é—´å¯¼èˆª
  'Ctrl+ArrowLeft': 'focusPreviousColumn',
  'Ctrl+ArrowRight': 'focusNextColumn',
  
  // æ¿€æ´»/ç¡®è®¤æ“ä½œ
  'Enter': 'activateSelectedMode',
  'Space': 'activateSelectedMode',
  
  // å–æ¶ˆæ“ä½œ
  'Escape': 'cancelOperation',
  
  // Tabå¯¼èˆª
  'Tab': 'focusNextElement',
  'Shift+Tab': 'focusPreviousElement'
}
```

### 3. å†…å®¹æ“ä½œå¿«æ·é”®
```typescript
interface ContentOperationKeys {
  // åœ¨åˆ—ä¸­æ·»åŠ å†…å®¹
  'Ctrl+Enter': 'addContentToCurrentColumn',
  
  // ç§»åŠ¨Block
  'Ctrl+Shift+ArrowLeft': 'moveBlockToPreviousColumn',
  'Ctrl+Shift+ArrowRight': 'moveBlockToNextColumn',
  
  // åˆ—å®½è°ƒæ•´
  'Ctrl+Alt+ArrowLeft': 'decreaseColumnWidth',
  'Ctrl+Alt+ArrowRight': 'increaseColumnWidth',
  
  // é‡ç½®å¸ƒå±€
  'Ctrl+Shift+R': 'resetLayout'
}
```

## ğŸ¨ é”®ç›˜å¯¼èˆªå®ç°è®¾è®¡

### 1. LayoutSwitcheré”®ç›˜å¯¼èˆª
```typescript
// æ–‡ä»¶: packages/components/src/layout-switcher/keyboard-navigation.ts
export class LayoutSwitcherKeyboardHandler {
  private currentFocusIndex = 0;
  private availableModes: PageLayoutMode[] = [];
  
  constructor(private layoutSwitcher: LayoutSwitcher) {
    this.setupKeyboardListeners();
  }
  
  private setupKeyboardListeners() {
    // ç›‘å¬é”®ç›˜äº‹ä»¶
    this.layoutSwitcher.addEventListener('keydown', this.handleKeydown);
    
    // ç›‘å¬ç„¦ç‚¹äº‹ä»¶
    this.layoutSwitcher.addEventListener('focusin', this.handleFocusIn);
    this.layoutSwitcher.addEventListener('focusout', this.handleFocusOut);
  }
  
  private handleKeydown = (event: KeyboardEvent) => {
    switch (event.key) {
      case 'ArrowLeft':
        event.preventDefault();
        this.selectPreviousMode();
        break;
        
      case 'ArrowRight':
        event.preventDefault();
        this.selectNextMode();
        break;
        
      case 'Enter':
      case ' ':
        event.preventDefault();
        this.activateSelectedMode();
        break;
        
      case 'Escape':
        this.blur();
        break;
        
      default:
        // å¤„ç†æ•°å­—é”®å¿«æ·æ–¹å¼
        this.handleNumberKey(event);
    }
  };
  
  private handleNumberKey(event: KeyboardEvent) {
    const number = parseInt(event.key);
    if (number >= 1 && number <= 5) {
      const modes = Object.values(PageLayoutMode);
      const targetMode = modes[number - 1];
      
      if (targetMode && this.isModelAvailable(targetMode)) {
        event.preventDefault();
        this.layoutSwitcher.switchToMode(targetMode);
      }
    }
  }
  
  private selectPreviousMode() {
    this.currentFocusIndex = Math.max(0, this.currentFocusIndex - 1);
    this.updateFocusVisual();
  }
  
  private selectNextMode() {
    this.currentFocusIndex = Math.min(
      this.availableModes.length - 1, 
      this.currentFocusIndex + 1
    );
    this.updateFocusVisual();
  }
  
  private updateFocusVisual() {
    // æ›´æ–°é”®ç›˜ç„¦ç‚¹çš„è§†è§‰æŒ‡ç¤º
    const buttons = this.layoutSwitcher.querySelectorAll('.layout-button');
    buttons.forEach((button, index) => {
      button.classList.toggle('keyboard-focused', index === this.currentFocusIndex);
    });
    
    // ç¡®ä¿ç„¦ç‚¹æŒ‰é’®å¯è§
    this.scrollIntoView(buttons[this.currentFocusIndex] as HTMLElement);
  }
  
  private activateSelectedMode() {
    const selectedMode = this.availableModes[this.currentFocusIndex];
    if (selectedMode) {
      this.layoutSwitcher.switchToMode(selectedMode);
    }
  }
}
```

### 2. ColumnContenté”®ç›˜å¯¼èˆª
```typescript
// æ–‡ä»¶: packages/components/src/column-content/keyboard-navigation.ts
export class ColumnContentKeyboardHandler {
  private focusedBlockIndex = -1;
  
  constructor(private columnContent: ColumnContent) {
    this.setupKeyboardListeners();
  }
  
  private setupKeyboardListeners() {
    this.columnContent.addEventListener('keydown', this.handleKeydown);
  }
  
  private handleKeydown = (event: KeyboardEvent) => {
    // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ—å¯¼èˆªå¿«æ·é”®
    if (event.ctrlKey && (event.key === 'ArrowLeft' || event.key === 'ArrowRight')) {
      event.preventDefault();
      this.navigateToAdjacentColumn(event.key === 'ArrowRight' ? 1 : -1);
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯Blockç§»åŠ¨å¿«æ·é”®
    if (event.ctrlKey && event.shiftKey && 
        (event.key === 'ArrowLeft' || event.key === 'ArrowRight')) {
      event.preventDefault();
      this.moveCurrentBlockToAdjacentColumn(event.key === 'ArrowRight' ? 1 : -1);
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ·»åŠ å†…å®¹å¿«æ·é”®
    if (event.ctrlKey && event.key === 'Enter') {
      event.preventDefault();
      this.addContentToColumn();
      return;
    }
    
    // å¤„ç†å‚ç›´å¯¼èˆª
    switch (event.key) {
      case 'ArrowUp':
        event.preventDefault();
        this.focusPreviousBlock();
        break;
        
      case 'ArrowDown':
        event.preventDefault();
        this.focusNextBlock();
        break;
    }
  };
  
  private navigateToAdjacentColumn(direction: number) {
    const currentColumnIndex = this.columnContent.columnIndex;
    const targetColumnIndex = currentColumnIndex + direction;
    
    // è§¦å‘åˆ—å¯¼èˆªäº‹ä»¶
    this.columnContent.dispatchEvent(new CustomEvent('navigate-to-column', {
      detail: { targetColumnIndex },
      bubbles: true
    }));
  }
  
  private moveCurrentBlockToAdjacentColumn(direction: number) {
    if (this.focusedBlockIndex === -1) return;
    
    const currentBlock = this.columnContent.blocks[this.focusedBlockIndex];
    const targetColumnIndex = this.columnContent.columnIndex + direction;
    
    // è§¦å‘Blockç§»åŠ¨äº‹ä»¶
    this.columnContent.dispatchEvent(new CustomEvent('move-block', {
      detail: {
        blockId: currentBlock.id,
        targetColumnIndex,
        sourceColumnIndex: this.columnContent.columnIndex
      },
      bubbles: true
    }));
  }
  
  private addContentToColumn() {
    // åœ¨å½“å‰ç„¦ç‚¹ä½ç½®æ·»åŠ å†…å®¹
    const insertIndex = this.focusedBlockIndex + 1;
    
    this.columnContent.dispatchEvent(new CustomEvent('add-content', {
      detail: {
        columnIndex: this.columnContent.columnIndex,
        insertIndex
      },
      bubbles: true
    }));
  }
  
  private focusPreviousBlock() {
    if (this.focusedBlockIndex > 0) {
      this.focusedBlockIndex--;
      this.updateBlockFocus();
    }
  }
  
  private focusNextBlock() {
    if (this.focusedBlockIndex < this.columnContent.blocks.length - 1) {
      this.focusedBlockIndex++;
      this.updateBlockFocus();
    }
  }
  
  private updateBlockFocus() {
    // æ›´æ–°Blockç„¦ç‚¹è§†è§‰æŒ‡ç¤º
    const blockElements = this.columnContent.querySelectorAll('.block-item');
    blockElements.forEach((block, index) => {
      block.classList.toggle('keyboard-focused', index === this.focusedBlockIndex);
    });
    
    // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
    if (blockElements[this.focusedBlockIndex]) {
      blockElements[this.focusedBlockIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }
  }
}
```

### 3. å…¨å±€é”®ç›˜å¿«æ·é”®ç®¡ç†å™¨
```typescript
// æ–‡ä»¶: packages/components/src/shared/global-keyboard-manager.ts
export class GlobalLayoutKeyboardManager {
  private isEnabled = true;
  private registeredHandlers = new Map<string, KeyboardEventHandler>();
  
  constructor(private layoutService: IPageLayoutService) {
    this.setupGlobalListeners();
  }
  
  private setupGlobalListeners() {
    document.addEventListener('keydown', this.handleGlobalKeydown, true);
  }
  
  private handleGlobalKeydown = (event: KeyboardEvent) => {
    if (!this.isEnabled) return;
    
    // å¤„ç†å…¨å±€å¸ƒå±€å¿«æ·é”® (Ctrl/Cmd + Shift + æ•°å­—)
    if ((event.ctrlKey || event.metaKey) && event.shiftKey) {
      const number = parseInt(event.key);
      if (number >= 1 && number <= 5) {
        event.preventDefault();
        this.switchToLayoutByNumber(number);
        return;
      }
    }
    
    // å¤„ç†é‡ç½®å¸ƒå±€å¿«æ·é”® (Ctrl/Cmd + Shift + R)
    if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'r') {
      event.preventDefault();
      this.resetLayout();
      return;
    }
    
    // å§”æ‰˜ç»™æ³¨å†Œçš„å¤„ç†å™¨
    const key = this.getEventKey(event);
    const handler = this.registeredHandlers.get(key);
    if (handler) {
      handler(event);
    }
  };
  
  private switchToLayoutByNumber(number: number) {
    const modes = Object.values(PageLayoutMode);
    const targetMode = modes[number - 1];
    
    if (targetMode) {
      // è·å–å½“å‰æ–‡æ¡£ID (éœ€è¦ä»ä¸Šä¸‹æ–‡è·å–)
      const docId = this.getCurrentDocId();
      this.layoutService.setLayoutMode(targetMode, docId);
      
      // æ˜¾ç¤ºåˆ‡æ¢æç¤º
      this.showKeyboardShortcutFeedback(`å·²åˆ‡æ¢åˆ°${this.getModeDisplayName(targetMode)}`);
    }
  }
  
  private resetLayout() {
    const docId = this.getCurrentDocId();
    
    // é‡ç½®ä¸ºå•åˆ—å¸ƒå±€ï¼Œç­‰å®½åˆ†å¸ƒ
    this.layoutService.setLayoutMode(PageLayoutMode.Normal, docId);
    
    // æ˜¾ç¤ºé‡ç½®æç¤º
    this.showKeyboardShortcutFeedback('å¸ƒå±€å·²é‡ç½®');
  }
  
  private showKeyboardShortcutFeedback(message: string) {
    // æ˜¾ç¤ºä¸´æ—¶æç¤ºæ¶ˆæ¯
    const toast = document.createElement('div');
    toast.className = 'keyboard-shortcut-toast';
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--affine-background-overlay-panel-color);
      color: var(--affine-text-primary-color);
      padding: 8px 16px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      font-size: 14px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // åŠ¨ç”»æ˜¾ç¤º
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }
  
  // å…¬å…±æ–¹æ³•
  registerKeyboardHandler(key: string, handler: KeyboardEventHandler) {
    this.registeredHandlers.set(key, handler);
  }
  
  unregisterKeyboardHandler(key: string) {
    this.registeredHandlers.delete(key);
  }
  
  enable() {
    this.isEnabled = true;
  }
  
  disable() {
    this.isEnabled = false;
  }
  
  dispose() {
    document.removeEventListener('keydown', this.handleGlobalKeydown, true);
    this.registeredHandlers.clear();
  }
}

type KeyboardEventHandler = (event: KeyboardEvent) => void;
```

## ğŸ¨ é”®ç›˜å¯¼èˆªæ ·å¼è®¾è®¡

### 1. ç„¦ç‚¹æŒ‡ç¤ºå™¨æ ·å¼
```css
/* æ–‡ä»¶: packages/components/src/shared/keyboard-styles.ts */
export const keyboardNavigationStyles = css`
  /* å¸ƒå±€åˆ‡æ¢å™¨é”®ç›˜ç„¦ç‚¹ */
  .layout-button.keyboard-focused {
    outline: 2px solid var(--affine-primary-color);
    outline-offset: 2px;
    box-shadow: 0 0 0 4px var(--affine-primary-color-alpha);
  }
  
  /* åˆ—å†…å®¹é”®ç›˜ç„¦ç‚¹ */
  .column-content.keyboard-focused {
    border-color: var(--affine-primary-color);
    box-shadow: 0 0 0 3px var(--affine-primary-color-alpha);
  }
  
  /* Blocké”®ç›˜ç„¦ç‚¹ */
  .block-item.keyboard-focused {
    outline: 2px solid var(--affine-primary-color);
    outline-offset: 1px;
    background: var(--affine-primary-color-alpha);
  }
  
  /* é”®ç›˜å¿«æ·é”®æç¤º */
  .keyboard-shortcut-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--affine-background-overlay-panel-color);
    color: var(--affine-text-primary-color);
    padding: 8px 16px;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    font-size: 14px;
    font-weight: 500;
    border: 1px solid var(--affine-border-color);
  }
  
  /* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
  @media (prefers-contrast: high) {
    .keyboard-focused {
      outline-width: 3px;
      outline-style: solid;
    }
  }
  
  /* å‡å¼±åŠ¨ç”»æ¨¡å¼ */
  @media (prefers-reduced-motion: reduce) {
    .keyboard-shortcut-toast {
      transition: none;
    }
  }
`;
```

### 2. é”®ç›˜å¯¼èˆªè¾…åŠ©ç»„ä»¶
```typescript
// æ–‡ä»¶: packages/components/src/shared/keyboard-hint.ts
@customElement('keyboard-hint')
export class KeyboardHint extends LitElement {
  @property() shortcuts: Array<{key: string, description: string}> = [];
  @property() visible = false;
  
  static styles = css`
    :host {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--affine-background-overlay-panel-color);
      border: 1px solid var(--affine-border-color);
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      z-index: 1000;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
      max-width: 300px;
    }
    
    :host([visible]) {
      opacity: 1;
      transform: translateY(0);
    }
    
    .hint-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--affine-text-primary-color);
    }
    
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      font-size: 12px;
    }
    
    .shortcut-key {
      background: var(--affine-background-secondary-color);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      border: 1px solid var(--affine-border-color);
    }
    
    .shortcut-description {
      color: var(--affine-text-secondary-color);
      margin-right: 8px;
    }
  `;
  
  render() {
    return html`
      <div class="hint-title">é”®ç›˜å¿«æ·é”®</div>
      ${this.shortcuts.map(shortcut => html`
        <div class="shortcut-item">
          <span class="shortcut-description">${shortcut.description}</span>
          <kbd class="shortcut-key">${shortcut.key}</kbd>
        </div>
      `)}
    `;
  }
}
```

## ğŸ“š ä½¿ç”¨æ–‡æ¡£

### å¿«æ·é”®åˆ—è¡¨
| åŠŸèƒ½ | å¿«æ·é”® | è¯´æ˜ |
|------|--------|------|
| åˆ‡æ¢åˆ°å•åˆ—å¸ƒå±€ | `Ctrl+Shift+1` | å¿«é€Ÿåˆ‡æ¢åˆ°å•åˆ—å¸ƒå±€ |
| åˆ‡æ¢åˆ°åŒåˆ—å¸ƒå±€ | `Ctrl+Shift+2` | å¿«é€Ÿåˆ‡æ¢åˆ°åŒåˆ—å¸ƒå±€ |
| åˆ‡æ¢åˆ°ä¸‰åˆ—å¸ƒå±€ | `Ctrl+Shift+3` | å¿«é€Ÿåˆ‡æ¢åˆ°ä¸‰åˆ—å¸ƒå±€ |
| åˆ‡æ¢åˆ°å››åˆ—å¸ƒå±€ | `Ctrl+Shift+4` | å¿«é€Ÿåˆ‡æ¢åˆ°å››åˆ—å¸ƒå±€ |
| åˆ‡æ¢åˆ°äº”åˆ—å¸ƒå±€ | `Ctrl+Shift+5` | å¿«é€Ÿåˆ‡æ¢åˆ°äº”åˆ—å¸ƒå±€ |
| é‡ç½®å¸ƒå±€ | `Ctrl+Shift+R` | é‡ç½®æ‰€æœ‰å¸ƒå±€è®¾ç½® |
| å¯¼èˆªåˆ°ä¸Šä¸€ä¸ªæ¨¡å¼ | `â†` | åœ¨å¸ƒå±€åˆ‡æ¢å™¨ä¸­å‘å·¦å¯¼èˆª |
| å¯¼èˆªåˆ°ä¸‹ä¸€ä¸ªæ¨¡å¼ | `â†’` | åœ¨å¸ƒå±€åˆ‡æ¢å™¨ä¸­å‘å³å¯¼èˆª |
| å¯¼èˆªåˆ°ä¸Šä¸€åˆ— | `Ctrl+â†` | ç„¦ç‚¹ç§»åŠ¨åˆ°å·¦ä¾§åˆ— |
| å¯¼èˆªåˆ°ä¸‹ä¸€åˆ— | `Ctrl+â†’` | ç„¦ç‚¹ç§»åŠ¨åˆ°å³ä¾§åˆ— |
| ç§»åŠ¨Blockåˆ°å·¦åˆ— | `Ctrl+Shift+â†` | å°†å½“å‰Blockç§»åŠ¨åˆ°å·¦ä¾§åˆ— |
| ç§»åŠ¨Blockåˆ°å³åˆ— | `Ctrl+Shift+â†’` | å°†å½“å‰Blockç§»åŠ¨åˆ°å³ä¾§åˆ— |
| æ·»åŠ å†…å®¹ | `Ctrl+Enter` | åœ¨å½“å‰åˆ—ä¸­æ·»åŠ æ–°å†…å®¹ |
| æ¿€æ´»/ç¡®è®¤ | `Enter` æˆ– `Space` | æ¿€æ´»é€‰ä¸­çš„å¸ƒå±€æ¨¡å¼ |
| å–æ¶ˆæ“ä½œ | `Escape` | å–æ¶ˆå½“å‰æ“ä½œæˆ–å¤±å»ç„¦ç‚¹ |

### é”®ç›˜å¯¼èˆªæµç¨‹
1. **è¿›å…¥å¸ƒå±€åˆ‡æ¢å™¨**: Tabé”®æˆ–ç‚¹å‡»è¿›å…¥ç„¦ç‚¹
2. **é€‰æ‹©å¸ƒå±€æ¨¡å¼**: ä½¿ç”¨æ–¹å‘é”®æˆ–æ•°å­—é”®é€‰æ‹©
3. **æ¿€æ´»å¸ƒå±€**: Enteræˆ–Spaceé”®æ¿€æ´»é€‰ä¸­æ¨¡å¼
4. **åˆ—é—´å¯¼èˆª**: Ctrl+æ–¹å‘é”®åœ¨åˆ—é—´ç§»åŠ¨ç„¦ç‚¹
5. **æ“ä½œå†…å®¹**: ä½¿ç”¨ç›¸åº”å¿«æ·é”®æ“ä½œBlockå’Œæ·»åŠ å†…å®¹

è¿™ä¸ªé”®ç›˜å¯¼èˆªç³»ç»Ÿç¡®ä¿äº†ï¼š
- å®Œå…¨çš„é”®ç›˜å¯è®¿é—®æ€§
- ç¬¦åˆWebæ ‡å‡†çš„ç„¦ç‚¹ç®¡ç†
- ä¸BlockSuiteç°æœ‰äº¤äº’æ¨¡å¼ä¸€è‡´
- æä¾›ä¸°å¯Œçš„è§†è§‰åé¦ˆ
- æ”¯æŒé«˜çº§ç”¨æˆ·çš„å¿«é€Ÿæ“ä½œ