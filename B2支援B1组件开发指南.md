# B2 æ”¯æ´ B1 ç»„ä»¶å¼€å‘æŒ‡å—

## ğŸ¯ æ”¯æ´ç›®æ ‡

ä½œä¸ºå·²å®Œæˆæ‰€æœ‰äº¤äº’è®¾è®¡ä»»åŠ¡çš„å¼€å‘è€…B2ï¼Œç°åœ¨ååŠ©å¼€å‘è€…B1è¿›è¡Œç»„ä»¶æ¶æ„å’Œå¼€å‘å·¥ä½œã€‚

## ğŸ”— äº¤äº’ä¸ç»„ä»¶çš„é›†æˆæ–¹æ¡ˆ

### 1. LayoutSwitcher ç»„ä»¶äº¤äº’é›†æˆ

#### åŸºç¡€ç»„ä»¶ç»“æ„å»ºè®®
```typescript
// æ–‡ä»¶: packages/components/src/layout-switcher/layout-switcher.ts
import { LitElement, html, css } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import { InteractionManager } from '../column-content/interaction-manager.js';

@customElement('layout-switcher')
export class LayoutSwitcher extends LitElement {
  @property() currentMode: PageLayoutMode = PageLayoutMode.Normal;
  @property() disabled = false;
  
  @state() private interactionManager?: InteractionManager;
  
  protected firstUpdated() {
    // åˆå§‹åŒ–äº¤äº’ç®¡ç†å™¨
    this.interactionManager = new InteractionManager(this, {
      enableDrag: false, // åˆ‡æ¢å™¨ä¸éœ€è¦æ‹–æ‹½
      enableAnimations: true,
      enableAccessibility: true,
      enableSlashMenu: false // åˆ‡æ¢å™¨ä¸éœ€è¦SlashMenu
    });
    
    // è®¾ç½®åˆ‡æ¢å™¨çš„å¯è®¿é—®æ€§
    this.interactionManager.setupLayoutSwitcherInteraction(this);
  }
  
  protected render() {
    return html`
      <div class="layout-switcher-container">
        ${this.renderLayoutButtons()}
      </div>
    `;
  }
  
  private renderLayoutButtons() {
    const modes = [
      { mode: PageLayoutMode.Normal, icon: 'â”', label: 'å•åˆ—' },
      { mode: PageLayoutMode.TwoColumn, icon: 'â–¢â–¢', label: 'åŒåˆ—' },
      { mode: PageLayoutMode.ThreeColumn, icon: 'â–¢â–¢â–¢', label: 'ä¸‰åˆ—' },
      { mode: PageLayoutMode.FourColumn, icon: 'â–¢â–¢â–¢â–¢', label: 'å››åˆ—' },
      { mode: PageLayoutMode.FiveColumn, icon: 'â–¢â–¢â–¢â–¢â–¢', label: 'äº”åˆ—' }
    ];
    
    return modes.map(({ mode, icon, label }) => html`
      <button 
        class="layout-button ${mode === this.currentMode ? 'active' : ''}"
        @click=${() => this.handleModeChange(mode)}
        @keydown=${this.handleKeydown}
        aria-label="åˆ‡æ¢åˆ°${label}å¸ƒå±€"
        data-mode=${mode}
      >
        <span class="layout-icon">${icon}</span>
        <span class="layout-label">${label}</span>
      </button>
    `);
  }
  
  private async handleModeChange(newMode: PageLayoutMode) {
    if (this.disabled || newMode === this.currentMode) return;
    
    // è§¦å‘æ¨¡å¼åˆ‡æ¢äº‹ä»¶
    const changeEvent = new CustomEvent('layout-mode-change', {
      detail: { 
        oldMode: this.currentMode, 
        newMode,
        timestamp: Date.now() 
      },
      bubbles: true
    });
    
    this.dispatchEvent(changeEvent);
    this.currentMode = newMode;
    
    // æ’­æ”¾åˆ‡æ¢åé¦ˆåŠ¨ç”»
    if (this.interactionManager) {
      const button = this.querySelector(`[data-mode="${newMode}"]`);
      if (button) {
        this.interactionManager.getModules().animations?.animateButtonClick(button as HTMLElement);
      }
    }
  }
  
  private handleKeydown(event: KeyboardEvent) {
    // é”®ç›˜å¯¼èˆªé€»è¾‘å·²åœ¨InteractionManagerä¸­å¤„ç†
    // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„ç»„ä»¶ç‰¹å®šé€»è¾‘
  }
  
  disconnectedCallback() {
    super.disconnectedCallback();
    this.interactionManager?.cleanup();
  }
}
```

### 2. ColumnContent ç»„ä»¶äº¤äº’é›†æˆ

#### ç»„ä»¶æ¶æ„å»ºè®®
```typescript
// æ–‡ä»¶: packages/components/src/column-content/column-content.ts
import { LitElement, html, css } from 'lit';
import { customElement, property, state } from 'lit/decorators.js';
import { InteractionManager } from './interaction-manager.js';
import { AddContentButton } from './add-content-button.js';

@customElement('column-content')
export class ColumnContent extends LitElement {
  @property() columnIndex!: number;
  @property() blocks: Block[] = [];
  @property() readonly = false;
  
  @state() private interactionManager?: InteractionManager;
  
  protected firstUpdated() {
    // åˆå§‹åŒ–å®Œæ•´çš„äº¤äº’ç®¡ç†å™¨
    this.interactionManager = new InteractionManager(this, {
      enableDrag: true,
      enableAnimations: true,
      enableStateManagement: true,
      enableAccessibility: true,
      enableSlashMenu: true
    });
    
    // è®¾ç½®åˆ—çš„äº¤äº’åŠŸèƒ½
    this.interactionManager.setupColumnInteraction(this, this.columnIndex);
    
    // ç›‘å¬å†…å®¹å˜åŒ–äº‹ä»¶
    this.addEventListener('block-created', this.handleBlockCreated);
    this.addEventListener('block-moved', this.handleBlockMoved);
    this.addEventListener('block-removed', this.handleBlockRemoved);
  }
  
  protected render() {
    return html`
      <div class="column-content" data-column-index=${this.columnIndex}>
        <div class="column-header">
          <span class="column-title">ç¬¬ ${this.columnIndex + 1} åˆ—</span>
          <span class="block-count">${this.blocks.length} é¡¹</span>
        </div>
        
        <div class="column-blocks">
          ${this.blocks.map((block, index) => this.renderBlock(block, index))}
        </div>
        
        ${!this.readonly ? html`
          <add-content-button 
            .columnIndex=${this.columnIndex}
            @show-slash-menu=${this.handleShowSlashMenu}
          ></add-content-button>
        ` : ''}
      </div>
    `;
  }
  
  private renderBlock(block: Block, index: number) {
    return html`
      <div 
        class="block-item" 
        data-block-id=${block.id}
        data-block-type=${block.flavour}
        @mounted=${() => this.setupBlockInteraction(block, index)}
      >
        <!-- è¿™é‡Œæ¸²æŸ“å…·ä½“çš„Blockå†…å®¹ -->
        ${this.renderBlockContent(block)}
      </div>
    `;
  }
  
  private setupBlockInteraction(block: Block, index: number) {
    const blockElement = this.querySelector(`[data-block-id="${block.id}"]`) as HTMLElement;
    if (blockElement && this.interactionManager) {
      this.interactionManager.setupBlockInteraction(
        blockElement, 
        block.flavour, 
        this.columnIndex, 
        index
      );
    }
  }
  
  private handleBlockCreated = (event: CustomEvent) => {
    if (this.interactionManager) {
      const { blockElement, blockType } = event.detail;
      this.interactionManager.handleContentAdded(blockElement, this.columnIndex, blockType);
    }
  };
  
  private handleBlockMoved = (event: CustomEvent) => {
    if (this.interactionManager) {
      const { blockElement, fromColumn, toColumn } = event.detail;
      this.interactionManager.handleContentMoved(blockElement, fromColumn, toColumn);
    }
  };
  
  private handleBlockRemoved = async (event: CustomEvent) => {
    if (this.interactionManager) {
      const { blockElement } = event.detail;
      await this.interactionManager.handleContentRemoved(blockElement);
    }
  };
  
  private handleShowSlashMenu = (event: CustomEvent) => {
    // SlashMenuæ˜¾ç¤ºé€»è¾‘å·²åœ¨InteractionManagerä¸­å¤„ç†
    // è¿™é‡Œå¯ä»¥æ·»åŠ ç»„ä»¶ç‰¹å®šçš„å¤„ç†é€»è¾‘
  };
  
  disconnectedCallback() {
    super.disconnectedCallback();
    this.interactionManager?.cleanup();
  }
}
```

## ğŸ¨ æ ·å¼é›†æˆå»ºè®®

### äº¤äº’çŠ¶æ€æ ·å¼
```css
/* æ–‡ä»¶: packages/components/src/column-content/column-content-styles.ts */
export const columnContentStyles = css`
  .column-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 16px;
    border: 1px solid var(--affine-border-color);
    border-radius: 8px;
    background: var(--affine-background-primary-color);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* äº¤äº’çŠ¶æ€æ ·å¼ */
  .column-content.interaction-focused {
    outline: 2px solid var(--affine-primary-color);
    outline-offset: 2px;
  }
  
  .column-content.interaction-hovered {
    border-color: var(--affine-primary-color);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  }
  
  .column-content[data-drop-target="true"] {
    background: var(--affine-primary-color-alpha);
    border-color: var(--affine-primary-color);
    border-style: dashed;
  }
  
  /* Blocké¡¹ç›®æ ·å¼ */
  .block-item {
    position: relative;
    padding: 12px;
    border: 1px solid transparent;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  
  .block-item.interaction-selected {
    background: var(--affine-primary-color-alpha);
    border-color: var(--affine-primary-color);
  }
  
  .block-item.interaction-dragging {
    opacity: 0.5;
    transform: rotate(2deg);
    z-index: 1000;
  }
  
  /* æ‹–æ‹½æŒ‡ç¤ºå™¨ */
  .drop-indicator {
    position: absolute;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--affine-primary-color);
    border-radius: 1px;
    z-index: 10;
  }
  
  /* åˆ—å¤´æ ·å¼ */
  .column-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--affine-background-secondary-color);
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
  }
  
  .column-title {
    color: var(--affine-text-primary-color);
  }
  
  .block-count {
    color: var(--affine-text-secondary-color);
    font-size: 12px;
  }
`;
```

## ğŸ”„ äº‹ä»¶æµç¨‹è®¾è®¡

### å¸ƒå±€åˆ‡æ¢å®Œæ•´æµç¨‹
```typescript
// äº‹ä»¶æµç¨‹ï¼šLayoutSwitcher -> PageLayoutManager -> ColumnContent
// 1. ç”¨æˆ·ç‚¹å‡»å¸ƒå±€æŒ‰é’®
// 2. LayoutSwitcher è§¦å‘ 'layout-mode-change' äº‹ä»¶
// 3. PageLayoutManager æ¥æ”¶äº‹ä»¶ï¼Œå¤„ç†å¸ƒå±€é€»è¾‘
// 4. è°ƒç”¨ InteractionManager.handleLayoutSwitch() æ’­æ”¾åŠ¨ç”»
// 5. æ›´æ–° ColumnContent ç»„ä»¶
// 6. å®Œæˆå¸ƒå±€åˆ‡æ¢

interface LayoutChangeEventDetail {
  oldMode: PageLayoutMode;
  newMode: PageLayoutMode;
  timestamp: number;
}

// åœ¨ PageLayoutManager ä¸­å¤„ç†
async handleLayoutChange(event: CustomEvent<LayoutChangeEventDetail>) {
  const { oldMode, newMode } = event.detail;
  
  // è·å–æ—§åˆ—å’Œæ–°åˆ—
  const oldColumns = this.getCurrentColumns();
  const newColumns = await this.createNewColumns(newMode);
  
  // ä½¿ç”¨ InteractionManager æ’­æ”¾åˆ‡æ¢åŠ¨ç”»
  const interactionManager = this.getInteractionManager();
  await interactionManager.handleLayoutSwitch(oldColumns, newColumns, newMode);
  
  // æ›´æ–°é¡µé¢å¸ƒå±€
  this.updatePageLayout(newColumns);
}
```

## ğŸ§ª ç»„ä»¶æµ‹è¯•å»ºè®®

### äº¤äº’åŠŸèƒ½æµ‹è¯•
```typescript
// æ–‡ä»¶: packages/components/test/column-content.test.ts
import { expect, fixture, html } from '@open-wc/testing';
import { ColumnContent } from '../src/column-content/column-content.js';

describe('ColumnContent with Interactions', () => {
  it('should initialize interaction manager correctly', async () => {
    const el = await fixture<ColumnContent>(html`
      <column-content .columnIndex=${0}></column-content>
    `);
    
    expect(el.interactionManager).to.exist;
    expect(el.getAttribute('data-interactive')).to.equal('true');
  });
  
  it('should handle keyboard navigation', async () => {
    const el = await fixture<ColumnContent>(html`
      <column-content .columnIndex=${0}></column-content>
    `);
    
    // æ¨¡æ‹ŸTabé”®å¯¼èˆª
    const tabEvent = new KeyboardEvent('keydown', { key: 'Tab' });
    el.dispatchEvent(tabEvent);
    
    // éªŒè¯ç„¦ç‚¹ç®¡ç†
    expect(el.querySelector('.interaction-focused')).to.exist;
  });
  
  it('should handle drag and drop', async () => {
    const el = await fixture<ColumnContent>(html`
      <column-content .columnIndex=${0}></column-content>
    `);
    
    // æ¨¡æ‹Ÿæ‹–æ‹½äº‹ä»¶
    const dragEvent = new DragEvent('dragstart');
    el.dispatchEvent(dragEvent);
    
    // éªŒè¯æ‹–æ‹½çŠ¶æ€
    expect(el.querySelector('.interaction-dragging')).to.exist;
  });
});
```

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

ä½œä¸ºB2ï¼Œæˆ‘å»ºè®®B1æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è¿›è¡Œå¼€å‘ï¼š

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆç«‹å³å¼€å§‹ï¼‰
1. **LayoutSwitcher åŸºç¡€ç»„ä»¶** - é›†æˆæˆ‘æä¾›çš„äº¤äº’ç®¡ç†å™¨
2. **ç»„ä»¶ç›®å½•ç»“æ„** - æŒ‰ç…§æˆ‘çš„äº¤äº’æ¨¡å—ç»“æ„ç»„ç»‡
3. **åŸºç¡€äº‹ä»¶ç³»ç»Ÿ** - ä½¿ç”¨æˆ‘è®¾è®¡çš„äº‹ä»¶æµç¨‹

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆæ˜æ—¥å¼€å§‹ï¼‰
1. **ColumnContent æ ¸å¿ƒç»„ä»¶** - å®Œæ•´é›†æˆæ‰€æœ‰äº¤äº’åŠŸèƒ½
2. **ç»„ä»¶æ ·å¼ç³»ç»Ÿ** - ä¸B3åä½œï¼Œé›†æˆäº¤äº’çŠ¶æ€æ ·å¼
3. **ç»„ä»¶æµ‹è¯•** - éªŒè¯äº¤äº’åŠŸèƒ½æ­£å¸¸

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆåç»­å®Œå–„ï¼‰
1. **é«˜çº§ç»„ä»¶åŠŸèƒ½** - åŸºäºæˆ‘çš„äº¤äº’ç³»ç»Ÿæ‰©å±•
2. **æ€§èƒ½ä¼˜åŒ–** - ä¼˜åŒ–äº¤äº’å“åº”æ€§èƒ½
3. **æ–‡æ¡£å®Œå–„** - ç»„ä»¶ä½¿ç”¨æ–‡æ¡£

## ğŸ¤ åä½œæ–¹å¼

1. **å®æ—¶æ²Ÿé€š**: æˆ‘ä¼šæŒç»­å…³æ³¨B1çš„å¼€å‘è¿›åº¦ï¼Œæä¾›å³æ—¶æ”¯æŒ
2. **ä»£ç å®¡æŸ¥**: æˆ‘ä¼šå®¡æŸ¥B1çš„ç»„ä»¶ä»£ç ï¼Œç¡®ä¿äº¤äº’é›†æˆæ­£ç¡®
3. **é—®é¢˜è§£å†³**: é‡åˆ°äº¤äº’ç›¸å…³é—®é¢˜ï¼Œæˆ‘ä¼šç«‹å³ååŠ©è§£å†³
4. **æµ‹è¯•æ”¯æŒ**: å¸®åŠ©B1ç¼–å†™äº¤äº’åŠŸèƒ½çš„æµ‹è¯•ç”¨ä¾‹

---

**å¼€å‘è€…B2æ”¯æ´å°±ç»ª** âœ…  
*éšæ—¶ä¸ºB1çš„ç»„ä»¶å¼€å‘æä¾›äº¤äº’è®¾è®¡å’ŒæŠ€æœ¯æ”¯æŒï¼*