# 通知中心功能（功能 + 实现说明）

> 关联上级：`论坛/通知与管理.md`  
> 相关代码位置：
> - 页面组件：`packages/frontend/core/src/desktop/pages/workspace/forum/notifications/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`（通知相关）
> - 类型定义：`packages/frontend/core/src/desktop/pages/workspace/forum/types.ts`（`NotificationDTO`）

---

## 1. 通知数据模型与类型

### 1.1 NotificationDTO 结构

- 在 `types.ts` 中定义：

```ts
export interface NotificationDTO {
  id: string;
  type:
    | 'ForumMention'
    | 'ForumPostReplied'
    | 'ForumReplyLiked'
    | 'ForumPostLiked'
    | 'ForumPostModerated';
  isRead: boolean;
  createdAt: string;
  actorId?: number;
  actorName?: string;
  forumId?: number;
  postId?: string;
  replyId?: number;
  title?: string;
  excerpt?: string;
  metadata?: Record<string, unknown>;
}
```

- 类型说明：
  - `ForumMention`：在帖子或回复中被 `@` 提及；
  - `ForumPostReplied`：自己的帖子收到回复；
  - `ForumReplyLiked` / `ForumPostLiked`：自己的回复或帖子被点赞；
  - `ForumPostModerated`：帖子被版主操作（置顶、加精、锁定等）。

### 1.2 通知相关 API

- `getNotifications(page, size, type?)`：
  - 若 `type` 为空，返回所有类型通知；
  - 若 `type` 非空，仅返回指定类型通知；
  - 返回 `PaginatedResponse<NotificationDTO>`。

- `getUnreadCount()`：
  - 返回当前用户未读通知数量；
  - 用于在导航栏或入口处显示红点/数量。

- `markAsRead(notificationId)`：
  - 将指定通知标记为已读；
  - 返回更新后的 `NotificationDTO`。

- `markAllAsRead()`：
  - 将当前用户所有通知标记为已读；
  - 返回布尔值表示成功与否。

---

## 2. 通知中心页面结构（/forum/notifications）

### 2.1 Tab 设计与类型映射

- 通知中心使用 Tab 区分不同类型通知：

```ts
type TabKey = 'ALL' | 'MENTION' | 'REPLY' | 'LIKE' | 'MOD';

const tabLabels: Record<TabKey, string> = {
  ALL: '全部',
  MENTION: '@提及',
  REPLY: '回复',
  LIKE: '点赞',
  MOD: '版主操作',
};
```

- 每个 Tab 对应一个或多个后端通知类型：

```ts
const tabToTypes: Record<TabKey, NotificationDTO['type'][] | null> = {
  ALL: null,
  MENTION: ['ForumMention'],
  REPLY: ['ForumPostReplied'],
  LIKE: ['ForumReplyLiked', 'ForumPostLiked'],
  MOD: ['ForumPostModerated'],
};
```

- 页面状态：
  - `activeTab`：当前选中的 Tab；
  - `page` / `totalPages`：分页信息；
  - `list`：当前页面的通知列表；
  - `loading`：加载状态。

### 2.2 服务端过滤与客户端过滤结合

- 为兼顾后端能力与前端灵活性，页面对“type 参数”的使用做了区分：

```ts
const serverTypeParam = useMemo(() => {
  const types = tabToTypes[activeTab];
  // 只有只有一个明确类型时传给后端type参数，否则传undefined，本地筛选
  if (types && types.length === 1) return types[0];
  return undefined;
}, [activeTab]);
```

- 策略说明：
  - 若当前 Tab 只包含一个类型（如 `MENTION` → `ForumMention`），则直接在请求中传 `type` 参数，让后端过滤；
  - 若包含多个类型（如 `LIKE` → `ForumReplyLiked` + `ForumPostLiked`），则不传 `type`，由前端在拿到全量结果后按类型过滤。

---

## 3. 通知列表加载与展示

### 3.1 数据加载逻辑

- 在 `useEffect` 中根据 `activeTab` 和 `page` 加载通知列表：

```ts
useEffect(() => {
  setLoading(true);
  getNotifications(page, PAGE_SIZE, serverTypeParam)
    .then(res => {
      const { content, totalPages } = res;
      setTotalPages(totalPages);
      // 如果当前tab只映射多个类型，则在客户端过滤
      if (clientFilter) {
        setList(content.filter(n => clientFilter.includes(n.type)));
      } else {
        setList(content);
      }
    })
    .catch(err => {
      console.error(err);
      alert('加载通知失败');
    })
    .finally(() => setLoading(false));
}, [activeTab, page, serverTypeParam, clientFilter]);
```

- 本地 `clientFilter`：
  - 若当前 Tab 的类型数组长度 > 1，则 `clientFilter` 为该数组；
  - 否则为 `null`，表示不需要在前端再筛选。

### 3.2 页面头部与“全部已读”

- 页面顶部显示标题与“全部已读”按钮：

```tsx
<div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
  <h2>通知中心</h2>
  <button onClick={onMarkAll}>全部已读</button>
</div>
```

- `onMarkAll` 调用 `markAllAsRead`：

```ts
const onMarkAll = async () => {
  try {
    await apiMarkAllAsRead();
    setList(prev => prev.map(x => ({ ...x, isRead: true })));
  } catch (e) {
    // ignore
  }
};
```

---

## 4. 列表渲染与点击跳转

### 4.1 空状态与加载状态

- 若 `loading` 为 true，显示“加载中...”；
- 若当前 Tab 下 `list.length === 0`，显示插画与文案：
  - 例如 “暂无 xxx 通知 / 你可以在这里查看与你相关的所有动态”；
- 保证不同 Tab 在没有通知时都有清晰反馈。

### 4.2 单条通知的展示

- 对每一条通知绘制一个条目：

```tsx
<div
  key={n.id}
  onClick={() => onClickItem(n)}
  style={{
    padding: 14,
    borderBottom: '1px solid #f0f0f0',
    background: n.isRead ? '#fff' : '#fffbe6',
    cursor: 'pointer',
  }}
>
  <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
    <span /* 类型标签 */>{类型文案}</span>
    <strong>{n.title || n.excerpt || '新的通知'}</strong>
  </div>
  <div /* 摘要行 */>
    {n.actorName ? `${n.actorName} ` : ''}
    {n.excerpt || ''}
  </div>
  <div /* 时间行 */>
    {new Date(n.createdAt).toLocaleString()}
  </div>
 </div>
```

- 类型标签根据 `n.type` 映射为不同颜色与文案：
  - `ForumMention` → `@提及`；
  - `ForumPostReplied` → `回复`；
  - `ForumReplyLiked` / `ForumPostLiked` → `点赞`；
  - `ForumPostModerated` → `版主操作`。

- 已读 vs 未读：
  - 未读通知背景为淡黄色（`#fffbe6`），更醒目；
  - 已读为白色背景。

### 4.3 点击跳转逻辑

- `onClickItem` 根据通知中的 `postId` / `forumId` 决定跳转位置：
  - 若有 `postId`，通常跳转到帖子详情 `/forum/{forumId}/post/{postId}`；
  - 若只有 `forumId`，则跳转到板块详情 `/forum/{forumId}`；
  - 具体解析逻辑封装在通知点击回调中（可进一步增强，例如跳转到特定回复楼层）。

- 点击后可选：
  - 调用 `markAsRead` 将该通知标记为已读；
  - 或延后到进入详情页后统一处理。

---

通知中心通过“类型 Tab + 服务端/客户端联合过滤 + 清晰的视觉标记”，为用户提供了一个集中查看论坛动态的入口；配合导航上的未读计数，可以满足大部分“消息中心”场景的需求。 
