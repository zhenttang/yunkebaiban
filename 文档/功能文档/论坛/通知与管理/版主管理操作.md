# 版主管理操作（功能 + 实现说明）

> 关联上级：`论坛/通知与管理.md`  
> 相关代码位置：
> - 版主面板页面：`packages/frontend/core/src/desktop/pages/workspace/forum/moderator-panel/index.tsx`
> - 举报相关 API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`
> - 类型定义：`packages/frontend/core/src/desktop/pages/workspace/forum/types.ts`（`ReportDTO`、`HandleReportRequest`）

---

## 1. 举报数据模型与 API

### 1.1 ReportDTO 结构

- 举报对象类型在 `types.ts` 中定义：

```ts
export interface ReportDTO {
  id: number;
  targetType: ReportTargetType;
  targetId: string;
  reporterId: number;
  reporterName?: string;
  reason: string;
  description?: string;
  status: ReportHandleStatus;
  handlerId?: number;
  handlerName?: string;
  handleNote?: string;
  handledAt?: string;
  createdAt: string;
}
```

- 说明：
  - `targetType`：举报目标类型（帖子/回复等，具体枚举看 `ReportTargetType`）；
  - `targetId`：目标对象的 ID；
  - `reporterId` / `reporterName`：举报人信息；
  - `reason` / `description`：举报原因与描述；
  - `status`：举报处理状态（`PENDING` / `RESOLVED` / `REJECTED`）；
  - `handlerId` / `handlerName` / `handleNote` / `handledAt`：处理人及处置记录。

### 1.2 处理请求结构

- 对举报的处理通过 `HandleReportRequest` 进行描述：

```ts
export interface HandleReportRequest {
  status: Exclude<ReportHandleStatus, 'PENDING'>; // 仅处理为 RESOLVED/REJECTED
  handleNote?: string;
}
```

- 其中：
  - `status`：只能是 `RESOLVED`（通过）或 `REJECTED`（驳回）；
  - `handleNote`：处理备注，选填。

### 1.3 举报相关 API

- `getPendingReports()`：
  - 返回当前待处理的举报列表；
  - Mock 模式下从 `mockDB.reports` 拿全部，实际环境中只拿状态为 `PENDING` 的记录。

- `getMyReports(userId)`：
  - 返回指定用户提交的举报列表（版主面板当前未使用，可用于“我的举报”页面）。

- `handleReport(id, data)`：
  - 更新指定举报的状态与备注：
    - Mock 模式下直接修改 `mockDB.reports` 中对应记录的 `status/handleNote/handlerId/handlerName/handledAt`；
    - 实际环境下调用 `PUT /reports/{id}/handle`。

---

## 2. 版主面板页面结构（/forum/moderator）

### 2.1 状态与 Tab 切换

- 版主面板内部状态：

```ts
const [reports, setReports] = useState<ReportDTO[]>([]);
const [loading, setLoading] = useState(true);
const [activeTab, setActiveTab] = useState<'PENDING' | 'PROCESSED'>('PENDING');
```

- Tab 含义：
  - `PENDING`：展示待处理举报（`status === 'PENDING'`）；
  - `PROCESSED`：展示已处理举报（`status !== 'PENDING'`）。

- 使用 `useMemo` 对 `reports` 进行分类：

```ts
const pending = useMemo(() => reports.filter(r => r.status === 'PENDING'), [reports]);
const processed = useMemo(() => reports.filter(r => r.status !== 'PENDING'), [reports]);
```

### 2.2 举报列表加载

- 在组件挂载时调用 `loadReports()`：

```ts
useEffect(() => {
  loadReports();
}, []);

const loadReports = () => {
  setLoading(true);
  getPendingReports()
    .then(setReports)
    .catch(err => {
      console.error(err);
      alert('加载举报列表失败');
    })
    .finally(() => setLoading(false));
};
```

- 说明：
  - 当前实现只调用 `getPendingReports()`，由后端返回包含 PENDING/RESOLVED/REJECTED 在内的完整列表或仅待处理列表（取决于后端实现）；
  - 前端通过 `pending/processed` 视图区分状态。

---

## 3. 待处理举报视图

### 3.1 空状态

- 当 `pending.length === 0` 时：
  - 展示插画和文案“暂无待处理举报 / 所有举报都已处理完毕”；
  - 提示版主当前没有需要处理的任务。

### 3.2 举报条目展示

- 对每条待处理举报展示：
  - 举报对象类型标签（`targetType`，如 POST/REPLY）；
  - 举报原因 `reason`；
  - 目标 ID `targetId`；
  - 举报描述 `description`（若存在，以灰底块展示）；  
  - 举报人信息（`reporterName` + `createdAt` 时间）。

渲染示例：

```tsx
<div key={report.id} style={{ padding: 16, border: '1px solid #eee', borderRadius: 4, marginBottom: 12 }}>
  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
    <div style={{ flex: 1 }}>
      <span>{report.targetType}</span>
      <strong>{report.reason}</strong>
      {/* 目标ID、描述、举报人信息 */}
    </div>
    {/* 操作按钮 */}
  </div>
</div>
```

### 3.3 处理操作（通过/拒绝）

- 面板提供两个操作按钮：
  - “通过”：将举报标记为 `RESOLVED`；
  - “拒绝”：将举报标记为 `REJECTED`。

- 相应逻辑：

```ts
const handleReportAction = async (
  reportId: number,
  status: HandleReportRequest['status'],
  note: string
) => {
  try {
    await handleReport(reportId, { status, handleNote: note || undefined });
    alert('处理成功');
    loadReports();
  } catch (error) {
    console.error(error);
    alert('处理失败');
  }
};
```

- 交互细节：
  - 点击“通过”时使用 `prompt` 获取可选备注，再调用 `handleReportAction(report.id, 'RESOLVED', note)`；  
  - 点击“拒绝”时要求输入驳回原因，非空时调用 `handleReportAction(report.id, 'REJECTED', note)`；
  - 操作成功后重新加载举报列表，以反映最新状态。

---

## 4. 已处理举报视图

### 4.1 空状态

- 当 `processed.length === 0` 时：
  - 展示插画和文案“暂无已处理举报 / 处理过的举报会显示在这里”；
  - 表示当前还没有任何处理记录。

### 4.2 已处理条目的展示

- 对每条已处理举报展示：
  - 状态标签：
    - `RESOLVED` → “已通过”，以绿色背景/边框显示；
    - `REJECTED` → “已拒绝”，以红色背景/边框显示；
  - 举报原因与目标 ID；
  - 举报描述（如有）；
  - 处理人 `handlerName` 与 `handledAt` 时间；
  - 处理备注 `handleNote`（如有）。

渲染示例：

```tsx
<span
  style={{
    background: report.status === 'RESOLVED' ? '#f6ffed' : '#fff1f0',
    color: report.status === 'RESOLVED' ? '#389e0d' : '#cf1322',
  }}
>
  {report.status === 'RESOLVED' ? '已通过' : '已拒绝'}
</span>
```

> 通过“待处理 + 已处理”的分栏视图，以及简明的通过/拒绝动作，版主面板为社区提供了一个集中、可审计的举报处理入口。结合帖子详情中的“版主操作”按钮和通知中心中的 `ForumPostModerated` 通知类型，可以形成较完整的社区治理闭环。 
