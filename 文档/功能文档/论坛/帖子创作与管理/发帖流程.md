# 发帖流程（功能 + 实现说明）

> 关联上级：`论坛/帖子创作与管理.md`  
> 相关代码位置：
> - 页面组件：`packages/frontend/core/src/desktop/pages/workspace/forum/create-post/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`

---

## 1. 进入发帖页面

### 1.1 路由入口

- 发帖页面挂载在板块详情下方：
  - 路由形式：`/forum/:forumId/create-post`
  - 在板块详情页（`forum-detail/index.tsx`）中，右上角“发帖”按钮跳转：

```tsx
<button
  onClick={() => navigate(`/forum/${forumId}/create-post`)}
  // ...
>
  发帖
</button>
```

- 通过 `useParams` 读取 `forumId`，作为发帖目标板块：

```ts
const { forumId } = useParams<{ forumId: string }>();
```

### 1.2 从草稿继续编辑

- 当从“我的草稿”点击“继续编辑”时，会带上 `draftId` 查询参数：

```tsx
navigate(`/forum/${draft.forumId}/create-post?draftId=${draft.id}`);
```

- 发帖页通过 `URLSearchParams` 读取 `draftId` 并加载对应草稿内容：

```ts
const draftIdFromUrl = useMemo(() => {
  const search = new URLSearchParams(location.search);
  return search.get('draftId');
}, [location.search]);
```

---

## 2. 编辑帖子内容

### 2.1 本地编辑状态

- 发帖页面维护以下本地状态：

```ts
const [title, setTitle] = useState('');
const [content, setContent] = useState('');
const [tags, setTags] = useState('');
const [files, setFiles] = useState<File[]>([]);
const [submitting, setSubmitting] = useState(false);
const [saving, setSaving] = useState(false);
const [lastSavedAt, setLastSavedAt] = useState<string | null>(null);
const [currentDraftId, setCurrentDraftId] = useState<string | null>(null);
const [hasChanges, setHasChanges] = useState(false);
```

- 说明：
  - `title`：帖子标题（必填推荐）；
  - `content`：帖子正文（目前为纯文本/简单富文本）；
  - `tags`：逗号分隔或空格分隔的标签字符串（视实现）；
  - `files`：待上传的附件文件列表；
  - `currentDraftId`：当前编辑草稿的 ID，用于后续更新同一个草稿；
  - `hasChanges`：标记标题/内容/标签是否有未保存变更；
  - `lastSavedAt`：最近一次保存草稿的时间，用作 UI 提示。

### 2.2 附件选择与校验

- 附件选择入口：`<input type="file" multiple />`；
- 校验逻辑：
  - 允许的后缀在 `allowedExt` 中定义：

```ts
const allowedExt = useMemo(
  () => ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'zip', 'rar', '7z', 'txt'],
  []
);
const MAX_SIZE = 50 * 1024 * 1024; // 50MB
```

- `onFilesChange` 中对每个文件进行检查：
  - 后缀不在允许列表则加入错误提示；
  - 文件大小超过 50MB 亦加入错误提示；
  - 通过校验的文件累加到 `files` 数组；
  - 若有错误，则通过 `alert` 统一提示；
  - 将 `<input>` 的 `value` 置空，以支持选择同名文件。

- 删除附件：

```ts
const removeFile = (idx: number) => {
  setFiles(prev => prev.filter((_, i) => i !== idx));
};
```

---

## 3. 草稿加载与自动保存

### 3.1 加载已有草稿

- 若 URL 中存在 `draftId`，发帖页面会在挂载后调用 `getDraft`：

```ts
useEffect(() => {
  if (!draftIdFromUrl) return;
  (async () => {
    try {
      const draft = await getDraft(draftIdFromUrl);
      setTitle(draft.title || '');
      setContent(draft.content || '');
      setTags(draft.tags || '');
      setCurrentDraftId(draft.id);
      setHasChanges(false);
    } catch (err) {
      console.error(err);
      showError('加载草稿失败');
    }
  })();
}, [draftIdFromUrl]);
```

- 加载完成后：
  - 标题/正文/标签会被预填；
  - `currentDraftId` 用于后续保存时区分“创建 vs 更新草稿”；
  - `hasChanges` 重置为 false。

### 3.2 自动保存草稿

- 定时器逻辑：每 30 秒尝试自动保存一次草稿：

```ts
useEffect(() => {
  const timer = setInterval(() => {
    if (!forumId) return;
    if (!title.trim() && !content.trim()) return; // 没有内容不保存
    if (!hasChanges) return;
    handleSaveDraft(true).catch(console.error);
  }, 30000);
  return () => clearInterval(timer);
}, [forumId, title, content, tags, hasChanges, currentDraftId]);
```

- 触发条件：
  - 目标板块 `forumId` 存在；
  - 标题和正文至少有一个非空；
  - `hasChanges` 为 true（有未保存修改）。

### 3.3 手动保存草稿

- 保存逻辑封装在 `handleSaveDraft`：

```ts
const handleSaveDraft = async (isAuto = false) => {
  if (!forumId) { alert('缺少板块ID'); return; }
  if (!title.trim() && !content.trim()) {
    if (!isAuto) alert('请输入标题或内容后再保存草稿');
    return;
  }

  setSaving(true);
  try {
    const draft = await saveDraft({
      id: currentDraftId || undefined,
      forumId: parseInt(forumId, 10),
      title,
      content,
      tags: tags || undefined,
    });

    setCurrentDraftId(draft.id);
    setHasChanges(false);
    setLastSavedAt(new Date().toLocaleTimeString());

    if (!draftIdFromUrl) {
      const search = new URLSearchParams(location.search);
      search.set('draftId', draft.id);
      navigate({ pathname: location.pathname, search: `?${search.toString()}` }, { replace: true });
    }

    if (!isAuto) {
      showSuccess('草稿已保存');
    }
  } catch (error) {
    console.error(error);
    showError('保存草稿失败');
  } finally {
    setSaving(false);
  }
};
```

- 关键点：
  - 若 `currentDraftId` 为空则创建新草稿，否则更新已有草稿；
  - 保存成功后，如 URL 中没有 `draftId`，则追加参数并用 `replace` 更新历史记录；
  - 手动保存时通过 `Toast` 提示“草稿已保存”，自动保存则静默。

---

## 4. 发布帖子与附件上传

### 4.1 创建帖子

- 发布逻辑大致如下：
  - 校验板块 ID、标题和内容；
  - 调用 `createPost` 创建帖子；
  - 若存在附件，则遍历 `files` 调用 `uploadAttachment`；
  - 若当前编辑来自草稿（`currentDraftId` 存在），可在发布成功后调用 `publishDraft` 或删除草稿；
  - 发布成功后跳转到新帖子详情页。

- 在现有实现中，具体 `createPost` / `publishDraft` 调用都通过 `forum-api.ts` 封装，发布后的导航一般类似：

```ts
const post = await createPost({ forumId, title, content, tags });
navigate(`/forum/${post.forumId}/post/${post.id}`);
```

### 4.2 附件上传

- 附件上传通过 `uploadAttachment` 完成：
  - 接收 `postId` 与 `FormData`；
  - 使用 `multipart/form-data` 向服务器发送文件；
  - 上传成功后可刷新附件列表或依赖帖子详情页重新加载。

- 文件大小与类型的前端校验已在选择阶段完成，服务器端仍需进行二次校验。

---

## 5. 与草稿列表和编辑历史的关系

- 发帖页面与草稿列表、编辑历史之间的关系：
  - 草稿列表（`/forum/drafts`）提供所有草稿入口，点击“继续编辑”时跳回发帖页面并附带 `draftId`；
  - 发帖页面保存草稿后，被发布的草稿可在草稿列表中消失，或标记为已发布（视 `publishDraft` 行为而定）；
  - 编辑历史页面（`/forum/posts/:postId/history`）记录帖子创建与后续编辑行为，与草稿阶段不直接关联，但构成完整的“创作 → 草稿 → 发布 → 编辑”闭环。 
