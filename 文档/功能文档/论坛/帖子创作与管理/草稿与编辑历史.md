# 草稿与编辑历史（功能 + 实现说明）

> 关联上级：`论坛/帖子创作与管理.md`  
> 相关代码位置：
> - 草稿列表：`packages/frontend/core/src/desktop/pages/workspace/forum/draft-list/index.tsx`
> - 编辑历史：`packages/frontend/core/src/desktop/pages/workspace/forum/edit-history/index.tsx`
> - 发帖页草稿逻辑：`packages/frontend/core/src/desktop/pages/workspace/forum/create-post/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`

---

## 1. 草稿管理（/forum/drafts）

### 1.1 草稿数据结构 DraftDTO

- 草稿类型定义在 `types.ts` 中：

```ts
export interface DraftDTO {
  id: string;
  forumId: number;
  forumName?: string;
  authorId: number;
  authorName?: string;
  title: string;
  content: string;
  tags?: string;
  createdAt: string;
  updatedAt?: string;
}
```

- 说明：
  - `forumId` / `forumName`：草稿所属板块；
  - `title` / `content` / `tags`：编辑中的帖子内容；
  - `createdAt` / `updatedAt`：创建与最后修改时间，列表按更新时间倒序展示。

### 1.2 草稿列表获取与分页

- 草稿列表页面通过以下 API 获取当前用户的草稿：

```ts
const pageSize = 20;

useEffect(() => {
  setLoading(true);
  getMyDrafts(page, pageSize)
    .then(data => setDrafts(data))
    .catch(console.error)
    .finally(() => setLoading(false));
}, [page]);
```

- `getMyDrafts(page, pageSize)` 返回 `PaginatedResponse<DraftDTO>`：
  - `content`：当前页草稿列表；
  - `totalElements`：草稿总数；
  - `totalPages`：总页数；
  - `number`：当前页索引。

- 页脚提供简单分页控件：
  - “上一页”/“下一页”按钮；
  - 标签“第 X / Y 页”；
  - 根据 `page === 0` 或 `page >= totalPages - 1` 控制按钮禁用状态。

### 1.3 草稿列表展示与操作

- 列表项展示内容：

```tsx
<h3 style={{ margin: 0 }}>{draft.title || '(无标题)'}</h3>
<div style={{ marginTop: 6, color: '#666', whiteSpace: 'pre-wrap' }}>
  {(draft.content || '').slice(0, 200)}{(draft.content || '').length > 200 ? '...' : ''}
</div>
<div style={{ marginTop: 6, color: '#999', fontSize: 12 }}>
  {draft.forumName ? `板块: ${draft.forumName} · ` : ''}
  更新: {draft.updatedAt ? new Date(draft.updatedAt).toLocaleString() : new Date(draft.createdAt).toLocaleString()}
</div>
```

- 操作按钮：
  - “继续编辑”：

```tsx
onClick={() => navigate(`/forum/${draft.forumId}/create-post?draftId=${draft.id}`)}
```

  - “发布”：

```ts
const handlePublish = async (id: string) => {
  try {
    const post = await publishDraft(id);
    navigate(`/forum/${post.forumId}/post/${post.id}`);
  } catch (err) {
    console.error(err);
    alert('发布失败');
  }
};
```

  - “删除”：

```ts
const handleDelete = async (id: string) => {
  const ok = confirm('确定删除该草稿吗？');
  if (!ok) return;
  await deleteDraft(id);
  const data = await getMyDrafts(page, pageSize);
  setDrafts(data);
};
```

- 当草稿列表为空时，页面展示插画与引导文案：“还没有草稿 / 开始创作你的第一篇帖子吧”。

---

## 2. 编辑历史（/forum/posts/:postId/history）

### 2.1 编辑历史数据结构 EditHistoryDTO

- 在 `types.ts` 中定义了编辑历史条目：

```ts
export interface EditHistoryDTO {
  id: string;
  postId: string;
  editorId: number;
  title?: string;
  content: string;
  version: number;
  createdAt: string;
}
```

- 后端返回的数据通常还会包含：
  - `editedAt`：编辑时间；
  - `editorName`：编辑人名称；
  - `oldTitle` / `oldContent`：变更前的标题与内容；
  - 这些字段在前端以 `any` 方式读取并使用。

### 2.2 页面加载逻辑

- 编辑历史页面路由：`/forum/posts/:postId/history`；
- 页面通过 `useParams` 获取 `postId`，然后：
  - 调用 `getPost(postId)` 获取最新帖子信息（用于显示标题与“返回帖子”链接）；
  - 调用 `getPostHistory(postId, page, 20)` 获取指定页历史记录；
  - 对返回的 `content` 按时间倒序排序：

```ts
Promise.all([getPost(postId), getPostHistory(postId, page, 20)])
  .then(([p, h]) => {
    setPost(p);
    const content = (h?.content || []).slice().sort((a, b) => {
      const ta = (a as any).editedAt || (a as any).createdAt;
      const tb = (b as any).editedAt || (b as any).createdAt;
      return new Date(tb).getTime() - new Date(ta).getTime();
    });
    setHistories({ ...h, content });
  })
  .finally(() => setLoading(false));
```

- 顶部区域：
  - 标题：“编辑历史 · {post.title}”；
  - “返回帖子”按钮跳回 `/forum/{forumId}/post/{postId}`。

### 2.3 历史列表展示

- 对每条历史记录展示：
  - 版本号 `v{version}`（如存在）；
  - 时间戳（`editedAt` 或 `createdAt`）；
  - 编辑人（`editorName` 或 `editorId`）；
  - 标记“标题变更”与“内容变更”：

```tsx
const titleChanged = Boolean((h as any).oldTitle);
const contentChanged = Boolean((h as any).oldContent || (h as any).content);
```

- 若 `title` 存在，则展示“旧标题”；  
- 内容区域展示“旧内容”预览：
  - 默认只显示前 100 字 + `...`；
  - 点击“查看详情”后展开完整内容；
  - 再次点击“收起”则恢复为截断视图。

### 2.4 按需加载详细内容

- 为避免一次性加载所有历史详情，页面采用“按需加载”策略：
  - 使用 `expanded` 状态记录哪些历史条目已展开；
  - 当用户首次展开某条历史记录且当前记录没有完整 `content` 时调用 `getHistoryDetail`：

```ts
const toggleDetail = async (h: EditHistoryDTO) => {
  const id = String((h as any).id);
  const next = !expanded[id];
  setExpanded(prev => ({ ...prev, [id]: next }));
  if (next && !(h as any).content && (h as any).id) {
    const detail = await getHistoryDetail((h as any).id);
    setHistories(prev => ({
      ...prev,
      content: prev.content.map(item =>
        String((item as any).id) === id ? { ...item, ...detail } : item
      ),
    }));
  }
};
```

- 好处：
  - 首屏加载更轻量，历史内容较多时不会阻塞渲染；
  - 用户只在需要查看某一版本详情时才请求对应内容。

### 2.5 分页与空状态

- 若没有任何历史记录，页面显示插画与提示：“暂无编辑历史 / 此帖子还没有被编辑过”；  
- 若历史记录总页数大于 1，则在底部显示分页控件（上一页 / 下一页）。

---

整体上，“草稿 + 编辑历史”模块为论坛帖子提供了一个相对完整的创作链路：  
- 在发帖和草稿阶段，用户可以自由中断和继续创作；  
- 帖子发布后，每次编辑都会留下可追溯的历史记录，便于审计和对比（未来可以在此基础上扩展“版本恢复”等能力）。 
