# è®ºå›é¦–é¡µä¸æ¿å—æµè§ˆï¼ˆåŠŸèƒ½ + å®ç°è¯´æ˜ï¼‰

> å…³è”ä¸Šçº§ï¼š`è®ºå›/æµè§ˆä¸å¯¼èˆª.md`  
> ç›¸å…³ä»£ç ä½ç½®ï¼š
> - é¡µé¢ç»„ä»¶ï¼š`packages/frontend/core/src/desktop/pages/workspace/forum/forum-home/index.tsx`
> - APIï¼š`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`ï¼ˆ`listForums`ï¼‰
> - ç±»å‹å®šä¹‰ï¼š`packages/frontend/core/src/desktop/pages/workspace/forum/types.ts`ï¼ˆ`ForumDTO`ï¼‰

---

## 1. æ•°æ®ç»“æ„ä¸ API

### 1.1 ForumDTOï¼ˆæ¿å—æ•°æ®ï¼‰

- è®ºå›é¦–é¡µå±•ç¤ºçš„â€œæ¿å—åˆ—è¡¨â€ä½¿ç”¨ `ForumDTO` æè¿°ï¼š

```ts
export interface ForumDTO {
  id: number;
  name: string;
  slug?: string;
  description?: string;
  icon?: string;
  banner?: string;
  parentId?: number;
  displayOrder: number;
  postCount: number;
  topicCount: number;
  isActive: boolean;
  isPrivate: boolean;
  createdAt: string;
  updatedAt?: string;
  children?: ForumDTO[];
}
```

- å…³é”®å­—æ®µï¼š
  - `name` / `description`ï¼šæ¿å—åç§°ä¸æè¿°ï¼›
  - `postCount` / `topicCount`ï¼šå¸–å­æ•°ä¸ä¸»é¢˜æ•°ï¼›
  - `children`ï¼šå­æ¿å—æ•°ç»„ï¼Œç”¨äºæ„å»ºå¤šçº§æ¿å—æ ‘ï¼›
  - `icon` / `banner`ï¼šå¯é€‰çš„è§†è§‰å…ƒç´ ã€‚

### 1.2 listForums API

- è®ºå›é¦–é¡µé€šè¿‡ `listForums()` è·å–æ¿å—æ ‘ï¼š

```ts
export async function listForums(): Promise<ForumDTO[]> {
  if (USE_FORUM_MOCK) {
    const result = JSON.parse(JSON.stringify(mockDB.forums));
    return result;
  }
  return request<ForumDTO[]>('/forums');
}
```

- å½“å‰å®ç°é»˜è®¤ä½¿ç”¨æœ¬åœ° `mockDB.forums`ï¼š
  - æ–¹ä¾¿åœ¨æ²¡æœ‰åç«¯æœåŠ¡æ—¶ä½“éªŒåŠŸèƒ½ï¼›
  - ä¸æ­£å¼ç¯å¢ƒæ¥å…¥åç«¯ `/api/forum/forums` å…¼å®¹ã€‚

---

## 2. è®ºå›é¦–é¡µå¸ƒå±€ä¸åŸºç¡€äº¤äº’

### 2.1 é¡µé¢å…¥å£ä¸å¸ƒå±€

- å…¥å£è·¯ç”±ï¼š`/forum`ï¼ˆæŒ‚åœ¨å·¥ä½œç©ºé—´ workbench ä¸‹ï¼‰ï¼›
- é¡µé¢ç»„ä»¶ä½¿ç”¨ `ViewBody` ä½œä¸ºå¤–å±‚å¸ƒå±€å®¹å™¨ï¼Œä¿è¯ä¸å…¶ä»–å·¥ä½œå°é¡µé¢è§†è§‰ä¸€è‡´ï¼›
- å†…éƒ¨æ•´ä½“ç»“æ„ï¼š
  - é¡¶éƒ¨æ ‡é¢˜ä¸æè¿°åŒºï¼›
  - æœç´¢è¾“å…¥æ¡†ä¸åŒ¹é…ç»Ÿè®¡ï¼›
  - æ¿å—æ ‘åˆ—è¡¨åŒºåŸŸï¼ˆå¯æ»šåŠ¨ï¼‰ã€‚

### 2.2 æœç´¢ä¸è¿‡æ»¤

- åœ¨ `forum-home/index.tsx` ä¸­ï¼Œé¡µé¢ç»´æŠ¤ `query` çŠ¶æ€ï¼š

```ts
const [query, setQuery] = useState('');
// ...
const filteredForums = forums.filter(f =>
  (f.name + (f.description || '')).toLowerCase().includes(query.toLowerCase())
);
```

- è¡Œä¸ºè¯´æ˜ï¼š
  - è¾“å…¥æ¡†çš„å€¼æ›´æ–° `query`ï¼›
  - `filteredForums` æ ¹æ® `name + description` åšç®€å•æ¨¡ç³ŠåŒ¹é…ï¼›
  - æœç´¢å­—ç¬¦ä¸²ä¸ºç©ºæ—¶ï¼Œæ˜¾ç¤ºå…¨éƒ¨æ¿å—ï¼›
  - æœç´¢å­—ç¬¦ä¸²éç©ºä¸”æ— ç»“æœæ—¶ï¼Œæ˜¾ç¤ºâ€œæœªæ‰¾åˆ°åŒ¹é…æ¿å—â€çš„ç©ºçŠ¶æ€ï¼Œå¹¶æä¾›â€œæ¸…é™¤æœç´¢â€æŒ‰é’®ã€‚

- UI è¾…åŠ©ä¿¡æ¯ï¼š
  - æ˜¾ç¤ºâ€œåŒ¹é…æ•°é‡ / æ€»æ¿å—æ•°â€ï¼›
  - ä½¿ç”¨ `HighlightText` ç»„ä»¶é«˜äº®åŒ¹é…çš„æ–‡æœ¬éƒ¨åˆ†ã€‚

---

## 3. æ¿å—æ ‘æ¸²æŸ“ä¸äº¤äº’

### 3.1 ForumTreeNode ç»„ä»¶

- å•ä¸ªæ¿å—èŠ‚ç‚¹ç”± `ForumTreeNode` è´Ÿè´£æ¸²æŸ“ï¼š

```tsx
const ForumTreeNode = memo(function ForumTreeNode({
  forum,
  level = 0,
  searchQuery = '',
}: {
  forum: ForumDTO;
  level?: number;
  searchQuery?: string;
}) {
  const navigate = useNavigate();
  const [collapsed, setCollapsed] = useState(false);
  const hasChildren = useMemo(
    () => forum.children && forum.children.length > 0,
    [forum.children]
  );
  const icon = useMemo(() => getForumIcon(forum), [forum]);
  const lastActivity = useMemo(
    () => formatLastActivity((forum as any).updatedAt),
    [(forum as any).updatedAt]
  );
  // ...
});
```

- ç»„ä»¶èŒè´£ï¼š
  - æ ¹æ® `hasChildren` å†³å®šæ˜¯å¦æ˜¾ç¤ºå±•å¼€/æŠ˜å æŒ‰é’®ï¼›
  - å±•ç¤ºæ¿å—å›¾æ ‡ã€åç§°ã€æè¿°ï¼›
  - å±•ç¤ºç»Ÿè®¡ä¿¡æ¯ä¸æœ€åæ´»è·ƒæ—¶é—´ï¼›
  - é€’å½’æ¸²æŸ“å­æ¿å—ã€‚

### 3.2 å±•å¼€/æŠ˜å ä¸é”®ç›˜å¯è®¿é—®æ€§

- å±•å¼€/æŠ˜å æŒ‰é’®ï¼š

```tsx
const handleToggle = useCallback((e: React.MouseEvent) => {
  e.stopPropagation();
  if (hasChildren) setCollapsed(s => !s);
}, [hasChildren]);
```

- æ¿å—è¡Œç‚¹å‡»è·³è½¬åˆ°è¯¦æƒ…é¡µï¼š

```tsx
const handleNavigate = useCallback(() => {
  navigate(`/forum/${forum.id}`);
}, [navigate, forum.id]);
```

- é”®ç›˜æ”¯æŒï¼š

```tsx
<div
  className={styles.forumRow}
  onClick={handleNavigate}
  role="button"
  tabIndex={0}
  onKeyDown={e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      handleNavigate();
    }
  }}
>
  {/* ... */}
</div>
```

- è¿™æ ·ä¿è¯ä½¿ç”¨é”®ç›˜ä¹Ÿå¯ä»¥åœ¨æ¿å—åˆ—è¡¨ä¸­å¯¼èˆªä¸æ‰“å¼€æ¿å—è¯¦æƒ…ã€‚

### 3.3 æ¿å—å›¾æ ‡ä¸æœ€åæ´»è·ƒæ—¶é—´

- å›¾æ ‡é€šè¿‡ `getForumIcon` æŒ‰åç§°è¿›è¡Œç®€å•è¯­ä¹‰æ˜ å°„ï¼š

```ts
function getForumIcon(forum: ForumDTO): string {
  const maybeIcon = (forum as any).icon;
  if (maybeIcon) return String(maybeIcon);
  const name = forum.name || '';
  if (name.includes('å…¬å‘Š') || name.includes('é€šçŸ¥')) return 'ğŸ“Œ';
  if (name.includes('è®¨è®º') || name.includes('äº¤æµ')) return 'ğŸ’¬';
  if (name.includes('æŠ€æœ¯') || name.includes('å¼€å‘')) return 'ğŸ› ï¸';
  if (name.includes('æ–°æ‰‹') || name.includes('æŠ¥åˆ°')) return 'ğŸ‘‹';
  if (name.includes('çŒæ°´') || name.includes('é—²èŠ')) return 'ğŸ’­';
  return 'ğŸ“';
}
```

- æœ€åæ´»è·ƒæ—¶é—´é€šè¿‡ `formatLastActivity` è¡¨è¾¾ä¸ºâ€œåˆšåˆš/xxåˆ†é’Ÿå‰/xxå°æ—¶å‰/æ˜¨å¤©/xxå¤©å‰â€ç­‰äººç±»å¯è¯»å½¢å¼ï¼š

```ts
function formatLastActivity(updatedAt?: string): string {
  if (!updatedAt) return '';
  const now = new Date();
  const updated = new Date(updatedAt);
  const diffMs = now.getTime() - updated.getTime();
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  if (diffMins < 1) return 'åˆšåˆš';
  if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
  if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
  if (diffDays === 1) return 'æ˜¨å¤©';
  if (diffDays < 7) return `${diffDays}å¤©å‰`;
  return updated.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
}
```

> é€šè¿‡è¿™äº›ç»†èŠ‚ï¼Œè®ºå›é¦–é¡µä¸ä»…æä¾›äº†æ¿å—åˆ—è¡¨ï¼Œè¿˜æä¾›äº†æ¿å—æ´»è·ƒåº¦ä¸è¯­ä¹‰åŒ–è§†è§‰æç¤ºï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿåˆ¤æ–­å“ªäº›æ¿å—å€¼å¾—å…³æ³¨ã€‚ 
