# 帖子详情浏览（功能 + 实现说明）

> 关联上级：`论坛/浏览与导航.md`  
> 相关代码位置：
> - 页面组件：`packages/frontend/core/src/desktop/pages/workspace/forum/post-detail/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`
> - 复用组件：
>   - `components/PostActions.tsx`：帖子点赞与收藏
>   - `components/ReplyList.tsx`：回复列表展示与分页
>   - `components/AttachmentList.tsx`：附件列表
>   - `hooks/usePermission.ts`：版权限判断

---

## 1. 帖子主信息与加载流程

### 1.1 路由参数与初始状态

- 路由：`/forum/:forumId/post/:postId`
- 页面通过 `useParams` 读取 `forumId` 与 `postId`：

```ts
const { forumId, postId } = useParams<{ forumId: string; postId: string }>();
```

- 内部维护的主状态包括：
  - `post`：当前帖子的详细信息（`PostDTO | null`）；
  - `tags`：帖子标签列表（`TagDTO[]`）；
  - `attachments`：附件列表（`AttachmentDTO[]`）；
  - `replies`：回复分页结果（`PaginatedResponse<ReplyDTO>`）；
  - `page`：当前回复页码；
  - `loading` / `error`：加载状态与错误信息。

### 1.2 数据加载逻辑

- 页面在 `useEffect` 中根据 `postId` 与 `page` 触发数据加载：
  - 使用 `getPost(postId)` 获取帖子主信息；
  - 使用 `getPostTags(postId)` 获取标签；
  - 使用 `getPostAttachments(postId)` 获取附件；
  - 使用 `getPostReplies(postId, page, pageSize)` 获取回复列表。

- 在加载过程中：
  - `loading` 为 true，页面显示“加载中...”；
  - 若请求失败，展示错误文本和“重新加载”按钮；
  - 若 `post` 为 null，展示“帖子不存在”提示。

### 1.3 主信息展示

- 帖子标题、作者与发布时间：

```tsx
<header className={styles.header}>
  <h1 className={styles.title}>{post.title}</h1>
  <div className={styles.meta}>
    <span>{post.authorName}</span>
    <span>· {new Date(post.createdAt).toLocaleString()}</span>
    <span>· {post.viewCount} 浏览</span>
    <span>· {post.replyCount} 回复</span>
  </div>
</header>
```

- 正文内容：
  - 使用 `dangerouslySetInnerHTML` 渲染 HTML；
  - 在渲染前通过 `sanitizeText` 进行 HTML 清洗，降低 XSS 风险：

```tsx
<article
  className={styles.content}
  dangerouslySetInnerHTML={{ __html: sanitizeText(post.content) }}
/>;
```

---

## 2. 标签、附件与基础交互

### 2.1 标签列表

- 使用 `getPostTags(post.id)` 获取标签列表，在页面中渲染为可点击的标签按钮：

```tsx
{tags.length > 0 && (
  <div className={styles.tags}>
    {tags.map(t => (
      <button
        key={t.id}
        onClick={() => navigate(`/forum/tags/${t.id}`)}
        className={styles.tag}
        title={t.name}
      >
        #{t.name}
      </button>
    ))}
  </div>
)}
```

- 行为说明：
  - 点击标签跳转到标签视图（`/forum/tags/:tagId`），展示相关帖子列表；
  - 具体标签视图的行为在“标签与搜索”模块文档中展开。

### 2.2 附件列表

- 使用 `AttachmentList` 组件展示附件：

```tsx
<AttachmentList attachments={attachments} />;
```

- `AttachmentDTO` 描述：
  - `fileName`：文件名；
  - `contentType`：MIME 类型；
  - `size`：文件大小；
  - `url`：下载或预览链接。

- UI 行为：
  - 按列表形式展示附件名称、大小等；
  - 提供点击下载或在新标签页打开附件的能力。

### 2.3 帖子点赞与收藏

- 使用 `PostActions` 组件处理帖子的点赞与收藏交互：

```tsx
<div className={styles.actionsRow}>
  <PostActions
    post={post}
    onLikeChange={refreshPost}
    onCollectChange={refreshPost}
  />
</div>
```

- `PostActions` 内部：
  - 点赞/取消点赞：
    - 调用 `likePost(post.id)` 或 `unlikePost(post.id)`；
    - 更新完成后调用父组件传入的 `onLikeChange` 触发重新加载帖子数据；
  - 收藏/取消收藏：
    - 调用 `collectPost(post.id)` 或 `uncollectPost(post.id)`；
    - 更新完成后调用 `onCollectChange`；
  - 使用 `useToast` 提示错误信息。

> 通过这一组合，帖子详情页在“阅读信息”的同时亦提供最常用的互动行为入口。

---

## 3. 回复列表与互动

### 3.1 回复分页与展示

- 回复数据结构：`PaginatedResponse<ReplyDTO>`（`types.ts` 中定义）：
  - `content`：当前页回复数组；
  - `totalElements`：总回复数；
  - `totalPages`：总页数；
  - `number`：当前页索引。

- 使用 `ReplyList` 组件渲染回复列表：

```tsx
<ReplyList
  replies={replies}
  page={page}
  onPageChange={setPage}
  onLike={handleToggleReplyLike}
  onMarkBest={handleMarkBest}
  replyLikeLoading={replyLikeLoading}
/>;
```

- `ReplyList` 中：
  - 每条回复展示楼层号（`#floor楼`）、作者、时间、内容；
  - 若 `reply.isBestAnswer` 为 true，显示“✓ 最佳答案”的标记；
  - 提供“点赞”按钮，状态由 `reply.isLiked` 与 `reply.likeCount` 控制；
  - 提供“标记为最佳答案”按钮（由外层根据权限决定显示与否）。

### 3.2 回复点赞与最佳答案

- 在父组件中维护 `replyLikeLoading` 状态，用于防止重复点赞操作；
- 点赞/取消点赞逻辑：
  - 使用 `likeReply(reply.id)` 与 `unlikeReply(reply.id)` API；
  - 更新后重新加载该帖子的回复列表；
  - 若有错误，通过 `useToast` 显示提示。

- 标记最佳答案：
  - 调用 `markBestAnswer(post.id, replyId)` API；
  - 更新后刷新帖子和回复数据，以同步“最佳答案”标记；
  - 通常仅版主或楼主有该权限（具体权限由 `usePermission` 与后端控制决定）。

### 3.3 发表回复

- 在帖子底部提供“发表回复”区域（当 `post.isLocked` 为 false 时）：

```tsx
{!post.isLocked && (
  <div className={styles.container}>
    <div className={styles.replyEditor}>
      <h3 className={styles.sectionTitle}>发表回复</h3>
      <textarea
        value={replyContent}
        onChange={e => setReplyContent(e.target.value)}
        placeholder="输入回复内容..."
        className={styles.textarea}
      />
      <button onClick={handleReply} className={styles.primaryBtn}>
        提交回复
      </button>
    </div>
  </div>
)}
```

- `handleReply` 中：
  - 调用 `createReply` API 创建新回复；
  - 成功后清空输入框并刷新回复列表；
  - 若帖子已被锁定（`post.isLocked`），则不显示回复编辑区域。

---

## 4. 版主管理操作与时间线

### 4.1 版主管理按钮

- 版主操作区域：

```tsx
<div className={styles.moderatorRow}>
  {canSticky && (
    <button onClick={() => handleModAction('sticky')} disabled={post.isSticky}>
      {post.isSticky ? '已置顶' : '置顶'}
    </button>
  )}
  {canEssence && (
    <button onClick={() => handleModAction('essence')} disabled={post.isEssence}>
      {post.isEssence ? '已加精' : '加精'}
    </button>
  )}
  {canLock && (
    <button onClick={() => handleModAction('lock')} disabled={post.isLocked}>
      {post.isLocked ? '已锁定' : '锁定'}
    </button>
  )}
  <button onClick={() => navigate(`/forum/posts/${post.id}/history`)}>
    编辑历史
  </button>
</div>
```

- 权限判断：
  - 由 `usePermission` Hook 提供 `canSticky` / `canEssence` / `canLock` 等布尔值；
  - 具体实现会检查当前用户是否为对应板块的版主或拥有管理员权限。

- 实际操作：
  - `handleModAction('sticky')` → 调用 `stickyPost(post.id)`；
  - `handleModAction('essence')` → 调用 `essencePost(post.id)`；
  - `handleModAction('lock')` → 调用 `lockPost(post.id)`；
  - 每次操作后重新加载帖子数据，以反映最新状态。

### 4.2 时间线侧边栏

- 帖子右侧展示一个简易“时间线”：

```tsx
<aside className={styles.sidebar}>
  <div className={styles.timelineCard}>
    <div className={styles.timelineHeader}>时间线</div>
    <ul className={styles.timelineList}>
      <li>创建于 {new Date(post.createdAt).toLocaleString()}</li>
      {post.lastReplyAt && (
        <li>最后回复于 {new Date(post.lastReplyAt).toLocaleString()}</li>
      )}
      <li>浏览 {post.viewCount}</li>
      <li>回复 {post.replyCount}</li>
    </ul>
  </div>
</aside>
```

- 作用：
  - 用简洁的方式呈现帖子的生命周期和关键统计指标；
  - 辅助用户快速判断帖子的活跃度与新鲜度。

> 通过“主信息 + 标签/附件 + 点赞/收藏 + 回复列表 + 版主管理 + 时间线”的组合，帖子详情页为用户提供了完整的阅读与互动体验，同时为版主提供了基础管理能力。 
