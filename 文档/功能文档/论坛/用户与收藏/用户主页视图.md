# 用户主页视图（功能 + 实现说明）

> 关联上级：`论坛/用户与收藏.md`  
> 相关代码位置：
> - 页面组件：`packages/frontend/core/src/desktop/pages/workspace/forum/user-profile/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`（`getUserPoints`、`signIn`）
> - 类型定义：`packages/frontend/core/src/desktop/pages/workspace/forum/types.ts`（`UserPointDTO`）

---

## 1. 用户数据模型与 API

### 1.1 UserPointDTO（用户积分与活跃度）

- 用户主页目前围绕 `UserPointDTO` 展示用户在论坛中的活跃度：

```ts
export interface UserPointDTO {
  id: number;
  userId: number;
  username?: string;
  totalPoints: number;
  level: number;
  postCount: number;
  replyCount: number;
  reputation: number;
  lastSignInDate?: string;
  continuousSignInDays: number;
  createdAt: string;
  updatedAt?: string;
}
```

- 字段说明：
  - `totalPoints`：总积分（由签到、发帖、回复等行为构成，具体规则由后端定义）；
  - `level`：用户等级；
  - `postCount` / `replyCount`：发帖/回复数量；
  - `reputation`：声望值（可与社区行为绑定）；
  - `lastSignInDate`：最后签到时间；
  - `continuousSignInDays`：连续签到天数。

### 1.2 获取用户积分与签到

- `getUserPoints(userId)`：
  - 输入用户 ID，返回对应的 `UserPointDTO`；
  - 用于渲染用户主页主要信息。

- `signIn(userId)`：

```ts
const handleSignIn = async () => {
  if (!userId || signingIn) return;
  setSigningIn(true);
  try {
    const updated = await signIn(parseInt(userId));
    setUserPoints(updated);
    alert('签到成功');
  } catch (error: any) {
    console.error(error);
    alert(error?.message || '签到失败');
  } finally {
    setSigningIn(false);
  }
};
```

- 行为说明：
  - 调用签到 API 增加积分和连续签到天数；
  - 成功后用返回的最新 `UserPointDTO` 更新页面；
  - 使用 `signingIn` 状态防止重复点击。

---

## 2. 页面加载与基本信息展示

### 2.1 路由与数据加载

- 路由形式：`/forum/user/:userId`；
- 页面通过 `useParams` 获取 `userId`，再调用 `getUserPoints`：

```ts
const { userId } = useParams<{ userId: string }>();
const [userPoints, setUserPoints] = useState<UserPointDTO | null>(null);
const [loading, setLoading] = useState(true);

useEffect(() => {
  if (!userId) return;
  getUserPoints(parseInt(userId))
    .then(setUserPoints)
    .catch(console.error)
    .finally(() => setLoading(false));
}, [userId]);
```

- 加载状态：
  - `loading` 时显示“加载中...”；
  - 若 `userPoints` 为空则显示“用户不存在”。

### 2.2 等级与进度计算

- 页面根据总积分计算等级与进度：

```ts
const computedLevel = useMemo(() => {
  const base = Math.floor((userPoints.totalPoints ?? 0) / 100) + 1;
  return userPoints.level && userPoints.level > 0 ? userPoints.level : base;
}, [userPoints.totalPoints, userPoints.level]);

const levelProgress = ((userPoints.totalPoints % 100) / 100) * 100;
```

- 说明：
  - 若后端提供 `level` 且 > 0，则直接使用；
  - 否则按简单规则“每 100 分升 1 级”计算等级；
  - `levelProgress` 表示当前等级内的积分进度（百分比）。

### 2.3 页面头部展示

- 顶部区域采用渐变背景突出用户信息：

```tsx
<div style={{ padding: 30, background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', color: '#fff', borderRadius: 8 }}>
  <h1>{userPoints.username || `用户${userPoints.userId}`}</h1>
  <div style={{ marginTop: 20, display: 'flex', gap: 40 }}>
    {/* 总积分、等级、连续签到卡片 */}
  </div>
  <div style={{ marginTop: 10, fontSize: 12 }}>
    上次签到：{userPoints.lastSignInDate ? new Date(userPoints.lastSignInDate).toLocaleString() : '从未签到'}
  </div>
  {/* 等级进度条与签到按钮 */}
</div>
```

- 显示信息包括：
  - 用户名或“用户{ID}”；
  - 总积分、等级、连续签到天数；
  - 上次签到时间；
  - 等级进度条（当前等级进度）。

---

## 3. 签到按钮与当前用户判断

### 3.1 签到可用性判断

- 页面通过以下逻辑判断是否可以签到：

```ts
const canSignIn =
  !userPoints.lastSignInDate ||
  new Date(userPoints.lastSignInDate).toDateString() !== new Date().toDateString();
```

- 解释：
  - 若从未签到，则允许签到；
  - 若最后签到日期与今天不同，则允许签到；
  - 若已经签到过今天，则按钮显示为“今日已签到”，并禁用。

### 3.2 当前用户识别

- 为避免给他人展示签到按钮，页面尝试从本地存储读取当前用户 ID：

```ts
const currentUserId = Number(globalThis.localStorage?.getItem('yunke-user-id') || '0');
const isCurrentUser = currentUserId ? currentUserId === userPoints.userId : true;
```

- 若本地没有记录，则默认视为当前用户（便于本地测试）；  
- 若有记录，则仅在 `currentUserId === userPoints.userId` 时展示签到按钮。

- 签到按钮渲染示例：

```tsx
{isCurrentUser && (
  <button
    onClick={handleSignIn}
    disabled={!canSignIn || signingIn}
  >
    {canSignIn ? '签到' : '今日已签到'}
  </button>
)}
```

---

## 4. 统计信息与扩展方向

- 当前用户主页侧重于“积分 + 签到 + 活跃度”展示：  
  - `postCount` / `replyCount` 可用于显示总发帖/总回复数量；  
  - `reputation` 可结合举报/点赞等行为，展示社区声望。

- 后续可拓展的内容包括：
  - 最近发帖列表（调用 `getForumPosts` 并按作者过滤）；  
  - 最近回复列表（按用户 ID 过滤 `ReplyDTO`）；  
  - 与工作空间用户信息（头像、简介）联动展示。  

> 综上，用户主页目前提供了一个围绕“积分体系”的可视化入口，帮助用户了解自己在论坛中的活跃情况，也为后续的勋章、等级、任务系统等扩展提供基础。 
