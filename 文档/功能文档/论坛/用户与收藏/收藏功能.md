# 收藏功能（功能 + 实现说明）

> 关联上级：`论坛/用户与收藏.md`  
> 相关代码位置：
> - 帖子详情收藏按钮：`packages/frontend/core/src/desktop/pages/workspace/forum/components/PostActions.tsx`
> - 我的收藏列表页：`packages/frontend/core/src/desktop/pages/workspace/forum/my-collections/index.tsx`
> - 收藏相关 API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`

---

## 1. 收藏/取消收藏行为（帖子详情）

### 1.1 PostActions 组件

- 在帖子详情页中，通过 `PostActions` 组件提供点赞与收藏按钮：

```tsx
<PostActions
  post={post}
  onLikeChange={refreshPost}
  onCollectChange={refreshPost}
/>;
```

- `PostActions` 接口：

```ts
export interface PostActionsProps {
  post: PostDTO;
  onLikeChange: () => void;
  onCollectChange: () => void;
}
```

### 1.2 收藏按钮逻辑

- 收藏按钮内部实现：

```ts
const handleToggleCollect = async () => {
  if (collectLoading) return;
  setCollectLoading(true);
  try {
    if (post.isCollected) {
      await uncollectPost(post.id);
    } else {
      await collectPost(post.id);
    }
    onCollectChange();
  } catch (err: any) {
    console.error(err);
    showError(err?.message || '操作失败');
  } finally {
    setCollectLoading(false);
  }
};
```

- UI 表现：
  - 未收藏时显示“☆ + 收藏数”，点击后调用 `collectPost`；
  - 已收藏时显示“⭐ + 收藏数”，点击后调用 `uncollectPost`；
  - 在请求过程中禁用按钮并降低透明度；
  - 完成后调用 `onCollectChange` 通知父组件刷新帖子数据（更新 `isCollected` 与 `collectCount`）。

### 1.3 收藏 API 实现（mock & 实际）

- `collectPost(id)`：
  - Mock 模式下：
    - 若当前用户未收藏该帖子，则向 `mockDB.collections` 中追加一条记录 `{ userId, postId, collectedAt }`；
    - 对应帖子 `collectCount` +1，`isCollected = true`；
  - 实际环境：
    - POST `/posts/{id}/collect`。

- `uncollectPost(id)`：
  - Mock 模式下：
    - 从 `mockDB.collections` 中移除当前用户对该帖子的收藏记录；
    - 如果确实删除了记录，则对帖子 `collectCount` -1；
    - 将 `isCollected` 设为 false；
  - 实际环境：
    - POST `/posts/{id}/uncollect`。

---

## 2. 我的收藏列表（/forum/my-collections）

### 2.1 数据模型：MyCollectionItemDTO

- 在 `forum-api.ts` 中定义“我的收藏”列表项结构：

```ts
export interface MyCollectionItemDTO {
  post: PostDTO;
  collectedAt: string;
}
```

- 说明：
  - `post`：被收藏帖子完整信息（`PostDTO`）；
  - `collectedAt`：收藏时间，用于排序与显示。

### 2.2 列表获取与分页

- 我的收藏页使用 `getMyCollections(page, size)` 获取分页结果：

```ts
const [collections, setCollections] = useState<PaginatedResponse<MyCollectionItemDTO>>({
  content: [],
  totalElements: 0,
  totalPages: 0,
  number: 0,
});

useEffect(() => {
  setLoading(true);
  getMyCollections(page, pageSize)
    .then(data => setCollections(data))
    .catch(err => {
      console.error(err);
      alert(err?.message || '加载失败');
    })
    .finally(() => setLoading(false));
}, [page]);
```

- Mock 模式下：
  - 从 `mockDB.collections` 中筛选当前用户的收藏记录；
  - 使用 `paginate` 进行分页；
  - 将每条记录转为 `{ post, collectedAt }`：

```ts
const mine = mockDB.collections.filter(c => c.userId === mockDB.currentUserId);
const res = paginate(mine, page, size);
const content = res.content.map(c => ({ post: clone(getPostOrThrow(c.postId)), collectedAt: c.collectedAt }));
```

### 2.3 列表展示与跳转

- 每条收藏项以一行展示：
  - 标题：`item.post.title`（溢出时省略号处理）；
  - 内容摘要：从 `post.content` 中截取前 200 字，剔除换行；
  - 元信息：作者名、帖子创建日期、收藏时间；
  - 行点击行为：跳转到 `/forum/{post.forumId}/post/{post.id}`。

示例渲染：

```tsx
<div
  key={item.post.id}
  onClick={() => navigate(`/forum/${item.post.forumId}/post/${item.post.id}`)}
  // ...
>
  <h3>{item.post.title}</h3>
  <p>{摘要}</p>
  <div>作者 · 创建时间</div>
  <div>收藏时间：{new Date(item.collectedAt).toLocaleString()}</div>
  {/* 取消收藏按钮 */}
</div>
```

### 2.4 列表内取消收藏

- 页面内部维护 `uncollectLoadingIds` 防止重复点击：

```ts
const [uncollectLoadingIds, setUncollectLoadingIds] = useState<Record<string, boolean>>({});
```

- 取消逻辑：

```ts
const handleUncollect = async (post: PostDTO) => {
  if (!post?.id) return;
  if (uncollectLoadingIds[post.id]) return;
  setUncollectLoadingIds(prev => ({ ...prev, [post.id]: true }));
  try {
    await uncollectPost(post.id);
    const data = await getMyCollections(page, pageSize);
    setCollections(data);
  } catch (err: any) {
    console.error(err);
    alert(err?.message || '取消收藏失败');
  } finally {
    setUncollectLoadingIds(prev => ({ ...prev, [post.id]: false }));
  }
};
```

- 按钮渲染：

```tsx
<button
  onClick={e => {
    e.stopPropagation();
    handleUncollect(item.post);
  }}
  disabled={!!uncollectLoadingIds[item.post.id]}
>
  取消收藏
</button>
```

- 注意：
  - 使用 `e.stopPropagation()` 防止点击按钮时触发整行的跳转行为；
  - 取消收藏后重新调用 `getMyCollections`，保持列表与收藏状态一致。

### 2.5 空状态与分页

- 当 `collections.content.length === 0` 时：
  - 展示插画与文案“还没有收藏任何内容 / 浏览帖子时点击收藏按钮吧”；
- 当 `totalPages > 1` 时：
  - 在底部显示“上一页/下一页”分页控件，与草稿列表等页面风格一致。

> 收藏功能由“帖子详情中的单个收藏按钮 + 我的收藏列表页”共同构成：  
> 前者负责为每篇帖子提供收藏入口，后者则为用户提供一个统一管理自己收藏内容的视图与操作入口。 
