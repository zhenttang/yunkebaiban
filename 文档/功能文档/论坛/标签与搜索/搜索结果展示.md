# 搜索结果展示（功能 + 实现说明）

> 关联上级：`论坛/标签与搜索.md`  
> 相关代码位置：
> - 页面组件：`packages/frontend/core/src/desktop/pages/workspace/forum/search-result/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`（`searchForum`、`quickSearch`）
> - 类型定义：`packages/frontend/core/src/desktop/pages/workspace/forum/types.ts`（`SearchRequest`、`SearchResultDTO`）

---

## 1. 搜索条件与请求模型

### 1.1 SearchRequest 与 SearchResultDTO

- 在 `types.ts` 中定义：

```ts
export interface SearchRequest {
  keyword: string;
  type?: SearchType;
  forumId?: number;
}

export interface SearchResultDTO {
  type: Exclude<SearchType, 'ALL'>; // 'POST' | 'FORUM' ...
  id: string;
  title: string;
  content?: string;
  highlight?: string;
  forumId?: number;
  forumName?: string;
  authorId?: number;
  authorName?: string;
  replyCount?: number;
  createdAt: string;
}
```

- 说明：
  - `keyword`：搜索关键字，必填；
  - `type`：搜索类型（帖子、板块或 ALL），默认为 `'ALL'`；
  - `forumId`：可选的板块过滤条件；
  - `SearchResultDTO.type`：返回结果实际类型（`POST` 或 `FORUM`）；
  - `highlight`：由后端生成的高亮 HTML 片段（可包含 `<mark>` 等标签）；
  - `content`：简要内容摘要，用于在没有高亮时回退展示。

### 1.2 searchForum 与 quickSearch

- `searchForum(data, page, size)`：
  - 用于分页搜索；
  - Mock 模式下实现为在本地 `mockDB.forums` 和 `mockDB.posts` 上做简单关键字匹配；
  - 返回 `SearchResultDTO[]`。

- `quickSearch(keyword, type, forumId?)`：

```ts
export async function quickSearch(keyword: string, type = 'ALL', forumId?: number): Promise<SearchResultDTO[]> {
  if (USE_FORUM_MOCK) {
    return searchForum({ keyword, type: type as any, forumId }, 0, 50);
  }
  const params = new URLSearchParams({ keyword, type });
  if (forumId) params.set('forumId', String(forumId));
  return request<SearchResultDTO[]>(`/search?${params}`);
}
```

- 行为说明：
  - Mock 模式：调用 `searchForum` 获取前 50 条结果；
  - 实际环境：GET `/search?keyword=...&type=...&forumId=...`；
  - 论坛搜索结果页使用 `quickSearch` 实现“按关键字快速搜索”的体验。

---

## 2. 搜索结果页（/forum/search）

### 2.1 读取搜索关键字

- 搜索结果页通过查询参数 `keyword` 获取关键字：

```ts
const [searchParams] = useSearchParams();
const keyword = searchParams.get('keyword') || '';
```

- 若 `keyword` 为空：
  - 页面仅展示“请输入搜索关键词”的提示；
  - 不发起任何搜索请求。

### 2.2 发起搜索请求

- 在 `useEffect` 中监听 `keyword` 变化：

```ts
useEffect(() => {
  if (!keyword) return;
  setLoading(true);
  quickSearch(keyword, 'ALL')
    .then(setResults)
    .catch(err => {
      console.error(err);
      alert('搜索失败');
    })
    .finally(() => setLoading(false));
}, [keyword]);
```

- 状态说明：
  - `results`：`SearchResultDTO[]`，包含帖子 + 板块结果；
  - `loading`：控制“搜索中...”提示；
  - `keyword`：驱动搜索请求和页面标题。

### 2.3 结果类型拆分

- 使用 `useMemo` 将结果按类型拆分：

```ts
const { postResults, forumResults } = useMemo(() => {
  const postResults = results.filter(r => r.type === 'POST');
  const forumResults = results.filter(r => r.type === 'FORUM');
  return { postResults, forumResults };
}, [results]);
```

- 便于在 UI 中分区展示“帖子”结果与“板块”结果。

---

## 3. 帖子搜索结果展示

### 3.1 帖子结果列表

- 当存在帖子结果时，页面会渲染“帖子”区域：

```tsx
{postResults.length > 0 && (
  <div style={{ marginBottom: 24 }}>
    <h3 style={{ margin: '10px 0' }}>帖子</h3>
    {postResults.map(p => (
      <div
        key={`post-${p.id}`}
        onClick={() => navigate(`/forum/${p.forumId}/post/${p.id}`)}
        style={{ padding: 16, borderBottom: '1px solid #eee', cursor: 'pointer' }}
      >
        {/* 标题与类型标签 */}
        {/* 高亮摘要或普通摘要 */}
        {/* 元信息：板块、作者、时间 */}
      </div>
    ))}
  </div>
)}
```

- 标题行展示：
  - 左侧小标签“帖子”；
  - 右侧为帖子标题 `p.title`。

### 3.2 高亮与内容摘要

- 对于帖子内容，优先展示后端提供的高亮片段：

```ts
const highlightHtml = (fallback: string, highlight?: string) => {
  return { __html: highlight || fallback };
};
```

- 具体渲染逻辑：

```tsx
{p.highlight ? (
  <div
    style={{
      marginTop: 6,
      color: '#666',
      background: '#fffbe6',
      borderLeft: '3px solid #faad14',
      padding: 8,
    }}
    dangerouslySetInnerHTML={highlightHtml('', p.highlight)}
  />
) : p.content ? (
  <div style={{ marginTop: 6, color: '#666' }}>
    {p.content.slice(0, 150)}
    {p.content.length > 150 ? '...' : ''}
  </div>
) : null}
```

- 行为说明：
  - 若 `highlight` 存在，则直接以 HTML 渲染并使用背景色与边框突出显示；
  - 否则，如果有 `content`，则截取前 150 字作为摘要；
  - 如果两者都没有，则不展示摘要。

### 3.3 元信息展示

- 在摘要下方展示板块、作者与时间等信息：

```tsx
<div style={{ marginTop: 6, color: '#999', fontSize: 12 }}>
  {p.forumName ? `板块: ${p.forumName} · ` : ''}
  {p.authorName ? `作者: ${p.authorName} · ` : ''}
  {p.createdAt ? new Date(p.createdAt).toLocaleString() : ''}
</div>
```

- 帮助用户快速判断帖子的上下文位置和时间。

---

## 4. 板块搜索结果展示

### 4.1 板块结果列表

- 当存在板块结果时，页面会渲染“板块”区域：

```tsx
{forumResults.length > 0 && (
  <div>
    <h3 style={{ margin: '10px 0' }}>板块</h3>
    {forumResults.map(f => (
      <div
        key={`forum-${f.id}`}
        onClick={() => navigate(`/forum/${String(f.forumId ?? f.id)}`)}
        style={{ padding: 16, borderBottom: '1px solid #eee', cursor: 'pointer' }}
      >
        {/* 标题与类型标签 */}
        {/* 高亮或内容摘要 */}
      </div>
    ))}
  </div>
)}
```

- 跳转逻辑：
  - 优先使用 `forumId`，否则回退为 `id`；
  - 统一跳转到板块详情页 `/forum/:forumId`。

### 4.2 高亮与摘要

- 使用与帖子类似的 `highlightHtml`，但 UI 样式更简洁：

```tsx
{f.highlight ? (
  <div
    style={{ marginTop: 6, color: '#666' }}
    dangerouslySetInnerHTML={highlightHtml('', f.highlight)}
  />
) : f.content ? (
  <div style={{ marginTop: 6, color: '#666' }}>{f.content}</div>
) : null}
```

- 一般情况下，板块高亮内容来自名称或描述中匹配到的关键字。

---

## 5. 空状态与交互体验

- 无关键词：
  - 页面提示“请输入搜索关键词”，避免空请求。
- 搜索中：
  - 显示“搜索中...”提示，避免用户误以为页面无响应。
- 无结果时：
  - 展示插画和文案“未找到与 {keyword} 相关的内容 / 试试其他关键词吧”；
  - 让结果页在无结果场景下依然有明确反馈。

> 总体而言，搜索结果页通过 `quickSearch` + `SearchResultDTO` 实现了“帖子+板块”统一搜索，并利用高亮 HTML + 摘要 + 元信息，让用户可以在单一视图中快速定位到需要的内容和板块入口。 
