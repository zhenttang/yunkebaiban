# 标签浏览与过滤（功能 + 实现说明）

> 关联上级：`论坛/标签与搜索.md`  
> 相关代码位置：
> - 标签帖子列表页：`packages/frontend/core/src/desktop/pages/workspace/forum/tag-posts/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`
> - 类型定义：`packages/frontend/core/src/desktop/pages/workspace/forum/types.ts`（`TagDTO`、`PostDTO`）

---

## 1. 标签数据结构与 API

### 1.1 TagDTO 类型

- 论坛标签类型定义在 `types.ts` 中：

```ts
export interface TagDTO {
  id: number;
  name: string;
  slug?: string;
  description?: string;
  usageCount: number;
  createdAt: string;
}
```

- 字段含义：
  - `name`：标签名称（如“BUG反馈”、“功能建议”等）；
  - `description`：标签描述（可选）；
  - `usageCount`：使用次数（带此标签的帖子数量）；
  - `slug`：可选的 URL 友好标识。

### 1.2 标签相关 API

- `getPopularTags()`：
  - 返回一组热门标签（用于在标签页或其它地方展示标签云/热门标签列表）；
  - 在标签帖子列表页中用于根据 `tagId` 找到标签名称。
- `getPostsByTag(tagId, page, size)`：
  - 输入标签 ID 和分页参数；
  - 返回 `PaginatedResponse<PostDTO>`，即该标签下的帖子列表。

> 当前实现重点在“按标签查看帖子”，标签列表页本身可以在此基础上继续扩展（例如 `/forum/tags` 聚合视图）。

---

## 2. 标签帖子列表页（/forum/tags/:tagId）

### 2.1 路由与参数

- 路由形式：`/forum/tags/:tagId`；
- 页面组件通过 `useParams` 获取标签 ID：

```ts
const { tagId } = useParams<{ tagId: string }>();
```

- 本地状态：
  - `tagName`：当前标签名称；
  - `posts`：`PaginatedResponse<PostDTO>`；
  - `page`：当前页码；
  - `loading`：加载状态。

### 2.2 数据加载流程

- 使用 `useEffect` 在 `tagId` 或 `page` 变化时刷新数据：

```ts
useEffect(() => {
  if (!tagId) return;
  setLoading(true);
  Promise.all([
    getPostsByTag(parseInt(tagId, 10), page, 20),
    getPopularTags().catch(() => [] as TagDTO[]),
  ])
    .then(([postsData, tags]) => {
      setPosts(postsData);
      const t = tags.find(x => String(x.id) === String(tagId));
      setTagName(t?.name || `标签 #${tagId}`);
    })
    .catch(console.error)
    .finally(() => setLoading(false));
}, [tagId, page]);
```

- 行为说明：
  - 并行请求“当前标签下帖子列表”和“热门标签列表”；
  - 从热门标签中匹配当前 `tagId` 获取标签名称；
  - 若未找到，回退为 `标签 #{tagId}` 形式。

### 2.3 页面展示与分页

- 头部展示标签信息：

```tsx
<h2>
  标签：
  <span /* ...样式省略 */>
    #{tagName}
  </span>
</h2>
```

- 帖子列表：
  - 遍历 `posts.content` 渲染每条帖子；
  - 显示标题、作者、发布时间、浏览数、回复数等摘要；
  - 点击列表项跳转到 `/forum/{post.forumId}/post/{post.id}`。

- 分页区域：
  - 若 `posts.totalPages > 1`，显示“上一页/下一页”按钮；
  - `page` 作为状态驱动重新加载数据；
  - 与其他列表页的分页风格保持一致。

---

## 3. 标签过滤的扩展方向

- 现有实现主要提供“按单个标签查看帖子”的能力；  
- 在此基础上可以扩展：
  - 标签列表页 `/forum/tags`：展示所有标签及 `usageCount`，支持按名称搜索；  
  - 多标签组合过滤：在板块详情或搜索页中增加标签过滤条件，将多个 tagId 一并传入搜索请求；  
  - 与板块过滤结合：在 `/forum/:forumId` 内按标签过滤当前板块的帖子（在 `SearchRequest` 中同时带上 `forumId` 与标签条件）。  

> 当前代码已经提供 `TagDTO`、标签 API 和标签帖子列表页，满足“按标签聚合帖子”的核心需求，更复杂的过滤行为可以通过在搜索请求层面扩展参数来实现。 
