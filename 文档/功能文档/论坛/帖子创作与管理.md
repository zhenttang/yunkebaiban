# 帖子创作与管理（功能 + 实现说明）

> 关联上级：`文档/功能文档/forum.md`  
> 主要相关代码：
> - 发帖页面：`packages/frontend/core/src/desktop/pages/workspace/forum/create-post/index.tsx`
> - 草稿列表：`packages/frontend/core/src/desktop/pages/workspace/forum/draft-list/index.tsx`
> - 编辑历史：`packages/frontend/core/src/desktop/pages/workspace/forum/edit-history/index.tsx`
> - API：`packages/frontend/core/src/desktop/pages/workspace/forum/forum-api.ts`

---

## 1. 发帖（/forum/:forumId/create-post）

> 细节见子文档：`论坛/帖子创作与管理/发帖流程.md`

- 功能视角：
  - 在指定板块下创建新帖子；
  - 支持填写标题、正文与标签；
  - 支持上传附件（图片/文档/压缩包等常见类型）；
  - 支持草稿自动保存与手动保存；
  - 支持从草稿继续编辑后发布。

- 实现关键点：
  - 使用 `useParams` 获取 `forumId`，作为发帖目标板块；
  - 使用 `createPost` API 创建帖子、`uploadAttachment` API 上传附件；
  - 通过 `saveDraft` / `getDraft` / `publishDraft` 支持草稿：
    - 每 30 秒自动保存有修改的内容；
    - 显式点击“保存草稿”时，立即保存并提示成功；
    - 草稿 ID 写入 URL（`?draftId=`），便于刷新后继续编辑；
    - 将草稿发布为正式帖子后，跳转回帖子详情页。

---

## 2. 草稿管理（/forum/drafts）

> 细节见子文档：`论坛/帖子创作与管理/草稿与编辑历史.md`

- 功能视角：
  - 展示当前用户的所有帖子草稿；
  - 支持继续编辑、发布、删除草稿；
  - 按更新时间倒序展示草稿（最近编辑的在前）。

- 实现关键点：
  - 通过 `getMyDrafts(page, pageSize)` 分页获取草稿列表；
  - 列表每一项展示：
    - 草稿标题（无标题时显示“(无标题)”）；
    - 内容前几百字；
    - 所属板块名与最近更新时间；
  - 操作按钮：
    - “继续编辑”：跳转到 `/forum/{forumId}/create-post?draftId={id}`，发帖页加载草稿内容；
    - “发布”：调用 `publishDraft(id)`，成功后跳转到新发布的帖子详情；
    - “删除”：调用 `deleteDraft(id)`，并刷新列表。

---

## 3. 编辑历史（/forum/posts/:postId/history）

- 功能视角：
  - 展示指定帖子的所有编辑历史记录；
  - 按时间倒序展示版本列表（最新编辑在前）；
  - 展示每个版本的编辑人、时间以及标题/内容是否发生变化；
  - 支持展开单条记录查看旧标题与旧内容详情。

- 实现关键点：
  - 使用 `getPost(postId)` 获取帖子的当前信息，用于显示历史标题的上下文；
  - 使用 `getPostHistory(postId, page, size)` 获取编辑历史分页结果；
  - 在前端按 `editedAt` 或 `createdAt` 对返回的 `content` 进行倒序排序；
  - 使用 `getHistoryDetail(historyId)` 在用户首次展开某条记录时按需加载完整内容；
  - 页面顶部提供“返回帖子”按钮跳回 `/forum/{forumId}/post/{postId}`；
  - 底部提供分页控件在历史记录页之间切换。

> 后续若需要支持“恢复到某个历史版本”，可以在编辑历史列表中为每条记录增加相应操作，并调用专用后端接口完成回滚。 
