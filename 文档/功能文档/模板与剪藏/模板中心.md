# 模板中心（功能 + 实现说明）

> 关联上级：`文档/功能文档/templates-and-clipper.md`  
> 主要相关代码：
> - 路由入口：`packages/frontend/core/src/desktop/router.tsx`（`/template/import`、`/template/preview`）
> - 模板导入模块：`packages/frontend/core/src/modules/import-template/*`
> - 导入对话框：`packages/frontend/core/src/desktop/dialogs/import-template/index.tsx`
> - 分享页入口按钮：`packages/frontend/core/src/components/cloud/share-header-right-item/import-template.tsx`

---

## 1. 模板列表与分类（功能视角）

> 详细交互见子文档：`模板中心/模板列表与分类.md`

- 列表展示：
  - 展示所有可用模板（页面/白板等类型）；
  - 每个模板展示名称、封面图、简介、适用场景等。
- 分类与过滤：
  - 支持按模板类型（页面模板、白板模板等）过滤；
  - 支持按业务场景（如“项目管理”“知识库”“会议记录”等）过滤；
  - 支持按标签过滤。
- 搜索：
  - 支持按名称、描述进行模糊搜索；
  - 搜索结果以同一列表形式展示。

> 列表数据来源与分类逻辑通常由模板服务或后端接口提供，本项目中模板导入侧的核心逻辑集中在“模板快照下载 + 导入流程”上，列表页可以按业务需求继续扩展。

---

## 2. 模板预览与入口

### 2.1 分享页中的“使用此模板”入口

- 在模板分享页或公开页面右上角，会展示一个“使用此模板”按钮：

```tsx
// packages/frontend/core/src/components/cloud/share-header-right-item/import-template.tsx
export const ImportTemplateButton = ({ name, snapshotUrl }) => {
  const t = useI18n();
  const { jumpToImportTemplate } = useNavigateHelper();
  return (
    <Button
      variant="primary"
      onClick={() => jumpToImportTemplate(name, snapshotUrl)}
    >
      {t['com.yunke.share-page.header.import-template']()}
    </Button>
  );
};
```

- 行为说明：
  - `jumpToImportTemplate` 将用户导航到 `/template/import` 路由；
  - 通过 URL 查询参数携带模板名称和快照地址：

```ts
// use-navigate-helper.ts
const jumpToImportTemplate = useCallback(
  (name: string, snapshotUrl: string) => {
    return navigate(
      `/template/import?name=${encodeURIComponent(name)}&snapshotUrl=${encodeURIComponent(snapshotUrl)}`
    );
  },
  [navigate]
);
```

- 典型 URL 示例：
  - `/template/import?name=项目管理模板&snapshotUrl=https%3A%2F%2Fcdn.example.com%2Ftemplates%2Fxxx.zip`

### 2.2 模板预览重定向（/template/preview）

- 当需要从某处“预览模板对应的实际文档”时，会使用 `/template/preview` 路由：
  - 通过 loader 将请求重定向到具体的 workspace/page：

```ts
// desktop/router.tsx
{
  path: '/template/preview',
  loader: ({ request }) => {
    const url = new URL(request.url);
    const workspaceId = url.searchParams.get('workspaceId');
    const docId = url.searchParams.get('docId');
    const templateName = url.searchParams.get('name');
    const templateMode = url.searchParams.get('mode');
    const snapshotUrl = url.searchParams.get('snapshotUrl');

    return redirect(
      `/workspace/${workspaceId}/${docId}?${new URLSearchParams({
        isTemplate: 'true',
        templateName: templateName ?? '',
        snapshotUrl: snapshotUrl ?? '',
        mode: templateMode ?? 'page',
      }).toString()}`
    );
  },
}
```

- 行为说明：
  - 根据传入的 `workspaceId` 与 `docId` 跳转到实际文档；
  - `isTemplate=true` 等查询参数在文档页面中可以用于：
    - 展示“模板预览”标记；
    - 显示“使用此模板”操作；
    - 将模板相关信息（名称、快照地址）传给后续导入流程。

---

## 3. 模板导入与应用（整体流程）

> 详细流程见子文档：`模板中心/模板预览与导入流程.md`

### 3.1 导入对话框入口

- 当用户点击“使用此模板”后，会进入 `/template/import` 页面，该页面会展示一个导入对话框 `ImportTemplateDialog`：
  - 对话框组件：`desktop/dialogs/import-template/index.tsx`
  - 通过全局对话框系统以 `import-template` 的 key 被打开：

```ts
// desktop/dialogs/index.tsx
export const dialogComponents: GLOBAL_DIALOG_SCHEMA = {
  // ...
  'import-template': ImportTemplateDialog,
};
```

### 3.2 模板快照下载

- 在对话框打开后，会立即下载模板快照 ZIP：

```ts
// ImportTemplateDialog 内部
const templateDownloader = templateDownloaderService.downloader;

useEffect(() => {
  templateDownloader.download({ snapshotUrl });
}, [snapshotUrl, templateDownloader]);
```

- 下载链路：
  - `TemplateDownloader.download`（Entity）调用 `TemplateDownloaderStore.download`；
  - `TemplateDownloaderStore.download` 使用 `fetch(snapshotUrl)` 拉取 ZIP，并转为 `Uint8Array`：

```ts
export class TemplateDownloaderStore extends Store {
  async download(snapshotUrl: string) {
    const response = await globalThis.fetch(snapshotUrl, { priority: 'high' } as any);
    const arrayBuffer = await response.arrayBuffer();
    return { data: new Uint8Array(arrayBuffer) };
  }
}
```

- 下载状态通过 `isDownloading$` 与 `error$` 暴露给对话框 UI：
  - 下载中：显示 loading 状态，禁用导入按钮；
  - 下载失败：显示错误提示，阻止后续导入。

### 3.3 选择目标工作空间

- 对话框中会列出当前可用工作空间，并允许选择导入目标：

```tsx
const workspaces = useLiveData(workspacesService.list.workspaces$);
const [rawSelectedWorkspace, setSelectedWorkspace] = useState<WorkspaceMetadata | null>(null);
const selectedWorkspace =
  rawSelectedWorkspace ??
  workspaces.find(w => w.flavour !== 'local') ??
  workspaces.at(0);

// UI 中使用 WorkspaceSelector 组件
<WorkspaceSelector
  workspaceMetadata={selectedWorkspace}
  onSelectWorkspace={handleSelectedWorkspace}
  onCreatedWorkspace={handleCreatedWorkspace}
  // ...
/>
```

- 行为说明：
  - 默认选择第一个“非本地”工作空间作为导入目标；
  - 若不存在任何工作空间，则对话框会提示“将创建一个新工作空间”；
  - 用户可以通过 `WorkspaceSelector` 切换目标工作空间或新建工作空间。

### 3.4 导入到现有工作空间

- 当用户选择了一个工作空间并点击导入按钮时，调用：

```ts
const docId = await importTemplateService.importToWorkspace(
  selectedWorkspace,
  templateDownloader.data$.value,
  templateMode
);
openPage(selectedWorkspace.id, docId);
```

- 对应服务逻辑（`ImportTemplateService`）：

```ts
export class ImportTemplateService extends Service {
  async importToWorkspace(
    workspaceMetadata: WorkspaceMetadata,
    docBinary: Uint8Array,
    mode: DocMode
  ) {
    const { workspace, dispose } = this.workspacesService.open({ metadata: workspaceMetadata });
    await workspace.engine.doc.waitForDocReady(workspace.id);

    const [importedDoc] = await ZipTransformer.importDocs(
      workspace.docCollection,
      getYUNKEWorkspaceSchema(),
      new Blob([docBinary], { type: 'application/zip' })
    );

    const docsService = workspace.scope.get(DocsService);
    if (importedDoc) {
      docsService.list.setPrimaryMode(importedDoc.id, mode);
      dispose();
      return importedDoc.id;
    } else {
      throw new Error('导入文档失败');
    }
  }
}
```

- 关键点：
  - 使用 `ZipTransformer.importDocs` 将 ZIP 中的文档导入到指定工作空间的 `docCollection`；
  - 使用 `DocsService` 设置导入文档的主模式（`page` / `edgeless` 等）；
  - 完成后关闭临时打开的 workspace scope，避免资源泄漏。

### 3.5 导入到新建工作空间

- 若当前没有可用工作空间，或用户选择“新建工作空间导入”，则调用：

```ts
const { workspaceId, docId } =
  await importTemplateService.importToNewWorkspace(
    'yunke-cloud',
    'Workspace',
    templateDownloader.data$.value
  );
openPage(workspaceId, docId);
```

- 服务逻辑：

```ts
async importToNewWorkspace(
  flavour: string,
  workspaceName: string,
  docBinary: Uint8Array
) {
  let docId: string = null!;
  const { id: workspaceId } = await this.workspacesService.create(
    flavour,
    async (docCollection, _, docStorage) => {
      docCollection.meta.initialize();
      docCollection.doc.getMap('meta').set('name', workspaceName);
      const doc = docCollection.createDoc();
      docId = doc.id;
      await docStorage.pushDocUpdate({
        docId: doc.spaceDoc.guid,
        bin: docBinary,
      });
    }
  );
  return { workspaceId, docId };
}
```

- 行为说明：
  - 创建一个新的工作空间（当前默认 flavour 为 `'yunke-cloud'`，名称为 `'Workspace'`，可按实际产品改造）；
  - 初始化 meta 信息并创建一个文档；
  - 将模板快照以一次性更新的方式写入存储；
  - 返回新工作空间与文档 ID，前端随后跳转到该文档。

---

整体来看，“模板中心”在当前代码结构中，核心实现集中在“模板快照下载 + 导入对话框 + 导入服务”三部分，模板列表与分类可以在此基础上继续扩展更丰富的 UI 与数据源。 
