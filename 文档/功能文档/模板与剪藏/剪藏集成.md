# 剪藏集成（功能 + 实现说明）

> 关联上级：`文档/功能文档/templates-and-clipper.md`  
> 主要相关代码：
> - 路由入口：`packages/frontend/core/src/desktop/router.tsx`（`/clipper/import`）
> - 剪藏导入页面：`packages/frontend/core/src/desktop/pages/import-clipper/index.tsx`
> - 剪藏导入服务：`packages/frontend/core/src/modules/import-clipper/services/import.ts`

---

## 1. 功能定位与整体流程

### 1.1 功能定位

- 为浏览器 Web Clipper 等外部工具提供一个统一的“剪藏落地入口”：
  - 接收剪藏后的结构化数据（标题、Markdown、HTML、附件等）；
  - 引导用户选择工作空间；
  - 将剪藏内容转换为 Yunke 文档；
  - 在导入完成后通知剪藏工具并关闭页面。

### 1.2 整体调用链

1. 用户在浏览器中使用 Yunke Web Clipper 对网页执行剪藏；
2. 剪藏扩展在新窗口中打开 Yunke 的 `/clipper/import` 页；
3. 扩展通过 `window.postMessage` 或 `MessagePort` 将 `ClipperInput` 数据发送给该页面；
4. `/clipper/import` 页面解析剪藏数据、展示工作空间选择 UI；
5. 用户确认后（或根据策略自动），调用 `ImportClipperService` 导入为文档；
6. 导入成功后，页面通过 `postMessage` 通知扩展，并关闭自身。

> 详细过程拆分在子文档：  
> - 《剪藏入口与参数.md》：路由、消息协议与剪藏 payload 结构；  
> - 《剪藏内容解析与落地策略.md》：Markdown 导入、工作空间选择与导入服务实现。

---

## 2. 路由入口与页面组件

### 2.1 `/clipper/import` 路由

- 路由定义位置：`packages/frontend/core/src/desktop/router.tsx`：

```ts
{
  path: '/clipper/import',
  lazy: () => import('./pages/import-clipper'),
},
```

- 特点：
  - 作为顶级路由存在，不依赖具体 workspace；
  - 通常由外部扩展以 `window.open('/clipper/import', ...)` 的方式打开；
  - 与模板导入等其他功能路由平级。

### 2.2 页面组件职责

- 页面组件：`packages/frontend/core/src/desktop/pages/import-clipper/index.tsx`：
  - 监听来自扩展的剪藏数据；
  - 拉取当前用户可用工作空间列表；
  - 依据剪藏输入中的工作空间策略自动或手动选择工作空间；
  - 调用 `ImportClipperService` 完成文档创建；
  - 向扩展回传结果并关闭窗口。

> 入口与参数细节见子文档《剪藏入口与参数.md》，导入逻辑见子文档《剪藏内容解析与落地策略.md》。

