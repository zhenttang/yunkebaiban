# 剪藏内容解析与落地策略（功能 + 实现说明）

> 关联上级：`模板与剪藏/剪藏集成.md`  
> 相关代码位置：
> - 剪藏导入页面：`packages/frontend/core/src/desktop/pages/import-clipper/index.tsx`
> - 剪藏导入服务：`packages/frontend/core/src/modules/import-clipper/services/import.ts`
> - BlockSuite Markdown 导入：`@blocksuite/yunke/widgets/linked-doc`（`MarkdownTransformer`）

---

## 1. Markdown 导入与文档创建

### 1.1 ImportClipperService 概览

- 核心服务：`ImportClipperService`，负责将 `ClipperInput` 落地为文档：

```ts
export class ImportClipperService extends Service {
  constructor(private readonly workspacesService: WorkspacesService) {
    super();
  }

  async importToWorkspace(
    workspaceMetadata: WorkspaceMetadata,
    clipperInput: ClipperInput
  ) {
    const { workspace, dispose } = this.workspacesService.open({ metadata: workspaceMetadata });
    await workspace.engine.doc.waitForDocReady(workspace.id);

    const docId = await MarkdownTransformer.importMarkdownToDoc({
      collection: workspace.docCollection,
      schema: getYUNKEWorkspaceSchema(),
      markdown: clipperInput.contentMarkdown,
      extensions: getStoreManager().config.init().value.get('store'),
    });

    const docsService = workspace.scope.get(DocsService);
    if (docId) {
      await docsService.changeDocTitle(docId, clipperInput.title);
      docsService.list.setPrimaryMode(docId, 'page');
      workspace.engine.doc.addPriority(workspace.id, 100);
      workspace.engine.doc.addPriority(docId, 100);
      await workspace.engine.doc.waitForSynced(workspace.id);
      await workspace.engine.doc.waitForSynced(docId);
      dispose();
      return docId;
    } else {
      throw new Error('导入文档失败');
    }
  }
```

- 关键点：
  - 通过 `WorkspacesService.open` 打开目标工作空间；
  - 使用 `MarkdownTransformer.importMarkdownToDoc` 将 Markdown 转换为 BlockSuite 文档；
  - 使用 `DocsService` 设置文档标题与主模式（目前仅支持 `page` 模式）；
  - 等待 workspace 与 doc 同步完成后，关闭临时 workspace 以释放资源。

### 1.2 新建工作空间导入

- 当需要在全新的工作空间中落地剪藏时，使用 `importToNewWorkspace`：

```ts
async importToNewWorkspace(
  flavour: string,
  workspaceName: string,
  clipperInput: ClipperInput
) {
  let docId: string | undefined;
  const { id: workspaceId } = await this.workspacesService.create(
    flavour,
    async docCollection => {
      docCollection.meta.initialize();
      docCollection.doc.getMap('meta').set('name', workspaceName);
      docId = await MarkdownTransformer.importMarkdownToDoc({
        collection: docCollection,
        schema: getYUNKEWorkspaceSchema(),
        markdown: clipperInput.contentMarkdown,
        extensions: getStoreManager().config.init().value.get('store'),
      });
    }
  );

  if (!docId) {
    throw new Error('导入文档失败');
  }
  return { workspaceId, docId };
}
```

- 行为说明：
  - 创建一个新的工作空间，并设置其名称；
  - 在创建过程回调中直接将剪藏 Markdown 导入为首个文档；
  - 返回新工作空间 ID 与文档 ID，供调用方进行后续跳转或通知。

---

## 2. 工作空间选择与导入触发

### 2.1 工作空间选择策略

- 在导入页面组件中：

```ts
const workspaces = useLiveData(workspacesService.list.workspaces$);
const [rawSelectedWorkspace, setSelectedWorkspace] =
  useState<WorkspaceMetadata | null>(null);
const [lastOpenedWorkspaceId] = useState(() =>
  localStorage.getItem('last_workspace_id')
);
const selectedWorkspace =
  rawSelectedWorkspace ??
  workspaces.find(w => w.id === lastOpenedWorkspaceId) ??
  workspaces.find(w => w.flavour !== 'local') ??
  workspaces.at(0);
```

- 策略优先级：
  1. 用户在 UI 中手动选择的工作空间；
  2. 上一次导入成功时记录的 `last_workspace_id`；
  3. 第一个非本地工作空间；
  4. 列表中的第一个工作空间（兜底）。

- UI 中通过 `WorkspaceSelector` 组件展示并允许用户切换或新建工作空间。

### 2.2 导入到选中工作空间

- 用户点击“导入到工作空间”按钮时触发：

```ts
const handleImportToSelectedWorkspace = useAsyncCallback(async () => {
  if (clipperInputSnapshot && selectedWorkspace) {
    localStorage.setItem('last_workspace_id', selectedWorkspace.id);
    setImporting(true);
    try {
      await importClipperService.importToWorkspace(
        selectedWorkspace,
        clipperInputSnapshot
      );
      handleSuccess();
    } catch (err) {
      setImportingError(err);
    } finally {
      setImporting(false);
    }
  }
});
```

- 逻辑说明：
  - 先将当前工作空间 ID 写入 `localStorage`，用于下次自动导入策略；
  - 调用 `ImportClipperService.importToWorkspace` 落地剪藏内容；
  - 成功后调用 `handleSuccess` 通知扩展并关闭页；
  - 失败时记录错误并在 UI 中展示提示。

### 2.3 导入到新建工作空间

- 当 `selectedWorkspace` 为空（无可用工作空间或用户选择新建）时，使用：

```ts
const handleImportToNewWorkspace = useAsyncCallback(async () => {
  if (!clipperInputSnapshot) {
    return;
  }
  setImporting(true);
  try {
    await importClipperService.importToNewWorkspace(
      'yunke-cloud',
      'Workspace',
      clipperInputSnapshot
    );
    handleSuccess();
  } catch (err) {
    setImportingError(err);
  } finally {
    setImporting(false);
  }
});
```

- 当前默认工作空间 flavour 与名称为硬编码值（`'yunke-cloud'`、`'Workspace'`），可以在后续版本中改为可配置或本地化的名称。

---

## 3. 导入完成后的回调与扩展通信

### 3.1 handleSuccess 通知扩展

- 导入成功后，通过 `handleSuccess` 与扩展通信：

```ts
const port$ = new LiveData<MessagePort | null>(null);

const handleSuccess = useCallback(() => {
  const arg = { type: 'yunke-clipper:import:success' };
  const port = port$.value;
  track.clipper.$.$.createDoc();
  if (port) {
    port.postMessage(arg);
  } else {
    window.postMessage(arg);
  }
  window.close();
}, []);
```

- 行为说明：
  - 构造 `{ type: 'yunke-clipper:import:success' }` 作为确认消息；
  - 若之前从 `event.ports[0]` 中保存了 `MessagePort`，优先通过 `port.postMessage` 返回；
  - 否则退回到 `window.postMessage`；
  - 调用 `window.close()` 关闭导入页面窗口；
  - 通过埋点 `track.clipper.$.$.createDoc()` 记录一次剪藏创建事件。

### 3.2 UI 状态与错误提示

- 页面通过以下状态控制 UI：
  - `importing`：导入中 → 按钮显示 loading 且禁用；
  - `importingError`：导入失败 → 展示 `com.yunke.import-clipper.dialog.errorImport` 文案；
  - `isMissingInput`：未收到剪藏数据 → 展示 `com.yunke.import-clipper.dialog.errorLoad` 文案。

- 按钮禁用条件：

```ts
const disabled = isMissingInput || importing;
```

- 界面结构：
  - 若没有任何工作空间：提示“将创建新工作区”；
  - 若有工作空间：展示 `WorkspaceSelector` 供选择；
  - 底部为“导入到选中工作区”或“创建新工作区并导入”按钮。

---

## 4. 授权与登录（当前实现状态）

### 4.1 登录检查逻辑（部分被注释）

- 页面中原本通过 `AuthService` 检查登录状态：

```ts
const session = useService(AuthService).session;
const sessionStatus = useLiveData(session.status$);
const notLogin = sessionStatus === 'unauthenticated';
```

- 设计上的预期行为：
  - 若 `notLogin` 为 true，则展示登录引导 UI（`AuthHeader` + 登录按钮）；
  - 阻止自动导入，要求用户先登录再继续；
  - 登录完成后，刷新 session 并恢复导入逻辑。

- 当前代码中，这部分登录拦截逻辑被注释，方便在本地或弱权限环境中直接测试剪藏导入流程。  
  在正式环境中应根据需要恢复或强化这一检查。

> 小结：  
> 剪藏内容解析与落地策略的核心，是将扩展发送的 `ClipperInput` 通过 `MarkdownTransformer` 和 `ImportClipperService` 转换为 Yunke 文档，并结合工作空间选择策略、自动导入逻辑与成功回调，形成一条完整、可扩展的剪藏导入链路。 

