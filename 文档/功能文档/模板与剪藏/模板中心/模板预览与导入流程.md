# 模板预览与导入流程（功能 + 实现说明）

> 关联上级：`模板与剪藏/模板中心.md`  
> 相关代码位置：
> - 路由：`packages/frontend/core/src/desktop/router.tsx`（`/template/import`、`/template/preview`）
> - 导入对话框：`packages/frontend/core/src/desktop/dialogs/import-template/index.tsx`
> - 导入服务：`packages/frontend/core/src/modules/import-template/services/import.ts`
> - 模板下载：`packages/frontend/core/src/modules/import-template/entities/downloader.ts`

---

## 1. 模板预览入口（/template/preview）

### 1.1 预览链接结构

- 在某些场景下（如模板市场或分享页），系统会提供一个预览链接，用于直接打开模板对应的文档，并带上模板上下文信息：

```txt
/template/preview?workspaceId={wid}&docId={docId}&name={模板名}&mode={page|edgeless}&snapshotUrl={zipUrl}
```

- 各参数含义：
  - `workspaceId`：模板所在工作空间 ID；
  - `docId`：模板对应的文档 ID；
  - `name`：模板名称；
  - `mode`：模板主模式（`page`、`edgeless` 等）；
  - `snapshotUrl`：模板快照 ZIP 下载地址。

### 1.2 预览路由重定向逻辑

- `/template/preview` 本身不渲染页面，而是立即重定向到 workspace 页面：

```ts
// desktop/router.tsx
{
  path: '/template/preview',
  loader: ({ request }) => {
    const url = new URL(request.url);
    const workspaceId = url.searchParams.get('workspaceId');
    const docId = url.searchParams.get('docId');
    const templateName = url.searchParams.get('name');
    const templateMode = url.searchParams.get('mode');
    const snapshotUrl = url.searchParams.get('snapshotUrl');

    return redirect(
      `/workspace/${workspaceId}/${docId}?${new URLSearchParams({
        isTemplate: 'true',
        templateName: templateName ?? '',
        snapshotUrl: snapshotUrl ?? '',
        mode: templateMode ?? 'page',
      }).toString()}`
    );
  },
}
```

- 在目标文档页面中，可通过查询参数判断：
  - 当前打开的是“模板预览”而非普通文档；
  - 是否展示“使用此模板”操作；
  - 模板名称与快照地址等信息，可用于后续导入。

---

## 2. 模板导入入口（/template/import）

### 2.1 导入入口触发方式

- 常见触发路径：
  - 在模板预览页顶部点击“使用此模板”按钮；
  - 直接访问 `jumpToImportTemplate` 生成的导入 URL。

- 入口按钮实现（分享页右上角）：

```tsx
export const ImportTemplateButton = ({ name, snapshotUrl }) => {
  const { jumpToImportTemplate } = useNavigateHelper();
  return (
    <Button
      variant="primary"
      onClick={() => jumpToImportTemplate(name, snapshotUrl)}
    >
      {t['com.yunke.share-page.header.import-template']()}
    </Button>
  );
};
```

- 导航帮助函数：

```ts
const jumpToImportTemplate = useCallback(
  (name: string, snapshotUrl: string) => {
    return navigate(
      `/template/import?name=${encodeURIComponent(name)}&snapshotUrl=${encodeURIComponent(snapshotUrl)}`
    );
  },
  [navigate]
);
```

### 2.2 导入页面与对话框

- `/template/import` 路由对应的页面懒加载 `./pages/import-template`，该页面内部会：
  - 打开 `ImportTemplateDialog` 对话框；
  - 将 URL 中的 `name`、`snapshotUrl`、`mode` 参数传给对话框。

- 对话框 props（在 `ImportTemplateDialog` 中）：

```ts
export const ImportTemplateDialog = ({
  close,
  snapshotUrl,
  templateName,
  templateMode,
}: DialogComponentProps<GLOBAL_DIALOG_SCHEMA['import-template']>) => {
  // ...
}
```

> 通过全局对话框系统，模板导入逻辑得以与具体页面解耦，可在多个场景中复用导入流程。

---

## 3. 模板快照下载流程

### 3.1 下载触发

- 对话框初始化时，会使用传入的 `snapshotUrl` 触发模板快照下载：

```ts
const templateDownloader = templateDownloaderService.downloader;

useEffect(() => {
  templateDownloader.download({ snapshotUrl });
}, [snapshotUrl, templateDownloader]);
```

- `templateDownloader` 是一个 `Entity`，封装了下载状态与数据：
  - `isDownloading$`：当前是否在下载；
  - `data$`：下载后的 `Uint8Array` 数据；
  - `error$`：下载错误信息。

### 3.2 Downloader 实现

- downloader 实体：

```ts
export class TemplateDownloader extends Entity {
  constructor(private readonly store: TemplateDownloaderStore) {
    super();
  }

  readonly isDownloading$ = new LiveData<boolean>(false);
  readonly data$ = new LiveData<Uint8Array | null>(null);
  readonly error$ = new LiveData<any | null>(null);

  readonly download = effect(
    switchMap(({ snapshotUrl }: { snapshotUrl: string }) => {
      return fromPromise(() => this.store.download(snapshotUrl)).pipe(
        tap(({ data }) => {
          this.data$.next(data);
        }),
        smartRetry(),
        catchErrorInto(this.error$),
        onStart(() => {
          this.isDownloading$.next(true);
          this.data$.next(null);
          this.error$.next(null);
        }),
        onComplete(() => this.isDownloading$.next(false))
      );
    })
  );
}
```

- store 层实际执行 `fetch`：

```ts
export class TemplateDownloaderStore extends Store {
  async download(snapshotUrl: string) {
    const response = await globalThis.fetch(snapshotUrl, { priority: 'high' } as any);
    const arrayBuffer = await response.arrayBuffer();
    return { data: new Uint8Array(arrayBuffer) };
  }
}
```

- 对话框通过 `useLiveData` 订阅 `isDownloading$` 与 `error$`：
  - 下载中禁用导入按钮并展示 loading；
  - 下载失败时展示错误提示（例如 `com.yunke.import-template.dialog.errorLoad`）。

---

## 4. 选择导入目标与导入行为

### 4.1 工作空间选择逻辑

- 对话框内部维护一个“当前选中工作空间”状态：

```ts
const workspaces = useLiveData(workspacesService.list.workspaces$);
const [rawSelectedWorkspace, setSelectedWorkspace] =
  useState<WorkspaceMetadata | null>(null);

const selectedWorkspace =
  rawSelectedWorkspace ??
  workspaces.find(w => w.flavour !== 'local') ??
  workspaces.at(0);
```

- 行为策略：
  - 优先使用用户手动选择的 workspace；
  - 否则选择第一个非本地 workspace；
  - 若仍为空，则使用列表第一项；
  - 若列表为空，则认为“没有可用工作空间”，导入时会走“创建新工作空间”流程。

- UI 上通过 `WorkspaceSelector` 提供：
  - 切换工作空间；
  - 新建工作空间并自动选择。

### 4.2 导入到现有工作空间

- 用户点击“导入到某个工作空间”时，触发：

```ts
const handleImportToSelectedWorkspace = useAsyncCallback(async () => {
  if (templateDownloader.data$.value && selectedWorkspace) {
    setImporting(true);
    try {
      const docId = await importTemplateService.importToWorkspace(
        selectedWorkspace,
        templateDownloader.data$.value,
        templateMode
      );
      openPage(selectedWorkspace.id, docId);
      onClose?.();
    } catch (err) {
      setImportingError(err);
    } finally {
      setImporting(false);
    }
  }
});
```

- UI 文案示例：
  - 使用 `com.yunke.import-template.dialog.createDocToWorkspace`：
    - “在「{{workspace}}」中新建文档”

### 4.3 导入到新建工作空间

- 如果没有选中工作空间（或列表为空），则展示“创建至新的工作区”按钮：

```tsx
{selectedWorkspace ? (
  // 导入到已有工作区
) : (
  <Button onClick={handleImportToNewWorkspace}>
    {t['com.yunke.import-template.dialog.createDocToNewWorkspace']()}
  </Button>
)}
```

- 对应导入逻辑使用 `ImportTemplateService.importToNewWorkspace`，详见上级文档《模板中心.md》。

### 4.4 错误与状态反馈

- 可能出现的错误类型：
  - 模板快照下载失败（`downloadError`）；
  - 导入过程失败（`importingError`，例如 ZIP 格式错误等）。
- 对话框通过 i18n 文案提示：
  - `com.yunke.import-template.dialog.errorLoad`：读取模板失败，请重试；
  - `com.yunke.import-template.dialog.errorImport`：导入模板失败，请重试。

---

## 5. 导入完成后的行为

- 无论是导入到现有工作空间还是新建工作空间：
  - 导入成功后都会调用 `openPage(workspaceId, docId)` 打开导入后的文档；
  - 然后关闭导入对话框（`onClose?.()`）。

- 在后续可扩展的功能包括：
  - 记录“最近使用的模板”；
  - 在工作空间设置中展示“常用模板”统计；
  - 在导入结果页面展示“模板来源”、“创建自模板”等元信息。

> 整体上，模板预览与导入流程将“模板预览链接”、“模板快照 ZIP”、“工作空间选择”、“导入服务调用”串成一条清晰的调用链，使得用户可以从任何入口一键使用模板创建新文档。 

