# 分享设置面板（功能 + 实现说明）

> 关联上级：`工作空间/分享与访问控制/页面分享与访问级别.md`  
> 相关代码位置：
> - 分享按钮：`packages/frontend/core/src/modules/share-menu/view/index.tsx` 中的 `SharePageButton`
> - 分享面板：`packages/frontend/core/src/modules/share-menu/view/share-menu/*`

---

## 1. 分享设置面板的入口与整体结构

### 1.1 入口：页面头部分享按钮

- 在普通页面头部（`NormalPageHeader`）中，通过 `SharePageButton` 作为入口：

```tsx
{page && !hideShare ? (
  <SharePageButton workspace={workspace} page={page} />
) : null}
```

- `SharePageButton` 负责：
  - 检查当前工作空间是否已经启用云端分享（通过 `useEnableCloud`）；
  - 若未启用，先弹出启用云端的确认流程；
  - 若已启用，打开分享设置面板 `ShareMenu`。

### 1.2 ShareMenu 组件

- `SharePageButton` 内部实现（简化）：

```tsx
export const SharePageButton = ({ workspace, page }: SharePageModalProps) => {
  const confirmEnableCloud = useEnableCloud();
  const handleOpenShareModal = useCallback((open: boolean) => {
    if (open) {
      track.$.sharePanel.$.open();
    }
  }, []);

  return (
    <ShareMenu
      workspaceMetadata={workspace.meta}
      currentPage={page}
      onEnableYunkeCloud={() =>
        confirmEnableCloud(workspace, { openPageId: page.id })
      }
      onOpenShareModal={handleOpenShareModal}
    />
  );
};
```

- 说明：
  - `ShareMenu` 接收当前工作空间元信息和当前页面；
  - 通过 `onEnableYunkeCloud` 引导启用云端；
  - 通过 `onOpenShareModal` 回调记录埋点（打开/关闭分享面板）。

---

## 2. 面板内容：分享开关与访问级别

### 2.1 分享开关

- 面板顶部通常包含分享总开关：
  - “开启分享”/“关闭分享”；
  - 当关闭时，该页面不再对外公开（包括之前生成的链接）。
- 操作行为：
  - 打开分享开关 → 调用 API 将页面标记为可分享；
  - 关闭分享开关 → 调用 API 撤销分享，并让之前链接失效。

### 2.2 访问级别设置（示例）

- 常见访问级别选项：
  - 公开访问：任何持有链接的人都可以访问；
  - 登录后访问：需要登录云端账号；
  - 仅工作空间成员：需要在当前 workspace 内具有访问权限；
  - 仅特定受邀成员：必须通过邀请或加到白名单中。

UI 形态（设计）：

- 使用单选按钮组或下拉选择：
  - “公开链接（仅阅读）”；
  - “团队成员可访问”；
  - “仅我和受邀成员可访问”等。

> 具体实现取决于后端返回的权限模式（ShareMode / PermissionMode），前端通过 ShareMenu 读取并展示。

### 2.3 过期时间与访问密码（高级选项）

- 过期时间：
  - 允许用户设置分享链接的有效期（例如 7 天、30 天、自定义日期）；
  - 到期后，访问该链接会跳转到 `/expired`。
- 访问密码：
  - 用户可以为分享链接设置访问密码；
  - 访问者需要输入密码才能查看页面。

实现建议：

- ShareMenu 中提供“高级设置”区域，包含过期时间和密码输入；
  - 更改这些设置时，通过 API 更新分享链接配置；
  - 访问时由后端协同验证，前端负责展示输入框和错误提示。

---

## 3. 分享链接生成与复制

### 3.1 链接生成规则

- 分享链接通常以统一的 `/share` 路由形式存在，在 Web 顶层路由中有对应配置：

```tsx
{
  path: '/share/:workspaceId/:pageId',
  loader: ({ params }) => {
    return redirect(`/workspace/${params.workspaceId}/${params.pageId}`);
  },
}
```

- 说明：
  - 真正的权限校验由后端决定；
  - 前端只负责根据 workspaceId + pageId 生成正确格式的链接；
  - 当访问 `/share/...` 时，loader 会重定向到对应 workspace/page，并将权限信息交由业务逻辑处理。

### 3.2 复制链接与二维码

- 在 ShareMenu 中，通常提供：
  - “复制链接”按钮；
  - 可选的“复制嵌入代码”（如 iframe）；
  - 可选的“生成二维码”：便于在移动端扫码打开。

交互细节：

- 点击“复制链接”：
  - 使用 `navigator.clipboard.writeText` 或回退方案复制到剪贴板；
  - 显示成功提示（如 toast：“链接已复制”）。
- 生成二维码（可选）：
  - 使用前端 QR 组件绘制二维码；
  - 指向分享链接 URL。

---

## 4. 云端启用与计划限制

### 4.1 启用云端共享

- 对于本地/自建部署场景，工作空间可能默认未启用云端分享能力：
  - 当用户点击分享按钮时，先通过 `useEnableCloud` 检查；
  - 如未启用，则弹出启用云端的引导对话框；
  - 用户确认后，调用云端启用 API，并在成功后重新打开 ShareMenu。

### 4.2 套餐限制（与历史版本类似）

- 对于免费工作空间，分享能力可能有限制（如仅支持部分模式或部分页面）：
  - ShareMenu 中可显示“升级套餐以解锁更多分享选项”的提示；
  - 引导用户进入管理后台的套餐页面（`/admin/settings` 中的 plans 页）。

> ShareMenu 与历史版本模块一样，都会与 Workspace 的 quota/plan 信息协同工作，具体逻辑在 quotas/permissions 模块中实现，这里主要关注 UI 层面的表现。 
