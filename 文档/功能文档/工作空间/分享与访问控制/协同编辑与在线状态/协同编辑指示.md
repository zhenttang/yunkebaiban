# 协同编辑指示（功能 + 实现说明）

> 关联上级：`工作空间/分享与访问控制/协同编辑与在线状态.md`  
> 相关代码位置（协同基础设施，不做细节展开）：
> - 云端协同存储：`CloudDocStorage`、`CloudAwarenessStorage`（`workspace-engine/impls/cloud.ts`）
> - 分享页协同配置：`desktop/pages/workspace/share/share-page.tsx` 中 remotes.awareness 配置

---

## 1. 光标与选区指示

### 1.1 功能说明

- 在多人同时编辑同一文档或白板时，前端需要体现协同状态：
  - 显示其他协作者的光标位置（通常带有姓名缩写或头像）；
  - 显示其他协作者选中的文本范围或块区域；
  - 在白板上显示其他人的选中节点或框选区域。

### 1.2 实现概览（基于 Awareness）

- BlockSuite 与 Yunke 的协同实现基于 Yjs + Awareness 概念：
  - 文档内容通过 Yjs 文档同步（`DocStorage`）；
  - 协作者状态（光标位置、选区、用户名、颜色等）通过 Awareness 通道同步（`AwarenessStorage`）。

示例（在分享页面中配置 Awareness）：

```ts
awareness: {
  name: 'CloudAwarenessStorage',
  opts: {
    type: 'workspace',
    id: workspaceId,
    serverBaseUrl: getBaseUrl(),
    isSelfHosted: false,
  },
},
```

- 在本地/浏览器标签页间，也可使用 `BroadcastChannelAwarenessStorage` 做轻量协作。

前端渲染：

- 编辑器在接收到其他用户的 Awareness 状态后：
  - 为每个协作者分配一个唯一颜色；
  - 在对应位置渲染协作者光标；
  - 在对应文本或块旁边显示小标签（如姓名缩写）。

> 光标和选区具体渲染逻辑位于 BlockSuite 编辑器内部，这里从功能和架构层面做说明。

---

## 2. 在线状态与参与者列表

### 2.1 在线成员指示

- 在页面头部或侧边栏中，可以显示当前在线编辑该页面的成员列表：
  - 展示头像或首字母；
  - 悬停时显示完整名称；
  - 点击可能跳转到该用户主页（视产品设计）。

数据来源：

- 基于 Awareness 中的活跃会话；
- 或基于协同服务端的在线状态接口；
- 前端定期更新显示当前在线成员。

### 2.2 工作空间级在线状态

- 除了页面级，还可以在工作空间视图中展示：
  - 整个 workspace 中在线的成员数量；
  - 正在某些关键页面编辑的人数（例如在导航中标记某页面“多人编辑中”）。

---

## 3. 冲突可视化与恢复（概念）

> 在使用 Yjs 这类 CRDT 引擎时，大部分编辑冲突会自动合并，前端更多关注“可视化提示”和“版本恢复”。

### 3.1 冲突场景

- 常见冲突类型：
  - 两人同时编辑同一段文本；
  - 同时对同一块做结构性变更（移动、删除、拆分等）。

### 3.2 可视化提示

- 当发生明显冲突时，前端可选地提供：
  - 高亮新近变更的区域；
  - 将某些变更结果标记为“由某某用户修改”；
  - 在历史版本中标记大版本变更。

### 3.3 与版本历史的配合

- 如果用户对协同合并结果不满意：
  - 可以通过“版本历史”回到某个历史版本（详见历史版本文档）；
  - 或根据历史记录手动对内容进行调整。

> 总体而言，冲突的解决主要由底层同步引擎负责，前端通过光标与选区指示、在线列表、版本历史三部分，让协同状态对用户“可见、可理解、可恢复”。 
