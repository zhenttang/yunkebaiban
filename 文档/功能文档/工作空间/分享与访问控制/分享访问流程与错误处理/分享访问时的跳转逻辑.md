# 分享访问时的跳转逻辑（功能 + 实现说明）

> 关联上级：`工作空间/分享与访问控制/分享访问流程与错误处理.md`  
> 相关代码位置：
> - 顶层分享路由：`packages/frontend/apps/web/src/router.tsx`
> - 分享页面：`packages/frontend/core/src/desktop/pages/workspace/share/share-page.tsx`

---

## 1. 顶层路由层面的重定向逻辑

### 1.1 `/share/:workspaceId/:pageId` → `/workspace/...`

- 在 Web 顶层路由（`router.tsx`）中定义了分享入口路由：

```tsx
{
  path: '/share/:workspaceId/:pageId',
  loader: ({ params }) => {
    return redirect(`/workspace/${params.workspaceId}/${params.pageId}`);
  },
}
```

- 说明：
  - 所有分享链接统一使用 `/share/:workspaceId/:pageId` 形式；
  - loader 收到请求后，直接将用户重定向到对应的 workspace 页面；
  - 查询参数（如 `?mode=...&isTemplate=true`）也可附加到分享链接，在重定向时一并保留。

### 1.2 工作空间未加载的特殊处理

- 在 `workspace/index.tsx` 中有一个 `detailDocRoute` 检测逻辑，用于在某些情况下（如 share-page 独立渲染）识别“正在访问具体页面”：
  - 当 workspace 列表还未加载或指定 workspace 不存在时：
    - 若是分享访问场景，会转而渲染 `SharePage` 组件；
    - 否则显示 `PageNotFound` 或其他错误页面。

---

## 2. SharePage 内部的权限与模式处理

### 2.1 SharePage 的基本职责

`SharePage`（`share-page.tsx`）负责在“分享模式”下渲染文档内容，主要场景包括：

- 公共分享页面；
- 模板预览页面；
- 只读/有限编辑模式下的访问。

它会：

- 创建一个仅用于分享的 workspace 实例（`isSharedMode: true`）；
- 通过云端存储（`CloudDocStorage`、`CloudAwarenessStorage`）加载文档；
- 根据 URL 查询参数决定初始模式（文档/白板）和选中的 block/元素。

### 2.2 权限检查与错误处理

片段示例（简化）：

```ts
// 优先使用 HEAD 请求获取权限信息
const response = await serverService.server.fetch(
  `/api/workspaces/${workspaceId}/docs/${docId}`,
  { method: 'HEAD', headers: { Accept: 'application/octet-stream' } }
);

if (response.status === 404) {
  throw new Error('文档不存在');
} else if (response.status === 403) {
  throw new Error('无权访问文档');
} else if (response.status !== 200) {
  throw new Error(`获取文档权限信息失败: ${response.status}`);
}

const permissionMode = response.headers.get('permission-mode');
```

- 行为说明：
  - 通过请求 `/api/workspaces/:workspaceId/docs/:docId` 的 HEAD/GET 来探测文档是否存在以及权限模式；
  - 404 → 文档不存在；
  - 403 → 无权访问；
  - 非 200/404/403 → 视为异常。

后续根据 `permissionMode` 和用户身份决定：

- 是否允许进入只读模式；
- 是否需要提示错误（例如“没有权限访问此文档”）；
- 是否对某些操作（如编辑）进行禁用。

---

## 3. 登录与重定向（概念）

> 登录重定向逻辑主要在认证模块和路由 guard 中，这里从分享访问的角度说明预期行为。

### 3.1 未登录访问分享链接

- 当用户未登录访问 `/share/:workspaceId/:pageId` 时，通常有两种策略：
  1. 若分享设置为“公开访问”，允许匿名访问：
     - 直接加载 `SharePage`，以匿名用户身份打开；
     - 仅支持只读操作。
  2. 若分享设置为“登录后访问”或“仅成员访问”：
     - 检测到 401/403 响应；
     - 将用户重定向到登录页（如 `/sign-in?redirect_uri=/share/...`）；
     - 登录成功后，根据 `redirect_uri` 回跳到原分享链接。

### 3.2 登录成功后的回跳

- 登录页解析 `redirect_uri`：
  - 成功登录后，使用 `navigate(redirect_uri)` 或服务端重定向回原链接；
  - 继续走 `/share` → `/workspace/...` 或 `SharePage` 的加载流程。

---

## 4. 权限不足与链接过期的处理

### 4.1 权限不足（403）

- 当后端返回 403 时：
  - 如果已登录，说明当前用户没有访问该分享的权限；
  - 前端可以：
    - 显示“无权限访问此页面”的错误提示组件；
    - 提供“返回首页/返回工作空间列表”的按钮；
    - 提示用户联系管理员或文档所有者。

### 4.2 链接过期

- 链接过期可以通过两种方式检测：
  - 后端返回特定错误码或字段（例如 HTTP 410 或自定义错误体）；
  - 或在权限探测 API 中返回标识“link_expired”的状态。

- 前端处理方式：
  - 在 `SharePage` 或工作空间页面中检测该状态；
  - 将用户重定向到 `/expired` 路由：
    - `/expired` 页面负责展示分享链接已过期的说明；
    - 提供返回首页/登录等操作。

---

## 5. 其他错误场景

- 文档不存在（404）：
  - 显示“页面不存在”或 `PageNotFound`；
  - 提供返回工作空间或首页的入口。
- 网络/服务器错误：
  - 显示通用错误提示；
  - 支持“重试加载”按钮。

> 总结：分享访问的跳转逻辑由“顶层路由重定向 + SharePage 内部权限检测 + 认证层重定向”共同构成，确保用户在不同状态下（未登录/无权限/链接过期）都能得到清晰的反馈和合适的下一步操作。 
