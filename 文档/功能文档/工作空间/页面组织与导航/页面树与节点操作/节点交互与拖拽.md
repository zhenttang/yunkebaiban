# 节点交互与拖拽（功能 + 实现说明）

> 关联上级：`工作空间/页面组织与导航/页面树与节点操作.md`  
> 主要代码位置（列表交互相关）：
> - `packages/frontend/core/src/components/page-list/*`
> - `page-header.tsx`、`list.tsx`、`page-group.tsx` 等  
> （页面树本身的节点组件分布在 workspace 导航相关代码中，下文从行为角度说明）

---

## 1. 点击行为

### 1.1 左键点击：打开页面

- 在页面树或列表中，左键点击某个页面节点：
  - 若当前不处于“多选模式”，则直接打开该页面；
  - 对应的路由跳转到 `/workspace/:workspaceId/:pageId` 或其他相应路径（例如集合、标签）。
- 实现要点：
  - 每个列表项/树节点绑定 `onClick` 事件；
  - 根据 `rowAsLink`、`selectable` 等状态决定是“跳转”还是“切换选中状态”：

```ts
to: props.rowAsLink && !props.selectable ? `/tag/${item.id}` : undefined,
onClick: toggleSelection,
```

- 在页面树组件中同样遵循这个模式：在非选择模式下，点击节点以导航为主。

### 1.2 右键或更多菜单：操作项

- 节点通常还会提供：
  - 右键菜单；
  - 或“更多”按钮（如三个点图标）；
- 菜单中包含：
  - 重命名页面；
  - 移动到集合；
  - 删除/移动到回收站；
  - 复制链接、分享等操作。
- 实现要点：
  - 使用通用菜单组件（`Menu` 等）；
  - 通过上下文信息（pageId、workspaceId）调用对应服务 API。

---

## 2. 拖拽行为（排序与层级）

> 页面树中的拖拽逻辑与列表拖拽逻辑类似，都是围绕“拖动某个实体并在目标位置重排”这一模式实现的。

### 2.1 拖拽调整顺序

- 功能：
  - 在同一父级下，通过拖拽改变页面的顺序；
  - 在集合/标签列表中，通过拖拽调整集合/标签顺序（视需求）。
- 常见交互：
  - 按住节点左侧的拖拽柄（DragHandle）或节点主体；
  - 拖动到目标位置，放手后保存新顺序。

### 2.2 拖拽改变层级结构（页面树）

- 功能：
  - 将页面拖入另一个页面下，使其成为子页面；
  - 或从某个父页面下拖出，提升为同级页面。
- 交互示例：
  - 将节点拖到另一个节点上方/下方/内部不同区域，表示不同操作；
  - 悬停时高亮目标位置或目标父节点。

### 2.3 实现模式概览

- 虽然当前代码片段主要展示的是“自定义属性管理”的拖拽逻辑（`WorkspacePropertyManager`），但页面树也采用类似模式：
  - 使用 `useDraggable<YunkeDNDData>` 标记可拖拽元素；
  - 使用 `useDropTarget<YunkeDNDData>` 标记可放置区域；
  - 基于 `closestEdge`、`entity.type`、`from.at` 等字段判断拖拽来源与目标。

示例（属性管理中的拖拽逻辑，页面树可类比）：

```ts
const { dragRef } = useDraggable<YunkeDNDData>(/* ... */);

const { dropTargetRef, closestEdge } = useDropTarget<YunkeDNDData>(
  () => ({
    canDrop(data) {
      return (
        !!canEditPropertyInfo &&
        data.source.data.entity?.type === 'custom-property' &&
        data.source.data.from?.at === 'doc-property:manager' &&
        data.source.data.from?.workspaceId === workspaceService.workspace.id &&
        data.source.data.entity.id !== propertyInfo.id
      );
    },
    closestEdge: {
      allowedEdges: ['top', 'bottom'],
    },
    isSticky: true,
    onDrop(data) {
      // 根据 drop 的位置更新顺序
    },
  }),
  [/* 依赖项 */]
);
```

- 页面树中的拖拽逻辑可以按此模式实现：
  - `entity.type` = `'page'`；
  - `from.at` = `'page-tree'`；
  - `closestEdge` 决定插入到目标节点之前/之后，或变为其子节点。

### 2.4 辅助视觉与 UX

- 在拖拽过程中，通常提供：
  - 高亮目标位置的线条或阴影；
  - 显示禁止放置的指示（无法拖拽到某些节点上方时）；
  - 拖拽时的光标变化。

> 总体来说，页面树的节点交互与拖拽遵循统一的 DnD 模式，具体实现基于 `useDraggable` / `useDropTarget` 封装，对外呈现为“拖动即重排/重组层级”的自然体验。 
