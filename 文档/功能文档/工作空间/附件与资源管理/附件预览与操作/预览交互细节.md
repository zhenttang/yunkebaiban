# 预览交互细节（功能 + 实现说明）

> 关联上级：`工作空间/附件与资源管理/附件预览与操作.md`  
> 相关代码位置：
> - 附件详细页：`packages/frontend/core/src/desktop/pages/workspace/attachment/index.tsx`
> - 附件预览组件：`packages/frontend/core/src/blocksuite/attachment-viewer/*`
> - PDF 预览：`blocksuite/attachment-viewer/pdf/pdf-viewer.tsx`

---

## 1. 预览方式与入口

### 1.1 从页面内预览

- 在文档编辑界面中，点击附件块即可：
  - 在页面内以弹层或侧边面板方式预览附件；
  - 预览组件由 `AttachmentViewerView` 负责，根据附件类型选择具体预览方式。

典型行为：

- 点击图片附件 → 在浮层中展示大图预览；
- 点击 PDF 附件 → 打开内嵌 PDF 阅读器；
- 点击音频附件 → 显示音频播放器；
- 其他文件类型 → 提供下载或“在新标签页打开”选项。

### 1.2 从附件详情路由预览

- 当访问：

  ```txt
  /workspace/:workspaceId/:pageId/attachments/:attachmentId
  ```

  时，会进入附件详情页：

  ```tsx
  if (doc && model) {
    return (
      <FrameworkScope scope={doc.scope}>
        <ViewTitle title={model.props.name} />
        <ViewIcon
          icon={model.props.type.endsWith('pdf') ? 'pdf' : 'attachment'}
        />
        <AttachmentViewerView model={model} />
      </FrameworkScope>
    );
  }
  ```

- 说明：
  - 这里直接使用 `AttachmentViewerView` 完整全屏展示附件；
  - 与页面内预览使用同一套预览逻辑；
  - 上方标题和图标来自附件模型属性。

---

## 2. 不同类型附件的预览行为

### 2.1 PDF 预览

- PDF 预览使用 `PDFViewer`（在 `pdf-viewer.tsx` 中实现），封装了：
  - 页面缩略图列表；
  - 主视图区域；
  - 虚拟滚动加载；
  - 缩放与自适应布局。

部分核心逻辑：

- 视口大小监听：

```tsx
useEffect(() => {
  const viewer = viewerRef.current;
  if (!viewer) return;
  return observeResize(viewer, ({ contentRect: { width, height } }) =>
    setViewportInfo({ width, height })
  );
}, []);
```

- 使用 `Virtuoso` 虚拟列表渲染每一页 PDF：

```tsx
<Virtuoso
  totalCount={meta.pageCount}
  itemContent={pageContent}
  // ...
/>
```

交互细节：

- 支持滚动浏览多页 PDF；
- 支持在缩略图区域点击某页快速跳转；
- 支持放大/缩小适配视口（`fitToPage` 等函数）。

### 2.2 图片预览

- 对于 `image/*` 类型附件：
  - 以 `<img>` 或 canvas 形式展示；
  - 支持缩放/拖拽查看细节；
  - 可能支持双击切换适配模式（视实现）。

### 2.3 音频与视频预览

- 音频附件：
  - 使用音频播放器组件；
  - 提供播放/暂停、音量控制、进度条等；
  - 可以在页面内或弹窗中播放。
- 视频附件：
  - 视实现可能使用 HTML5 `<video>` 或第三方播放器；
  - 同样提供基本播放控制。

### 2.4 其他文件类型

- 对无法内嵌预览的类型（如某些二进制格式）：
  - 显示文件信息（名称、类型、大小）；
  - 提供“下载”按钮；
  - 可选：尝试在新标签页打开（由浏览器决定是否能预览）。

---

## 3. 交互细节与 UX

### 3.1 缩放与滚动（图片/PDF）

- 针对图片和 PDF 等可视内容：
  - 鼠标滚轮 + 修饰键调整缩放；
  - 拖拽平移视图；
  - 双击恢复/适配窗口（视具体实现）。
- PDF 通过 Virtualized 渲染保证在大文档下的性能：
  - 高速滚动时采用占位模式（ScrollSeekPlaceholder）；
  - 低速时加载真实页面。

### 3.2 播放控制（音频/视频）

- 播放器应支持：
  - 播放/暂停；
  - 拖动进度条；
  - 调节音量；
  - 显示当前时间/总时长。
- 多个音频/视频同时存在时：
  - 可以考虑在播放某一个时自动暂停其他（视产品需求）。

### 3.3 跳转回所属页面

- 从附件预览界面，用户可能需要“回到附件所在页面”：
  - 在预览 UI 中提供“打开所在页面”按钮；
  - 根据 `pageId` 跳转到 `/workspace/:workspaceId/:pageId`；
  - 并可选择在页面内高亮目标附件块（视实现）。

---

## 4. 错误处理与兼容性

### 4.1 加载失败

- 对于加载失败的情况（网络/文件损坏）：
  - 显示错误提示（如“文件加载失败，请重试”）；
  - 提供重试按钮；
  - 对 PDF/图片，还可提供“下载原文件”作为兜底方案。

### 4.2 文件大小限制

- 通过 `file-size-limit` 扩展，可对附件大小进行校验：
  - 超过大小的附件在上传阶段就被限制；
  - 或预览时提示无法加载过大的文件。

### 4.3 移动端适配

- 在移动端：
  - 预览控件需要适配触摸手势（双指缩放、滑动）；
  - 保证预览区域在竖屏下仍然可用；
  - 对 PDF/大图片，可考虑简化交互避免卡顿。

> 总体上，附件预览模块通过 `AttachmentViewerView` 对不同类型文件进行了统一封装，结合类型识别、虚拟列表和专用 viewer（如 PDFViewer），同时兼顾了性能和交互体验。 
