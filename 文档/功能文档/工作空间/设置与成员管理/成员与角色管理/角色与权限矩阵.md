# 角色与权限矩阵（功能 + 实现说明）

> 关联上级：`工作空间/设置与成员管理/成员与角色管理.md`  
> 相关代码位置：
> - 权限模块入口：`packages/frontend/core/src/modules/permissions/index.ts`
> - 权限服务：`WorkspacePermissionService`、`GuardService`
> - 权限实体与 store：`entities/permission`、`stores/permission`、`stores/guard`

---

## 1. 角色体系（概念）

### 1.1 常见角色

> 实际角色名称与数量取决于后端与权限实体定义，这里按常见场景描述。

- 所有者（Owner）：
  - 通常是工作空间创建者；
  - 拥有最高权限；
  - 可以删除工作空间、转移所有权、管理套餐等。
- 管理员（Admin）：
  - 管理工作空间成员与权限；
  - 管理工作空间设置（如基础信息、分享策略）；
  - 通常不能删除工作空间本身（视产品设计）。
- 成员（Member）：
  - 可以在工作空间内创建/编辑页面；
  - 根据具体设置决定是否可以分享页面、创建集合等。
- 访客（Guest/Viewer）：
  - 仅能查看部分内容（只读）；
  - 一般不能修改设置或邀请成员。

### 1.2 角色与权限的关系

- 角色本身是权限集合的一种“打包表示”；
- 前端通过 `WorkspacePermissionService` 和 `GuardService` 获取“当前用户在当前 workspace 的权限集合”，而不是直接依赖角色名称；
- 例如：`useGuard('Workspace_Properties_Update')`、`useGuard('Doc_Update', pageId)` 等。

---

## 2. 权限模块结构与 Guard 使用

### 2.1 权限模块配置

权限模块在 `configurePermissionsModule` 中注册：

```ts
export function configurePermissionsModule(framework: Framework) {
  framework
    .scope(WorkspaceScope)
    .service(WorkspacePermissionService, [WorkspaceService, WorkspacesService, WorkspacePermissionStore])
    .store(WorkspacePermissionStore, [WorkspaceServerService, WorkspaceLocalState])
    .entity(WorkspacePermission, [WorkspaceService, WorkspacePermissionStore])
    .service(WorkspaceMembersService, [WorkspaceMembersStore, WorkspaceService])
    // ...
    .service(GuardService, [
      GuardStore,
      WorkspaceService,
      WorkspacePermissionService,
    ])
    .store(GuardStore, [WorkspaceService, WorkspaceServerService]);
}
```

- `WorkspacePermissionService`：
  - 负责从服务器拉取当前 workspace 的权限配置和用户权限；
  - 提供数据给实体 `WorkspacePermission`。
- `GuardService`：
  - 基于当前 workspace 与用户信息提供 Guard 能力；
  - 对外暴露 `useGuard` 等 Hook，用于在组件内判断权限。

### 2.2 `useGuard` 的典型用法

- 在多个地方可以看到对权限的判断，例如历史版本恢复按钮：

```tsx
const canEdit = useGuard('Doc_Update', pageDocId);

<Button
  variant="primary"
  onClick={onConfirmRestore}
  disabled={isMutating || !activeVersion || !canEdit}
>
  {t['com.yunke.history.restore-current-version']()}
</Button>
```

- 说明：
  - `useGuard('Doc_Update', pageDocId)` 判断当前用户是否有更新该文档的权限；
  - 若无权限，则禁用“恢复版本”操作；
  - 具体“Doc_Update”对应什么角色由后端权限配置与 `WorkspacePermission` 决定。

---

## 3. 权限矩阵（示例维度）

> 下表是一个概念性的描述，真实权限矩阵需要结合后端定义。这里重点说明前端如何“用”这些权限，而不是“定义”它们。

### 3.1 典型操作维度

- Workspace 级操作：
  - 更新工作空间基础信息（名称/图标/描述）；
  - 管理成员（邀请/移除）；
  - 修改分享策略和默认权限；
  - 查看/修改工作空间套餐与配额设置。
- Doc 级操作：
  - 创建/删除页面；
  - 编辑页面内容；
  - 配置页面的分享设置；
  - 恢复历史版本。
- 其他模块：
  - 管理集合/标签；
  - 管理 AI 配置（在某些场景下归管理后台）。

### 3.2 前端权限控制方式

- 在组件内使用 `useGuard` 或相关 hook：
  - 控制按钮是否显示/可用；
  - 控制菜单项是否可见；
  - 在页面进入时决定是否重定向/显示无权限提示。

示例：

- 工作空间属性管理：

```tsx
const canEditPropertyInfo = useGuard('Workspace_Properties_Update');

// 属性管理 UI 中根据 canEditPropertyInfo 控制可编辑状态
```

- 分享设置面板中的某些开关：
  - 仅对拥有“分享配置”权限的用户展示；
  - 否则只显示只读信息。

---

## 4. 成员管理界面与权限

> 成员列表和角色管理具体界面由 `WorkspaceMembersService`、`WorkspaceMembersStore` 驱动，这里仅从权限视角说明。

### 4.1 成员列表与角色字段

- 成员列表中通常需要展示：
  - 成员头像、名称、邮箱；
  - 角色（Owner/Admin/Member/Guest 等）；
  - 邀请状态（已加入/待接受等）。

### 4.2 角色修改操作

- 修改角色的操作需受权限保护：
  - 只有 Owner 或具备特定管理权限的角色可以修改其他成员的角色；
  - 在 UI 上：
    - 权限不足的用户不会看到“修改角色”的下拉框或按钮；
    - 或看到但处于禁用状态，并有解释提示。

---

## 5. 与管理后台权限的关系（概念）

- 工作空间权限模块主要关注“某个 workspace 内”的操作；
- 管理后台权限模块（在 `admin` 应用中）则关注：
  - 管理员登录；
  - 系统级配置（AI、监控、全局设置等）。
- 二者协同：
  - 工作空间 Owner 或特定角色可能具备进入管理后台的资格；
  - 具体由后端权限系统决定，前端通过各自的 Guard 进行控制。

> 总体来说，前端不直接硬编码“某个角色能做什么”，而是通过 `WorkspacePermissionService` + `GuardService` 获取权限，再用 `useGuard` 在界面上控制行为，从而保证角色/权限矩阵的灵活性与可配置性。 
