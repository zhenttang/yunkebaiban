# 配额显示与提示（功能 + 实现说明）

> 关联上级：`工作空间/设置与成员管理/高级设置与配额.md`  
> 相关代码位置：
> - 配额模块入口：`packages/frontend/core/src/modules/quota/index.ts`
> - 配额服务：`WorkspaceQuotaService`
> - 配额视图：`QuotaCheck`（`modules/quota/views/quota-check`）
> - 版本历史中的套餐提示：`page-history-modal/PlanPrompt`

---

## 1. 配额模型与数据来源

### 1.1 WorkspaceQuota 模块

- 在 `configureQuotaModule` 中注册了配额相关实体与服务：

```ts
export function configureQuotaModule(framework: Framework) {
  framework
    .scope(WorkspaceScope)
    .service(WorkspaceQuotaService)
    .store(WorkspaceQuotaStore, [WorkspaceServerService])
    .entity(WorkspaceQuota, [WorkspaceService, WorkspaceQuotaStore]);
}
```

- `WorkspaceQuotaService`：
  - 负责从服务器获取当前工作空间的配额信息；
  - 提供 `quota$` 等响应式数据流；
  - 可以调用 `quota.revalidate()` 主动刷新。

### 1.2 配额结构（概念）

- 每个工作空间的配额信息通常包括：
  - 总存储配额（如 5GB / 50GB）；
  - 已用存储量；
  - 可访问的历史版本时间长度（如 7 天 / 30 天）；
  - 当前套餐类型（如 Free、Pro 等）。

在 `page-history-modal` 中，对配额的使用示例：

```tsx
const workspaceQuotaService = useService(WorkspaceQuotaService);
useEffect(() => {
  workspaceQuotaService.quota.revalidate();
}, [workspaceQuotaService]);
const workspaceQuota = useLiveData(workspaceQuotaService.quota.quota$);
const isProWorkspace = useMemo(() => {
  return workspaceQuota && workspaceQuota.humanReadable && workspaceQuota.humanReadable.name
    ? workspaceQuota.humanReadable.name.toLowerCase() !== 'free'
    : null;
}, [workspaceQuota]);
```

---

## 2. 配额显示（UI 层）

### 2.1 配额总览

- 在“高级设置”或类似区域展示配额总览组件（可以由 `QuotaCheck` 或自定义组件承担）：
  - 总容量：例如“总空间 50GB”；
  - 已用：例如“已用 12.3GB（24.6%）”；
  - 剩余：例如“剩余 37.7GB”；
  - 当前套餐：Free / Pro / Enterprise 等。

### 2.2 进度条/百分比显示

- 使用进度条或环形图展示使用比例：
  - 0–80%：使用正常；
  - 80–100%：显示警告色（橙色）；
  - ≥100%：显示错误色（红色），并提示超出。

UI 建议：

- 在工作空间设置中单独放一块“存储与配额”区域；
- 同时在某些关键页面（如上传附件时）以轻量提示形式展示当前使用情况。

---

## 3. 提示策略与限制行为

### 3.1 接近配额时的提示

- 阈值设计：
  - 当已用容量达到 80% 时开始提示；
  - 可在顶部或相关操作处显示“接近配额上限”的 banner。

提示内容示例：

- “当前工作空间存储已使用 80%，请注意清理或升级套餐。”

### 3.2 超过配额时的行为

- 当已用容量超过配额时，应限制部分操作，例如：
  - 禁止上传新附件或导入大文件；
  - 禁止创建新文档（或给出明显警告）；
  - 允许删除和导出，以便用户清理空间。

界面行为：

- 在相关操作按钮上显示禁用状态 + tooltip 说明原因；
- 在设置页面/配额视图中突出显示“已超过上限”状态。

### 3.3 引导升级或清理

- 升级引导：
  - 在提示中提供“升级套餐”按钮；
  - 点击后跳转到管理后台/设置中的 plans 页面；
  - 埋点记录用户行为（如 `track.$.docHistory.$.viewPlans()` 类似用法）。

- 清理引导：
  - 提供“清理空间”入口；
  - 跳转到附件列表或大文件列表，协助用户删除不需要的内容。

---

## 4. 与历史版本和分享的联动

### 4.1 历史版本可用时间

- 在 `page-history-modal` 中，配额信息决定可访问的历史版本时间范围：
  - Free：例如仅支持 7 天内的版本；
  - Pro：例如支持 30 天或更长时间。

`PlanPrompt` 中的文案示例（翻译后）：

- Free 版：所有成员可访问最多 7 天历史；
- Pro 版：可访问最多 30 天历史。

### 4.2 与分享/云端功能的关系

- 某些高级分享功能（如公开分享、长期链接）可能只对高等级套餐开放；
- 当前工作空间的配额信息可用于控制 ShareMenu 中的可选项：
  - Free 工作空间：只显示基本分享选项；
  - Pro 工作空间：解锁高级设置（过期时间、密码、更多访问级别）。

---

## 5. 实现建议与扩展（占位）

> 现有代码已具备 WorkspaceQuotaService 和基础配额实体，后续可扩展的方向包括：

- 在工作空间设置界面增加“配额详情”卡片，统一显示配额与套餐信息；
- 在上传/导入等关键操作处，通过 `QuotaCheck` 做前置校验，避免操作失败后才提示；
- 在管理后台提供整个组织/团队层面的配额视图，与单个工作空间的配额信息形成补充。 
