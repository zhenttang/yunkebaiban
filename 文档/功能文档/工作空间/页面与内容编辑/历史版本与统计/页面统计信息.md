# 页面统计信息（功能 + 实现说明）

> 关联上级：`工作空间/页面与内容编辑/历史版本与统计.md`  
> 相关代码位置（统计与展示）：
> - 文档历史：`page-history-modal`（间接反映编辑次数与参与者）
> - 文档元信息与展示：`DocDisplayMetaService`、`display-meta` 扩展
> - 文档统计组件：`packages/frontend/core/src/components/document-stats/*`（如存在）

当前仓库中，页面统计信息更多通过“版本历史”和“Doc 元信息”体现，以下描述的是功能目标和实现方向，部分属于设计约定。

---

## 1. 浏览与编辑统计（概念设计）

### 1.1 功能目标

- 对每个页面记录：
  - 浏览次数（view count）；
  - 编辑次数或编辑时长；
  - 最近浏览时间与最近编辑时间；
- 在合适位置展示这些信息，如：
  - 页面右上角或属性面板；
  - 文档统计弹窗。

### 1.2 数据来源与记录方式（设计）

- 浏览统计：
  - 用户进入某页面时，在前端触发“页面查看”事件；
  - 通过接口或埋点记录一次浏览；
  - 服务端汇总每个页面的浏览次数与最近浏览时间。
- 编辑统计：
  - 每次编辑完成时（例如退出编辑态或定期），记录一次编辑事件；
  - 或基于版本历史（历史版本数量）估算编辑次数；
  - 编辑时长可以通过前端定时上报或后端计算。

> 在当前代码片段中，这类统计逻辑主要体现在埋点与历史记录上：  
> - 如 `track.$.docHistory.$.switchPageMode`、`track.$.docHistory.$.viewPlans` 等埋点；  
> - 以及 `useDocSnapshotList` 记录版本快照。

### 1.3 展示方式（建议）

- 页面头部属性面板中展示：
  - “浏览次数：X 次”；
  - “编辑次数：Y 次”；
  - “最近编辑：2025-01-01 12:00”；
- 在“页面详情/统计”弹窗中展示更完整的信息：
  - 访问趋势图；
  - 编辑活跃度统计等（视需求）。

---

## 2. 参与人员与最近编辑者

### 2.1 功能目标

- 展示一个页面历史上“参与编辑过的人员”；
- 突出显示“最近编辑者”和“页面创建者”；
- 可选：展示每个人的编辑次数或贡献度（视隐私与实现）。

### 2.2 现有实现线索

- 在版本历史列表中，每条历史记录都包含编辑者信息：

```tsx
<Avatar
  className={styles.historyItemAvatar}
  url={history.editor?.avatarUrl ?? ''}
  name={history.editor?.name ?? ''}
  size={22}
/>
<span className={styles.historyItemName}>
  {history.editor?.name ?? t['unnamed']()}
</span>
```

- 可通过聚合版本历史数据得出：
  - 所有参与编辑过的用户列表；
  - 某用户编辑次数（出现次数）；
  - 最近编辑者（历史记录中的最新编辑者）。

### 2.3 展示方式（建议）

- 在页面属性面板中增加“参与者”区域：
  - 显示若干头像（最多 N 个）；
  - 鼠标悬停展示具体姓名；
  - 点击可跳转到更详细的“参与者列表”或用户主页。
- 最近编辑者：
  - 在页面顶部显示：“最近编辑：某某，时间 XXXX-XX-XX XX:XX”；
  - 信息来源于最新的历史记录。

---

## 3. 与版本历史、权限和套餐的关系

- 版本历史对统计的影响：
  - 历史记录数量在某种程度上反映编辑频率；
  - Free/Pro 计划对可见历史范围有不同限制（如 7 天 vs 30 天），相应会影响统计的时间窗口；
  - 在统计设计时，需要明确“统计周期”和“统计范围”（例如仅统计可见历史内的数据）。

- 权限的影响：
  - 无访问某页面权限的用户不能参与统计；
  - 无权查看历史版本的用户也不应看到详细编辑记录；
  - 但可以展示高层摘要（如“最近编辑时间”，不暴露用户详情）。

- 隐私与合规：
  - 在展示“谁编辑过什么内容”时需考虑隐私；
  - 对于自建部署环境，可以通过管理后台配置是否开启详细统计展示。

---

## 4. 后续实现方向（占位）

> 当前代码库主要实现了“版本历史”这一维度的跟踪，页面统计信息模块可以在此基础上演进。

后续可以考虑：

- 在 `DocDisplayMetaService` 或相关服务中增加统计字段（viewCount、lastViewedAt 等）；
- 在 `components/document-stats`（如果存在）中实现统一的统计展示组件；
- 与埋点系统（`@yunke/track`）联动，从前端行为日志中计算高维度统计；
- 在管理后台增加“统计可见性”和“数据保留周期”的配置项。 
