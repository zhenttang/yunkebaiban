# 页面路由规则（功能 + 实现说明）

> 关联上级：`工作空间/页面与内容编辑/页面类型与路由.md`  
> 主要代码位置：
> - 顶层路由：`packages/frontend/apps/web/src/router.tsx`
> - 工作空间容器：`packages/frontend/core/src/desktop/pages/workspace/index.tsx`
> - 工作空间内部路由：`packages/frontend/core/src/desktop/workbench-router.ts`

---

## 1. 路由层级结构概览

### 1.1 顶层：`/workspace/:workspaceId/*`

- 在 Web 应用路由中，工作空间部分通过如下配置接管：

```tsx
{
  path: '/workspace/:workspaceId/*',
  lazy: () => import('@yunke/core/desktop/pages/workspace/index'),
}
```

- 说明：
  - 顶层只负责识别 `workspaceId` 并加载 `workspace/index.tsx`；
  - 真正的“页面级路由”由 `workbenchRoutes` 在工作空间内部继续划分。

### 1.2 工作空间内部：`workbenchRoutes`

- 代码位置：`packages/frontend/core/src/desktop/workbench-router.ts`
- 核心配置（节选）：

```ts
export const workbenchRoutes = [
  { path: '/all', lazy: () => import('./pages/workspace/all-page/all-page') },
  { path: '/collection', lazy: () => import('./pages/workspace/all-collection') },
  { path: '/collection/:collectionId', lazy: () => import('./pages/workspace/collection/index') },
  { path: '/tag', lazy: () => import('./pages/workspace/all-tag') },
  { path: '/tag/:tagId', lazy: () => import('./pages/workspace/tag') },
  { path: '/community', lazy: () => import('./pages/workspace/community') },
  { path: '/community/:docId', lazy: () => import('./pages/workspace/community/doc-detail') },
  { path: '/forum', lazy: () => import('./pages/workspace/forum/forum-home') },
  { path: '/forum/:forumId', lazy: () => import('./pages/workspace/forum/forum-detail') },
  { path: '/forum/:forumId/post/:postId', lazy: () => import('./pages/workspace/forum/post-detail') },
  { path: '/trash', lazy: () => import('./pages/workspace/trash-page') },
  { path: '/:pageId', lazy: () => import('./pages/workspace/detail-page/detail-page') },
  { path: '/:pageId/attachments/:attachmentId', lazy: () => import('./pages/workspace/attachment/index') },
  { path: '/journals', lazy: () => import('./pages/journals') },
  { path: '/settings', lazy: () => import('./pages/workspace/settings') },
  { path: '*', lazy: () => import('./pages/404') },
] satisfies RouteObject[];
```

- 这些 `path` 会自动挂到 `/workspace/:workspaceId` 后面，例如：
  - `/workspace/:workspaceId/all`
  - `/workspace/:workspaceId/:pageId`
  - `/workspace/:workspaceId/forum/:forumId/post/:postId`

---

## 2. 页面级路由规则（文档/白板/数据库等）

### 2.1 通用页面路由：`/:pageId`

- 对应配置：

```ts
{
  path: '/:pageId',
  lazy: () => import('./pages/workspace/detail-page/detail-page'),
}
```

- 规则：
  - 在某个工作空间下，如果路径为 `/workspace/:workspaceId/xxx`，且 `xxx` 不与前面显式声明的前缀（如 `/all`、`/tag` 等）匹配，则会被当作 `pageId`；
  - `detail-page` 组件会根据 `pageId` 加载对应的文档/白板/数据库页面。

### 2.2 附件视图路由：`/:pageId/attachments/:attachmentId`

- 对应配置：

```ts
{
  path: '/:pageId/attachments/:attachmentId',
  lazy: () => import('./pages/workspace/attachment/index'),
}
```

- 规则：
  - 在文档详情页中点击某个附件，可以跳转到：
    - `/workspace/:workspaceId/:pageId/attachments/:attachmentId`
  - 该页面以附件内容为主，通常仍会展示与原页面的关系（如“返回原页面”的入口）。

---

## 3. 特殊页面与列表路由

### 3.1 全局列表类

- 全部页面列表：
  - 路由：`/workspace/:workspaceId/all`
  - 用于展示当前工作空间的所有页面列表。
- 集合相关：
  - `/workspace/:workspaceId/collection`：全部集合列表；
  - `/workspace/:workspaceId/collection/:collectionId`：单个集合视图。
- 标签相关：
  - `/workspace/:workspaceId/tag`：全部标签列表；
  - `/workspace/:workspaceId/tag/:tagId`：某标签下页面列表。

### 3.2 社区与论坛

- 社区：
  - `/workspace/:workspaceId/community`：社区列表/入口；
  - `/workspace/:workspaceId/community/:docId`：社区中文档详情。
- 论坛：
  - `/workspace/:workspaceId/forum`：论坛首页（在工作空间内部）；
  - `/workspace/:workspaceId/forum/:forumId`：板块详情；
  - `/workspace/:workspaceId/forum/:forumId/post/:postId`：帖子详情。

> 注意：论坛还有一套 `/forum/*` 顶层路由（在 Web 级路由中），用于更“全局”的论坛访问，上面这些是挂在具体 workspace 下的视图。

### 3.3 其他特殊页面

- 回收站：
  - `/workspace/:workspaceId/trash`
- 日志/日记：
  - `/workspace/:workspaceId/journals`
- 工作空间设置：
  - `/workspace/:workspaceId/settings`

---

## 4. 分享路由与只读访问

### 4.1 顶层分享路由：`/share/:workspaceId/:pageId`

- 在 Web 应用的顶层路由（`router.tsx`）中：

```tsx
{
  path: '/share/:workspaceId/:pageId',
  loader: ({ params }) => {
    return redirect(`/workspace/${params.workspaceId}/${params.pageId}`);
  },
}
```

- 说明：
  - 分享链接统一使用 `/share/...` 形式；
  - 前端收到分享链接后，直接重定向到对应的 workspace/page；
  - 真正的访问控制（只读/可编辑）由后端权限 + 页面属性决定。

### 4.2 工作空间级分享处理

- 当访问 `/workspace/:workspaceId/:pageId` 时：
  - 如果用户是正常成员，进入编辑/协作模式；
  - 如果通过分享链接且权限为只读，前端可根据返回的信息：
    - 禁用编辑操作；
    - 显示“只读模式”提示。

> 具体的权限判断逻辑在数据层/接口层和 Guard 组件中，这里不展开。

---

## 5. 文档详情路由的特殊检测逻辑

### 5.1 `detailDocRoute` 的匹配

- 在 `workspace/index.tsx` 中，有一段逻辑用于判断当前路径是否为“文档详情路由”（在工作空间未找到时用于分享页）：

```ts
const detailDocRoute = useMemo(() => {
  // 如果已经匹配到社区路由，则不再检查文档详情路由
  if (communityRoute) {
    return null;
  }
  
  const match = matchPath(
    '/workspace/:workspaceId/:docId',
    location.pathname
  );

  if (
    match &&
    match.params.docId &&
    match.params.workspaceId &&
    workbenchRoutes.find(route =>
      matchPath(route.path, '/' + match.params.docId)
    )?.path === '/:pageId'
  ) {
    return {
      docId: match.params.docId,
      workspaceId: match.params.workspaceId,
    };
  } else {
    return null;
  }
}, [location.pathname, communityRoute]);
```

- 说明：
  - 通过 `matchPath('/workspace/:workspaceId/:docId', ...)` 检测当前 URL；
  - 然后用 `workbenchRoutes` 再确认 `docId` 是否符合 `/:pageId` 这种页面路由；
  - 目的是在 workspace 未加载成功时，仍然识别出“这是访问某个页面”的场景，用于渲染分享页等。

### 5.2 workspace 未找到时的处理

- 在 `workspaceNotFound` 为 true 时：
  - 若匹配社区路由 → 渲染 `StandaloneCommunityPage`；
  - 若匹配 `detailDocRoute` → 渲染 `SharePage`；
  - 否则 → 渲染带“无权限/未找到”提示的 404（`PageNotFound noPermission`）。

---

## 6. 查询参数与模式切换（占位）

目前在代码中，工作空间内的视图切换（例如数据库视图、不同布局）主要由页面内部状态和 Block 数据决定。  
