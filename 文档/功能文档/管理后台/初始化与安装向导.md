# 初始化与安装向导（功能 + 实现说明）

> 关联上级：`文档/功能文档/admin.md`  
> 主要代码位置：
> - 向导入口页面：`packages/frontend/admin/src/modules/setup/index.tsx`（`Setup`）
> - 表单与步骤逻辑：`modules/setup/form.tsx`
> - 创建管理员表单：`modules/setup/create-admin.tsx`
> - 服务器配置 Hook：`modules/common` 中的 `useServerConfig` / `useRevalidateServerConfig`

---

## 1. 入口与触发条件

### 1.1 路由入口 `/admin/setup`

- `Setup` 组件：

```tsx
export function Setup() {
  const config = useServerConfig();

  if (config.initialized) {
    return <Navigate to=\"/admin\" />;
  }

  return (
    <div className=\"w-full lg:grid lg:grid-cols-2 h-screen\">
      <div className=\"flex items-center justify-center py-12 h-full\">
        <Form />
      </div>
      <div className=\"hidden lg:block relative overflow-hidden \">
        <img
          src={logo}
          alt=\"Image\"
          className=\"absolute object-right-bottom bottom-0 right-0 h-3/4\"
        />
      </div>
    </div>
  );
}

export { Setup as Component };
```

- 行为：
  - 使用 `useServerConfig()` 拉取服务器当前配置；
  - 如果 `config.initialized === true`，说明系统已初始化，直接重定向到 `/admin`；
  - 否则展示安装向导表单 `Form`；
  - 右侧展示品牌 Logo 图（仅在大屏幕上显示）。

### 1.2 从 `/admin` 自动重定向（逻辑说明）

- 在管理后台入口路由中（不在本文件片段），如果检测到服务器未初始化，访问 `/admin` 会被重定向到 `/admin/setup`；
- 整体逻辑：
  - 未初始化 → 必须先完成 `Setup`；
  - 初始化后 → `/admin/setup` 将自动跳回 `/admin`，避免重复执行安装流程。

---

## 2. 安装步骤与页面流程

安装向导通过轮播（Carousel）实现多步骤体验，相关代码在 `Form` 组件中。

### 2.1 步骤定义与组件

```ts
export enum CarouselSteps {
  Welcome = 0,
  CreateAdmin,
  SettingsDone,
}

const Welcome = () => {
  return (
    <div className=\"flex flex-col h-full w-full mt-60 max-lg:items-center max-lg:mt-16\" style={{ minHeight: '300px' }}>
      <h1 className=\"text-5xl font-extrabold max-lg:text-3xl max-lg:font-bold\">欢迎使用 YUNKE</h1>
      <p className=\"mt-5 font-semibold text-xl max-lg:px-4 max-lg:text-lg\">
        通过几个简单的设置配置您的自托管 YUNKE。
      </p>
    </div>
  );
};

const SettingsDone = () => {
  return (
    <div className=\"flex flex-col h-full w-full mt-60 max-lg:items-center max-lg:mt-16\" style={{ minHeight: '300px' }}>
      <h1 className=\"text-5xl font-extrabold max-lg:text-3xl max-lg:font-bold\">所有设置已完成</h1>
      <p className=\"mt-5 font-semibold text-xl max-lg:px-4 max-lg:text-lg\">YUNKE 已准备就绪。</p>
    </div>
  );
};
```

- 步骤说明：
  1. Welcome：欢迎页，简单介绍安装向导；
  2. CreateAdmin：创建管理员账号；
  3. SettingsDone：安装完成提示页。

### 2.2 Carousel 与步骤控制

- `Form` 组件中使用 `Carousel` 控件管理步骤：

```tsx
export const Form = () => {
  const [api, setApi] = useState<CarouselApi>();
  const [current, setCurrent] = useState(0);
  const [count, setCount] = useState(0);

  useEffect(() => {
    if (!api) return;
    setCount(api.scrollSnapList().length);
    setCurrent(api.selectedScrollSnap() + 1);
    api.on('select', () => {
      setCurrent(api.selectedScrollSnap() + 1);
    });
  }, [api, serverConfig.initialized, navigate]);

  // ...
};
```

- 底部用进度条表示当前步骤：

```tsx
{Array.from({ length: count }).map((_, index) => (
  <span
    key={index}
    className={`inline-block w-16 h-1 rounded mr-1 ${
      index <= current - 1 ? 'bg-primary' : 'bg-muted-foreground opacity-20'
    }`}
  />
))}
```

---

## 3. 创建管理员账户步骤

### 3.1 输入字段与校验状态

- 在 `Form` 中维护管理员信息状态：

```ts
const [nameValue, setNameValue] = useState('');
const [emailValue, setEmailValue] = useState('');
const [passwordValue, setPasswordValue] = useState('');
const [invalidEmail, setInvalidEmail] = useState(false);
const [invalidPassword, setInvalidPassword] = useState(false);

const serverConfig = useServerConfig();
const refreshServerConfig = useRevalidateServerConfig();
const passwordLimits = serverConfig.credentialsRequirement.password;

const isCreateAdminStep = current - 1 === CarouselSteps.CreateAdmin;

const disableContinue =
  (!nameValue || !emailValue || !passwordValue) && isCreateAdminStep;
```

- 字段：
  - `nameValue`：姓名；
  - `emailValue`：邮箱；
  - `passwordValue`：密码；
  - `invalidEmail` / `invalidPassword`：错误状态标记。
- 密码规则：
  - 来自 `serverConfig.credentialsRequirement.password`，包含最小/最大长度等；
  - 在 UI 中提示密码长度和复杂度要求。

### 3.2 CreateAdmin 表单组件

`CreateAdmin` 负责渲染具体输入界面：

```tsx
export const CreateAdmin = ({
  name,
  email,
  password,
  invalidEmail,
  invalidPassword,
  passwordLimits,
  onNameChange,
  onEmailChange,
  onPasswordChange,
}: CreateAdminProps) => {
  // 输入事件处理略
  return (
    <div className="flex flex-col h-full w-full mt-24 max-lg:items-center max-lg:mt-16 max-md:mt-5 lg:pl-0">
      <div className="flex flex-col pl-1 max-lg:p-4 max-w-96 mb-5">
        <div className="flex flex-col mb-16 max-sm:mb-6">
          <h1 className="text-lg font-semibold">创建管理员账户</h1>
          <p className="text-sm text-muted-foreground">
            此账户也可用于以YUNKE用户身份登录。
          </p>
        </div>
        {/* 姓名、邮箱、密码输入以及错误提示 */}
      </div>
    </div>
  );
};
```

### 3.3 提交创建管理员请求

- `Form` 中的 `createAdmin` 实现：

```ts
const createAdmin = useCallback(async () => {
  try {
    const createResponse = await yunkeFetch('/api/setup/create-admin-user', {
      method: 'POST',
      body: JSON.stringify({ email: emailValue, password: passwordValue }),
      headers: { 'Content-Type': 'application/json' },
    });

    if (!createResponse.ok) {
      const errorData = await createResponse.json();
      throw new Error(errorData.message || '创建管理员失败');
    }

    await createResponse.json();
    await refreshServerConfig();
    toast.success('管理员账户创建成功。');
  } catch (err) {
    toast.error((err as Error).message);
    console.error(err);
    throw err;
  }
}, [emailValue, passwordValue, refreshServerConfig]);
```

- 行为：
  - 调用 `/api/setup/create-admin-user` 创建管理员用户；
  - 若返回非 2xx，从响应 JSON 解析错误信息并提示；
  - 成功后刷新服务器配置 `refreshServerConfig`，并弹出成功 toast 提示。

### 3.4 下一步逻辑与验证

- “下一步”按钮逻辑（在 `onNext` 中）：
  - 当前步骤为 `CreateAdmin` 时：
    - 先使用 `validateEmailAndPassword` 进行前端格式校验；
    - 校验失败时设置 `invalidEmail/invalidPassword`，阻止继续；
    - 校验通过后调用 `createAdmin`；
  - 创建成功后将 Carousel 进度推进到 `SettingsDone` 步骤。

---

## 4. 完成与跳转

### 4.1 设置完成页面

- `SettingsDone` 步骤展示“所有设置已完成 / YUNKE 已准备就绪”的提示；
- 可选设计：
  - 在页面提供“进入管理后台”按钮；
  - 或通过超时自动跳转到 `/admin`。

### 4.2 初始化标记与重定向

- 成功创建管理员后，后端通常会：
  - 标记服务器配置中的 `initialized = true`；
  - 后续 `useServerConfig()` 获取到的 `initialized` 即为 true；
- 之后：
  - 访问 `/admin/setup` → 立即重定向到 `/admin`；
  - 访问 `/admin` 时不再被强制引导至安装向导。

> 整个初始化与安装向导的目标，是在首次部署时以最简流程引导管理员完成关键步骤（当前主要是“创建管理员账号”），之后所有配置改动都通过管理后台其他模块（设置、AI 配置、监控等）进行。 
