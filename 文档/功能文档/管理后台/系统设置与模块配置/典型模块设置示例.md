# 典型模块设置示例（功能 + 实现说明）

> 关联上级：`管理后台/系统设置与模块配置.md`  
> 相关代码位置：
> - 配置分组：`packages/frontend/admin/src/modules/settings/config.ts`
> - 配置数据：`packages/frontend/admin/src/modules/settings/use-app-config.ts`

---

## 1. 存储与文件设置（storages 模块）

### 1.1 模块职责概览

- 统一管理系统中“文件存储”相关配置，包括：
  - 普通文件（文档附件、资源等）的存储；
  - 用户头像的存储；
  - 存储提供商选择（本地文件系统、S3 兼容存储、R2、COS 等）；
  - 存储桶（bucket）名称与额外配置（如 SDK 连接参数）。

### 1.2 配置字段定义

在 `config.ts` 中，`storages` 模块的配置字段定义如下（精简版）：

```ts
{
  name: '存储服务',
  module: 'storages',
  fields: [
    {
      key: 'blob.storage',
      desc: '用户上传文件的存储提供商',
      sub: 'provider',
      type: 'Enum',
      options: ['fs', 'aws-s3', 'cloudflare-r2', 'tencent-cos'],
    },
    {
      key: 'blob.storage',
      sub: 'bucket',
      type: 'String',
      desc: '用户上传文件存储的桶名称',
    },
    {
      key: 'blob.storage',
      sub: 'config',
      type: 'JSON',
      desc: '直接传递给存储提供商的配置（例如aws-sdk）',
    },
    {
      key: 'avatar.storage',
      desc: '用户头像的存储提供商',
      sub: 'provider',
      type: 'Enum',
      options: ['fs', 'aws-s3', 'cloudflare-r2', 'tencent-cos'],
    },
    {
      key: 'avatar.storage',
      sub: 'bucket',
      type: 'String',
      desc: '用户头像存储的桶名称',
    },
    {
      key: 'avatar.storage',
      sub: 'config',
      type: 'JSON',
      desc: '直接传递给存储提供商的配置（例如aws-sdk）',
    },
  ],
  operations: [StorageConfigOperation],
}
```

- 功能说明：
  - 对于 `blob.storage` 和 `avatar.storage`：
    - `provider`：选择存储实现（本地 `fs` 或各类云存储），由 Enum 下拉框提供；
    - `bucket`：具体存储桶名称；
    - `config`：JSON 形式的额外配置（如 endpoint、region、密钥等），直接传给对应 SDK。
  - 通过这种拆分：
    - 管理员可以在同一界面配置多个存储场景；
    - JSON 字段保持足够灵活，支持不同平台的自定义选项。

### 1.3 快捷操作：StorageConfigOperation

- `storages` 模块定义了一个快捷操作组件 `StorageConfigOperation`：
  - 在设置页面底部“快捷操作”区域以卡片形式展示；
  - 接收当前的 `patchedAppConfig`，可以读取最新的存储配置；
  - 通常用于：
    - 检测当前存储配置是否可用（连通性测试）；
    - 自动创建或验证存储桶；
    - 给出配置错误的友好提示。

> 通过“字段配置 + 快捷操作”的组合，存储设置不仅支持多种存储后端，还提供了可视化的验证和运维手段。

---

## 2. 邮件与通知设置（mailer 模块）

### 2.1 模块职责概览

- 负责系统中所有“邮件发送”相关配置，例如：
  - SMTP 服务器地址与端口；
  - 认证账号与密码；
  - 默认发件人邮箱地址；
  - TLS/SSL 相关选项。

### 2.2 配置字段定义

在 `config.ts` 中，`mailer` 模块的字段定义如下（精简版）：

```ts
{
  name: '通知服务',
  module: 'mailer',
  fields: [
    'SMTP.host',
    'SMTP.port',
    'SMTP.username',
    'SMTP.password',
    'SMTP.ignoreTLS',
    'SMTP.sender',
  ],
  operations: [SendTestEmail],
}
```

- 常见字段说明：
  - `SMTP.host`：SMTP 服务器地址；
  - `SMTP.port`：服务器端口（常见如 587/465 等）；
  - `SMTP.username` / `SMTP.password`：认证用账号、密码或 token；
  - `SMTP.ignoreTLS`：是否忽略 TLS 校验（一般仅用于调试）；
  - `SMTP.sender`：系统发出邮件时使用的默认发件人地址。

- 在实际 UI 中，这些字段会按类型自动渲染为：
  - 文本输入框（host、username、sender）；
  - 数字输入框（port）；
  - 密码输入框（password）；
  - 开关控件（ignoreTLS）。

### 2.3 快捷操作：SendTestEmail

- `SendTestEmail` 是一个典型的快捷操作组件，用于验证当前邮件配置是否正确：
  - 渲染在配置字段下方“快捷操作”区域；
  - 内部会读取当前 `patchedAppConfig.mailer` 配置；
  - 发起“测试邮件”请求（通常需要后端接口支持）；
  - 在界面上展示发送结果（成功/失败原因）。

> 这种“配置 + 测试”的模式可以有效降低配置错误导致的邮件投递失败风险，尤其适合上线前的环境联调。

---

## 3. 认证与安全设置（auth 模块）

### 3.1 模块职责概览

- 负责用户登录、注册与密码安全相关配置，例如：
  - 是否允许用户自助注册账号；
  - 密码复杂度与长度要求；
  - 会话有效期与刷新策略等。

### 3.2 配置字段定义

在 `KNOWN_CONFIG_GROUPS` 中对 `auth` 模块进行了显式配置：

```ts
{
  name: '认证授权',
  module: 'auth',
  fields: [
    'allowSignup',
    {
      key: 'passwordRequirements',
      sub: 'min',
      type: 'Number',
      desc: '密码最小长度要求',
    },
    {
      key: 'passwordRequirements',
      sub: 'max',
      type: 'Number',
      desc: '密码最大长度要求',
    },
  ],
}
```

- 功能说明：
  - `allowSignup`：
    - 控制是否开放自助注册入口；
    - 在 UI 中通常为一个开关控件；
  - `passwordRequirements.min/max`：
    - 将原本嵌套在 `passwordRequirements` 对象中的字段展开为两个独立的数字配置；
    - 在 UI 中分别渲染为“最小长度”“最大长度”输入框；
    - 通过前端校验与后端共用，提升密码安全性。

- 在 `mockAppConfig` 中，还预填了与会话相关的配置（例如 `session.ttl` 等），方便后续继续扩展：
  - 可以通过 `UNKNOWN_CONFIG_GROUPS` 自动展示；
  - 或者在 `KNOWN_CONFIG_GROUPS` 中补充字段定义，使其拥有更友好的说明。

---

## 4. 人工智能设置（copilot 模块）

### 4.1 模块职责概览

- 控制“AI Copilot”相关能力，包括：
  - 是否启用 AI 功能；
  - 不同模型供应商的接入配置（OpenAI、DeepSeek、Gemini 等）；
  - AI 文件存储的配置（与 `storages` 类似）。

### 4.2 配置字段定义（概览）

在 `config.ts` 中，`copilot` 模块字段定义（精简）：

```ts
{
  name: '人工智能',
  module: 'copilot',
  fields: [
    'enabled',
    'providers.openai',
    'providers.deepseek',
    'providers.gemini',
    'providers.perplexity',
    'providers.anthropic',
    'providers.fal',
    'unsplash',
    'exa',
    {
      key: 'storage',
      desc: 'AI助手文件的存储提供商',
      sub: 'provider',
      type: 'Enum',
      options: ['fs', 'aws-s3', 'cloudflare-r2', 'tencent-cos'],
    },
    {
      key: 'storage',
      sub: 'bucket',
      type: 'String',
      desc: 'AI助手文件存储的桶名称',
    },
    {
      key: 'storage',
      sub: 'config',
      type: 'JSON',
      desc: '直接传递给存储提供商的配置（例如aws-sdk）',
    },
  ],
}
```

- 功能说明：
  - `enabled`：
    - 控制整个 AI Copilot 能力是否启用；
    - 在 UI 中为一个全局开关；
  - `providers.*`：
    - 各种第三方 AI 服务的配置；
    - 具体字段结构由后端 `config.json` 定义，前端通常以 JSON 编辑方式展示，或者在后续进一步拆分。
  - `storage.*`：
    - AI 生成内容、临时文件等的存储配置；
    - 与 `storages` 模块保持一致的 provider/bucket/config 结构。

> 通过将 AI 配置与其他系统配置统一在一个设置中心，管理员可以在同一入口完成“开关设置、模型接入、存储配置”等操作，为后续的 AI 功能（文档助手、白板 Copilot 等）提供统一的基础设施。

---

总体来看，这几个“典型模块设置示例”展示了系统设置中心的典型用法模式：

- 使用 `ConfigGroup` 将后端配置模块抽象为“可视化模块”；
- 使用 `fields` 将复杂的嵌套配置拆分为多个独立字段；
- 使用 `operations` 为重要模块提供一键验证和运维动作；
- 通过统一的渲染和保存逻辑，让不同模块的配置体验保持一致。 

