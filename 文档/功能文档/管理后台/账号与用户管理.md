# 账号与用户管理（功能 + 实现说明）

> 关联上级：`文档/功能文档/admin.md`  
> 主要代码位置：
> - 页面入口：`packages/frontend/admin/src/modules/accounts/index.tsx`
> - 列表与表格组件：`packages/frontend/admin/src/modules/accounts/components/*`
> - 用户数据与请求：`use-user-list-simple.ts`、`user-actions.ts`、`schema.ts`

---

## 1. 用户列表（/admin/accounts）

### 1.1 页面结构与数据流

- 路由 `/admin/accounts` 对应 `AccountPage` 组件：

```tsx
function AccountPage() {
  const currentUser = useCurrentUser();
  const {
    users,
    pagination,
    setPagination,
    usersCount,
    filters,
    searchUsers,
    filterByStatus,
    clearFilters,
    refreshUsers,
    loading,
    hasNext,
    hasPrevious,
    error,
  } = useUserList();

  const [memoUsers, setMemoUsers] = useState<UserType[]>([]);
  const [selectedUserIds, setSelectedUserIds] = useState<Set<string>>(new Set<string>());

  const columns = useColumns({
    setSelectedUserIds,
    refreshUsers,
  });

  const selectedUsers = useMemo(
    () => memoUsers.filter(user => selectedUserIds.has(user.id)),
    [selectedUserIds, memoUsers]
  );
  // ...
}
```

- 数据流说明：
  - `useUserList()`（`use-user-list-simple.ts`）负责向后台 `/api/admin/users` 请求用户数据，处理分页、过滤、加载状态、错误等；
  - `DataTable` 组件负责渲染 `users` 列表，展示分页信息和操作按钮；
  - `useColumns` 定义表格列结构和行级操作（编辑、启用/禁用、重置密码等）；
  - `memoUsers + selectedUserIds` 用于跨页记住多选状态，以支持批量操作。

### 1.2 顶部信息与加载指示

- 头部组件 `Header` 显示标题和用户总数：

```tsx
<Header 
  title="账户管理" 
  endFix={
    <div className="flex items-center gap-2">
      <span className="text-sm text-gray-500">
        共 {usersCount} 个用户
      </span>
      {loading && <div className="w-4 h-4 ... animate-spin"></div>}
    </div>
  }
/>
```

- `usersCount` 来自后端统计字段，代表当前筛选条件下的用户总数；
- `loading` 控制右侧小 loading 圈，提示正在刷新数据。

### 1.3 表格与分页

- `DataTable` 接受以下关键 props：

```tsx
<DataTable
  data={users}
  columns={columns}
  pagination={pagination}
  usersCount={usersCount}
  onPaginationChange={setPagination}
  selectedUsers={selectedUsers}
  setMemoUsers={setMemoUsers}
  // 搜索和筛选功能
  filters={filters}
  onSearch={searchUsers}
  onFilterByStatus={filterByStatus}
  onClearFilters={clearFilters}
  onRefresh={refreshUsers}
  loading={loading}
  hasNext={hasNext}
  hasPrevious={hasPrevious}
/>
```

- 功能点：
  - 分页：
    - `pagination` 包含 `pageIndex`、`pageSize`；
    - `hasNext` / `hasPrevious` 用于控制翻页按钮；
    - 翻页动作通过 `setPagination` 触发，`useUserList` 会根据新的页码重新请求；
  - 多选与批量操作：
    - `selectedUsers` 用于传递当前选中的用户列表；
    - `setMemoUsers` 用于在翻页时缓存表格中展示过的用户，以便保持选中状态。

### 1.4 搜索与状态筛选

- `useUserList` 中的相关逻辑：

```tsx
// 搜索用户
const searchUsers = useCallback((searchTerm: string) => {
  setFilters(prev => ({
    ...prev,
    search: searchTerm || undefined,
  }));
  setPagination(prev => ({ ...prev, pageIndex: 0 }));
}, []);

// 按状态筛选
const filterByStatus = useCallback((enabled?: boolean, registered?: boolean) => {
  setFilters(prev => ({
    ...prev,
    enabled,
    registered,
  }));
  setPagination(prev => ({ ...prev, pageIndex: 0 }));
}, []);

// 清除筛选
const clearFilters = useCallback(() => {
  setFilters({});
  setPagination(prev => ({ ...prev, pageIndex: 0 }));
}, []);
```

- 功能说明：
  - 搜索：按关键字过滤用户（通常对邮箱/姓名等字段）；
  - 状态筛选：
    - `enabled`：启用/禁用状态；
    - `registered`：是否完成注册/激活；
  - 清除筛选：恢复到无过滤状态，并重置页码。

---

## 2. 用户详情与行级操作

### 2.1 表格列与行渲染（columns.tsx）

- 通过 `useColumns` 定义了用户列表的各列信息，如头像、邮箱、状态、操作列等；
- 每一行用户都有对应的行级操作组件 `DataTableRowActions`：
  - 编辑用户；
  - 启用/禁用账号；
  - 重置密码；
  - 删除用户；
  - 导出/更多操作（视实现）。

> 具体列定义较长，这里聚焦主要行为：每个用户在列表中有一个“操作”列，点击可打开编辑、重置密码、启用/禁用等动作。

### 2.2 用户详情弹窗与编辑行为

- 在行操作中调用 `use-user-management.ts` 和相关对话框组件：
  - `user-edit-dialog.tsx`：编辑用户基础信息；
  - `reset-password.tsx`：重置密码对话框；
  - `disable-account.tsx` / `enable-account.tsx`：启用/禁用确认弹窗；
  - `delete-account.tsx`：删除确认弹窗。

行为流程（例如编辑用户）：

1. 用户点击“编辑”操作；
2. 打开编辑对话框，展示当前用户信息（由 `schema.ts` 定义的 `UserType`、`UpdateUserInput` 决定字段）；
3. 修改后提交：
   - 调用 `updateUser` API；
   - 成功后刷新列表 `refreshUsers()`；
   - 关闭对话框并给出提示。

### 2.3 用户状态与安全相关操作

对应 API 封装在 `user-actions.ts` 中：

```ts
// 更新用户
export const updateUser = async (userId: string, userData: UpdateUserInput) => {
  return await httpClient.put(`/api/admin/users/${userId}`, userData);
};

// 删除用户
export const deleteUser = async (userId: string) => {
  return await httpClient.delete(`/api/admin/users/${userId}`);
};

// 重置密码
export const resetUserPassword = async (userId: string, newPassword?: string) => {
  return await httpClient.post(
    `/api/admin/users/${userId}/reset-password`,
    newPassword ? { password: newPassword } : {}
  );
};

// 启用/禁用用户
export const toggleUserStatus = async (userId: string) => {
  return await httpClient.post(`/api/admin/users/${userId}/toggle-status`);
};
```

- 安全点：
  - 删除、禁用、重置密码等操作必须通过对话框明确确认；
  - 前端只负责调用 API 和更新 UI，具体权限判定由后端执行；
  - 若后端返回权限错误（如 403），`error` 将在 `useUserList` 中暴露，并在页面上显示“权限验证失败”的调试信息。

### 2.4 权限错误提示（当前实现）

- 在 `AccountPage` 顶部有一段调试输出和错误处理：

```tsx
if (error) {
  return (
    <div className="h-screen flex-1 flex-col flex">
      <Header title="账户管理" />
      <div className="flex-1 flex items-center justify-center">
        <div className="text-center max-w-md">
          <div className="text-red-500 mb-4 text-lg">权限验证失败</div>
          <div className="text-gray-700 mb-4">{error}</div>
          {/* 调试信息区域 */}
          <button onClick={refreshUsers}>重试请求</button>
          <button onClick={() => (window.location.href = '/admin/auth')}>
            重新登录
          </button>
        </div>
      </div>
    </div>
  );
}
```

- 用于在管理员权限配置异常时帮助排查问题（用户信息、token 是否存在等）。

---

## 3. 邀请、创建与批量操作

### 3.1 创建与邀请用户（API 侧）

- 创建用户接口：

```ts
export const createUser = async (userData: CreateUserInput) => {
  return await httpClient.post('/api/admin/users', userData);
};
```

- 前端行为（典型设计）：
  - 在用户列表上方提供“新建用户”按钮；
  - 弹出用户创建表单（`user-form.tsx`）；
  - 支持：
    - 直接创建账号（指定邮箱、初始角色、状态）；
    - 或发送邀请邮件（由后端处理，前端只传递参数）。

> 当前代码片段未展示具体 UI，但 `<user-form>` / `user-edit-dialog` 模块已存在基础结构，可以承载这一能力。

### 3.2 批量操作

- 批量操作 API：

```ts
export const batchOperateUsers = async (batchData: BatchOperationInput) => {
  return await httpClient.post('/api/admin/users/batch', batchData);
};
```

- 用途：
  - 批量启用/禁用用户；
  - 批量调整角色（视后端支持）；
  - 批量删除或导出。

- 多选支持：
  - `DataTable` 中通过首列复选框和 `selectedUserIds` 维护选中用户；
  - 批量操作按钮读取 `selectedUsers` 列表并调用 `batchOperateUsers`。

### 3.3 导入与导出用户

- 批量导入（CSV）：

```ts
export const importUsersFromCsv = async (file: File) => {
  const formData = new FormData();
  formData.append('file', file);
  return await httpClient.post('/api/admin/users/batch-import', formData, {
    headers: { 'Content-Type': 'multipart/form-data' },
  });
};
```

- 前端流程：
  - 在工具栏提供“导入用户”按钮；
  - 选择 CSV 文件后调用该 API；
  - 显示导入结果（成功/失败条目数、错误原因等）。

- 用户统计信息：

```ts
export const getUserStatistics = async () => {
  return await httpClient.get('/api/admin/users/statistics');
};
```

- 可用于在页面顶部或仪表盘展示用户数量、激活率等统计汇总。

---

## 4. 权限与安全考虑

- 所有 `/api/admin/users/*` 接口都应仅对具有管理员权限的账户开放：
  - 前端通过 admin 登录（`/admin/auth`）获得专用 token（如 `yunke-admin-token`）；
  - 在请求中由 `httpClient` 附带相应认证。
- 前端层面的安全措施：
  - 对关键操作（删除、禁用、重置密码）使用确认对话框；
  - 不在 UI 中暴露多余的调试信息给普通用户（当前的“调试信息”区域可考虑在生产环境中隐藏或弱化）。

> 总体来看，“账号与用户管理”模块已经具备较完整的用户列表、搜索分页、单用户操作、批量操作和导入/统计的前端结构，权限判断和具体行为由后台接口统一控制。 
