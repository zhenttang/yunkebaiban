# 系统监控（功能 + 实现说明）

> 关联上级：`文档/功能文档/admin.md`  
> 主要代码位置：
> - 页面入口：`packages/frontend/admin/src/modules/monitoring/index.tsx`（`MonitoringPage`）
> - 指标获取 Hook：`hooks/use-metrics.ts`
> - UI 组件：使用 `@yunke/admin/components/ui/*` 和 `lucide-react` 图标

---

## 1. 运行状态总览（/admin/monitoring）

### 1.1 页面结构与布局

- 路由 `/admin/monitoring` 对应 `MonitoringPage` 组件：

```tsx
export function MonitoringPage() {
  const {
    systemMetrics,
    applicationMetrics,
    databaseMetrics,
    healthStatus,
    metricsSummary,
    loading,
    error,
    refreshMetrics,
  } = useMetrics();

  // 每 30 秒自动刷新一次
  useEffect(() => {
    const interval = setInterval(refreshMetrics, 30000);
    return () => clearInterval(interval);
  }, [refreshMetrics]);

  if (error) {
    // 错误状态视图
  }

  return (
    <div className="h-screen flex-1 flex-col flex">
      <Header
        title="系统监控"
        endFix={/* 健康状态 Badge + 刷新按钮 */}
      />
      <ScrollArea className="flex-1">
        <div className="p-6 space-y-6">
          {/* 概览卡片、告警信息、详细指标等 */}
        </div>
      </ScrollArea>
    </div>
  );
}
```

- 顶部 `Header`：
  - 标题：“系统监控”；
  - 右侧 `endFix` 显示整体健康状态 Badge（健康/异常）和手动刷新按钮。
- 主体区域使用 `ScrollArea` 包裹，内部包含：
  - 系统资源概览卡片（CPU/内存/磁盘/活跃用户）；
  - 活跃告警列表（如存在）；
  - 系统、应用、数据库指标的详细卡片。

### 1.2 概览卡片（CPU/内存/磁盘/活跃用户）

- 使用四个 `MetricCard` 显示系统整体状态：

```tsx
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  <MetricCard
    title="CPU使用率"
    value={systemMetrics?.cpu?.processCpuLoad || 0}
    unit="%"
    icon={<Cpu className="h-4 w-4" />}
    color={getColorByThreshold(systemMetrics?.cpu?.processCpuLoad || 0, 70, 90)}
  />
  <MetricCard
    title="内存使用率"
    value={systemMetrics?.memory?.heapUsedPercent || 0}
    unit="%"
    icon={<MemoryStick className="h-4 w-4" />}
    color={getColorByThreshold(systemMetrics?.memory?.heapUsedPercent || 0, 70, 85)}
  />
  <MetricCard
    title="磁盘使用率"
    value={systemMetrics?.disk?.usedPercent || 0}
    unit="%"
    icon={<HardDrive className="h-4 w-4" />}
    color={getColorByThreshold(systemMetrics?.disk?.usedPercent || 0, 80, 95)}
  />
  <MetricCard
    title="活跃用户"
    value={applicationMetrics?.userActivity?.activeUsers || 0}
    unit="人"
    icon={<Users className="h-4 w-4" />}
    color="blue"
  />
</div>
```

- `getColorByThreshold` 根据阈值返回不同颜色（正常/警告/危险），便于快速识别风险：
  - CPU、内存、磁盘分别有不同的阈值（如 70/90、70/85、80/95）。

### 1.3 整体健康状态 Badge

- Header 右侧通过 `healthStatus.overall` 判断整体健康：

```tsx
<Badge variant={healthStatus?.overall === 'UP' ? 'default' : 'destructive'}>
  {healthStatus?.overall === 'UP' ? '健康' : '异常'}
</Badge>
```

- 同时提供一个刷新按钮：
  - 点击调用 `refreshMetrics`；
  - `loading` 为 true 时，图标使用 `animate-spin` 提示正在刷新。

---

## 2. 指标获取与数据结构

### 2.1 useMetrics Hook

`useMetrics` 封装了所有监控数据的拉取逻辑：

```ts
interface MetricsData {
  systemMetrics?: any;
  applicationMetrics?: any;
  databaseMetrics?: any;
  healthStatus?: any;
  metricsSummary?: any;
  historyData?: any;
}

export function useMetrics() {
  const [data, setData] = useState<MetricsData>({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  // ...
}
```

- 子请求：
  - `/api/admin/metrics/system`：系统资源指标（CPU、内存、磁盘等）；
  - `/api/admin/metrics/application`：应用级指标（用户活跃、请求量等）；
  - `/api/admin/metrics/database`：数据库指标（连接数、慢查询等）；
  - `/api/admin/metrics/health`：健康状态（`overall=UP/DOWN`，各子系统状态）；
  - `/api/admin/metrics/summary`：综合摘要（用于卡片/告警汇总）。

示例：系统指标获取

```ts
const fetchSystemMetrics = useCallback(async () => {
  const response = await httpClient.get('/api/admin/metrics/system');
  return response.data;
}, []);
```

刷新逻辑：

```ts
const refreshMetrics = useCallback(async () => {
  setLoading(true);
  setError(null);
  try {
    const [
      systemMetrics,
      applicationMetrics,
      databaseMetrics,
      healthStatus,
      metricsSummary
    ] = await Promise.all([
      fetchSystemMetrics(),
      fetchApplicationMetrics(),
      fetchDatabaseMetrics(),
      fetchHealthStatus(),
      fetchMetricsSummary()
    ]);
    setData({ systemMetrics, applicationMetrics, databaseMetrics, healthStatus, metricsSummary });
  } catch (err) {
    setError(err instanceof Error ? err.message : '获取监控数据失败');
  } finally {
    setLoading(false);
  }
}, [/* ... */]);
```

### 2.2 历史数据与实时数据 Hook（预留）

- 历史指标：

```ts
export function useHistoryMetrics(type: string, timeRange: string) {
  // 调用 /api/admin/metrics/history?type=&timeRange=
}
```

- 实时指标（轮询）：

```ts
export function useRealTimeMetrics(interval = 5000) {
  const [metrics, setMetrics] = useState<any>({});
  const [connected, setConnected] = useState(false);

  const fetchMetrics = useCallback(async () => {
    const response = await httpClient.get('/api/admin/metrics/summary');
    setMetrics(response.data);
    setConnected(true);
  }, []);

  useEffect(() => {
    fetchMetrics();
    const timer = setInterval(fetchMetrics, interval);
    return () => clearInterval(timer);
  }, [fetchMetrics, interval]);

  return { metrics, connected, refresh: fetchMetrics };
}
```

- 目前 UI 中主要使用 `useMetrics` 的聚合数据，`useHistoryMetrics` 和 `useRealTimeMetrics` 为未来图表/实时监控预留能力。

---

## 3. 告警与状态卡片

### 3.1 活跃告警卡片

- 如果 `metricsSummary.alerts` 存在且非空，则显示“活跃告警”卡片：

```tsx
{metricsSummary?.alerts && metricsSummary.alerts.length > 0 && (
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center gap-2">
        <AlertTriangle className="h-5 w-5 text-amber-500" />
        活跃告警
      </CardTitle>
    </CardHeader>
    <CardContent>
      {/* 遍历 alerts 列表，展示每个告警的 message 和 value */}
    </CardContent>
  </Card>
)}
```

- 每条告警包括：
  - 告警信息（如“CPU 使用率过高”、“数据库连接数接近上限”等）；
  - 当前值或等级（通过 `Badge` 显示）。

### 3.2 系统/应用/数据库详细卡片

- 系统指标卡片：
  - 展示 CPU、内存、磁盘等更细致信息（如进程 CPU、系统 CPU、堆内存使用等）；
  - 使用 `Progress` 展示占比，用颜色标识不同健康状态。
- 应用指标卡片：
  - 用户活跃趋势（活跃用户数、请求量趋势等）；
  - 延迟、错误率等（视后端提供）。
- 数据库指标卡片：
  - 连接数、活动连接、慢查询数量；
  - 数据库大小或重要表大小（视实现）。

> 这些卡片的 UI 实现使用 `Card`, `CardHeader`, `CardContent`, `Progress`, `Badge` 等组件，具体字段由后端 metrics 数据结构决定。 

---

## 4. 错误处理与导出能力

### 4.1 错误状态视图

- 当 `useMetrics` 返回 `error` 时，`MonitoringPage` 显示错误页：

```tsx
if (error) {
  return (
    <div className="h-screen flex-1 flex-col flex">
      <Header title="系统监控" />
      <div className="flex-1 flex items-center justify-center">
        <div className="text-center">
          <XCircle className="h-12 w-12 text-red-500 mx-auto mb-4" />
          <h3 className="text-lg font-semibold mb-2">监控数据加载失败</h3>
          <p className="text-gray-600 mb-4">{error}</p>
          <button onClick={refreshMetrics}>重新加载</button>
        </div>
      </div>
    </div>
  );
}
```

- 用于网络错误、认证失败或后端监控服务不可用时的反馈。

### 4.2 指标导出（API 层）

- `useMetrics` 中还提供了 `exportMetrics` 方法：

```ts
const exportMetrics = useCallback(async (format = 'json', timeRange = '1h') => {
  const response = await httpClient.post('/api/admin/metrics/export', {
    format,
    timeRange,
  });
  return response.data;
}, []);
```

- 作用：
  - 导出一定时间范围内的监控数据（如 JSON/CSV）；
  - 方便管理员离线分析或导入外部监控系统（如 Grafana, Prometheus 等）。
- UI 端目前尚未添加对应按钮，但 API 已预留。

---

## 5. 告警与通知（规划）

> 当前前端主要展示告警列表，告警阈值和通知通道配置更多依赖后端与管理后台其他模块，这里对未来扩展做简单规划。

- 告警阈值配置：
  - 在管理后台添加“告警设置”页面，允许管理员配置各项指标的阈值；
  - 前端可展示当前告警策略，并发送修改请求。
- 通知通道配置：
  - 邮件通知：配置 SMTP 和告警邮件模板；
  - IM 通知：配置 Webhook（例如企业微信、钉钉、Slack 等）；
  - 日志系统集成：配置外部监控/日志平台的地址，以便统一查看。

> 总体上，`/admin/monitoring` 提供了一个前端层面的“系统体检面板”：通过多个 REST 接口拉取关键指标，用卡片和图表展示当前状态，并通过告警卡片和导出能力辅助运维人员进行诊断和排查。 
