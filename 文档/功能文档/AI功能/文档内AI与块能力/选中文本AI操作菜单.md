# 选中文本 AI 操作菜单（功能 + 实现说明）

> 关联上级：`AI功能/文档内AI与块能力.md`  
> 主要代码位置（入口与动作）：
> - AI 文本相关动作：`packages/frontend/core/src/blocksuite/ai/chat-panel/actions/text.ts`
> - 页面/白板响应：`actions/page-response.ts`、`actions/edgeless-response.ts`
> - 选中内容工具：`utils/extract.ts`、`utils/selection-utils.ts`

---

## 1. 菜单项与入口

### 1.1 选中文本时的 AI 菜单

当用户在文档中选中一段文本时，编辑器会展示一个快捷菜单，其中包含 AI 相关操作，例如：

- 重写/润色选中的文本；
- 翻译为其他语言；
- 提取摘要（总结本段/本页）；
- 生成后续内容（继续写）。

这些菜单项通常由 “文本相关动作” 模块驱动，例如 `actions/text.ts` 中定义的动作：

- `rewriteText`；
- `polishText`；
- `translateText`；
- `summarizeSelection`；
- `continueWriting` 等（具体名称视实现）。

### 1.2 菜单触发方式

- 选中一段文本后：
  - 编辑器在选区附近显示浮动工具条；
  - 工具条中包含 AI 图标/按钮；
  - 展开后显示各 AI 文本操作项。
- 也可以在顶部工具栏或右键菜单中提供相同入口，用于选中或当前段落的 AI 操作。

---

## 2. 上下文构建与请求发送

### 2.1 提取选中内容

当用户点击 AI 菜单某项时，前端会：

1. 使用 `getSelectedTextContent` 获取选中文本；
2. 使用 `getSelectedImagesAsBlobs` 获取与选区相关的图片（如有）；
3. 使用 `extractSelectedContent` 将选中内容整合成统一的上下文结构；
4. 更新 `ChatContextValue` 中的 `quote`/`markdown`/`images` 字段。

这些上下文信息随后由 `AIProvider` 用于构造请求体，例如：

- 提示词中包含：“以下是用户选中的文本：…，请对其进行重写/翻译/总结”等；
- 对于生成后续内容，则提示：“基于以下内容继续写作：…”。 

### 2.2 调用 AI 动作

- 每个菜单项对应一个 AI 动作函数（定义在 `actions/text.ts`）：
  - 接收上下文（选中内容、当前语言、用户设置等）；
  - 构造请求并提交给 `AIProvider`；
  - 处理响应和错误。
- 在请求发出时，前端会：
  - 将聊天状态置为 `transmitting`；
  - 在聊天面板或块中显示“正在生成…”提示；
  - 支持中断（通过 `abortController`）和重试。

---

## 3. 操作结果落地：替换、插入与发送到聊天面板

### 3.1 替换原文

适用场景：

- 重写（Rewrite）；
- 润色（Polish）；
- 翻译（Translate）等。

行为：

- AI 返回的新文本与原选中内容长度/结构可能不同；
- 前端通过 `page-response` 中的逻辑，将选中范围内的内容替换为新文本：
  - 更新对应文本块/行内内容；
  - 保留原格式（如加粗/斜体）或按需要重建。

### 3.2 插入新块

适用场景：

- 总结本段/本页；
- 生成后续内容；
- 生成大纲/要点列表。

行为：

- 不覆盖原文，而是在原选中区域之后插入一个新的块或一组块：
  - 如插入一个 Callout 块，展示“本段摘要”；
  - 插入一个列表块，展示 AI 生成的要点；
  - 在文末追加新的段落或标题。
- 插入实现同样在 `page-response` 等动作模块中完成，通过编辑器的 block API 创建/插入新块。

### 3.3 将结果发送到 AI 聊天面板

适用场景：

- 用户希望在聊天面板中继续追问或修改结果：
  - 比如“帮我进一步简化上面这段文字”；  
  - 或“把刚才的摘要变成 bullet 列表”。

行为：

- 将 AI 生成的结果作为一条新消息发送到聊天面板：
  - 更新 `ChatContextValue.messages`；
  - 在 `ChatPanel` 中展示，相当于对当前内容进行“后续讨论”；
  - 用户可以在面板里继续追加指令，而不修改文档原文。

---

## 4. 用户控制与可撤销性

### 4.1 操作确认与撤销

- 对于会修改文档内容的操作（替换/插入）：
  - 可以在结果生成后先在预览中展示，提供“应用到文档 / 取消”两个选项；
  - 或直接应用，但依赖编辑器的 Undo/Redo 能力让用户可以撤销。

### 4.2 安全与边界

- 边界情况处理：
  - 若选区为空或跨越不支持的块类型，应禁用 AI 菜单或提示用户；
  - 对于过大的选区（超出模型限制），应截断或提示用户缩小范围；
  - 对错误响应（如网络错误）显示清晰的错误消息，而不修改文档内容。

> 总的来说，“选中文本 AI 操作菜单”把“选区 → 上下文 → AI 请求 → 结果落地/发送到聊天”这一链路打通，让用户在不离开文档编辑界面的情况下，就能直接用 AI 进行重写、翻译、总结和生成内容。 
