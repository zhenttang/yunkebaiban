# 生成内容与布局规则（功能 + 实现说明）

> 关联上级：`AI功能/白板与 Edgeless Copilot.md`  
> 主要代码位置（相关模块）：
> - Edgeless Copilot 面板：`widgets/edgeless-copilot-panel/index.ts`（`EdgelessCopilotPanel`）
> - AI 动作配置：`ai/components/ai-item`（布局、mindmap、slides 等入口）
> - 图形与布局引擎：`blocks/surface`、`gfx` 模块（具体布局算法分散在 gfx 层与动作实现中）

---

## 1. 生成内容类型

> Edgeless Copilot 负责“将 AI 结果转化为白板上的内容”，这里从功能角度列举主要类型。

### 1.1 思维导图（Mindmap）

- 基于 AI 响应生成一张思维导图：
  - 中心节点为主题；
  - 一级分支为主要要点；
  - 二级及更多分支用于详细展开。
- 使用场景：
  - 将文档摘要转化为图形结构；
  - 从自然语言描述快速生成脑图草稿。

### 1.2 流程图（Flowchart）

- 基于步骤/状态信息生成流程图：
  - 每个步骤作为矩形/菱形节点；
  - 使用箭头连接节点表示顺序与条件；
  - 支持分支和循环结构（视实现）。
- 使用场景：
  - 将“操作步骤”、“业务流程”转成可视流程图；
  - 从用户描述中推导出流程草案。

### 1.3 标注与说明文本

- 以文本节点形式附着在白板上的注释：
  - 对已有图形进行解释；
  - 标记重点、风险点等。
- 使用场景：
  - 帮助用户在复杂图中加上说明；
  - 为思维导图/流程图生成简要概述。

### 1.4 Slides/布局片段（与 Slides 模块协同）

- 在白板上预生成部分 Slides 或结构块：
  - 将文档内容拆分为多个节点，每个节点代表一页/一部分内容；
  - 后续可作为 Slides 生成的输入。

> 具体“生成什么内容”由 Copilot 面板中 AI Item 的配置和 AI 动作实现决定，这里从高层类型进行归纳。 

---

## 2. Copilot 面板与动作过滤

### 2.1 面板渲染与可用动作

在 `EdgelessCopilotPanel` 中，根据当前编辑器状态过滤可用的 AI 动作（AIItem）：

```ts
const chain = this._getChain();
const groups = this.groups.reduce((pre, group) => {
  const filtered = group.items.filter(item =>
    item.showWhen?.(chain, 'edgeless', this.host)
  );

  if (filtered.length > 0) pre.push({ ...group, items: filtered });

  return pre;
}, [] as AIItemGroupConfig[]);

if (groups.every(group => group.items.length === 0)) return nothing;

return html`
  <div class="edgeless-copilot-panel" data-app-theme=${appTheme}>
    <ai-item-list
      .theme=${appTheme}
      .onClick=${() => {
        this.onClick?.();
      }}
      .host=${this.host}
      .groups=${groups}
    ></ai-item-list>
  </div>
`;
```

- `AIItemGroupConfig` 中定义了可用的 AI 工具条目（如“生成流程图”、“生成思维导图”、“自动布局”等）；
- 每个条目有 `showWhen(chain, 'edgeless', host)` 条件，用于基于当前上下文（选区、模式、特性开关等）决定是否显示；
- 这样可以：
  - 在不合适的上下文中隐藏某些动作；
  - 避免对用户展示无意义或会失败的选项。

### 2.2 点击动作后如何调用生成逻辑

- 用户在 Copilot 面板中点击某个 AI 动作：
  - 触发对应的 command chain（`chain`）；
  - 通过 AIProvider 和对应动作模块（如 mindmap、slides、flowchart）发送请求；
  - 收到响应后，根据动作类型生成相应的白板节点和布局。

---

## 3. 布局规则（概念层面）

> 实际布局逻辑分布在 gfx 和 surface 相关模块中，这里从行为角度描述目标规则。

### 3.1 节点间距与层级结构

- 思维导图：
  - 中心节点居中；
  - 一级分支按角度分散分布（左右或环形）；
  - 子节点沿树型结构展开；
  - 节点间距根据文本长度/缩放比例自动调整。

- 流程图：
  - 一般从上到下或从左到右布局；
  - 同一层级的节点在一条虚拟线上对齐；
  - 分支路径在水平/垂直方向上拉开距离，避免线重叠。

### 3.2 避免重叠与遮挡

- 布局算法需要确保：
  - 新生成的节点不覆盖已有节点；
  - 当场景中已有图形时，尽量为新内容选择空白区域；
  - 对密集区域，允许适度自动调整已有节点位置。

一般策略：

- 先计算当前画布中所有节点的 `Bound`（通过 gfx 的 `getCommonBoundWithRotation` 等工具）；
- 在空白区域中寻找合适的插入位置；
- 如需与已有内容关联，则在附近布局并留出足够间距。

### 3.3 用户干预与二次调整

- 自动布局并非最终结果，用户仍可：
  - 手动拖动节点调整位置；
  - 修改节点文本、颜色、形状；
  - 再次调用 Copilot（如“再整理一下布局”）进行微调。

---

## 4. 与 Edgeless 交互的统一性

- 无论是 AI 生成的新节点，还是对已有节点的重新排列，所有操作都通过白板的标准命令链（`chain`）执行：
  - 保证 Undo/Redo 一致性；
  - 避免直接操作 DOM 带来的状态错乱。
- Copilot 作为“智能助手”，更多扮演“自动批量编辑”的角色，具体规则依旧遵守白板本身的约束和交互习惯。

> 总结：Edgeless Copilot 的核心价值在于“把 AI 生成的结构化结果转化为白板上的图形 + 合理布局”，并保持与普通白板操作同一种交互语言（拖动、缩放、撤销等），让用户在复杂图形编辑场景下获得强力辅助而不是被强控。 
