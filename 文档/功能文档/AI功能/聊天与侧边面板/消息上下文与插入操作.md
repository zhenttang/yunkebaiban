# 消息上下文与插入操作（功能 + 实现说明）

> 关联上级：`AI功能/聊天与侧边面板.md`  
> 主要代码位置：
> - 上下文结构：`chat-context.ts`（`ChatContextValue`）
> - 选中内容抽取工具：`utils/extract.ts`、`utils/selection-utils.ts`
> - AI 动作与插入：`actions/*`（`page-response.ts`、`edgeless-response.ts` 等）

---

## 1. 消息上下文控制

### 1.1 ChatContextValue 与上下文字段

在 `chat-context.ts` 中，聊天上下文包含：

```ts
export type ChatContextValue = {
  // 对话历史
  messages: HistoryMessage[];
  status: ChatStatus;
  error: AIError | null;

  // 选中内容的纯文本
  quote: string;
  // 选中内容的 markdown
  markdown: string;
  // 选中/上传的图片
  images: File[];

  abortController: AbortController | null;
};
```

- `quote`：选中的文本内容（plain text），用于构造人类可读的上下文提示；
- `markdown`：选中内容的 markdown 表示，便于 AI 理解结构信息；
- `images`：与选区相关或用户上传的图片，用于图像理解任务。

### 1.2 选中内容的提取

- 选中内容由工具函数生成，例如：

```ts
import { extractSelectedContent } from '../utils/extract';
import {
  getSelectedImagesAsBlobs,
  getSelectedTextContent,
} from '../utils/selection-utils';
```

- 当用户在编辑器中选中某一部分内容，然后打开 AI 面板或点击特定 AI 动作时：
  1. 使用 `getSelectedTextContent` 获取选中文本；
  2. 使用 `getSelectedImagesAsBlobs` 获取关联图片；
  3. 将结果写入 `ChatContextValue` 的 `quote`、`markdown`、`images` 字段；
  4. 构造 AI 请求时，将这些字段作为上下文注入提示词中。

### 1.3 上下文启用/禁用的控制（概念）

- 在聊天 UI 中，用户可以选择：
  - “使用当前页面/文档作为上下文”；
  - “只使用选中的内容”；
  - “不附带任何上下文，仅按输入问题回答”。
- 前端实现：
  - 在聊天入力区或 AI 面板顶部提供上下文选择器；
  - 根据选择情况控制是否调用 `extractSelectedContent` 或如何构建 `quote/markdown`；
  - 将上下文配置连同消息发送给 `AIProvider`，由其构造最终请求体。

---

## 2. AI 响应插入文档/白板

> AI 响应不仅用于显示聊天结果，还经常需要“插回”到当前文档或白板中。相关逻辑由 `actions/*` 模块负责。

### 2.1 文档内插入：page-response.ts

- `page-response.ts` 处理“基于文档/选中内容”的 AI 结果插入逻辑（具体代码未在片段中展开，这里做功能说明）：
  - 根据用户选择的操作（重写、续写、总结、生成大纲等），决定如何将 AI 返回内容插入文档；
  - 常见策略：
    - 覆盖：用 AI 生成内容替换选中的 text 块；
    - 插入：在选中块之后插入新块；
    - 追加：在文档末尾追加一个新的段落或标题/列表。

交互示例：

1. 用户选中一段文本；
2. 在 AI 菜单中选择“重写本段”；
3. AI 返回重写后的文本；
4. 前端调用 `page-response` 中的函数，用新文本覆盖原选中范围。

### 2.2 白板内插入：edgeless-response.ts

- `edgeless-response.ts` 处理白板场景下的 AI 响应：
  - 将 AI 生成的结构化信息映射为白板上的节点（文本框、形状、连线等）；
  - 按一定布局规则放置在画布上；
  - 例如：
    - AI 生成思维导图 → 在白板上创建中心节点和子节点；
    - AI 生成流程图 → 创建一系列步骤节点和箭头。

交互示例：

1. 用户在白板上选中一块内容或输入自然语言；
2. 单击“让 AI 帮我画流程图”；
3. AI 返回结构化流程信息；
4. `edgeless-response` 将其转换为若干 whiteboard 块，并布局到画布上。

### 2.3 多模态插入：图文结合

- 对于图片 + 文本的混合场景：
  - AI 可能返回带图文的结构；
  - 插入策略可以包括：
    - 创建一个文本块描述分析结果；
    - 在其周围创建/更新图片块；
    - 或在聊天面板中展示，用户选择是否插入。

---

## 3. 插入模式与用户控制

### 3.1 插入模式选项（设计）

在 UI 上，用户可以对每次 AI 调用选择插入模式，例如：

- 替换选中内容；
- 在选中内容之后插入；
- 在文档末尾追加；
- 不插入，仅在聊天面板查看。

实现建议：

- 在 AI 操作入口处（菜单或按钮上）预设插入模式；
- 或在 AI 响应后弹出简短选择卡片，让用户决定如何插回。

### 3.2 Undo/Redo 与安全性

- 所有插入操作都应通过编辑器的标准变更路径进行：
  - 这样用户可以使用撤销（Undo）恢复原状；
  - 保证 AI 操作与其他编辑行为在同一历史栈中。
- 失败场景：
  - 当 AI 响应解析错误或插入失败时，应提示错误，而不是 silently fail；
  - 不改变文档内容，避免出现“部分应用”的不一致状态。

---

## 4. 会话与上下文生命周期

### 4.1 会话 ID 与上下文持久化（概念）

- `ChatPanel` 中有 `getSessionId`、`createSessionId` 等属性（在 index.ts 底部可见）：

```ts
@property({ attribute: false })
accessor getSessionId!: () => Promise<string | undefined>;

@property({ attribute: false })
accessor createSessionId!: () => Promise<string | undefined>;
```

- 用途：
  - 将一次聊天会话绑定到一个可复用的 Session ID；
  - 允许用户在不同时间回到同一会话，查看历史消息与上下文；
  - 后端可基于 Session ID 保持一定长度的历史记录和上下文缓存。

### 4.2 清空上下文与重置会话

- 在 UI 中提供“清空对话”或“新建会话”入口：
  - 调用 `updateContext({ messages: [], quote: '', markdown: '', images: [] })` 等重置上下文；
  - 根据需要生成新的 Session ID；
  - 确保新会话不会混入旧的上下文，避免干扰后续回答。

> 综上，“消息上下文与插入操作”模块把“当前页面和选中内容”转化为 AI 请求的结构化上下文，再将 AI 的响应雪落回文档或白板中，形成从编辑器到 AI 再到编辑器的闭环。 
