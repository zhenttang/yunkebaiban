# 云客白板前端（baibanfront）技术与功能总览

> 本文是当前项目的主技术文档入口，用于从整体上描述「有哪些功能」以及「大致是如何实现的」。详细的模块说明、子系统说明会拆分到后续子文档中。

## 1. 项目定位与整体架构

### 1.1 项目定位

- 项目名称：`baibanfront`（云客白板前端，基于 yunke 二次开发）
- 核心目标：提供一个支持文档、白板、数据库、论坛社区等多种形态的知识工作空间，支持多端（Web、移动、桌面）访问和编辑。
- 技术栈：TypeScript、React、React Router 6、BlockSuite 编辑器、SWR、Sentry、Worker、本地 + 云存储等。

### 1.2 整体结构（Monorepo）

- 使用 Yarn Workspaces 管理多个子包：
  - 应用层：`packages/frontend/apps/*`（web、mobile、android、ios、electron、website 等）
  - Web / 桌面核心：`packages/frontend/core`
  - 管理后台：`packages/frontend/admin`
  - 通用组件与样式：`packages/frontend/component`、`packages/theme`、`packages/common/*`
  - Block 引擎：`blocksuite/*`（`blocksuite/yunke/*` 是云客定制部分）
  - 工具链：`tools/*`（CLI、changelog、commitlint 等）

### 1.3 文档结构（本仓库内）

- 主文档入口（当前文件）：`文档/主文档/总览.md`
- 功能与特性说明：`文档/功能文档/*`
- 架构与模块设计：`文档/架构文档/*`
- 实现细节与技术方案：`文档/实现细节/*`

后续所有子文档都应从本文出发，按模块链接，避免重复描述。

## 2. 应用层功能总览

### 2.1 Web 桌面端应用（主产品）

入口与主要代码位置：

- 入口应用：`packages/frontend/apps/web`
- Web 根组件与路由：
  - `src/index.tsx`：React 挂载、全局错误兜底
  - `src/app.tsx`：应用根组件，注入框架、存储、云存储、主题等
  - `src/router.tsx`：React Router 6 路由配置
- 桌面端页面与组件：
  - `@yunke/core/desktop/pages/*`
  - `@yunke/core/desktop/components/*`

功能维度：

- 首页与下载
  - `/`：入口首页（工作空间入口、引导）
  - `/download`、`/download-mobile`：桌面端 / 移动端下载页面
- 工作空间（Workspace）系统
  - 路由：`/workspace/:workspaceId/*`
  - 功能：文档与白板编辑、集合与标签视图、附件视图、分享与权限、工作空间设置等
  - 对应页面目录：`packages/frontend/core/src/desktop/pages/workspace/*`
- 模板与剪藏
  - `/clipper/import`：从剪藏工具导入
  - `/template/import`：导入模板
  - `/template/preview`：模板预览并重定向到具体文档
- 论坛与社区
  - `/forum` 及其子路由：论坛首页、帖子详情、发帖、草稿、标签、通知、版主面板等
  - 对应目录：`packages/frontend/core/src/desktop/pages/workspace/forum/*`、`packages/frontend/core/src/components/community-ui/*`
- 认证与登录
  - `/auth/:authType`、`/sign-in`、`/magic-link`、`/oauth/login`、`/oauth/callback` 等
  - 对应目录：`packages/frontend/core/src/desktop/pages/auth/*`、`packages/frontend/core/src/components/sign-in/*`
- 订阅与升级
  - `/subscribe`、`/upgrade-success*`、`/ai-upgrade-success`、`/upgrade-to-team` 等
  - 用于管理订阅状态与升级结果展示
- 新手引导与主题
  - `/onboarding`：新手引导流程
  - `/theme-editor`：主题编辑器
  - `packages/frontend/core/src/desktop/pages/root/custom-theme`：自定义主题相关页面
- 通用页面
  - `/invite/:inviteId`：邀请加入
  - `/redirect-proxy`：跳转中转
  - `/open-app/:action`：从外部唤起应用
  - `/expired`：过期页面
  - `/404`：404 页面

实现要点（后续在实现文档中展开）：

- 使用 `wrapCreateBrowserRouterV6` + Sentry 集成路由级错误上报。
- 对路由加载状态进行监控与日志输出，支持加载超时（默认 15 秒）时在页面上给出友好提示。
- 通过 `YunkeContext`、`FrameworkRoot` 等组件注入全局上下文。
- 使用 `NbstoreProvider` + Worker 提供本地存储和离线能力。

### 2.2 管理后台（Admin）

代码位置：

- 应用入口：`packages/frontend/admin/src/index.tsx`
- 根组件：`packages/frontend/admin/src/app.tsx`
- 功能模块：`packages/frontend/admin/src/modules/*`

功能维度：

- 初始化与安装向导
  - 路由：`/admin/setup`
  - 功能：在服务器未初始化时引导完成基础配置与管理员创建。
- 管理员认证与权限控制
  - 路由：`/admin/auth`
  - 功能：管理员登录、权限校验、未登录/无权限重定向。
  - 关键 hooks：`useCurrentUser`、`useAdminAccess`、`useRevalidateCurrentUser`
- 管理后台主布局
  - 路由：`/admin`（根）及其子路由
  - 布局组件：`modules/layout`
- 具体管理模块
  - `/admin/accounts`：账号管理（成员、权限等）
  - `/admin/ai`：AI 配置中心（模型、API Key、策略等）
  - `/admin/monitoring`：系统监控
  - `/admin/settings`、`/admin/settings/:module`：系统设置（模块化拆分）
  - `/admin/about`：关于页面（版本、部署信息等）

实现要点：

- 使用 React Router 保护路由，仅允许管理员访问内部模块。
- 使用 SWR 统一数据获取、缓存与重新验证。
- 使用 `ErrorBoundary` 捕获渲染错误，提供友好错误页与“刷新”按钮。
- 集成 `sonner` 进行 toast 反馈。

### 2.3 其他端应用（Android / iOS / Mobile / Electron / Website）

代码位置：

- `packages/frontend/apps/android`
- `packages/frontend/apps/ios`
- `packages/frontend/apps/mobile`
- `packages/frontend/apps/electron`、`packages/frontend/apps/electron-renderer`
- `packages/frontend/apps/website`

共性：

- 与 Web 端共用核心模块：`@yunke/core`（工作空间、编辑器、存储等）。
- 移动端通过 `components/mobile/*` 提供移动适配的 UI。
- Electron 通过 `view-extensions/electron` 提供桌面特有能力（菜单、窗口控制等）。

这些部分后续会在各自的子文档中展开，目前主文档仅做索引。

## 3. 核心领域能力总览

### 3.1 BlockSuite 编辑器与 Block 类型

代码位置：

- 通用 Block 框架：`blocksuite/framework`
- 云客定制 Block 集合：`blocksuite/yunke/*`
- 前端集成与扩展：`packages/frontend/core/src/blocksuite/*`

能力总览：

- Block 类型支持：
  - 文本类：段落、列表、Callout、Note 等
  - 富媒体：图片、附件、书签、嵌入内容（包括嵌入其他文档）
  - 白板类：画布（surface）、无边界文本（edgeless）、流程图、drawio、excalidraw 等
  - 数据类：数据库块（database）、数据视图（data-view）
  - 高级表达：代码块（code）、Mermaid 图、LaTeX 公式等
- 编辑器扩展：
  - 视图扩展：数据库视图、白板块头部工具栏、音频/PDF 预览、主题切换、Turbo 渲染等
  - 附件查看：音频、PDF、文本附件浏览

后续会有单独文档详细说明每一类 Block 的功能与实现。

### 3.2 AI 能力

代码位置：

- `packages/frontend/core/src/blocksuite/ai/*`

能力总览：

- AI Block：
  - AI 聊天块（文档内聊天与生成内容）
  - 语音转写块（音频 → 文本）
- AI 面板与工具：
  - 侧边 AI 面板、浮动 AI 工具条
  - Edgeless Copilot（白板辅助手）、思维导图生成、PPT/Slides 生成等
- Provider 与消息流：
  - AI Provider 抽象（模型选择、请求路由）
  - 消息模型管理、模板与提示词系统

### 3.3 数据与存储

代码位置：

- `packages/frontend/core/src/nbstore/*`
- `packages/frontend/core/src/modules/storage/*`
- `packages/frontend/apps/web/src/nbstore.worker.ts`

能力总览：

- Worker + Store 架构：
  - 使用 Worker/SharedWorker 封装 nbstore，避免主线程阻塞。
  - 提供加载超时检测与错误日志。
- 本地存储：
  - 通过 `configureLocalStorageStateStorageImpls` 注册多种本地存储实现（如 LocalStorage / IndexedDB 等）。
  - 支持部分数据离线访问。
- 云存储与同步：
  - 云存储 Provider，用于同步云端工作空间。
  - 云状态指示器组件（前端 UI 提醒同步状态）。

### 3.4 用户、认证与权限

能力总览：

- 用户登录 / 注册 / 绑定第三方登录。
- Web 端工作空间权限控制（成员、访客、分享链接）。
- Admin 管理员权限校验（仅管理员可访问管理后台模块）。

## 4. 跨模块基础设施

### 4.1 配置与环境

- 环境变量与运行模式管理：`packages/frontend/core/src/env/*`
- Worker URL 计算：`@yunke/env/worker`
- Nginx 示例配置：根目录 `nginx.conf.example`

### 4.2 网络请求与 API 封装

- 通用请求封装：`packages/frontend/core/src/request/*`
- 业务 API 模块：`packages/frontend/core/src/api/*`（用户、workspace、论坛、订阅等）

### 4.3 错误处理与数据透明

- 全局错误类型与处理：`packages/frontend/core/src/error/*`
- 数据透明与隐私相关展示：`packages/frontend/core/src/data-transparency/*`
- 前端错误边界与错误页组件：`packages/frontend/core/src/components/yunke/yunke-error-boundary/*`

### 4.4 Telemetry 与埋点

- 组件位置：`packages/frontend/core/src/components/telemetry`
- 负责上报页面浏览、关键操作、性能指标等。

## 5. 文档拆分与后续规划

后续将从本文拆分出多篇更细的技术文档，建议结构如下：

- `文档/功能文档/Web端概览.md`：Web 桌面端所有功能（路由、页面、用户视角）。
- `文档/功能文档/admin.md`：管理后台功能说明。
- `文档/功能文档/workspace.md`：工作空间系统（文档、白板、集合、标签、附件、分享）。
- `文档/功能文档/forum.md`：论坛与社区功能。
- `文档/功能文档/ai.md`：AI 功能说明（用户视角）。
- `文档/功能文档/templates-and-clipper.md`：模板中心与剪藏集成功能。
- `文档/架构文档/frontend-overview.md`：前端整体架构与依赖关系。
- `文档/架构文档/blocksuite.md`：BlockSuite 与 Block 类型架构。
- `文档/实现细节/ai.md`：AI 实现细节（请求流、Provider、前后端协作）。
- `文档/实现细节/storage.md`：存储与同步实现（nbstore、Worker、本地/云）。

后续每一篇子文档都会：

- 列出相关路由、页面、组件、数据结构；
- 描述用户功能与交互流程；
- 说明核心实现方案与重要技术细节；
- 链接到相关代码路径，方便开发者快速定位。

