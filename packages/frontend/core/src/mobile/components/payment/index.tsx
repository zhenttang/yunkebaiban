import React, { useState, useCallback, useEffect } from 'react';\nimport { Button, Loading } from '@yunke/component';\nimport type { CommunityDocument, PaymentOrderRequest, PaymentOrderResponse } from '../../../components/community-ui/types';\nimport { PAYMENT_METHODS } from '../../../components/community-ui/types';\nimport { paymentApi } from '../../../api/payment';\nimport { useQRCode } from '../../../utils/qrcode';\nimport * as styles from './styles.css';\n\ninterface MobilePaymentProps {\n  document: CommunityDocument;\n  onPaymentSuccess: () => void;\n  onCancel: () => void;\n}\n\ntype PaymentStatus = 'selecting' | 'processing' | 'waiting' | 'success' | 'error';\n\nexport const MobilePayment: React.FC<MobilePaymentProps> = ({\n  document,\n  onPaymentSuccess,\n  onCancel,\n}) => {\n  const [paymentMethod, setPaymentMethod] = useState<'WECHAT' | 'ALIPAY'>('ALIPAY');\n  const [status, setStatus] = useState<PaymentStatus>('selecting');\n  const [orderInfo, setOrderInfo] = useState<PaymentOrderResponse | null>(null);\n  const [error, setError] = useState<string>('');\n  const [qrCodeImageUrl, setQrCodeImageUrl] = useState<string>('');\n  const { generateImage } = useQRCode();\n\n  useEffect(() => {\n    let timer: NodeJS.Timeout;\n    \n    if (status === 'waiting' && orderInfo) {\n      timer = setInterval(async () => {\n        try {\n          const isPaid = await paymentApi.checkPaymentStatus(orderInfo.orderId);\n          if (isPaid) {\n            setStatus('success');\n            setTimeout(() => {\n              onPaymentSuccess();\n            }, 2000);\n          }\n        } catch (err) {\n          console.error('æ£€æŸ¥æ”¯ä»˜çŠ¶æ€å¤±è´¥:', err);\n        }\n      }, 3000);\n    }\n\n    return () => {\n      if (timer) clearInterval(timer);\n    };\n  }, [status, orderInfo, onPaymentSuccess]);\n\n  const handlePayment = useCallback(async () => {\n    setStatus('processing');\n    setError('');\n    setQrCodeImageUrl('');\n\n    try {\n      const order = await paymentApi.createPaymentOrder({\n        documentId: document.id,\n        paymentMethod,\n      });\n\n      if (order.qrCode) {\n        const qrImageUrl = await generateImage(order.qrCode, { width: 200 });\n        setQrCodeImageUrl(qrImageUrl);\n      }\n\n      setOrderInfo(order);\n      setStatus('waiting');\n    } catch (err: any) {\n      console.error('æ”¯ä»˜å¤±è´¥:', err);\n      setError(err.message || 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•');\n      setStatus('error');\n    }\n  }, [document.id, paymentMethod, generateImage]);\n\n  const handleRetry = useCallback(() => {\n    setStatus('selecting');\n    setError('');\n    setOrderInfo(null);\n    setQrCodeImageUrl('');\n  }, []);\n\n  const renderContent = () => {\n    switch (status) {\n      case 'selecting':\n        return (\n          <div className={styles.container}>\n            {/* å•†å“ä¿¡æ¯ */}\n            <div className={styles.productInfo}>\n              <div className={styles.productHeader}>\n                <h3 className={styles.productTitle}>{document.title}</h3>\n                <span className={styles.productPrice}>Â¥{document.price}</span>\n              </div>\n              <p className={styles.productDescription}>{document.description}</p>\n            </div>\n\n            {/* æ”¯ä»˜æ–¹å¼ */}\n            <div className={styles.paymentSection}>\n              <h4 className={styles.sectionTitle}>é€‰æ‹©æ”¯ä»˜æ–¹å¼</h4>\n              <div className={styles.paymentMethods}>\n                {PAYMENT_METHODS.map(method => (\n                  <label\n                    key={method.value}\n                    className={`${styles.paymentMethod} ${\n                      paymentMethod === method.value ? styles.paymentMethodActive : ''\n                    }`}\n                  >\n                    <input\n                      type=\"radio\"\n                      name=\"paymentMethod\"\n                      value={method.value}\n                      checked={paymentMethod === method.value}\n                      onChange={(e) => setPaymentMethod(e.target.value as 'WECHAT' | 'ALIPAY')}\n                      className={styles.radioInput}\n                    />\n                    <div className={styles.methodIcon}>\n                      {method.value === 'ALIPAY' ? (\n                        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"#1677FF\">\n                          <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v-.07zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z\"/>\n                        </svg>\n                      ) : (\n                        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"#07C160\">\n                          <path d=\"M12 2.04c-5.5 0-9.96 4.46-9.96 9.96 0 1.68.41 3.26 1.15 4.65L2 22l5.5-1.18c1.33.69 2.84 1.08 4.5 1.08 5.5 0 9.96-4.46 9.96-9.96S17.5 2.04 12 2.04zm0 17.92c-1.43 0-2.76-.38-3.91-1.04L7.5 19.5l.54-.12c-1.15-1.15-1.85-2.74-1.85-4.5 0-4.39 3.57-7.96 7.96-7.96s7.96 3.57 7.96 7.96-3.57 7.96-7.96 7.96z\"/>\n                        </svg>\n                      )}\n                    </div>\n                    <span className={styles.methodLabel}>{method.label}</span>\n                  </label>\n                ))}\n              </div>\n            </div>\n\n            {/* å®‰å…¨æç¤º */}\n            <div className={styles.securityNotice}>\n              <span className={styles.securityIcon}>ğŸ”’</span>\n              <span className={styles.securityText}>å®‰å…¨æ”¯ä»˜ç”±æ”¯ä»˜å®/å¾®ä¿¡å®˜æ–¹ä¿éšœ</span>\n            </div>\n\n            {/* æ“ä½œæŒ‰é’® */}\n            <div className={styles.actions}>\n              <Button\n                variant=\"secondary\" \n                onClick={onCancel}\n                className={styles.cancelButton}\n              >\n                å–æ¶ˆ\n              </Button>\n              <Button\n                variant=\"primary\" \n                onClick={handlePayment}\n                className={styles.payButton}\n              >\n                æ”¯ä»˜ Â¥{document.price}\n              </Button>\n            </div>\n          </div>\n        );\n\n      case 'processing':\n        return (\n          <div className={styles.statusContainer}>\n            <Loading size={32} />\n            <h3 className={styles.statusTitle}>æ­£åœ¨ç”Ÿæˆæ”¯ä»˜è®¢å•</h3>\n            <p className={styles.statusText}>è¯·ç¨å€™...</p>\n            <Button\n              variant=\"secondary\" \n              onClick={onCancel}\n              className={styles.fullWidthButton}\n            >\n              å–æ¶ˆ\n            </Button>\n          </div>\n        );\n\n      case 'waiting':\n        return (\n          <div className={styles.container}>\n            {/* äºŒç»´ç  */}\n            <div className={styles.qrCodeSection}>\n              <div className={styles.qrCodeContainer}>\n                {(qrCodeImageUrl || orderInfo?.qrCode) && (\n                  <img \n                    src={qrCodeImageUrl || orderInfo.qrCode} \n                    alt=\"æ”¯ä»˜äºŒç»´ç \"\n                    className={styles.qrCodeImage}\n                    onError={(e) => {\n                      if (orderInfo?.qrCode && e.currentTarget.src !== orderInfo.qrCode) {\n                        e.currentTarget.src = orderInfo.qrCode;\n                      }\n                    }}\n                  />\n                )}\n              </div>\n              <h3 className={styles.qrTitle}>\n                ä½¿ç”¨{paymentMethod === 'WECHAT' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®'}æ‰«ç æ”¯ä»˜\n              </h3>\n              <p className={styles.qrDescription}>\n                æ‰“å¼€{paymentMethod === 'WECHAT' ? 'å¾®ä¿¡' : 'æ”¯ä»˜å®'}Appæ‰«æäºŒç»´ç \n              </p>\n              <div className={styles.amountInfo}>\n                <span className={styles.amountDot}></span>\n                æ”¯ä»˜é‡‘é¢: Â¥{orderInfo ? (orderInfo.amount / 100).toFixed(2) : document.price}\n              </div>\n            </div>\n\n            {/* è®¢å•ä¿¡æ¯ */}\n            <div className={styles.orderInfo}>\n              <h4 className={styles.orderTitle}>è®¢å•ä¿¡æ¯</h4>\n              <div className={styles.orderItem}>\n                <span className={styles.orderLabel}>å•†å“</span>\n                <span className={styles.orderValue}>{document.title}</span>\n              </div>\n              <div className={styles.orderItem}>\n                <span className={styles.orderLabel}>è®¢å•å·</span>\n                <span className={styles.orderValue}>{orderInfo?.orderId?.slice(-8) || 'N/A'}</span>\n              </div>\n              <div className={styles.orderItem}>\n                <span className={styles.orderLabel}>æ”¯ä»˜æ–¹å¼</span>\n                <span className={styles.orderValue}>{paymentMethod === 'WECHAT' ? 'å¾®ä¿¡æ”¯ä»˜' : 'æ”¯ä»˜å®'}</span>\n              </div>\n            </div>\n\n            {/* æ“ä½œæŒ‰é’® */}\n            <div className={styles.actions}>\n              <Button\n                variant=\"secondary\" \n                onClick={onCancel}\n                className={styles.fullWidthButton}\n              >\n                å–æ¶ˆæ”¯ä»˜\n              </Button>\n              <div className={styles.waitingStatus}>\n                ç­‰å¾…æ”¯ä»˜ä¸­...\n              </div>\n            </div>\n          </div>\n        );\n\n      case 'success':\n        return (\n          <div className={styles.statusContainer}>\n            <div className={styles.successIcon}>\n              <span>âœ“</span>\n            </div>\n            <h3 className={styles.statusTitle}>æ”¯ä»˜æˆåŠŸ</h3>\n            <p className={styles.statusText}>å†…å®¹å·²è§£é”ï¼Œæ„Ÿè°¢æ‚¨çš„è´­ä¹°</p>\n            <Button\n              variant=\"primary\" \n              onClick={onCancel}\n              className={styles.fullWidthButton}\n            >\n              å®Œæˆ\n            </Button>\n          </div>\n        );\n\n      case 'error':\n        return (\n          <div className={styles.statusContainer}>\n            <div className={styles.errorIcon}>\n              <span>âœ•</span>\n            </div>\n            <h3 className={styles.statusTitle}>æ”¯ä»˜å¤±è´¥</h3>\n            <p className={styles.statusText}>{error || 'æ”¯ä»˜è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•'}</p>\n            <div className={styles.actions}>\n              <Button\n                variant=\"secondary\" \n                onClick={onCancel}\n                className={styles.cancelButton}\n              >\n                å…³é—­\n              </Button>\n              <Button\n                variant=\"primary\" \n                onClick={handleRetry}\n                className={styles.retryButton}\n              >\n                é‡è¯•\n              </Button>\n            </div>\n          </div>\n        );\n    }\n  };\n\n  return (\n    <div className={styles.mobilePayment}>\n      {renderContent()}\n    </div>\n  );\n};\n\nexport default MobilePayment;\n