# å“åº”å¼ç³»ç»Ÿé›†æˆæŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸ºå…¶ä»–å›¢é˜Ÿæˆå‘˜æä¾›å“åº”å¼ç³»ç»Ÿçš„é›†æˆæŒ‡å—å’Œä½¿ç”¨ç¤ºä¾‹ã€‚å“åº”å¼ä¸“å®¶ï¼ˆå¼€å‘è€…C2ï¼‰å·²å®Œæˆæ‰€æœ‰åŠŸèƒ½å¼€å‘ï¼Œæœ¬æŒ‡å—å°†å¸®åŠ©UIç»„ä»¶å¼€å‘è€…å’ŒåŠ¨ç”»å·¥ç¨‹å¸ˆå¿«é€Ÿé›†æˆå“åº”å¼åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### âœ… å·²å®ŒæˆåŠŸèƒ½
- å“åº”å¼ç®¡ç†å™¨ (ResponsiveManager)
- åˆ—å®½è°ƒæ•´å™¨ (ColumnResizer)  
- æ™ºèƒ½æ–­ç‚¹æ£€æµ‹ (IntelligentBreakpointDetector)
- é«˜çº§çº¦æŸç³»ç»Ÿ (AdvancedConstraintSystem)
- å®¹å™¨æŸ¥è¯¢æ”¯æŒ (ContainerQueryManager)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€å“åº”å¼åŠŸèƒ½é›†æˆ

```typescript
import { ResponsiveManager, DEFAULT_BREAKPOINTS } from '@blocksuite/affine-layout-interactions/responsive';

// åˆ›å»ºå“åº”å¼ç®¡ç†å™¨
const responsiveManager = new ResponsiveManager({
  breakpoints: DEFAULT_BREAKPOINTS,
  enableContainerQueries: true,
  enableOrientationChange: true
});

// è®¾ç½®å“åº”å¼ç›‘å¬
const container = document.querySelector('.column-layout-container');
const handle = responsiveManager.setupResponsiveListeners(container, (event) => {
  console.log('å“åº”å¼å˜åŒ–:', event);
  
  // æ ¹æ®æ–­ç‚¹è°ƒæ•´å¸ƒå±€
  if (event.breakpoint === 'mobile') {
    // å¼ºåˆ¶å•åˆ—å¸ƒå±€
    container.className = 'column-layout-1';
  } else if (event.breakpoint === 'tablet') {
    // æœ€å¤šåŒåˆ—
    if (event.maxColumns > 2) {
      container.className = 'column-layout-2';
    }
  }
});

// æ¸…ç†
// handle.cleanup();
```

### 2. åˆ—å®½è°ƒæ•´å™¨é›†æˆ

```typescript
import { ColumnResizer } from '@blocksuite/affine-layout-interactions/resizer';

// åœ¨HTMLä¸­æ·»åŠ åˆ—è°ƒæ•´å™¨
// <column-resizer column-index="0" min-width="200" max-width="800"></column-resizer>

const resizer = document.querySelector('column-resizer') as ColumnResizer;

// ç›‘å¬åˆ—å®½å˜åŒ–
resizer.onColumnResize((newWidths) => {
  console.log('æ–°çš„åˆ—å®½åº¦:', newWidths);
  
  // åº”ç”¨åˆ°CSS Grid
  const container = document.querySelector('.column-layout-container');
  const gridColumns = newWidths.map(w => `${w}fr`).join(' ');
  container.style.gridTemplateColumns = gridColumns;
});

// å¯ç”¨/ç¦ç”¨è°ƒæ•´å™¨
resizer.enable();
// resizer.disable();
```

### 3. æ™ºèƒ½æ–­ç‚¹æ£€æµ‹é›†æˆ

```typescript
import { IntelligentBreakpointDetector } from '@blocksuite/affine-layout-interactions/responsive';

// åˆ›å»ºæ™ºèƒ½æ£€æµ‹å™¨
const detector = new IntelligentBreakpointDetector(DEFAULT_BREAKPOINTS);

// åˆ†æå†…å®¹å¹¶è·å–æ¨è
const container = document.querySelector('.content-container');
const analysis = await detector.analyzeContent(container);

console.log('å†…å®¹åˆ†æç»“æœ:', analysis);
console.log('æ¨èåˆ—æ•°:', analysis.recommendedColumns);
console.log('ç½®ä¿¡åº¦:', analysis.confidence);

// ç”Ÿæˆå¸ƒå±€æ¨è
const recommendation = detector.generateAdaptiveLayoutRecommendation(
  analysis,
  container.getBoundingClientRect().width,
  'single' // å½“å‰æ¨¡å¼
);

console.log('æ¨èå¸ƒå±€:', recommendation.mode);
console.log('æ¨èåˆ—å®½:', recommendation.columnWidths);
```

## ğŸ¨ UIç»„ä»¶å¼€å‘è€…é›†æˆæŒ‡å—

### ä¸ºå¼€å‘è€…B1ï¼ˆç»„ä»¶æ¶æ„å¸ˆï¼‰

```typescript
// åœ¨LayoutSwitcherç»„ä»¶ä¸­é›†æˆå“åº”å¼
import { ResponsiveManager } from '@blocksuite/affine-layout-interactions/responsive';

@customElement('layout-switcher')
export class LayoutSwitcher extends LitElement {
  private responsiveManager = new ResponsiveManager();
  
  override connectedCallback() {
    super.connectedCallback();
    
    // è®¾ç½®å“åº”å¼ç›‘å¬
    const container = this.closest('.page-container');
    this.responsiveManager.setupResponsiveListeners(container, (event) => {
      // æ ¹æ®æ–­ç‚¹ç¦ç”¨ä¸æ”¯æŒçš„å¸ƒå±€æ¨¡å¼
      this.updateAvailableModes(event.maxColumns);
    });
  }
  
  private updateAvailableModes(maxColumns: number) {
    const buttons = this.shadowRoot.querySelectorAll('.layout-button');
    buttons.forEach((button, index) => {
      const requiredColumns = index + 1;
      button.disabled = requiredColumns > maxColumns;
    });
  }
}
```

### ä¸ºå¼€å‘è€…B2ï¼ˆäº¤äº’è®¾è®¡å¸ˆï¼‰

```typescript
// åœ¨æ‹–æ‹½äº¤äº’ä¸­é›†æˆå“åº”å¼çº¦æŸ
import { AdvancedConstraintSystem } from '@blocksuite/affine-layout-interactions/resizer';

export class DragInteractionManager {
  private constraintSystem = new AdvancedConstraintSystem({
    enableContentAnalysis: true,
    enableResponsiveConstraints: true,
    preferredDistribution: 'content-based'
  });
  
  handleColumnDrop(sourceColumn: number, targetColumn: number, blockId: string) {
    // æ£€æŸ¥æ˜¯å¦è¿åå“åº”å¼çº¦æŸ
    const containerWidth = this.getContainerWidth();
    const currentWidths = this.getCurrentColumnWidths();
    
    const result = this.constraintSystem.applyConstraints(
      currentWidths,
      containerWidth
    );
    
    if (result.violations.length > 0) {
      // æ˜¾ç¤ºçº¦æŸè¿è§„æç¤º
      this.showConstraintWarning(result.violations);
    }
    
    // æ‰§è¡Œæ‹–æ‹½æ“ä½œ
    this.performDrop(sourceColumn, targetColumn, blockId);
  }
}
```

### ä¸ºå¼€å‘è€…B3ï¼ˆæ ·å¼å·¥ç¨‹å¸ˆï¼‰

```css
/* å“åº”å¼æ ·å¼é›†æˆç¤ºä¾‹ */

/* ä½¿ç”¨å®¹å™¨æŸ¥è¯¢ï¼ˆç°ä»£æµè§ˆå™¨ï¼‰ */
@container layout-container (max-width: 768px) {
  .column-layout-container {
    grid-template-columns: 1fr !important;
    gap: 12px;
  }
  
  .column-resizer {
    display: none;
  }
}

@container layout-container (min-width: 769px) and (max-width: 1024px) {
  .column-layout-container.column-layout-3,
  .column-layout-container.column-layout-4,
  .column-layout-container.column-layout-5 {
    grid-template-columns: 1fr 1fr !important;
  }
  
  .layout-switcher .layout-button:nth-child(n+3) {
    opacity: 0.5;
    pointer-events: none;
  }
}

/* å¤‡ç”¨æ–¹æ¡ˆï¼ˆä½¿ç”¨JavaScriptç±»åï¼‰ */
.column-layout-container.cq-mobile {
  grid-template-columns: 1fr !important;
}

.column-layout-container.cq-tablet.column-layout-5 {
  grid-template-columns: 1fr 1fr 1fr !important;
}

/* åˆ—è°ƒæ•´å™¨æ ·å¼ */
column-resizer {
  opacity: 0;
  transition: opacity 0.2s ease;
}

column-resizer:hover,
column-resizer[data-dragging] {
  opacity: 1;
}

/* ç§»åŠ¨ç«¯éšè—è°ƒæ•´å™¨ */
@media (max-width: 768px) {
  column-resizer {
    display: none;
  }
}
```

## ğŸ­ åŠ¨ç”»å·¥ç¨‹å¸ˆé›†æˆæŒ‡å—

### ä¸ºå¼€å‘è€…C1ï¼ˆåŠ¨ç”»å·¥ç¨‹å¸ˆï¼‰

```typescript
// åœ¨åŠ¨ç”»ä¸­è€ƒè™‘å“åº”å¼çŠ¶æ€
import { ResponsiveManager } from '@blocksuite/affine-layout-interactions/responsive';

export class LayoutAnimationManager {
  private responsiveManager = new ResponsiveManager();
  
  async animateLayoutTransition(fromMode: string, toMode: string) {
    // æ£€æŸ¥å“åº”å¼çº¦æŸ
    const effectiveToMode = this.responsiveManager.getEffectiveMode(toMode);
    
    if (effectiveToMode !== toMode) {
      // å¦‚æœç›®æ ‡æ¨¡å¼ä¸è¢«æ”¯æŒï¼ŒåŠ¨ç”»åˆ°æœ‰æ•ˆæ¨¡å¼
      console.log(`å“åº”å¼çº¦æŸ: ${toMode} -> ${effectiveToMode}`);
      toMode = effectiveToMode;
    }
    
    // æ‰§è¡ŒåŠ¨ç”»
    await this.performLayoutAnimation(fromMode, toMode);
  }
  
  animateColumnResize(columnIndex: number, newWidth: number) {
    // æ£€æŸ¥åˆ—å®½çº¦æŸ
    const isValid = this.responsiveManager.isValidWidth(newWidth);
    
    if (!isValid) {
      // åŠ¨ç”»åˆ°çº¦æŸèŒƒå›´å†…çš„å®½åº¦
      const constrainedWidth = this.responsiveManager.constrainWidth(newWidth);
      return this.animateToWidth(columnIndex, constrainedWidth);
    }
    
    return this.animateToWidth(columnIndex, newWidth);
  }
}
```

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

```typescript
// ç§»åŠ¨ç«¯ç‰¹æ®Šå¤„ç†
import { ResponsiveUtils } from '@blocksuite/affine-layout-interactions/responsive';

export class MobileLayoutAdapter {
  static adapt(container: HTMLElement) {
    if (ResponsiveUtils.isMobile()) {
      // å¼ºåˆ¶å•åˆ—å¸ƒå±€
      container.className = 'column-layout-1';
      
      // ç¦ç”¨åˆ—è°ƒæ•´å™¨
      const resizers = container.querySelectorAll('column-resizer');
      resizers.forEach(resizer => resizer.style.display = 'none');
      
      // å¯ç”¨è§¦æ‘¸å‹å¥½çš„äº¤äº’
      container.classList.add('touch-optimized');
    }
  }
}
```

## ğŸ”§ è°ƒè¯•å’Œå¼€å‘å·¥å…·

```typescript
// å“åº”å¼è°ƒè¯•åŠ©æ‰‹
export class ResponsiveDebugger {
  static logBreakpointInfo(manager: ResponsiveManager) {
    console.group('å“åº”å¼çŠ¶æ€');
    console.log('å½“å‰æ–­ç‚¹:', manager.getCurrentBreakpoint());
    console.log('æ˜¯å¦æ¡Œé¢ç«¯:', manager.isDesktop());
    console.log('æ˜¯å¦ç§»åŠ¨ç«¯:', manager.isMobile());
    console.log('æœ€å¤§åˆ—æ•°:', manager.getMaxColumnsForWidth(window.innerWidth));
    console.groupEnd();
  }
  
  static logConstraintViolations(violations: any[]) {
    if (violations.length > 0) {
      console.warn('çº¦æŸè¿è§„:', violations);
      violations.forEach(v => {
        console.log(`- åˆ—${v.columnIndex + 1}: ${v.message}`);
      });
    }
  }
}
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é˜²æŠ–å¤„ç†**: å“åº”å¼ç›‘å¬å™¨å·²å†…ç½®é˜²æŠ–ï¼Œé»˜è®¤250ms
2. **ç¼“å­˜ç­–ç•¥**: å†…å®¹åˆ†æç»“æœä¼šè‡ªåŠ¨ç¼“å­˜
3. **æŒ‰éœ€åŠ è½½**: ä½¿ç”¨åŠ¨æ€å¯¼å…¥å‡å°‘åˆå§‹åŒ…å¤§å°
4. **å®¹å™¨æŸ¥è¯¢**: ä¼˜å…ˆä½¿ç”¨åŸç”Ÿå®¹å™¨æŸ¥è¯¢ï¼Œè‡ªåŠ¨é™çº§åˆ°polyfill

```typescript
// æ€§èƒ½ä¼˜åŒ–ç¤ºä¾‹
import { ContainerQueryUtils } from '@blocksuite/affine-layout-interactions/responsive';

// æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
if (ContainerQueryUtils.isSupported()) {
  console.log('ä½¿ç”¨åŸç”Ÿå®¹å™¨æŸ¥è¯¢');
} else {
  console.log('ä½¿ç”¨polyfill');
  await ContainerQueryUtils.loadPolyfill();
}
```

## ğŸ“ æ”¯æŒå’ŒååŠ©

ä½œä¸ºå“åº”å¼ä¸“å®¶ï¼ˆå¼€å‘è€…C2ï¼‰ï¼Œæˆ‘å·²å®Œæˆæ‰€æœ‰åŠŸèƒ½å¼€å‘ã€‚å¦‚æœåœ¨é›†æˆè¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹å…·ä½“çš„TypeScriptæ¥å£å®šä¹‰
2. å‚è€ƒæœ¬æ–‡æ¡£çš„ç¤ºä¾‹ä»£ç 
3. ä½¿ç”¨è°ƒè¯•å·¥å…·æ£€æŸ¥çŠ¶æ€
4. è”ç³»æˆ‘è·å–æŠ€æœ¯æ”¯æŒ

**å…³é”®æ–‡ä»¶ä½ç½®**:
- `/packages/interactions/src/responsive/` - å“åº”å¼æ ¸å¿ƒ
- `/packages/interactions/src/resizer/` - åˆ—å®½è°ƒæ•´
- `/packages/interactions/src/types/` - ç±»å‹å®šä¹‰

ç¥å¼€å‘é¡ºåˆ©ï¼ğŸš€